<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Mapping Survey | Workflow Partners</title>
    <meta name="description" content="Map your workflows in detail. 25–30 minute guided survey with save & resume.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1a2f4a;
            --primary-light: #2a4a6b;
            --accent: #3d8ea6;
            --accent-light: #5bb8d4;
            --dark: #0c1b2e;
            --text: #1e293b;
            --text-mid: #475569;
            --text-light: #64748b;
            --bg: #fafbfc;
            --bg-alt: #f1f5f9;
            --white: #ffffff;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --success: #16a34a;
            --success-bg: rgba(22,163,74,0.06);
            --warn: #f59e0b;
            --warn-bg: #fffbeb;
            --danger: #ef4444;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.06);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.08);
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 20px;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            color: var(--text);
            line-height: 1.65;
            background: var(--bg);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        h1, h2, h3, h4 {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
            line-height: 1.15;
            color: var(--dark);
        }

        .top-bar {
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226,232,240,0.6);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .top-bar-inner {
            max-width: 800px;
            margin: 0 auto;
            padding: 0.9rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar a {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }

        .top-bar-badge {
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent);
            background: rgba(61,142,166,0.08);
            padding: 4px 12px;
            border-radius: 999px;
        }

        .progress-wrap {
            background: var(--white);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 50px;
            z-index: 99;
        }

        .progress-inner {
            max-width: 800px;
            margin: 0 auto;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-bar-track {
            flex: 1;
            height: 4px;
            background: var(--border-light);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            border-radius: 4px;
            transition: width 0.4s cubic-bezier(0.16,1,0.3,1);
            width: 0%;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-light);
            font-weight: 600;
            white-space: nowrap;
            min-width: 80px;
            text-align: right;
        }

        .page-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2.5rem 1.5rem 4rem;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: sectionIn 0.4s cubic-bezier(0.16,1,0.3,1);
        }

        @keyframes sectionIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 2.25rem 2rem;
            margin-bottom: 1rem;
        }

        .section-num {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2.5px;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 0.4rem;
        }

        .section-card h2 {
            font-size: 1.65rem;
            margin-bottom: 0.35rem;
            letter-spacing: -0.3px;
        }

        .section-card > p, .section-card .section-desc {
            font-size: 0.88rem;
            color: var(--text-light);
            margin-bottom: 1.75rem;
            line-height: 1.6;
        }

        .question-group {
            margin-bottom: 1.5rem;
        }

        .question-group:last-child { margin-bottom: 0; }

        .question-label {
            font-weight: 600;
            font-size: 0.92rem;
            color: var(--text);
            margin-bottom: 0.3rem;
        }

        .question-help {
            font-size: 0.82rem;
            color: var(--text-light);
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-mid);
            margin-bottom: 0.35rem;
            letter-spacing: 0.1px;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="tel"],
        input[type="date"],
        input[type="datetime-local"],
        select,
        textarea {
            width: 100%;
            padding: 0.7rem 0.9rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.9rem;
            color: var(--text);
            background: var(--white);
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(61,142,166,0.1);
        }

        input::placeholder, textarea::placeholder { color: #a0aec0; }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2364748b' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 2.25rem;
        }

        .input-with-unit { position: relative; }
        .input-with-unit input { padding-right: 4rem; }
        .input-unit {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: var(--text-light);
            pointer-events: none;
        }

        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.6rem;
            margin-top: 0.5rem;
        }

        .option-card { display: block; cursor: pointer; }
        .option-card input[type="radio"] { display: none; }
        .option-card .option-inner {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-mid);
            transition: all 0.2s cubic-bezier(0.16,1,0.3,1);
            font-weight: 500;
        }

        .option-card input[type="radio"]:checked + .option-inner {
            border-color: var(--accent);
            background: rgba(61,142,166,0.06);
            color: var(--primary);
            font-weight: 600;
            box-shadow: 0 0 0 2px rgba(61,142,166,0.15);
        }

        .option-card:hover .option-inner {
            border-color: var(--accent);
            background: rgba(61,142,166,0.03);
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.6rem;
            margin-top: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 0.7rem 0.9rem;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.16,1,0.3,1);
        }

        .checkbox-label:hover {
            border-color: var(--accent);
            background: rgba(61,142,166,0.03);
        }

        .checkbox-label input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin-right: 0.65rem;
            cursor: pointer;
            accent-color: var(--primary);
            flex-shrink: 0;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkbox-text {
            color: var(--primary);
            font-weight: 600;
        }

        .checkbox-text { font-size: 0.85rem; color: var(--text-mid); }

        .step-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .step-row input { flex: 1; }
        .step-row .button-remove {
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            background: transparent;
            color: var(--text-light);
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .step-row .button-remove:hover { border-color: var(--danger); color: var(--danger); }

        .workflow-input-block {
            background: var(--bg);
            padding: 1.25rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            border: 1px solid var(--border-light);
        }

        .info-need-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .info-need-row select { flex: 1; }
        .info-need-row .option-grid { flex: 1; margin-top: 0; }
        .info-need-row .button-remove { padding: 0.5rem; font-size: 0.8rem; background: transparent; border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; color: var(--text-light); }

        .handoff-card {
            background: var(--bg);
            padding: 1.25rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            border: 1px solid var(--border-light);
        }

        .handoff-card h4 { font-size: 1rem; margin-bottom: 1rem; }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .button {
            padding: 0.75rem 1.75rem;
            border-radius: 999px;
            font-family: inherit;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.16,1,0.3,1);
            border: none;
            letter-spacing: 0.2px;
        }

        .button-primary {
            background: var(--primary);
            color: var(--white);
        }

        .button-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(26,47,74,0.2);
        }

        .button-secondary {
            background: transparent;
            color: var(--text-mid);
            border: 1px solid var(--border);
        }

        .button-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .button-submit {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            color: var(--white);
            padding: 0.85rem 2.25rem;
            font-size: 0.95rem;
        }

        .button-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(61,142,166,0.3);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .welcome-hero {
            text-align: center;
            margin-bottom: 2.5rem;
            padding: 2.5rem 1.5rem;
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .welcome-hero h1 { font-size: 2.4rem; margin-bottom: 0.5rem; }
        .welcome-hero-sub {
            font-size: 1rem;
            color: var(--text-light);
            max-width: 520px;
            margin: 0 auto 1.5rem;
            line-height: 1.65;
        }

        .diagnostic-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .diagnostic-stat {
            text-align: center;
        }

        .diagnostic-stat strong {
            display: block;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
        }

        .diagnostic-stat span { font-size: 0.78rem; color: var(--text-light); }

        .sub-step-header {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .duration-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .duration-grid .input-group { margin-bottom: 0; }

        .char-hint { font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem; }

        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(8px);
            z-index: 200;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1.5rem;
        }

        .loading-overlay.visible { display: flex; }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .completion-summary {
            text-align: center;
            padding: 2rem;
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .completion-summary h2 { margin-bottom: 1rem; }
        .completion-summary .stats-row {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .completion-summary .stat { text-align: center; }
        .completion-summary .stat strong { font-family: 'Cormorant Garamond', serif; font-size: 1.8rem; color: var(--primary); display: block; }
        .completion-summary .stat span { font-size: 0.82rem; color: var(--text-light); }

        .timeline-list { list-style: none; padding: 0; }
        .timeline-list li {
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .timeline-list li:last-child { border-bottom: none; }
        .timeline-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .error-msg { font-size: 0.82rem; color: var(--danger); margin-top: 0.35rem; }

        .progress-wrap.hidden { display: none; }

        @media (max-width: 768px) {
            .page-container { padding: 1.5rem 1rem 3rem; }
            .section-card { padding: 1.5rem 1.25rem; }
            .input-row { grid-template-columns: 1fr; }
            .duration-grid { grid-template-columns: 1fr; }
            .checkbox-grid { grid-template-columns: 1fr; }
            .option-grid { grid-template-columns: 1fr 1fr; }
            .button-group { flex-wrap: wrap; }
            .button { flex: 1; min-width: 120px; text-align: center; }
        }

        @media (max-width: 480px) {
            .option-grid { grid-template-columns: 1fr; }
            .top-bar-badge { display: none; }
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="top-bar-inner">
            <a href="/">Workflow Partners</a>
            <span class="top-bar-badge">Workflow Survey</span>
        </div>
    </div>

    <div class="progress-wrap hidden" id="progressWrap">
        <div class="progress-inner">
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">Section 1 of 9</div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Submitting your survey...</div>
    </div>

    <div class="page-container">

        <!-- Welcome -->
        <div class="section active" id="sectionWelcome">
            <div class="welcome-hero">
                <h1>Workflow Mapping Survey</h1>
                <p class="welcome-hero-sub">
                    This survey captures how your workflows actually run: triggers, steps, handoffs, delays, and impact.
                    Allow about 25–30 minutes per workflow. Your progress is saved locally so you can resume later.
                </p>
                <div class="diagnostic-stats" id="diagnosticStats"></div>
                <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap;">
                    <button class="button button-primary" id="btnStartSurvey">Start Survey</button>
                    <button class="button button-secondary" id="btnResumeSurvey" style="display: none;">Resume</button>
                </div>
            </div>
        </div>

        <!-- Section 1: Workflow Overview -->
        <div class="section" id="section1">
            <div class="section-card">
                <div class="section-num">Section 1 of 9</div>
                <h2>Workflow Overview</h2>
                <p class="section-desc">Define the workflow you're mapping and its basic parameters.</p>

                <div class="question-group">
                    <label class="input-label" for="workflowSelect">Which workflow are you mapping?</label>
                    <select id="workflowSelect">
                        <option value="">Select workflow...</option>
                        <option value="workflow1" id="optWf1">Workflow 1</option>
                        <option value="workflow2" id="optWf2">Workflow 2</option>
                        <option value="workflow3" id="optWf3">Workflow 3</option>
                    </select>
                </div>

                <div class="question-group">
                    <label class="input-label" for="workflowTrigger">What triggers this workflow?</label>
                    <input type="text" id="workflowTrigger" placeholder="e.g., New customer signs contract">
                </div>

                <div class="question-group">
                    <label class="input-label" for="workflowCompletion">What defines completion?</label>
                    <input type="text" id="workflowCompletion" placeholder="e.g., Customer onboarded and first invoice sent">
                </div>

                <div class="question-group">
                    <div class="question-label">How often does this workflow run?</div>
                    <div class="option-grid" id="frequencyOptions">
                        <label class="option-card"><input type="radio" name="frequency" value="multiple_day"><div class="option-inner">Multiple/day</div></label>
                        <label class="option-card"><input type="radio" name="frequency" value="daily"><div class="option-inner">Daily</div></label>
                        <label class="option-card"><input type="radio" name="frequency" value="2_3_week"><div class="option-inner">2–3/week</div></label>
                        <label class="option-card"><input type="radio" name="frequency" value="weekly"><div class="option-inner">Weekly</div></label>
                        <label class="option-card"><input type="radio" name="frequency" value="2_3_month"><div class="option-inner">2–3/month</div></label>
                        <label class="option-card"><input type="radio" name="frequency" value="monthly"><div class="option-inner">Monthly</div></label>
                        <label class="option-card"><input type="radio" name="frequency" value="quarterly"><div class="option-inner">Quarterly</div></label>
                    </div>
                </div>

                <div class="question-group">
                    <label class="input-label" for="inFlightCount">Roughly how many instances are in-flight at once?</label>
                    <div class="input-with-unit">
                        <input type="number" id="inFlightCount" placeholder="e.g., 12" min="0">
                        <span class="input-unit">instances</span>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="button button-secondary" onclick="surveyNav(0)">Back</button>
                <button class="button button-primary" onclick="surveyNav(2)">Continue</button>
            </div>
        </div>

        <!-- Section 2: Step Mapping -->
        <div class="section" id="section2">
            <div class="section-card">
                <div class="section-num">Section 2 of 9</div>
                <h2>Step Mapping</h2>
                <p class="section-desc">List the main steps in order (min 3, max 15). You'll analyse each step in the next section.</p>

                <div class="question-group">
                    <div class="question-label">Steps (in order)</div>
                    <div id="stepList"></div>
                    <button type="button" class="button button-secondary" id="btnAddStep" style="margin-top: 0.5rem">+ Add Step</button>
                    <p class="error-msg" id="stepListError" style="display:none">Please add at least 3 steps.</p>
                </div>
            </div>

            <div class="button-group">
                <button class="button button-secondary" onclick="surveyNav(1)">Back</button>
                <button class="button button-primary" onclick="surveyNav(3)">Continue</button>
            </div>
        </div>

        <!-- Section 3: Step-by-Step Analysis (dynamic per step) -->
        <div class="section" id="section3">
            <div class="section-card">
                <div class="section-num">Section 3 of 9</div>
                <h2>Step-by-Step Analysis</h2>
                <p class="section-desc"><span id="stepAnalysisTitle">Step 1 of N</span></p>

                <div id="section3Content"></div>
            </div>

            <div class="button-group">
                <button class="button button-secondary" id="btnStepPrev">Previous Step</button>
                <button class="button button-primary" id="btnStepNext">Next Step</button>
            </div>
        </div>

        <!-- Section 4: Handoff Analysis (dynamic per handoff) -->
        <div class="section" id="section4">
            <div class="section-card">
                <div class="section-num">Section 4 of 9</div>
                <h2>Handoff Analysis</h2>
                <p class="section-desc">For each handoff between consecutive steps, capture how it works and where delays occur.</p>

                <div id="section4Content"></div>
            </div>

            <div class="button-group">
                <button class="button button-secondary" onclick="surveyNav(3)">Back</button>
                <button class="button button-primary" onclick="surveyNav(5)">Continue</button>
            </div>
        </div>

        <!-- Section 5: Recent Example -->
        <div class="section" id="section5">
            <div class="section-card">
                <div class="section-num">Section 5 of 9</div>
                <h2>Recent Example</h2>
                <p class="section-desc">Pick one recent instance and describe how it went.</p>

                <div class="question-group">
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label" for="recentStartDate">Start date</label>
                            <input type="date" id="recentStartDate">
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="recentEndDate">End date</label>
                            <input type="date" id="recentEndDate">
                        </div>
                    </div>
                    <p class="char-hint" id="elapsedDaysHint">Elapsed: — days</p>
                </div>

                <div class="question-group">
                    <div class="question-label">Was this instance:</div>
                    <div class="option-grid">
                        <label class="option-card"><input type="radio" name="instanceSpeed" value="faster"><div class="option-inner">Faster</div></label>
                        <label class="option-card"><input type="radio" name="instanceSpeed" value="typical"><div class="option-inner">Typical</div></label>
                        <label class="option-card"><input type="radio" name="instanceSpeed" value="slower"><div class="option-inner">Slower</div></label>
                        <label class="option-card"><input type="radio" name="instanceSpeed" value="much_slower"><div class="option-inner">Much slower</div></label>
                    </div>
                </div>

                <div class="question-group">
                    <div class="question-label">Per-step timeline (optional)</div>
                    <div class="question-help">Started and completed date/time for each step, plus optional notes.</div>
                    <div id="recentStepTimeline"></div>
                </div>

                <div class="question-group">
                    <label class="input-label" for="bottleneckStep">Which step was the bottleneck (if any)?</label>
                    <select id="bottleneckStep">
                        <option value="">None / N/A</option>
                    </select>
                </div>

                <div class="question-group">
                    <label class="input-label" for="bottleneckReason">Why was it the bottleneck?</label>
                    <textarea id="bottleneckReason" rows="3" placeholder="Brief reason"></textarea>
                </div>

                <div class="question-group">
                    <label class="input-label" for="couldBeFaster">What would have made it faster?</label>
                    <textarea id="couldBeFaster" rows="3" placeholder="e.g., clearer handoff, earlier approval"></textarea>
                </div>
            </div>

            <div class="button-group">
                <button class="button button-secondary" onclick="surveyNav(4)">Back</button>
                <button class="button button-primary" onclick="surveyNav(6)">Continue</button>
            </div>
        </div>

        <!-- Section 6: Worst Case -->
        <div class="section" id="section6">
            <div class="section-card">
                <div class="section-num">Section 6 of 9</div>
                <h2>Worst Case</h2>
                <p class="section-desc">Think of a time this workflow went badly. How long did it take and what went wrong?</p>

                <div class="question-group">
                    <label class="input-label" for="worstCaseDays">Total days (worst case)</label>
                    <div class="input-with-unit">
                        <input type="number" id="worstCaseDays" placeholder="e.g., 45" min="0">
                        <span class="input-unit">days</span>
                    </div>
                    <p class="char-hint" id="typicalDaysRef">Typical reference: — days (from recent example)</p>
                </div>

                <div class="question-group">
                    <div class="question-label">What went wrong? (select all that apply)</div>
                    <div class="checkbox-grid">
                        <label class="checkbox-label"><input type="checkbox" name="worstCaseCauses" value="multiple_approvals"><span class="checkbox-text">Multiple approvals</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="worstCaseCauses" value="missing_info"><span class="checkbox-text">Missing info</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="worstCaseCauses" value="wrong_person"><span class="checkbox-text">Wrong person</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="worstCaseCauses" value="system_issues"><span class="checkbox-text">System issues</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="worstCaseCauses" value="customer_changed"><span class="checkbox-text">Customer changed</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="worstCaseCauses" value="external_dependency"><span class="checkbox-text">External dependency</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="worstCaseCauses" value="legal_compliance"><span class="checkbox-text">Legal/compliance</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="worstCaseCauses" value="budget_surprise"><span class="checkbox-text">Budget surprise</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="worstCaseCauses" value="other"><span class="checkbox-text">Other</span></label>
                    </div>
                </div>

                <div class="question-group">
                    <label class="input-label" for="worstCasePrevention">What could have prevented it?</label>
                    <textarea id="worstCasePrevention" rows="3" maxlength="300" placeholder="Max 300 characters"></textarea>
                    <p class="char-hint"><span id="preventionCount">0</span>/300</p>
                </div>
            </div>

            <div class="button-group">
                <button class="button button-secondary" onclick="surveyNav(5)">Back</button>
                <button class="button button-primary" onclick="surveyNav(7)">Continue</button>
            </div>
        </div>

        <!-- Section 7: Cost & Impact -->
        <div class="section" id="section7">
            <div class="section-card">
                <div class="section-num">Section 7 of 9</div>
                <h2>Cost &amp; Impact</h2>
                <p class="section-desc">If this workflow were 50% faster, what would improve? What's the impact?</p>

                <div class="question-group">
                    <div class="question-label">If 50% faster, what improves? (select all)</div>
                    <div class="checkbox-grid">
                        <label class="checkbox-label"><input type="checkbox" name="improves" value="revenue"><span class="checkbox-text">Revenue</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="improves" value="customer_satisfaction"><span class="checkbox-text">Customer satisfaction</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="improves" value="capacity"><span class="checkbox-text">Capacity</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="improves" value="compliance"><span class="checkbox-text">Compliance</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="improves" value="cost_reduction"><span class="checkbox-text">Cost reduction</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="improves" value="quality"><span class="checkbox-text">Quality</span></label>
                    </div>
                </div>

                <div class="question-group">
                    <div class="question-label">Annual impact estimate if improved</div>
                    <div class="option-grid">
                        <label class="option-card"><input type="radio" name="annualImpact" value="under_10k"><div class="option-inner">&lt;£10K</div></label>
                        <label class="option-card"><input type="radio" name="annualImpact" value="10k_50k"><div class="option-inner">£10K–50K</div></label>
                        <label class="option-card"><input type="radio" name="annualImpact" value="50k_100k"><div class="option-inner">£50K–100K</div></label>
                        <label class="option-card"><input type="radio" name="annualImpact" value="100k_250k"><div class="option-inner">£100K–250K</div></label>
                        <label class="option-card"><input type="radio" name="annualImpact" value="250k_500k"><div class="option-inner">£250K–500K</div></label>
                        <label class="option-card"><input type="radio" name="annualImpact" value="over_500k"><div class="option-inner">&gt;£500K</div></label>
                    </div>
                </div>

                <div class="question-group">
                    <label class="input-label" for="oneThingToChange">One thing to change that would help most</label>
                    <textarea id="oneThingToChange" rows="3" maxlength="300" placeholder="Max 300 characters"></textarea>
                    <p class="char-hint"><span id="oneThingCount">0</span>/300</p>
                </div>

                <div class="question-group">
                    <label class="input-label" for="biggestPainPoint">Biggest pain point in this workflow</label>
                    <textarea id="biggestPainPoint" rows="3" maxlength="300" placeholder="Max 300 characters"></textarea>
                    <p class="char-hint"><span id="painPointCount">0</span>/300</p>
                </div>

                <div class="question-group">
                    <label class="input-label" for="roleEasier">What would make your role easier?</label>
                    <textarea id="roleEasier" rows="3" maxlength="300" placeholder="Max 300 characters"></textarea>
                    <p class="char-hint"><span id="roleEasierCount">0</span>/300</p>
                </div>
            </div>

            <div class="button-group">
                <button class="button button-secondary" onclick="surveyNav(6)">Back</button>
                <button class="button button-primary" onclick="surveyNav(8)">Continue</button>
            </div>
        </div>

        <!-- Section 8: Validation -->
        <div class="section" id="section8">
            <div class="section-card">
                <div class="section-num">Section 8 of 9</div>
                <h2>Validation</h2>
                <p class="section-desc">How confident are you in this mapping, and do you track any metrics?</p>

                <div class="question-group">
                    <div class="question-label">How confident are you in this mapping?</div>
                    <div class="option-grid">
                        <label class="option-card"><input type="radio" name="confidence" value="very_confident"><div class="option-inner">Very confident</div></label>
                        <label class="option-card"><input type="radio" name="confidence" value="confident"><div class="option-inner">Confident</div></label>
                        <label class="option-card"><input type="radio" name="confidence" value="somewhat"><div class="option-inner">Somewhat</div></label>
                        <label class="option-card"><input type="radio" name="confidence" value="not_very"><div class="option-inner">Not very</div></label>
                    </div>
                </div>

                <div class="question-group">
                    <div class="question-label">Metrics you track for this workflow (select all)</div>
                    <div class="checkbox-grid">
                        <label class="checkbox-label"><input type="checkbox" name="metricsTracked" value="cycle_times"><span class="checkbox-text">Cycle times</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="metricsTracked" value="handoff_delays"><span class="checkbox-text">Handoff delays</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="metricsTracked" value="volume"><span class="checkbox-text">Volume</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="metricsTracked" value="error_rates"><span class="checkbox-text">Error rates</span></label>
                        <label class="checkbox-label"><input type="checkbox" name="metricsTracked" value="none"><span class="checkbox-text">None</span></label>
                    </div>
                </div>

                <div class="question-group" id="whereTrackedGroup">
                    <div class="question-label">Where do you track them?</div>
                    <div class="option-grid">
                        <label class="option-card"><input type="radio" name="whereTracked" value="spreadsheet"><div class="option-inner">Spreadsheet</div></label>
                        <label class="option-card"><input type="radio" name="whereTracked" value="crm"><div class="option-inner">CRM</div></label>
                        <label class="option-card"><input type="radio" name="whereTracked" value="pm_tool"><div class="option-inner">PM tool</div></label>
                        <label class="option-card"><input type="radio" name="whereTracked" value="bi_dashboard"><div class="option-inner">BI dashboard</div></label>
                        <label class="option-card"><input type="radio" name="whereTracked" value="other"><div class="option-inner">Other</div></label>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="button button-secondary" onclick="surveyNav(7)">Back</button>
                <button class="button button-primary" onclick="surveyNav(9)">Continue</button>
            </div>
        </div>

        <!-- Section 9: Next Workflow / Completion -->
        <div class="section" id="section9">
            <div class="section-card">
                <div class="section-num">Section 9 of 9</div>
                <h2>Next Workflow or Finish</h2>
                <p class="section-desc">Map another workflow or submit your survey.</p>

                <div class="button-group" style="flex-direction: column; gap: 1rem;">
                    <button class="button button-secondary" id="btnMapNext">Map Next Workflow</button>
                    <button class="button button-submit" id="btnSubmitSurvey">Submit Survey</button>
                </div>
            </div>
        </div>

        <!-- Completion Screen -->
        <div class="section" id="sectionComplete">
            <div class="completion-summary">
                <h2>Thank you</h2>
                <p class="section-desc">Your workflow mapping has been submitted.</p>
                <div class="stats-row" id="completionStats"></div>
                <div class="question-group" style="text-align: left; max-width: 560px; margin: 0 auto;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">What happens next</h3>
                    <ul class="timeline-list">
                        <li><span class="timeline-num">1</span> We'll review your mapping and combine it with your diagnostic.</li>
                        <li><span class="timeline-num">2</span> You'll receive a summary and optional call to discuss findings.</li>
                        <li><span class="timeline-num">3</span> We'll propose a transformation plan with quick wins and longer-term improvements.</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
(function() {
        const DEPARTMENTS = ['Sales', 'Operations', 'Finance', 'IT', 'HR', 'Marketing', 'Leadership', 'Customer Service', 'Other'];
        const DELAY_CAUSES = ['approval', 'missing_info', 'person_unavailable', 'system_issues', 'unclear_requirements', 'dependencies', 'quality_rework', 'capacity', 'other'];
        const DELAY_CAUSE_LABELS = {
            approval: 'Approval', missing_info: 'Missing info', person_unavailable: 'Person unavailable',
            system_issues: 'System issues', unclear_requirements: 'Unclear requirements', dependencies: 'Dependencies',
            quality_rework: 'Quality/rework', capacity: 'Capacity', other: 'Other'
        };
        const INFO_SOURCES = ['CRM', 'Email', 'Spreadsheet', 'Shared drive', 'System A', 'System B', 'Person', 'Document', 'Other'];
        const STORAGE_KEY = 'workflow_survey_draft';
        const MIN_STEPS = 3;
        const MAX_STEPS = 15;

        let currentSectionIndex = 0;
        let section3StepIndex = 0;
        let steps = ['', '', ''];
        let workflowsCompleted = [];
        let currentWorkflowData = null;
        const sectionIds = ['sectionWelcome', 'section1', 'section2', 'section3', 'section4', 'section5', 'section6', 'section7', 'section8', 'section9', 'sectionComplete'];

        function getUrlParams() {
            const p = new URLSearchParams(window.location.search);
            return {
                healthScore: p.get('healthScore'),
                totalCost: p.get('totalCost'),
                workflowCount: p.get('workflowCount'),
                workflow1: p.get('workflow1') || '',
                workflow2: p.get('workflow2') || '',
                workflow3: p.get('workflow3') || ''
            };
        }

        function renderWelcomeDiagnostic() {
            const params = getUrlParams();
            const el = document.getElementById('diagnosticStats');
            if (!params.healthScore && !params.totalCost && !params.workflowCount) {
                el.innerHTML = '';
                return;
            }
            let html = '';
            if (params.healthScore) html += '<div class="diagnostic-stat"><strong>' + params.healthScore + '</strong><span>Health score</span></div>';
            if (params.totalCost) html += '<div class="diagnostic-stat"><strong>£' + Number(params.totalCost).toLocaleString() + '</strong><span>Est. annual cost</span></div>';
            if (params.workflowCount) html += '<div class="diagnostic-stat"><strong>' + params.workflowCount + '</strong><span>Workflows</span></div>';
            el.innerHTML = html;
        }

        function prefillWorkflowOptions() {
            const params = getUrlParams();
            const w1 = params.workflow1 || 'Workflow 1';
            const w2 = params.workflow2 || 'Workflow 2';
            const w3 = params.workflow3 || 'Workflow 3';
            document.getElementById('optWf1').textContent = w1;
            document.getElementById('optWf2').textContent = w2;
            document.getElementById('optWf3').textContent = w3;
        }

        function surveyNav(nextIndex) {
            if (nextIndex === 2 && !validateSection1()) return;
            if (nextIndex === 3 && !validateSection2()) return;
            if (nextIndex === 5) buildSection4();
            if (nextIndex === 6) {
                buildRecentStepTimeline();
                buildBottleneckDropdown();
                updateElapsedDays();
                updateTypicalDaysRef();
            }
            if (nextIndex === 8) buildSection3Content();
            showSection(nextIndex);
            if (nextIndex === 3) {
                section3StepIndex = 0;
                buildSection3Content();
            }
            saveDraft();
        }

        function validateSection1() {
            const w = document.getElementById('workflowSelect').value;
            if (!w) {
                alert('Please select which workflow you are mapping.');
                return false;
            }
            return true;
        }

        function validateSection2() {
            const names = steps.filter(s => (s || '').trim());
            if (names.length < MIN_STEPS) {
                document.getElementById('stepListError').style.display = 'block';
                return false;
            }
            document.getElementById('stepListError').style.display = 'none';
            return true;
        }

        function addStepRow(value, canRemove) {
            const idx = steps.length;
            const div = document.createElement('div');
            div.className = 'step-row';
            div.dataset.index = idx;
            div.innerHTML =
                '<input type="text" placeholder="Step ' + (idx + 1) + ' name" data-step-index="' + idx + '" value="' + (value || '').replace(/"/g, '&quot;') + '">' +
                (canRemove ? '<button type="button" class="button-remove" data-remove-step="' + idx + '">Remove</button>' : '');
            document.getElementById('stepList').appendChild(div);
            div.querySelector('input').addEventListener('input', function() {
                steps[idx] = this.value;
                saveDraft();
            });
            if (canRemove) {
                div.querySelector('[data-remove-step]').addEventListener('click', function() {
                    if (steps.length <= MIN_STEPS) return;
                    steps.splice(idx, 1);
                    renderStepList();
                    saveDraft();
                });
            }
        }

        function renderStepList() {
            const list = document.getElementById('stepList');
            list.innerHTML = '';
            steps.forEach((s, i) => addStepRow(s, steps.length > MIN_STEPS && i >= MIN_STEPS));
        }

        document.getElementById('btnAddStep').addEventListener('click', function() {
            if (steps.length >= MAX_STEPS) return;
            steps.push('');
            addStepRow('', true);
            saveDraft();
        });

        function getStepNames() {
            return steps.map((s, i) => {
                const input = document.querySelector('#stepList input[data-step-index="' + i + '"]');
                return input ? input.value.trim() : (s || '').trim();
            }).filter(Boolean);
        }

        function buildSection3Content() {
            const names = getStepNames();
            const total = names.length;
            const stepNames = names.length ? names : steps.map((s, i) => document.querySelector('#stepList input[data-step-index="' + i + '"]')?.value?.trim() || 'Step ' + (i + 1));
            const idx = section3StepIndex;
            const name = stepNames[idx] || ('Step ' + (idx + 1));

            document.getElementById('stepAnalysisTitle').textContent = 'Step ' + (idx + 1) + ' of ' + total + ': ' + name;

            const stepKey = 'step_' + idx;
            const prefix = 's3_' + idx + '_';
            let html = '';

            html += '<div class="question-group"><label class="input-label">Department</label><select id="' + prefix + 'department"><option value="">Select...</option>' +
                DEPARTMENTS.map(d => '<option value="' + d + '">' + d + '</option>').join('') + '</select></div>';

            html += '<div class="question-group"><label class="input-label">Role/Title</label><input type="text" id="' + prefix + 'role" placeholder="e.g., Account Manager"></div>';

            html += '<div class="question-group"><div class="question-label">Commitment level</div><div class="option-grid">' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'commitment" value="fulltime"><div class="option-inner">Full-time 80%+</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'commitment" value="parttime"><div class="option-inner">Part-time 20–80%</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'commitment" value="occasional"><div class="option-inner">Occasional &lt;20%</div></label></div></div>';

            html += '<div class="sub-step-header">Duration (hours)</div>';
            html += '<div class="duration-grid">';
            ['work_min', 'work_typical', 'work_max'].forEach((f, i) => {
                const label = i === 0 ? 'Work (min)' : i === 1 ? 'Work (typical)' : 'Work (max)';
                html += '<div class="input-group"><label class="input-label">' + label + '</label><input type="number" id="' + prefix + f + '" min="0" step="0.25" placeholder="0"></div>';
            });
            html += '</div><div class="duration-grid">';
            ['wait_min', 'wait_typical', 'wait_max'].forEach((f, i) => {
                const label = i === 0 ? 'Wait (min)' : i === 1 ? 'Wait (typical)' : 'Wait (max)';
                html += '<div class="input-group"><label class="input-label">' + label + '</label><input type="number" id="' + prefix + f + '" min="0" step="0.25" placeholder="0"></div>';
            });
            html += '</div><p class="char-hint">Total (work + wait): <span id="' + prefix + 'total_display">—</span> hours</p>';

            html += '<div class="question-group"><div class="question-label">Variability</div><div class="option-grid">' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'variability" value="rarely"><div class="option-inner">Rarely &lt;10%</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'variability" value="sometimes"><div class="option-inner">Sometimes 10–30%</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'variability" value="frequently"><div class="option-inner">Frequently 30–60%</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'variability" value="usually"><div class="option-inner">Usually &gt;60%</div></label></div></div>';

            html += '<div class="question-group" id="' + prefix + 'delayCausesWrap"><div class="question-label">Delay causes (max 3)</div><div class="checkbox-grid" id="' + prefix + 'delayCauses">';
            DELAY_CAUSES.forEach(dc => {
                html += '<label class="checkbox-label"><input type="checkbox" name="' + prefix + 'delayCause" value="' + dc + '"><span class="checkbox-text">' + DELAY_CAUSE_LABELS[dc] + '</span></label>';
            });
            html += '</div></div>';

            html += '<div class="question-group"><div class="question-label">Trigger method</div><div class="option-grid">' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'trigger" value="auto"><div class="option-inner">Auto notification</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'trigger" value="email"><div class="option-inner">Email</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'trigger" value="someone_asks"><div class="option-inner">Someone asks</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'trigger" value="scheduled"><div class="option-inner">Scheduled check-in</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'trigger" value="adhoc"><div class="option-inner">Ad-hoc</div></label></div></div>';

            html += '<div class="question-group"><div class="question-label">Back-and-forth communications</div><div class="option-grid">' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'backforth" value="none"><div class="option-inner">None</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'backforth" value="1_2"><div class="option-inner">1–2</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'backforth" value="3_5"><div class="option-inner">3–5</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'backforth" value="6_10"><div class="option-inner">6–10</div></label>' +
                '<label class="option-card"><input type="radio" name="' + prefix + 'backforth" value="10_plus"><div class="option-inner">10+</div></label></div></div>';

            html += '<div class="question-group"><div class="question-label">Information needs</div><div id="' + prefix + 'infoNeeds"></div><button type="button" class="button button-secondary" id="' + prefix + 'addInfo">+ Add</button></div>';

            document.getElementById('section3Content').innerHTML = html;

            const addInfoBtn = document.getElementById(prefix + 'addInfo');
            const infoNeedsContainer = document.getElementById(prefix + 'infoNeeds');
            let infoNeedCount = 0;

            function addInfoNeed() {
                const id = prefix + 'info_' + (infoNeedCount++);
                const row = document.createElement('div');
                row.className = 'info-need-row';
                row.innerHTML = '<select><option value="">Source...</option>' + INFO_SOURCES.map(s => '<option value="' + s + '">' + s + '</option>').join('') + '</select>' +
                    '<div class="option-grid"><label class="option-card"><input type="radio" name="' + id + '_acc" value="easy"><div class="option-inner">Easy</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + id + '_acc" value="moderate"><div class="option-inner">Moderate</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + id + '_acc" value="hard"><div class="option-inner">Hard</div></label></div>' +
                    '<button type="button" class="button-remove">Remove</button>';
                infoNeedsContainer.appendChild(row);
                row.querySelector('.button-remove').addEventListener('click', function() { row.remove(); });
            }
            addInfoNeed();
            addInfoBtn.addEventListener('click', addInfoNeed);

            function updateTotal() {
                const w = (parseFloat(document.getElementById(prefix + 'work_typical')?.value) || 0) + (parseFloat(document.getElementById(prefix + 'wait_typical')?.value) || 0);
                const el = document.getElementById(prefix + 'total_display');
                if (el) el.textContent = w.toFixed(1);
            }
            ['work_min','work_typical','work_max','wait_min','wait_typical','wait_max'].forEach(f => {
                const el = document.getElementById(prefix + f);
                if (el) el.addEventListener('input', updateTotal);
            });
            updateTotal();

            document.getElementById('btnStepPrev').style.display = '';
            document.getElementById('btnStepPrev').textContent = idx === 0 ? 'Back to steps' : 'Previous Step';
            document.getElementById('btnStepNext').textContent = idx < total - 1 ? 'Next Step' : 'Continue to Handoffs';
            document.getElementById('btnStepPrev').onclick = function() {
                if (section3StepIndex > 0) {
                    section3StepIndex--;
                    buildSection3Content();
                } else {
                    surveyNav(2);
                }
            };
            document.getElementById('btnStepNext').onclick = function() {
                if (section3StepIndex < total - 1) {
                    section3StepIndex++;
                    buildSection3Content();
                } else {
                    surveyNav(4);
                }
            };
        }

        function buildSection4() {
            const names = getStepNames();
            const container = document.getElementById('section4Content');
            container.innerHTML = '';
            for (let i = 0; i < names.length - 1; i++) {
                const a = names[i];
                const b = names[i + 1];
                const handoffId = 'handoff_' + i;
                const div = document.createElement('div');
                div.className = 'handoff-card';
                div.innerHTML = '<h4>Handoff: ' + a + ' → ' + b + '</h4>' +
                    '<div class="question-group"><div class="question-label">Method</div><div class="option-grid">' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_method" value="email"><div class="option-inner">Email notification</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_method" value="system"><div class="option-inner">System status update</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_method" value="verbal"><div class="option-inner">Verbal/meeting</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_method" value="shared_doc"><div class="option-inner">Shared document</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_method" value="slack_teams"><div class="option-inner">Slack/Teams</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_method" value="physical"><div class="option-inner">Physical handoff</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_method" value="other"><div class="option-inner">Other</div></label></div></div>' +
                    '<div class="question-group"><div class="question-label">Delay (hours)</div><div class="duration-grid">' +
                    '<div class="input-group"><label class="input-label">Min</label><input type="number" id="' + handoffId + '_delay_min" min="0" step="0.25" placeholder="0"></div>' +
                    '<div class="input-group"><label class="input-label">Typical</label><input type="number" id="' + handoffId + '_delay_typical" min="0" step="0.25" placeholder="0"></div>' +
                    '<div class="input-group"><label class="input-label">Max</label><input type="number" id="' + handoffId + '_delay_max" min="0" step="0.25" placeholder="0"></div></div></div>' +
                    '<div class="question-group"><div class="question-label">Delay causes (rank 1–5)</div><p class="question-help">Select order of causes if applicable.</p></div>' +
                    '<div class="question-group"><div class="question-label">Clarification frequency</div><div class="option-grid">' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_clarify" value="never"><div class="option-inner">Never</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_clarify" value="rarely"><div class="option-inner">Rarely &lt;10%</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_clarify" value="sometimes"><div class="option-inner">Sometimes 10–30%</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_clarify" value="frequently"><div class="option-inner">Frequently 30–60%</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_clarify" value="usually"><div class="option-inner">Usually &gt;60%</div></label></div></div>' +
                    '<div class="question-group"><label class="input-label">What\'s typically missing? (if sometimes+)</label><textarea id="' + handoffId + '_missing" rows="2" maxlength="300" placeholder="Max 300 chars"></textarea></div>' +
                    '<div class="question-group handoff-cross-dept" data-handoff-index="' + i + '"><div class="question-label">Different systems? (cross-department)</div><div class="option-grid">' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_systems" value="yes_manual"><div class="option-inner">Yes, manual</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_systems" value="yes_integrated"><div class="option-inner">Yes, integrated</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_systems" value="no"><div class="option-inner">No</div></label></div></div>' +
                    '<div class="question-group handoff-cross-dept" data-handoff-index="' + i + '"><div class="question-label">Cultural challenges?</div><div class="option-grid">' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_cultural" value="none"><div class="option-inner">None</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_cultural" value="minor"><div class="option-inner">Minor</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_cultural" value="moderate"><div class="option-inner">Moderate</div></label>' +
                    '<label class="option-card"><input type="radio" name="' + handoffId + '_cultural" value="significant"><div class="option-inner">Significant</div></label></div></div>';
                container.appendChild(div);
            }
        }

        function buildRecentStepTimeline() {
            const names = getStepNames();
            const container = document.getElementById('recentStepTimeline');
            container.innerHTML = '';
            names.forEach((name, i) => {
                const id = 'recentStep_' + i;
                const div = document.createElement('div');
                div.className = 'input-row';
                div.style.marginBottom = '0.75rem';
                div.innerHTML = '<div class="input-group"><label class="input-label">' + name + ' – Started</label><input type="datetime-local" id="' + id + '_start"></div>' +
                    '<div class="input-group"><label class="input-label">' + name + ' – Completed</label><input type="datetime-local" id="' + id + '_end"></div>' +
                    '<div class="input-group"><label class="input-label">Notes</label><input type="text" id="' + id + '_notes" placeholder="Optional"></div>';
                container.appendChild(div);
            });
        }

        function buildBottleneckDropdown() {
            const names = getStepNames();
            const sel = document.getElementById('bottleneckStep');
            sel.innerHTML = '<option value="">None / N/A</option>' + names.map((n, i) => '<option value="' + i + '">' + n + '</option>').join('');
        }

        function updateElapsedDays() {
            const start = document.getElementById('recentStartDate').value;
            const end = document.getElementById('recentEndDate').value;
            const el = document.getElementById('elapsedDaysHint');
            if (!start || !end) { el.textContent = 'Elapsed: — days'; return; }
            const d1 = new Date(start);
            const d2 = new Date(end);
            const days = Math.round((d2 - d1) / (24 * 60 * 60 * 1000));
            el.textContent = 'Elapsed: ' + days + ' days';
        }

        document.getElementById('recentStartDate').addEventListener('change', updateElapsedDays);
        document.getElementById('recentEndDate').addEventListener('change', updateElapsedDays);

        function updateTypicalDaysRef() {
            const start = document.getElementById('recentStartDate').value;
            const end = document.getElementById('recentEndDate').value;
            const el = document.getElementById('typicalDaysRef');
            if (!start || !end) { el.textContent = 'Typical reference: — days (from recent example)'; return; }
            const d1 = new Date(start);
            const d2 = new Date(end);
            const days = Math.round((d2 - d1) / (24 * 60 * 60 * 1000));
            el.textContent = 'Typical reference: ' + days + ' days (from recent example)';
        }

        function charCount(id, counterId) {
            const ta = document.getElementById(id);
            const counter = document.getElementById(counterId);
            if (!ta || !counter) return;
            function update() { counter.textContent = (ta.value || '').length; }
            ta.addEventListener('input', update);
            update();
        }

        charCount('worstCasePrevention', 'preventionCount');
        charCount('oneThingToChange', 'oneThingCount');
        charCount('biggestPainPoint', 'painPointCount');
        charCount('roleEasier', 'roleEasierCount');

        function updateWhereTrackedVisibility() {
            const none = document.querySelector('input[name="metricsTracked"][value="none"]');
            const anyOther = document.querySelector('input[name="metricsTracked"]:checked:not([value="none"])');
            document.getElementById('whereTrackedGroup').style.display = (none && none.checked) || !anyOther ? 'none' : 'block';
        }
        document.querySelectorAll('input[name="metricsTracked"]').forEach(cb => {
            cb.addEventListener('change', updateWhereTrackedVisibility);
        });

        function collectSurveyData() {
            const stepNames = getStepNames();
            const data = {
                urlParams: getUrlParams(),
                workflow: {
                    select: document.getElementById('workflowSelect').value,
                    trigger: document.getElementById('workflowTrigger').value,
                    completion: document.getElementById('workflowCompletion').value,
                    frequency: document.querySelector('input[name="frequency"]:checked')?.value || '',
                    inFlightCount: document.getElementById('inFlightCount').value
                },
                steps: stepNames,
                stepAnalysis: [],
                handoffs: [],
                recent: {
                    startDate: document.getElementById('recentStartDate').value,
                    endDate: document.getElementById('recentEndDate').value,
                    instanceSpeed: document.querySelector('input[name="instanceSpeed"]:checked')?.value || '',
                    perStepTimeline: stepNames.map((_, i) => ({
                        started: document.getElementById('recentStep_' + i + '_start')?.value,
                        completed: document.getElementById('recentStep_' + i + '_end')?.value,
                        notes: document.getElementById('recentStep_' + i + '_notes')?.value
                    })),
                    bottleneckStep: document.getElementById('bottleneckStep').value,
                    bottleneckReason: document.getElementById('bottleneckReason').value,
                    couldBeFaster: document.getElementById('couldBeFaster').value
                },
                worstCase: {
                    totalDays: document.getElementById('worstCaseDays').value,
                    causes: Array.from(document.querySelectorAll('input[name="worstCaseCauses"]:checked')).map(c => c.value),
                    prevention: document.getElementById('worstCasePrevention').value
                },
                costImpact: {
                    improves: Array.from(document.querySelectorAll('input[name="improves"]:checked')).map(c => c.value),
                    annualImpact: document.querySelector('input[name="annualImpact"]:checked')?.value || '',
                    oneThingToChange: document.getElementById('oneThingToChange').value,
                    biggestPainPoint: document.getElementById('biggestPainPoint').value,
                    roleEasier: document.getElementById('roleEasier').value
                },
                validation: {
                    confidence: document.querySelector('input[name="confidence"]:checked')?.value || '',
                    metricsTracked: Array.from(document.querySelectorAll('input[name="metricsTracked"]:checked')).map(c => c.value),
                    whereTracked: document.querySelector('input[name="whereTracked"]:checked')?.value || ''
                }
            };

            for (let i = 0; i < stepNames.length; i++) {
                const p = 's3_' + i + '_';
                const get = (id) => document.getElementById(p + id)?.value;
                const getRadio = (name) => document.querySelector('input[name="' + p + name + '"]:checked')?.value || '';
                const delayChecks = Array.from(document.querySelectorAll('input[name="' + p + 'delayCause"]:checked')).map(c => c.value).slice(0, 3);
                data.stepAnalysis.push({
                    department: get('department'),
                    role: get('role'),
                    commitment: getRadio('commitment'),
                    workMin: get('work_min'), workTypical: get('work_typical'), workMax: get('work_max'),
                    waitMin: get('wait_min'), waitTypical: get('wait_typical'), waitMax: get('wait_max'),
                    variability: getRadio('variability'),
                    delayCauses: delayChecks,
                    trigger: getRadio('trigger'),
                    backforth: getRadio('backforth'),
                    infoNeeds: [] // could collect from dynamic rows
                });
            }

            for (let i = 0; i < stepNames.length - 1; i++) {
                const h = 'handoff_' + i + '_';
                const getRadio = (n) => document.querySelector('input[name="' + h + n + '"]:checked')?.value || '';
                data.handoffs.push({
                    method: getRadio('method'),
                    delayMin: document.getElementById('handoff_' + i + '_delay_min')?.value,
                    delayTypical: document.getElementById('handoff_' + i + '_delay_typical')?.value,
                    delayMax: document.getElementById('handoff_' + i + '_delay_max')?.value,
                    delayCauseRank: [1,2,3,4,5].map(r => document.getElementById('handoff_' + i + '_rank' + r)?.value || ''),
                    clarification: getRadio('clarify'),
                    typicallyMissing: document.getElementById('handoff_' + i + '_missing')?.value,
                    differentSystems: getRadio('systems'),
                    culturalChallenges: getRadio('cultural')
                });
            }

            return data;
        }

        function saveDraft() {
            try {
                const draft = {
                    steps: steps.slice(),
                    workflowSelect: document.getElementById('workflowSelect').value,
                    workflowTrigger: document.getElementById('workflowTrigger').value,
                    workflowCompletion: document.getElementById('workflowCompletion').value,
                    frequency: document.querySelector('input[name="frequency"]:checked')?.value,
                    inFlightCount: document.getElementById('inFlightCount').value,
                    currentSectionIndex: currentSectionIndex,
                    section3StepIndex: section3StepIndex
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(draft));
            } catch (e) {}
        }

        function loadDraft() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const draft = JSON.parse(raw);
                if (draft.steps && draft.steps.length >= MIN_STEPS) steps = draft.steps;
                renderStepList();
                document.getElementById('workflowSelect').value = draft.workflowSelect || '';
                document.getElementById('workflowTrigger').value = draft.workflowTrigger || '';
                document.getElementById('workflowCompletion').value = draft.workflowCompletion || '';
                if (draft.frequency) {
                    const r = document.querySelector('input[name="frequency"][value="' + draft.frequency + '"]');
                    if (r) r.checked = true;
                }
                document.getElementById('inFlightCount').value = draft.inFlightCount || '';
                currentSectionIndex = draft.currentSectionIndex || 0;
                section3StepIndex = draft.section3StepIndex || 0;
            } catch (e) {}
        }

        document.getElementById('btnStartSurvey').addEventListener('click', function() {
            currentSectionIndex = 1;
            showSection(1);
        });

        document.getElementById('btnMapNext').addEventListener('click', function() {
            workflowsCompleted.push(collectSurveyData());
            steps = ['', '', ''];
            renderStepList();
            document.getElementById('workflowSelect').value = '';
            document.getElementById('workflowTrigger').value = '';
            document.getElementById('workflowCompletion').value = '';
            document.querySelectorAll('input[name="frequency"]').forEach(r => r.checked = false);
            document.getElementById('inFlightCount').value = '';
            section3StepIndex = 0;
            currentSectionIndex = 1;
            showSection(1);
            saveDraft();
        });

        document.getElementById('btnSubmitSurvey').addEventListener('click', function() {
            const allWorkflows = workflowsCompleted.slice();
            allWorkflows.push(collectSurveyData());
            const payload = {
                workflows: allWorkflows,
                diagnostic: getUrlParams()
            };
            document.getElementById('loadingOverlay').classList.add('visible');
            fetch('/api/survey-submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(function(res) {
                document.getElementById('loadingOverlay').classList.remove('visible');
                if (!res.ok) throw new Error('Submit failed');
                try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
                const totalW = payload.workflows.length;
                let totalSteps = 0, totalHandoffs = 0;
                payload.workflows.forEach(w => {
                    totalSteps += (w.steps || []).length;
                    totalHandoffs += (w.handoffs || []).length;
                });
                document.getElementById('completionStats').innerHTML =
                    '<div class="stat"><strong>' + totalW + '</strong><span>Workflows</span></div>' +
                    '<div class="stat"><strong>' + totalSteps + '</strong><span>Steps</span></div>' +
                    '<div class="stat"><strong>' + totalHandoffs + '</strong><span>Handoffs</span></div>';
                showSection(sectionIds.length - 1);
            }).catch(function() {
                document.getElementById('loadingOverlay').classList.remove('visible');
                alert('Submission failed. Your progress is saved locally. Please try again or contact support.');
            });
        });

        function showSection(index) {
            currentSectionIndex = index;
            sectionIds.forEach((id, i) => {
                document.getElementById(id).classList.toggle('active', i === index);
            });
            const isWelcome = index === 0;
            const isComplete = index === sectionIds.length - 1;
            document.getElementById('progressWrap').classList.toggle('hidden', isWelcome || isComplete);
            if (!isWelcome && !isComplete) {
                const total = sectionIds.length - 2;
                const step = index;
                const pct = (step / total) * 100;
                document.getElementById('progressBar').style.width = pct + '%';
                document.getElementById('progressText').textContent = 'Section ' + step + ' of ' + total;
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showResumeIfDraft() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    const draft = JSON.parse(raw);
                    if (draft.currentSectionIndex != null && draft.currentSectionIndex > 0) {
                        document.getElementById('btnResumeSurvey').style.display = '';
                    }
                }
            } catch (e) {}
        }

        document.getElementById('btnResumeSurvey').addEventListener('click', function() {
            loadDraft();
            const idx = currentSectionIndex || 1;
            if (idx === 3) buildSection3Content();
            showSection(idx);
        });

        renderWelcomeDiagnostic();
        prefillWorkflowOptions();
        renderStepList();
        loadDraft();
        showResumeIfDraft();
    })();
    </script>
</body>
</html>
