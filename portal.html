<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Portal | Workflow Partners</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles/base.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { display: flex; flex-direction: column; font-weight: 300; }
        :root { --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); --shadow-lg: 0 10px 40px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04); --bg: #f8fafb; }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #243f5c 100%); color: white;
            padding: 18px 28px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-logo {
            font-family: 'Cormorant Garamond', serif; font-size: 1.3rem;
            font-weight: 700; color: white; text-decoration: none;
        }
        .header-logo span { color: var(--gold); }
        .header-divider { width: 1px; height: 20px; background: rgba(255,255,255,0.15); }
        .header-title { font-size: 0.85rem; font-weight: 400; opacity: 0.7; letter-spacing: 0.3px; }
        .header-right { display: flex; align-items: center; gap: 14px; }
        .header-email { font-size: 0.76rem; opacity: 0.55; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .header-btn {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.85); padding: 6px 16px; border-radius: 6px;
            font-size: 0.76rem; font-family: inherit; cursor: pointer;
            transition: all 0.2s; font-weight: 400;
        }
        .header-btn:hover { background: rgba(255,255,255,0.15); color: white; }

        /* Layout */
        .portal-wrap { max-width: 960px; margin: 0 auto; padding: 24px 20px 60px; flex: 1; width: 100%; }

        /* Auth card */
        .auth-card {
            max-width: 400px; margin: 48px auto; background: var(--white);
            border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
            padding: 40px 36px 36px; border: 1px solid var(--border);
            position: relative;
        }
        .auth-card::before {
            content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 60px; height: 3px; border-radius: 0 0 4px 4px;
            background: linear-gradient(90deg, var(--accent), var(--gold));
        }
        .auth-card h2 { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; font-weight: 700; color: var(--primary); margin-bottom: 6px; text-align: center; }
        .auth-card p.auth-subtitle { font-family: 'Work Sans', -apple-system, sans-serif; color: var(--text-light); font-size: 0.84rem; font-weight: 400; text-align: center; margin-bottom: 28px; line-height: 1.5; }
        .auth-input { width: 100%; padding: 12px 14px; font-size: 0.88rem; border: 1.5px solid var(--border); border-radius: var(--radius-sm); font-family: inherit; margin-bottom: 10px; background: var(--bg); transition: all 0.2s; }
        .auth-input:focus { border-color: var(--accent); outline: none; background: var(--white); box-shadow: 0 0 0 3px rgba(61,142,166,0.08); }
        .pw-wrap { position: relative; }
        .pw-wrap .auth-input { padding-right: 42px; }
        .pw-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); margin-top: -5px; background: none; border: none; cursor: pointer; color: var(--text-light); padding: 2px; display: flex; align-items: center; justify-content: center; transition: color 0.15s; }
        .pw-toggle:hover { color: var(--text-mid); }
        .auth-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary), #2a4a6b); color: white; border: none; border-radius: var(--radius-sm); font-family: inherit; font-weight: 500; font-size: 0.9rem; cursor: pointer; margin-top: 6px; margin-bottom: 14px; transition: all 0.25s; }
        .auth-btn:hover { box-shadow: 0 4px 12px rgba(26,47,74,0.25); transform: translateY(-1px); }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .auth-toggle { text-align: center; font-size: 0.82rem; color: var(--text-light); }
        .auth-toggle a { color: var(--accent); cursor: pointer; text-decoration: none; font-weight: 500; }
        .auth-toggle a:hover { text-decoration: underline; }
        .auth-error { background: #fef2f2; color: var(--red); padding: 10px 14px; border-radius: var(--radius-sm); font-size: 0.82rem; margin-bottom: 12px; display: none; border: 1px solid #fecaca; }
        .auth-error.show { display: block; }
        .auth-success { background: #f0fdf4; color: var(--green); padding: 10px 14px; border-radius: var(--radius-sm); font-size: 0.82rem; margin-bottom: 12px; display: none; border: 1px solid #bbf7d0; }
        .auth-success.show { display: block; }

        /* Tabs */
        .portal-tabs {
            display: flex; gap: 4px; border-bottom: 1.5px solid var(--border); margin-bottom: 28px;
            padding: 0 2px;
        }
        .portal-tab {
            padding: 11px 22px; font-size: 0.84rem; font-weight: 500;
            color: var(--text-light); border-bottom: 2.5px solid transparent;
            margin-bottom: -1.5px; cursor: pointer; transition: all 0.2s;
            background: none; border-top: none; border-left: none; border-right: none;
            font-family: inherit; position: relative; letter-spacing: 0.2px;
        }
        .portal-tab:hover { color: var(--text-mid); }
        .portal-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

        /* Metric cards */
        .metrics-row {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 26px;
        }
        .metric-card {
            background: var(--white); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 22px 20px; text-align: center;
            transition: all 0.25s; position: relative; overflow: hidden;
        }
        .metric-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--primary));
            opacity: 0; transition: opacity 0.25s;
        }
        .metric-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-1px); }
        .metric-card:hover::before { opacity: 1; }
        .metric-val {
            font-family: 'Cormorant Garamond', serif; font-size: 2rem;
            font-weight: 700; color: var(--primary); display: block; margin-bottom: 4px; line-height: 1.1;
        }
        .metric-lbl { font-size: 0.68rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.6px; font-weight: 500; }
        .metric-sub { font-size: 0.72rem; color: var(--text-mid); margin-top: 6px; font-weight: 400; }

        /* Dashboard card */
        .dash-card {
            background: var(--white); border: 1px solid var(--border);
            border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .dash-card-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 22px; border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, var(--white) 0%, #fafbfc 100%);
        }
        .dash-card-title { font-size: 0.9rem; font-weight: 600; color: var(--primary); letter-spacing: 0.1px; }
        .dash-card-action {
            font-size: 0.78rem; color: var(--accent); text-decoration: none;
            font-weight: 500; cursor: pointer; background: none; border: none;
            font-family: inherit; display: inline-flex; align-items: center; gap: 4px;
            transition: color 0.2s;
        }
        .dash-card-action:hover { color: var(--primary); }

        /* Process rows */
        .process-row {
            display: flex; align-items: center; gap: 14px;
            padding: 16px 22px; border-bottom: 1px solid #f1f5f9;
            transition: all 0.15s;
        }
        .process-row:last-child { border-bottom: none; }
        .process-row:hover { background: #f8fafc; }
        .process-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .process-dot.green { background: var(--green); box-shadow: 0 0 0 3px rgba(22,163,74,0.12); }
        .process-dot.amber { background: var(--amber); box-shadow: 0 0 0 3px rgba(217,119,6,0.12); }
        .process-dot.red { background: var(--red); box-shadow: 0 0 0 3px rgba(220,38,38,0.12); }
        .process-dot.blue { background: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.12); }
        .process-name { flex: 1; font-size: 0.86rem; font-weight: 400; color: var(--text); line-height: 1.4; }
        .process-tag {
            display: inline-block; font-size: 0.64rem; font-weight: 600;
            padding: 3px 10px; border-radius: 100px; letter-spacing: 0.2px;
        }
        .process-tag.optimised { background: #ecfdf5; color: var(--green); }
        .process-tag.progress { background: #fffbeb; color: var(--amber); }
        .process-tag.review { background: #fef2f2; color: var(--red); }
        .process-tag.new { background: #eff6ff; color: #3b82f6; }
        .process-val { font-size: 0.76rem; color: var(--text-light); font-weight: 400; white-space: nowrap; }
        .process-actions {
            display: flex; gap: 6px; align-items: center; flex-shrink: 0;
        }
        .process-btn {
            padding: 6px 14px; border-radius: 6px; font-size: 0.74rem; font-weight: 500;
            text-decoration: none; cursor: pointer; font-family: inherit;
            transition: all 0.2s; letter-spacing: 0.1px;
        }
        .process-btn-view { background: var(--accent); color: white; border: none; }
        .process-btn-view:hover { background: #2d7a8f; }
        .process-btn-edit { background: transparent; color: var(--accent); border: 1.5px solid var(--border); }
        .process-btn-edit:hover { background: var(--accent); color: white; border-color: var(--accent); }

        /* Quick access */
        .quick-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 28px; }
        .quick-tile {
            background: var(--white); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 22px 18px; text-align: center;
            text-decoration: none; color: var(--text); transition: all 0.25s; display: block;
            position: relative; overflow: hidden;
        }
        .quick-tile:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); border-color: var(--accent); }
        .quick-tile-icon {
            width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center;
            justify-content: center; margin: 0 auto 10px; font-size: 1.2rem;
        }
        .quick-tile-icon.ic-diag { background: linear-gradient(135deg, #eff6ff, #dbeafe); color: #2563eb; }
        .quick-tile-icon.ic-trends { background: linear-gradient(135deg, #f0fdf4, #dcfce7); color: var(--green); }
        .quick-tile-icon.ic-monitor { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #b45309; }
        .quick-tile h3 { font-family: 'Work Sans', sans-serif; font-size: 0.86rem; font-weight: 600; margin-bottom: 3px; }
        .quick-tile p { font-size: 0.72rem; color: var(--text-light); line-height: 1.4; }

        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-light); font-size: 0.88rem; line-height: 1.6; }
        .empty-state a { color: var(--accent); text-decoration: none; font-weight: 500; }
        .empty-state a:hover { text-decoration: underline; }
        .empty-state-icon { width: 56px; height: 56px; border-radius: 16px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; margin: 0 auto 14px; color: var(--text-light); }

        /* Spinner (portal uses 36px variant) */
        .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.45,0.05,0.55,0.95) infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .retry-btn { margin-top: 14px; padding: 8px 22px; background: var(--accent); color: white; border: none; border-radius: 6px; font-family: inherit; font-size: 0.82rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .retry-btn:hover { background: #2d7a8f; transform: translateY(-1px); }
        .fade-in { animation: fadeIn 0.35s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
        /* Skeleton shimmer for loading states */
        .skeleton { position: relative; overflow: hidden; background: #e8ecf0; border-radius: var(--radius-sm); }
        .skeleton::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.5) 50%, transparent 100%);
            animation: shimmer 1.5s ease-in-out infinite;
        }
        @keyframes shimmer { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
        .skeleton .metric-val, .skeleton .metric-lbl { color: transparent !important; }
        .skeleton-val { display: inline-block; width: 56px; height: 28px; background: #e8ecf0; border-radius: 6px; margin-bottom: 4px; }
        .skeleton-ring { width: 88px; height: 88px; border-radius: 50%; background: #e8ecf0; margin: 0 auto 6px; }

        /* Refreshing overlay for tab content */
        .refreshing-overlay { position: relative; min-height: 60px; }
        .refreshing-overlay::before {
            content: ''; position: absolute; inset: 0; background: rgba(248,250,251,0.8);
            display: flex; align-items: center; justify-content: center; z-index: 5;
            border-radius: var(--radius-md);
        }
        .refreshing-overlay::after {
            content: 'Refreshing...'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 6;
            font-size: 0.84rem; color: var(--text-light); font-weight: 500;
        }

        /* Trends tab — delta banner */
        .delta-banner { background: linear-gradient(135deg, #f0fdf4, #f0f9ff); border: 1px solid #bbf7d0; border-radius: var(--radius-md); padding: 20px 24px; margin-bottom: 24px; text-align: center; }
        .delta-banner.negative { background: linear-gradient(135deg, #fffbeb, #fef2f2); border-color: #fde68a; }
        .delta-banner h3 { font-family: 'Cormorant Garamond', serif; font-size: 1.15rem; font-weight: 700; color: var(--text); margin-bottom: 4px; line-height: 1.4; }
        .delta-banner p { font-size: 0.82rem; color: var(--text-mid); }

        /* Trends — metric grid */
        .trends-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 14px; margin-bottom: 28px; }
        .trends-metric { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; text-align: center; transition: all 0.2s; }
        .trends-metric:hover { box-shadow: var(--shadow); }
        .trends-metric-val { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 3px; }
        .trends-metric-val.blue { color: #1e40af; } .trends-metric-val.green { color: var(--green); }
        .trends-metric-val.purple { color: var(--purple); } .trends-metric-val.amber { color: var(--amber); }
        .trends-metric-lbl { font-size: 0.68rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.6px; font-weight: 500; }
        .metric-delta { display: inline-flex; align-items: center; gap: 3px; font-size: 0.7rem; font-weight: 600; margin-top: 6px; padding: 2px 10px; border-radius: 100px; }
        .metric-delta.up { background: #f0fdf4; color: var(--green); }
        .metric-delta.down { background: #fef2f2; color: var(--red); }

        /* Trends — comparison table */
        .trends-section-title { font-size: 0.92rem; font-weight: 600; color: var(--primary); margin-bottom: 14px; padding-bottom: 8px; border-bottom: 1.5px solid var(--border); display: flex; align-items: center; gap: 8px; }
        .trends-section-title svg { width: 18px; height: 18px; color: var(--accent); flex-shrink: 0; }
        .comp-table { width: 100%; border-collapse: collapse; margin-bottom: 28px; font-size: 0.84rem; }
        .comp-table th { text-align: left; padding: 10px 12px; background: #f8fafc; color: var(--text-light); font-size: 0.68rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; border-bottom: 1.5px solid var(--border); }
        .comp-table td { padding: 11px 12px; border-bottom: 1px solid #f1f5f9; }
        .comp-table tr:last-child td { border-bottom: none; }
        .comp-table tr:hover td { background: #fafbfc; }
        .latest-tag { display: inline-block; font-size: 0.58rem; font-weight: 600; padding: 2px 6px; border-radius: 100px; background: var(--accent); color: white; margin-left: 6px; vertical-align: middle; }

        /* Trends — timeline */
        .timeline { position: relative; padding-left: 28px; margin-bottom: 24px; }
        .timeline::before { content: ''; position: absolute; left: 8px; top: 6px; bottom: 6px; width: 2px; background: linear-gradient(180deg, var(--accent), var(--border)); border-radius: 1px; }
        .timeline-item { position: relative; margin-bottom: 22px; cursor: pointer; transition: all 0.2s; padding: 10px 14px; border-radius: var(--radius-sm); margin-left: 4px; }
        .timeline-item:hover { background: #f8fafc; }
        .timeline-item:last-child { margin-bottom: 0; }
        .timeline-dot { position: absolute; left: -24px; top: 14px; width: 12px; height: 12px; border-radius: 50%; background: var(--accent); border: 2.5px solid var(--white); box-shadow: 0 0 0 2px var(--accent); }
        .timeline-item:not(:first-child) .timeline-dot { background: #cbd5e1; box-shadow: 0 0 0 2px #cbd5e1; }
        .timeline-date { font-size: 0.74rem; color: var(--text-light); font-weight: 500; margin-bottom: 3px; }
        .timeline-title { font-size: 0.86rem; font-weight: 600; color: var(--text); margin-bottom: 4px; }
        .timeline-metrics-row { display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.76rem; color: var(--text-mid); }
        .timeline-metrics-row span { display: inline-flex; align-items: center; gap: 3px; }

        /* Trends CTA */
        .trends-cta { background: linear-gradient(135deg, #eff6ff, #f0fdf4); border: 1px solid #e0f2fe; border-radius: var(--radius-md); padding: 28px; text-align: center; margin-top: 12px; }
        .trends-cta h3 { font-size: 1.05rem; margin-bottom: 6px; color: var(--text); font-weight: 600; }
        .trends-cta p { font-size: 0.84rem; color: var(--text-mid); margin-bottom: 18px; }
        .trends-cta-btn { display: inline-block; padding: 11px 28px; background: linear-gradient(135deg, var(--accent), var(--primary)); color: white; text-decoration: none; border-radius: 8px; font-weight: 500; font-size: 0.88rem; transition: all 0.25s; box-shadow: 0 2px 8px rgba(61,142,166,0.2); }
        .trends-cta-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(61,142,166,0.3); }

        /* Chart containers */
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 28px; }
        .chart-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; }
        .chart-card-title { font-size: 0.78rem; font-weight: 600; color: var(--primary); margin-bottom: 14px; text-transform: uppercase; letter-spacing: 0.4px; }
        .chart-legend { display: flex; gap: 14px; flex-wrap: wrap; justify-content: center; margin-top: 12px; }
        .chart-legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; color: var(--text-mid); }
        .chart-legend-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }

        /* Redesign modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.45); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: var(--white); border-radius: var(--radius-lg); max-width: 740px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 24px 80px rgba(0,0,0,0.15), 0 4px 16px rgba(0,0,0,0.08); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 22px 26px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--white); z-index: 1; border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
        .modal-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 1.35rem; font-weight: 700; color: var(--primary); }
        .modal-close { background: #f1f5f9; border: none; width: 32px; height: 32px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; color: var(--text-light); display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .modal-close:hover { background: #e2e8f0; color: var(--text); }
        .modal-body { padding: 26px; }
        .modal-body h3 { font-size: 0.92rem; font-weight: 600; color: var(--primary); margin: 24px 0 10px; display: flex; align-items: center; gap: 8px; }
        .modal-body h3:first-child { margin-top: 0; }
        .modal-body p, .modal-body li { font-size: 0.86rem; color: var(--text-mid); line-height: 1.7; font-weight: 300; }
        .modal-body ul { padding-left: 20px; margin-bottom: 12px; }
        .modal-body li { margin-bottom: 4px; }
        .modal-actions { padding: 18px 26px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; background: #fafbfc; border-radius: 0 0 var(--radius-lg) var(--radius-lg); }
        .modal-actions button { padding: 9px 22px; border-radius: 8px; font-family: inherit; font-size: 0.82rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .modal-actions button:hover { transform: translateY(-1px); }

        /* Redesign: optimised flow */
        .rd-flow { padding: 0; margin: 0 0 16px; list-style: none; }
        .rd-step { display: flex; align-items: flex-start; gap: 10px; padding: 10px 14px; border-left: 3px solid var(--accent); margin-bottom: 2px; background: var(--white); transition: background 0.15s; position: relative; }
        .rd-step:hover { background: #f8fafb; }
        .rd-step.removed { border-left-color: var(--red); background: #fef2f2; opacity: 0.65; }
        .rd-step.removed .rd-step-name { text-decoration: line-through; }
        .rd-step.new { border-left-color: var(--green); background: #f0fdf4; }
        .rd-step.changed { border-left-color: var(--amber); background: #fffbeb; }
        .rd-step.automated { border-left-color: #7c3aed; }
        .rd-step-num { width: 24px; height: 24px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.68rem; font-weight: 700; flex-shrink: 0; }
        .rd-step.removed .rd-step-num { background: var(--red); }
        .rd-step.new .rd-step-num { background: var(--green); }
        .rd-step.changed .rd-step-num { background: var(--amber); }
        .rd-step.automated .rd-step-num { background: #7c3aed; }
        .rd-step-body { flex: 1; min-width: 0; }
        .rd-step-name { font-size: 0.85rem; font-weight: 500; color: var(--text); }
        .rd-step-meta { font-size: 0.72rem; color: var(--text-light); margin-top: 1px; }
        .rd-step-note { font-size: 0.75rem; color: var(--text-mid); margin-top: 3px; font-style: italic; }
        .rd-step-tag { font-size: 0.6rem; font-weight: 700; padding: 2px 6px; border-radius: 3px; letter-spacing: 0.3px; flex-shrink: 0; align-self: center; }
        .rd-arrow { text-align: center; color: var(--border); font-size: 0.7rem; padding: 1px 0; margin-left: 38px; }

        /* Redesign: changelog */
        .rd-change { padding: 10px 14px; border-radius: var(--radius-sm); margin-bottom: 8px; border-left: 4px solid var(--border); background: #f8fafb; }
        .rd-change-type { font-size: 0.62rem; font-weight: 700; padding: 2px 7px; border-radius: 3px; letter-spacing: 0.4px; text-transform: uppercase; display: inline-block; margin-bottom: 4px; }
        .rd-change-type.removed { background: #fef2f2; color: var(--red); }
        .rd-change-type.merged { background: #fef9c3; color: #854d0e; }
        .rd-change-type.automated { background: #f5f0ff; color: #7c3aed; }
        .rd-change-type.simplified { background: #eff6ff; color: #1e40af; }
        .rd-change-type.added { background: #f0fdf4; color: var(--green); }
        .rd-change-type.reordered { background: #fdf4ff; color: #a21caf; }
        .rd-change-before { font-size: 0.82rem; color: var(--text-light); text-decoration: line-through; }
        .rd-change-after { font-size: 0.82rem; color: var(--text); font-weight: 500; }
        .rd-change-why { font-size: 0.78rem; color: var(--text-mid); margin-top: 3px; }

        /* Redesign: efficiency gains */
        .rd-gain { display: flex; gap: 10px; align-items: flex-start; padding: 10px 14px; border-radius: var(--radius-sm); margin-bottom: 6px; background: #f8fafb; border: 1px solid var(--border); }
        .rd-gain-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; flex-shrink: 0; }
        .rd-gain-icon.high { background: #f0fdf4; color: var(--green); }
        .rd-gain-icon.medium { background: #eff6ff; color: #1e40af; }
        .rd-gain-icon.low { background: #f1f5f9; color: var(--text-mid); }
        .rd-gain-body { flex: 1; }
        .rd-gain-area { font-size: 0.82rem; font-weight: 600; color: var(--text); }
        .rd-gain-desc { font-size: 0.78rem; color: var(--text-mid); margin-top: 1px; }
        .rd-gain-mag { font-size: 0.6rem; font-weight: 700; padding: 2px 6px; border-radius: 3px; flex-shrink: 0; align-self: center; }
        .rd-gain-mag.high { background: #f0fdf4; color: var(--green); }
        .rd-gain-mag.medium { background: #eff6ff; color: #1e40af; }
        .rd-gain-mag.low { background: #f1f5f9; color: var(--text-light); }

        /* Redesign: process name header */
        .rd-process-name { font-size: 0.88rem; font-weight: 600; color: var(--primary); padding: 8px 0 6px; margin-top: 12px; border-bottom: 1px solid var(--border); margin-bottom: 8px; }
        .rd-process-name:first-child { margin-top: 0; }

        /* Redesign button */
        .process-btn-redesign { background: #f5f0ff; color: var(--purple); border: 1.5px solid #ddd6fe; }
        .process-btn-redesign:hover { background: var(--purple); color: white; border-color: var(--purple); }

        .footer { padding: 32px 24px; font-size: 0.76rem; border-top: 1px solid var(--border); margin-top: auto; font-weight: 500; }

        @media (max-width: 600px) {
            .header { flex-direction: column; gap: 10px; text-align: center; padding: 16px 20px; }
            .header-left { flex-direction: column; gap: 4px; }
            .header-divider { display: none; }
            .portal-wrap { padding: 20px 16px 40px; }
            .metrics-row { grid-template-columns: 1fr; gap: 10px; }
            .quick-grid { grid-template-columns: 1fr; gap: 10px; }
            .portal-tabs { overflow-x: auto; gap: 0; }
            .portal-tab { padding: 10px 16px; font-size: 0.82rem; white-space: nowrap; }
            .process-row { flex-wrap: wrap; gap: 8px; padding: 14px 16px; }
            .process-actions { width: 100%; justify-content: flex-end; }
            .trends-metrics { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .chart-row { grid-template-columns: 1fr; }
            .comp-table { font-size: 0.76rem; }
            .comp-table th, .comp-table td { padding: 7px 6px; }
            .modal-overlay { padding: 8px; }
            .modal-card { max-height: 92vh; }
            .modal-header { padding: 16px 18px; }
            .modal-body { padding: 18px; }
            .modal-actions { padding: 14px 18px; }
            .auth-card { margin: 24px auto; padding: 28px 24px 24px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="/" class="header-logo">Workflow<span>.</span></a>
            <div class="header-divider"></div>
            <span class="header-title">Client Portal</span>
        </div>
        <div class="header-right" id="headerNav" style="display: none;">
            <span class="header-email" id="userEmail"></span>
            <button class="header-btn" onclick="signOut()">Sign Out</button>
        </div>
    </div>

    <div class="portal-wrap">
        <!-- Auth Card -->
        <div id="authCard">
            <div class="auth-card">
                <div id="loginForm">
                    <h2>Sign In</h2>
                    <p class="auth-subtitle">Access your diagnostic reports and track implementation progress.</p>
                    <div class="auth-error" id="authError"></div>
                    <input type="email" class="auth-input" id="authEmail" placeholder="Email address" autofocus>
                    <div class="pw-wrap">
                        <input type="password" class="auth-input" id="authPassword" placeholder="Password">
                        <button type="button" class="pw-toggle" onclick="togglePw(this)" aria-label="Show password"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg></button>
                    </div>
                    <button class="auth-btn" id="authBtn" onclick="signIn()">Sign In</button>
                    <div style="text-align:center;margin-bottom:12px;">
                        <a onclick="showForgotPassword()" style="font-size:0.82rem;color:var(--accent);cursor:pointer;text-decoration:none;">Forgot password?</a>
                    </div>
                    <div class="auth-toggle">
                        Don't have an account? <a onclick="toggleAuthMode()">Sign up</a>
                    </div>
                </div>
                <div id="signupForm" style="display: none;">
                    <h2>Create Account</h2>
                    <p class="auth-subtitle">Sign up to access your portal. Use the same email from your diagnostic.</p>
                    <div class="auth-error" id="signupError"></div>
                    <input type="email" class="auth-input" id="signupEmail" placeholder="Email address">
                    <div class="pw-wrap">
                        <input type="password" class="auth-input" id="signupPassword" placeholder="Password (min 6 characters)">
                        <button type="button" class="pw-toggle" onclick="togglePw(this)" aria-label="Show password"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg></button>
                    </div>
                    <button class="auth-btn" id="signupBtn" onclick="signUp()">Create Account</button>
                    <div class="auth-toggle">
                        Already have an account? <a onclick="toggleAuthMode()">Sign in</a>
                    </div>
                </div>
                <div id="forgotForm" style="display: none;">
                    <h2>Reset Password</h2>
                    <p class="auth-subtitle">Enter your email and we'll send you a link to reset your password.</p>
                    <div class="auth-error" id="forgotError"></div>
                    <div class="auth-success" id="forgotSuccess"></div>
                    <input type="email" class="auth-input" id="forgotEmail" placeholder="Email address">
                    <button class="auth-btn" id="forgotBtn" onclick="sendResetEmail()">Send Reset Link</button>
                    <div class="auth-toggle">
                        <a onclick="showLoginForm()" style="cursor:pointer;">Back to sign in</a>
                    </div>
                </div>
                <div id="updatePasswordForm" style="display: none;">
                    <h2>Set New Password</h2>
                    <p class="auth-subtitle">Choose a new password for your account.</p>
                    <div class="auth-error" id="updateError"></div>
                    <div class="auth-success" id="updateSuccess"></div>
                    <div class="pw-wrap">
                        <input type="password" class="auth-input" id="newPassword" placeholder="New password (min 6 characters)">
                        <button type="button" class="pw-toggle" onclick="togglePw(this)" aria-label="Show password"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg></button>
                    </div>
                    <div class="pw-wrap">
                        <input type="password" class="auth-input" id="confirmPassword" placeholder="Confirm new password">
                        <button type="button" class="pw-toggle" onclick="togglePw(this)" aria-label="Show password"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg></button>
                    </div>
                    <button class="auth-btn" id="updateBtn" onclick="updatePassword()">Update Password</button>
                </div>
            </div>
        </div>

        <!-- Portal Content -->
        <div id="portalContent" style="display: none;">
            <div class="portal-tabs" role="tablist">
                <button class="portal-tab active" role="tab" aria-selected="true" aria-controls="tabOverview" id="tab-overview" onclick="switchTab('overview')">Overview</button>
                <button class="portal-tab" role="tab" aria-selected="false" aria-controls="tabReports" id="tab-reports" onclick="switchTab('reports')">Reports</button>
                <button class="portal-tab" role="tab" aria-selected="false" aria-controls="tabTrends" id="tab-trends" onclick="switchTab('trends')">Trends</button>
            </div>

            <!-- Overview tab -->
            <div id="tabOverview" role="tabpanel" aria-labelledby="tab-overview">
                <!-- Metrics -->
                <div class="metrics-row" id="metricsRow">
                    <div class="metric-card skeleton"><span class="metric-val" id="metricProcesses"><span class="skeleton-val"></span></span><span class="metric-lbl">Processes Analysed</span></div>
                    <div class="metric-card skeleton">
                        <div id="automationRing" style="margin: 0 auto 6px;"><div class="skeleton-ring"></div></div>
                        <span class="metric-lbl">Automation Readiness</span>
                    </div>
                    <div class="metric-card skeleton"><span class="metric-val" id="metricReports"><span class="skeleton-val"></span></span><span class="metric-lbl">Reports</span></div>
                </div>

                <!-- Quick access -->
                <div class="quick-grid">
                    <a href="/diagnostic" class="quick-tile">
                        <div class="quick-tile-icon ic-diag"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg></div>
                        <h3>New Diagnostic</h3>
                        <p>Analyse a new process</p>
                    </a>
                    <a href="#" class="quick-tile" onclick="event.preventDefault(); switchTab('trends');">
                        <div class="quick-tile-icon ic-trends"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 16l4-4 4 4 5-6"/></svg></div>
                        <h3>Trends</h3>
                        <p>Track progress over time</p>
                    </a>
                    <a id="monitorTile" href="/monitor" class="quick-tile">
                        <div class="quick-tile-icon ic-monitor"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div>
                        <h3>Process Monitor</h3>
                        <p>Track live instances</p>
                    </a>
                </div>

                <!-- Recent reports preview -->
                <div class="dash-card" id="reportsCard">
                    <div class="dash-card-header">
                        <span class="dash-card-title">Your Diagnostic Reports</span>
                        <a href="/diagnostic" class="dash-card-action">+ New Diagnostic</a>
                    </div>
                    <div id="reportList">
                        <div class="loading-state"><div class="spinner"></div><p>Loading your reports...</p></div>
                    </div>
                </div>
            </div>

            <!-- Reports tab -->
            <div id="tabReports" role="tabpanel" aria-labelledby="tab-reports" style="display: none;">
                <div class="metrics-row" id="metricsRowReports">
                    <div class="metric-card skeleton"><span class="metric-val" id="metricReportsTotal"><span class="skeleton-val"></span></span><span class="metric-lbl">Total Reports</span></div>
                    <div class="metric-card skeleton">
                        <div id="statusDonut" style="margin: 0 auto 6px;"><div class="skeleton-ring"></div></div>
                        <span class="metric-lbl">Status Breakdown</span>
                    </div>
                    <div class="metric-card skeleton"><span class="metric-val" id="metricNeedsReview"><span class="skeleton-val"></span></span><span class="metric-lbl">Needs Review</span></div>
                </div>
                <div class="dash-card">
                    <div class="dash-card-header">
                        <span class="dash-card-title">All Diagnostic Reports</span>
                        <a href="/diagnostic" class="dash-card-action">+ New Diagnostic</a>
                    </div>
                    <div id="reportListFull">
                        <div class="loading-state"><div class="spinner"></div><p>Loading your reports...</p></div>
                    </div>
                </div>
            </div>

            <!-- Trends tab -->
            <div id="tabTrends" role="tabpanel" aria-labelledby="tab-trends" style="display: none;">
                <div id="trendsLoading" class="loading-state" style="padding: 60px 20px;">
                    <div class="spinner"></div>
                    <p>Loading your diagnostic trends...</p>
                </div>
                <div id="trendsEmpty" class="empty-state" style="display: none;">
                    You need at least one diagnostic to view trends. <a href="/diagnostic">Start your first diagnostic</a>
                </div>
                <div id="trendsContent" style="display: none;" class="fade-in">
                    <div class="dash-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <div><strong id="trendsName" style="display:block; font-size:1.05rem;"></strong><span id="trendsCompany" style="font-size:0.82rem; color:var(--text-light);"></span></div>
                        <span id="trendsCount" style="display:inline-flex; align-items:center; gap:6px; padding:5px 12px; border-radius:100px; font-size:0.78rem; font-weight:600; background:#f0f9ff; color:#1e40af;"></span>
                    </div>
                    <div class="delta-banner" id="trendsDelta" style="display: none;"></div>
                    <h3 class="trends-section-title">Latest Diagnostic Snapshot</h3>
                    <div class="trends-metrics" id="trendsMetrics"></div>
                    <div id="trendsCharts" class="chart-row" style="display: none;">
                        <div class="chart-card">
                            <div class="chart-card-title">Automation Readiness Over Time</div>
                            <div id="automationBarChart"></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card-title">Cost vs Savings</div>
                            <div id="costSavingsChart"></div>
                        </div>
                    </div>
                    <div id="trendsComparison" style="display: none;">
                        <h3 class="trends-section-title">Side-by-Side Comparison</h3>
                        <div style="overflow-x: auto;"><table class="comp-table" id="trendsCompTable"></table></div>
                    </div>
                    <h3 class="trends-section-title">Diagnostic Timeline</h3>
                    <div class="timeline" id="trendsTimeline"></div>
                    <div class="trends-cta">
                        <h3>Ready for your next assessment?</h3>
                        <p>Run another diagnostic to track your improvement.</p>
                        <a href="/diagnostic" class="trends-cta-btn">Start New Diagnostic</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Redesign Modal -->
    <div id="redesignModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="redesignTitle" style="display: none;" onclick="if(event.target===this)closeRedesignModal()">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="redesignTitle">Operating Model Redesign</h2>
                <button class="modal-close" aria-label="Close" onclick="closeRedesignModal()">&times;</button>
            </div>
            <div class="modal-body" id="redesignBody" aria-live="polite">
                <div class="loading-state" style="padding: 60px 20px;" aria-busy="true">
                    <div class="spinner"></div>
                    <p>Generating your operating model redesign...</p>
                    <p style="font-size: 0.78rem; opacity: 0.6; margin-top: 4px;">This may take 30–60 seconds.</p>
                </div>
            </div>
            <div class="modal-actions" id="redesignActions" style="display: none;">
                <button onclick="copyRedesign()" style="background: var(--bg); border: 1.5px solid var(--border); color: var(--text);">Copy to clipboard</button>
                <button onclick="regenerateRedesign()" style="background: var(--bg); border: 1.5px solid var(--border); color: var(--text);">Regenerate</button>
                <button onclick="closeRedesignModal()" style="background: var(--accent); border: none; color: white;">Close</button>
            </div>
        </div>
    </div>

    <div class="footer"><a href="/">Workflow Partners</a> &middot; Technology-agnostic workflow optimisation</div>

    <script>
        let sbClient = null;
        let isSignUp = false;
        let currentUser = null;
        let cachedReports = null;
        let trendsLoaded = false;

        async function initSupabase() {
            try {
                const resp = await fetch('/api/public-config');
                if (!resp.ok) throw new Error('Config not available');
                const config = await resp.json();

                if (!window.supabase || !window.supabase.createClient) {
                    console.warn('Supabase JS library not loaded from CDN');
                    return;
                }

                sbClient = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);

                sbClient.auth.onAuthStateChange(function(event, session) {
                    if (event === 'PASSWORD_RECOVERY') {
                        showUpdatePasswordForm();
                    }
                });

                const { data: { session } } = await sbClient.auth.getSession();

                const hash = window.location.hash;
                if (hash && (hash.includes('type=recovery') || hash.includes('type=signup'))) {
                    if (hash.includes('type=recovery')) {
                        showUpdatePasswordForm();
                        return;
                    }
                }

                if (session?.user) {
                    onAuthenticated(session.user);
                }
            } catch (e) {
                console.warn('Supabase init failed — portal will use email fallback.', e.message);
            }
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            document.getElementById('loginForm').style.display = isSignUp ? 'none' : '';
            document.getElementById('signupForm').style.display = isSignUp ? '' : 'none';
            document.getElementById('forgotForm').style.display = 'none';
            document.getElementById('updatePasswordForm').style.display = 'none';
        }

        function hideAllAuthForms() {
            ['loginForm', 'signupForm', 'forgotForm', 'updatePasswordForm'].forEach(function(id) {
                document.getElementById(id).style.display = 'none';
            });
        }

        function showLoginForm() {
            hideAllAuthForms();
            document.getElementById('loginForm').style.display = '';
            isSignUp = false;
        }

        function showForgotPassword() {
            hideAllAuthForms();
            document.getElementById('forgotForm').style.display = '';
            document.getElementById('forgotEmail').value = document.getElementById('authEmail').value || '';
            document.getElementById('forgotError').classList.remove('show');
            document.getElementById('forgotSuccess').classList.remove('show');
        }

        function showUpdatePasswordForm() {
            hideAllAuthForms();
            document.getElementById('authCard').style.display = '';
            document.getElementById('portalContent').style.display = 'none';
            document.getElementById('updatePasswordForm').style.display = '';
            document.getElementById('updateError').classList.remove('show');
            document.getElementById('updateSuccess').classList.remove('show');
        }

        async function sendResetEmail() {
            const email = document.getElementById('forgotEmail').value.trim();
            const btn = document.getElementById('forgotBtn');

            document.getElementById('forgotError').classList.remove('show');
            document.getElementById('forgotSuccess').classList.remove('show');

            if (!email) { showAuthError('forgotError', 'Please enter your email address.'); return; }

            if (!sbClient) {
                showAuthError('forgotError', 'Authentication service not available. Please try again later.');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const redirectUrl = window.location.origin + '/portal';
                const { error } = await sbClient.auth.resetPasswordForEmail(email, { redirectTo: redirectUrl });
                if (error) throw error;

                const successEl = document.getElementById('forgotSuccess');
                successEl.textContent = 'Password reset link sent! Check your email (including spam folder).';
                successEl.classList.add('show');
                btn.textContent = 'Link Sent';
            } catch (err) {
                showAuthError('forgotError', err.message || 'Failed to send reset email. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Send Reset Link';
            }
        }

        async function updatePassword() {
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            const btn = document.getElementById('updateBtn');

            document.getElementById('updateError').classList.remove('show');
            document.getElementById('updateSuccess').classList.remove('show');

            if (!newPass || !confirmPass) { showAuthError('updateError', 'Please fill in both fields.'); return; }
            if (newPass.length < 6) { showAuthError('updateError', 'Password must be at least 6 characters.'); return; }
            if (newPass !== confirmPass) { showAuthError('updateError', 'Passwords do not match.'); return; }

            if (!sbClient) {
                showAuthError('updateError', 'Authentication service not available.');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Updating...';

            try {
                const { error } = await sbClient.auth.updateUser({ password: newPass });
                if (error) throw error;

                const successEl = document.getElementById('updateSuccess');
                successEl.textContent = 'Password updated successfully! Redirecting...';
                successEl.classList.add('show');
                btn.textContent = 'Updated!';

                setTimeout(function() {
                    sbClient.auth.getSession().then(function(res) {
                        if (res.data.session?.user) {
                            onAuthenticated(res.data.session.user);
                        } else {
                            showLoginForm();
                        }
                    }).catch(function() {
                        showLoginForm();
                    });
                }, 1500);
            } catch (err) {
                showAuthError('updateError', err.message || 'Failed to update password. The link may have expired.');
                btn.disabled = false;
                btn.textContent = 'Update Password';
            }
        }

        function togglePw(btn) {
            const input = btn.parentElement.querySelector('input');
            const showing = input.type === 'text';
            input.type = showing ? 'password' : 'text';
            btn.setAttribute('aria-label', showing ? 'Show password' : 'Hide password');
            btn.innerHTML = showing
                ? '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>'
                : '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19M1 1l22 22"/><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"/></svg>';
        }

        function showAuthError(formId, msg) {
            const el = document.getElementById(formId);
            el.textContent = msg;
            el.classList.add('show');
        }

        async function signIn() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const btn = document.getElementById('authBtn');

            if (!email || !password) { showAuthError('authError', 'Please enter email and password.'); return; }

            btn.disabled = true;
            btn.textContent = 'Signing in...';

            try {
                if (sbClient) {
                    const { data, error } = await sbClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    currentUser = data.user;
                } else {
                    currentUser = { email };
                }
                btn.textContent = 'Welcome back!';
                setTimeout(() => onAuthenticated(currentUser), 400);
            } catch (err) {
                showAuthError('authError', err.message || 'Sign in failed.');
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }

        async function signUp() {
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const btn = document.getElementById('signupBtn');

            if (!email || !password) { showAuthError('signupError', 'Please enter email and password.'); return; }
            if (password.length < 6) { showAuthError('signupError', 'Password must be at least 6 characters.'); return; }

            btn.disabled = true;
            btn.textContent = 'Creating account...';

            try {
                if (sbClient) {
                    const { data, error } = await sbClient.auth.signUp({ email, password });
                    if (error) throw error;
                    if (data.user) {
                        currentUser = data.user;
                        btn.textContent = 'Welcome!';
                        setTimeout(() => onAuthenticated(currentUser), 400);
                    } else {
                        showAuthError('signupError', 'Check your email for a confirmation link.');
                        btn.disabled = false;
                        btn.textContent = 'Create Account';
                    }
                } else {
                    currentUser = { email };
                    btn.textContent = 'Welcome!';
                    setTimeout(() => onAuthenticated(currentUser), 400);
                }
            } catch (err) {
                showAuthError('signupError', err.message || 'Sign up failed.');
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }

        async function signOut() {
            const btn = document.querySelector('.header-btn');
            btn.textContent = 'Signing out...';
            btn.disabled = true;
            if (sbClient) await sbClient.auth.signOut();
            currentUser = null;
            cachedReports = null;
            trendsLoaded = false;
            document.getElementById('authCard').style.display = '';
            document.getElementById('portalContent').style.display = 'none';
            document.getElementById('headerNav').style.display = 'none';
            btn.textContent = 'Sign Out';
            btn.disabled = false;
        }

        function onAuthenticated(user) {
            currentUser = user;
            const email = user.email;

            document.getElementById('authCard').style.display = 'none';
            document.getElementById('portalContent').style.display = '';
            document.getElementById('headerNav').style.display = 'flex';
            document.getElementById('userEmail').textContent = email;

            document.getElementById('monitorTile').href = '/monitor?email=' + encodeURIComponent(email);

            loadReports(email);
        }

        function clearSkeletons() {
            document.querySelectorAll('.metric-card.skeleton').forEach(function(el) { el.classList.remove('skeleton'); });
            document.querySelectorAll('.skeleton-val').forEach(function(el) { el.remove(); });
        }

        function getStatusInfo(r) {
            const pct = r.metrics.automationPercentage;
            if (pct >= 70) return { dot: 'green', tag: 'optimised', tagText: 'Optimised' };
            if (pct >= 40) return { dot: 'amber', tag: 'progress', tagText: 'In progress' };
            return { dot: 'red', tag: 'review', tagText: 'Needs review' };
        }

        async function loadReports(email) {
            const list = document.getElementById('reportList');
            const listFull = document.getElementById('reportListFull');
            const spinnerHtml = '<div class="loading-state"><div class="spinner"></div><p>Loading your reports...</p></div>';
            list.innerHTML = spinnerHtml;
            listFull.innerHTML = spinnerHtml;

            let timeoutId = setTimeout(() => {
                list.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Taking longer than expected...</p><button class="retry-btn" data-retry-email>Retry</button></div>';
                listFull.innerHTML = list.innerHTML;
                document.querySelectorAll('[data-retry-email]').forEach(function(b) { b.addEventListener('click', function() { loadReports(email); }); });
            }, 15000);

            try {
                const resp = await fetch('/api/get-dashboard?email=' + encodeURIComponent(email));
                clearTimeout(timeoutId);
                const data = await resp.json();

                const emptyHtml = '<div class="empty-state">No diagnostics found yet. <a href="/diagnostic">Start your first diagnostic</a></div>';

                if (!resp.ok || !data.success || !Array.isArray(data.reports) || !data.reports.length) {
                    clearSkeletons();
                    document.getElementById('metricProcesses').textContent = '0';
                    document.getElementById('metricReports').textContent = '0';
                    document.getElementById('metricReportsTotal').textContent = '0';
                    document.getElementById('metricNeedsReview').textContent = '0';
                    renderAutomationRing('automationRing', 0);
                    renderStatusDonut('statusDonut', 0, 0, 0);
                    list.innerHTML = emptyHtml;
                    listFull.innerHTML = emptyHtml;
                    cachedReports = null;
                    return;
                }

                cachedReports = data;
                const reports = data.reports;
                const totalProcs = reports.reduce((sum, r) => sum + r.metrics.totalProcesses, 0);
                const avgAuto = Math.round(reports.reduce((sum, r) => sum + r.metrics.automationPercentage, 0) / reports.length);
                const optimisedCount = reports.filter(r => r.metrics.automationPercentage >= 70).length;
                const reviewCount = reports.filter(r => r.metrics.automationPercentage < 40).length;

                const progressCount = reports.filter(r => r.metrics.automationPercentage >= 40 && r.metrics.automationPercentage < 70).length;

                clearSkeletons();
                document.getElementById('metricProcesses').textContent = totalProcs;
                document.getElementById('metricReports').textContent = reports.length;
                document.getElementById('metricReportsTotal').textContent = reports.length;
                document.getElementById('metricNeedsReview').textContent = reviewCount;

                renderAutomationRing('automationRing', avgAuto);
                renderStatusDonut('statusDonut', optimisedCount, progressCount, reviewCount);

                const buildRows = (arr) => arr.map(r => {
                    const date = new Date(r.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    const procs = r.processes.map(p => p.name).join(', ') || 'Process Diagnostic';
                    const editUrl = '/diagnostic?edit=' + r.id + '&email=' + encodeURIComponent(email);
                    const s = getStatusInfo(r);
                    return '<div class="process-row">' +
                        '<span class="process-dot ' + s.dot + '"></span>' +
                        '<span class="process-name">' + esc(procs) + '</span>' +
                        '<span class="process-tag ' + s.tag + '">' + esc(s.tagText) + '</span>' +
                        '<span class="process-val">' + esc(date) + '</span>' +
                        '<div class="process-actions">' +
                            '<button class="process-btn process-btn-redesign" onclick="openRedesign(\'' + r.id + '\')">Redesign</button>' +
                            '<a href="' + editUrl + '" class="process-btn process-btn-edit">Edit</a>' +
                            '<a href="/diagnostic?view=' + r.id + '" class="process-btn process-btn-view">View</a>' +
                        '</div>' +
                    '</div>';
                }).join('');

                list.innerHTML = '<div class="fade-in">' + buildRows(reports) + '</div>';
                listFull.innerHTML = '<div class="fade-in">' + buildRows(reports) + '</div>';

            } catch (err) {
                clearTimeout(timeoutId);
                clearSkeletons();
                console.error(err);
                const failedHtml = '<div class="empty-state"><div class="empty-state-icon"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M12 9v4M12 17h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg></div>Failed to load reports. Please check your connection and try again.<br><button class="retry-btn" data-retry-email>Retry</button></div>';
                document.getElementById('metricProcesses').textContent = '0';
                document.getElementById('metricReports').textContent = '0';
                document.getElementById('metricReportsTotal').textContent = '0';
                document.getElementById('metricNeedsReview').textContent = '0';
                renderAutomationRing('automationRing', 0);
                renderStatusDonut('statusDonut', 0, 0, 0);
                list.innerHTML = failedHtml;
                listFull.innerHTML = failedHtml;
                document.querySelectorAll('[data-retry-email]').forEach(function(b) { b.addEventListener('click', function() { loadReports(email); }); });
                cachedReports = null;
            }
        }

        /* ── Tab switching ─────────────────────────── */
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.portal-tab');
            tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
            document.getElementById('tabOverview').style.display = 'none';
            document.getElementById('tabReports').style.display = 'none';
            document.getElementById('tabTrends').style.display = 'none';

            if (tab === 'overview') {
                tabs[0].classList.add('active'); tabs[0].setAttribute('aria-selected', 'true');
                document.getElementById('tabOverview').style.display = '';
            } else if (tab === 'reports') {
                tabs[1].classList.add('active'); tabs[1].setAttribute('aria-selected', 'true');
                const tabEl = document.getElementById('tabReports');
                tabEl.style.display = '';
                if (!cachedReports) {
                    tabEl.classList.add('refreshing-overlay');
                    let pollCount = 0;
                    const checkLoaded = setInterval(function() {
                        pollCount++;
                        if (cachedReports || !currentUser || pollCount > 50) {
                            tabEl.classList.remove('refreshing-overlay');
                            clearInterval(checkLoaded);
                        }
                    }, 300);
                }
            } else if (tab === 'trends') {
                tabs[2].classList.add('active'); tabs[2].setAttribute('aria-selected', 'true');
                document.getElementById('tabTrends').style.display = '';
                if (!trendsLoaded && cachedReports) {
                    renderTrends(cachedReports);
                } else if (!cachedReports) {
                    document.getElementById('trendsLoading').style.display = '';
                    document.getElementById('trendsEmpty').style.display = 'none';
                }
            }
        }

        /* ── Trends helpers ────────────────────────── */
        function fmtDate(d) { return new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }); }
        function fmtCur(a) { return a >= 1e6 ? '£' + (a/1e6).toFixed(1) + 'M' : a >= 1e3 ? '£' + (a/1e3).toFixed(0) + 'K' : '£' + a.toLocaleString(); }
        function deltaArrow(value, inverted) {
            if (value === 0) return '';
            const improved = inverted ? value < 0 : value > 0;
            const arrow = improved ? '&#9650;' : '&#9660;';
            const cls = improved ? 'up' : 'down';
            const abs = Math.abs(value);
            const display = abs >= 1 ? Math.round(abs) : abs.toFixed(1);
            return '<span class="metric-delta ' + cls + '">' + arrow + ' ' + display + (abs < 200 ? '%' : '') + '</span>';
        }

        function renderTrends(data) {
            trendsLoaded = true;
            const { reports, deltas, totalReports } = data;
            if (!reports || !reports.length) {
                document.getElementById('trendsLoading').style.display = 'none';
                document.getElementById('trendsEmpty').style.display = '';
                return;
            }

            const latest = reports[0];
            const m = latest.metrics;

            document.getElementById('trendsName').textContent = latest.contactName || 'Your Trends';
            document.getElementById('trendsCompany').textContent = latest.company || '';
            document.getElementById('trendsCount').textContent = totalReports + ' diagnostic' + (totalReports !== 1 ? 's' : '');

            const banner = document.getElementById('trendsDelta');
            if (deltas) {
                const autoChange = deltas.automationReadiness.change;
                const costChange = deltas.annualCost.change;
                const improved = autoChange > 0 || costChange < 0;
                const parts = [];
                if (autoChange !== 0) {
                    parts.push(autoChange > 0
                        ? 'Automation readiness improved from ' + reports[1].metrics.automationPercentage + '% to ' + m.automationPercentage + '%'
                        : 'Automation readiness changed from ' + reports[1].metrics.automationPercentage + '% to ' + m.automationPercentage + '%');
                }
                if (costChange !== 0) {
                    parts.push('Annual process cost ' + (costChange < 0 ? 'reduced' : 'increased') + ' by ' + fmtCur(Math.abs(costChange)));
                }
                banner.innerHTML = '<h3>' + (parts.length ? parts.join('. ') + '.' : 'Your latest results are in.') + '</h3><p>Compared to your diagnostic from ' + fmtDate(deltas.comparedTo) + '</p>';
                banner.className = 'delta-banner' + (improved ? '' : ' negative');
                banner.style.display = '';
            } else {
                banner.style.display = 'none';
            }

            const cards = [
                { value: fmtCur(m.totalAnnualCost), label: 'Annual Process Cost', color: 'blue', delta: deltas ? deltas.annualCost.percentChange : null, inv: true },
                { value: fmtCur(m.potentialSavings), label: 'Potential Savings', color: 'green', delta: deltas ? deltas.potentialSavings.percentChange : null, inv: false },
                { value: m.automationPercentage + '%', label: 'Automation Readiness', color: 'purple', delta: deltas ? deltas.automationReadiness.change : null, inv: false },
                { value: m.totalProcesses, label: 'Processes Analysed', color: 'amber', delta: deltas ? deltas.processCount.change : null, inv: false }
            ];
            document.getElementById('trendsMetrics').innerHTML = cards.map(c =>
                '<div class="trends-metric"><div class="trends-metric-val ' + c.color + '">' + c.value + '</div><div class="trends-metric-lbl">' + c.label + '</div>' + (c.delta !== null && c.delta !== 0 ? deltaArrow(c.delta, c.inv) : '') + '</div>'
            ).join('');

            if (reports.length >= 2) {
                const headers = ['Metric'].concat(reports.slice(0,4).map(function(r, i) { return fmtDate(r.createdAt) + (i === 0 ? ' <span class="latest-tag">Latest</span>' : ''); }));
                const rows = [
                    { label: 'Annual Process Cost', key: 'totalAnnualCost', fmt: fmtCur, inv: true },
                    { label: 'Potential Savings', key: 'potentialSavings', fmt: fmtCur, inv: false },
                    { label: 'Automation Readiness', key: 'automationPercentage', fmt: function(v){return v+'%';}, inv: false },
                    { label: 'Processes Analysed', key: 'totalProcesses', fmt: function(v){return v;}, inv: false },
                    { label: 'Data Quality', key: 'qualityScore', fmt: function(v){return v+'%';}, inv: false }
                ];
                let html = '<thead><tr>' + headers.map(function(h){return '<th>'+h+'</th>';}).join('') + '</tr></thead><tbody>';
                rows.forEach(function(row) {
                    html += '<tr><td style="font-weight:500;">' + row.label + '</td>';
                    reports.slice(0,4).forEach(function(r, i) {
                        const val = row.fmt(r.metrics[row.key]);
                        let delta = '';
                        if (i === 0 && reports.length >= 2) {
                            const diff = r.metrics[row.key] - reports[1].metrics[row.key];
                            if (diff !== 0) {
                                const imp = row.inv ? diff < 0 : diff > 0;
                                delta = ' <span style="font-size:0.72rem;color:' + (imp ? 'var(--green)' : 'var(--red)') + ';">' + (imp ? '&#9650;' : '&#9660;') + '</span>';
                            }
                        }
                        html += '<td>' + val + delta + '</td>';
                    });
                    html += '</tr>';
                });
                html += '</tbody>';
                document.getElementById('trendsCompTable').innerHTML = html;
                document.getElementById('trendsComparison').style.display = '';

                renderAutomationBarChart('automationBarChart', reports);
                renderCostSavingsChart('costSavingsChart', reports);
                document.getElementById('trendsCharts').style.display = '';
            } else {
                document.getElementById('trendsComparison').style.display = 'none';
                document.getElementById('trendsCharts').style.display = 'none';
            }

            document.getElementById('trendsTimeline').innerHTML = reports.map(function(r, i) {
                const rm = r.metrics;
                return '<div class="timeline-item" onclick="window.open(\'/report?id=' + r.id + '\',\'_blank\')">' +
                    '<div class="timeline-dot"></div>' +
                    '<div class="timeline-date">' + fmtDate(r.createdAt) + (i === 0 ? ' &mdash; Latest' : '') + '</div>' +
                    '<div class="timeline-title">' + (r.processes.map(function(p){return p.name;}).join(', ') || 'Process Diagnostic') + '</div>' +
                    '<div class="timeline-metrics-row"><span>Cost: ' + fmtCur(rm.totalAnnualCost) + '</span><span>Savings: ' + fmtCur(rm.potentialSavings) + '</span><span>Automation: ' + rm.automationPercentage + '%</span><span>' + rm.totalProcesses + ' process' + (rm.totalProcesses !== 1 ? 'es' : '') + '</span></div>' +
                '</div>';
            }).join('');

            document.getElementById('trendsLoading').style.display = 'none';
            document.getElementById('trendsContent').style.display = '';
        }

        /* ── Chart helpers ─────────────────────────── */
        function renderAutomationRing(containerId, pct) {
            const el = document.getElementById(containerId);
            if (!el) return;
            const p = Math.max(0, Math.min(100, pct || 0));
            const r = 34, cx = 44, cy = 44, sw = 7;
            const circ = 2 * Math.PI * r;
            const offset = circ - (p / 100) * circ;
            const color = p >= 70 ? '#16a34a' : p >= 40 ? '#d97706' : '#dc2626';
            el.innerHTML = '<svg width="88" height="88" viewBox="0 0 88 88">' +
                '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="#f1f5f9" stroke-width="' + sw + '"/>' +
                '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="' + color + '" stroke-width="' + sw + '" stroke-linecap="round" stroke-dasharray="' + circ + '" stroke-dashoffset="' + offset + '" transform="rotate(-90 ' + cx + ' ' + cy + ')" style="transition:stroke-dashoffset 0.8s ease;"/>' +
                '<text x="' + cx + '" y="' + (cy + 1) + '" text-anchor="middle" dominant-baseline="middle" font-family="Cormorant Garamond,serif" font-size="20" font-weight="700" fill="' + color + '">' + p + '%</text>' +
                '</svg>';
        }

        function renderStatusDonut(containerId, optimised, progress, review) {
            const el = document.getElementById(containerId);
            if (!el) return;
            const total = optimised + progress + review;
            if (total === 0) { el.innerHTML = '<div style="font-size:0.82rem;color:var(--text-light);padding:10px;">No data</div>'; return; }
            const r = 30, cx = 44, cy = 44, sw = 10;
            const circ = 2 * Math.PI * r;
            const slices = [
                { val: optimised, color: '#16a34a', label: 'Optimised' },
                { val: progress, color: '#d97706', label: 'In Progress' },
                { val: review, color: '#dc2626', label: 'Needs Review' }
            ].filter(function(s) { return s.val > 0; });
            let svg = '<svg width="88" height="88" viewBox="0 0 88 88">';
            let cumulative = 0;
            slices.forEach(function(s) {
                const pct = s.val / total;
                const dashLen = pct * circ;
                const gap = circ - dashLen;
                const rotation = -90 + (cumulative / total) * 360;
                svg += '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="' + s.color + '" stroke-width="' + sw + '" stroke-dasharray="' + dashLen + ' ' + gap + '" transform="rotate(' + rotation + ' ' + cx + ' ' + cy + ')"/>';
                cumulative += s.val;
            });
            svg += '<text x="' + cx + '" y="' + (cy + 1) + '" text-anchor="middle" dominant-baseline="middle" font-family="Cormorant Garamond,serif" font-size="18" font-weight="700" fill="#1e293b">' + total + '</text>';
            svg += '</svg>';
            let legend = '<div class="chart-legend">';
            slices.forEach(function(s) {
                legend += '<span class="chart-legend-item"><span class="chart-legend-dot" style="background:' + s.color + ';"></span>' + s.val + ' ' + s.label + '</span>';
            });
            legend += '</div>';
            el.innerHTML = svg + legend;
        }

        function renderAutomationBarChart(containerId, reports) {
            const el = document.getElementById(containerId);
            if (!el) return;
            const items = reports.slice(0, 6).reverse();
            const barW = 36, gap = 12, h = 140, padL = 30, padB = 40;
            const totalW = padL + items.length * (barW + gap) + 10;
            let svg = '<svg width="100%" height="' + (h + padB) + '" viewBox="0 0 ' + totalW + ' ' + (h + padB) + '" preserveAspectRatio="xMidYMid meet">';
            svg += '<line x1="' + padL + '" y1="' + h + '" x2="' + totalW + '" y2="' + h + '" stroke="#e2e8f0" stroke-width="1"/>';
            [0, 25, 50, 75, 100].forEach(function(tick) {
                const y = h - (tick / 100) * (h - 10);
                svg += '<text x="' + (padL - 4) + '" y="' + (y + 3) + '" text-anchor="end" font-size="9" fill="#94a3b8" font-family="Work Sans,sans-serif">' + tick + '</text>';
                if (tick > 0) svg += '<line x1="' + padL + '" y1="' + y + '" x2="' + totalW + '" y2="' + y + '" stroke="#f1f5f9" stroke-width="0.5"/>';
            });
            items.forEach(function(r, i) {
                const pct = r.metrics.automationPercentage;
                const barH = Math.max(2, (pct / 100) * (h - 10));
                const x = padL + i * (barW + gap) + gap / 2;
                const y = h - barH;
                const color = pct >= 70 ? '#16a34a' : pct >= 40 ? '#d97706' : '#dc2626';
                svg += '<rect x="' + x + '" y="' + y + '" width="' + barW + '" height="' + barH + '" rx="4" fill="' + color + '" opacity="0.85"><animate attributeName="height" from="0" to="' + barH + '" dur="0.5s" fill="freeze"/><animate attributeName="y" from="' + h + '" to="' + y + '" dur="0.5s" fill="freeze"/></rect>';
                svg += '<text x="' + (x + barW / 2) + '" y="' + (y - 5) + '" text-anchor="middle" font-size="10" font-weight="600" fill="' + color + '" font-family="Work Sans,sans-serif">' + pct + '%</text>';
                const dateStr = new Date(r.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                svg += '<text x="' + (x + barW / 2) + '" y="' + (h + 14) + '" text-anchor="middle" font-size="8" fill="#94a3b8" font-family="Work Sans,sans-serif">' + dateStr + '</text>';
            });
            svg += '</svg>';
            el.innerHTML = svg;
        }

        function renderCostSavingsChart(containerId, reports) {
            const el = document.getElementById(containerId);
            if (!el) return;
            const items = reports.slice(0, 6).reverse();
            const barW = 16, pairGap = 8, gap = 16, h = 140, padL = 38, padB = 40;
            const pairW = barW * 2 + pairGap;
            const totalW = padL + items.length * (pairW + gap) + 10;
            let maxVal = 0;
            items.forEach(function(r) { maxVal = Math.max(maxVal, r.metrics.totalAnnualCost, r.metrics.potentialSavings); });
            if (maxVal === 0) maxVal = 1;
            let svg = '<svg width="100%" height="' + (h + padB + 20) + '" viewBox="0 0 ' + totalW + ' ' + (h + padB + 20) + '" preserveAspectRatio="xMidYMid meet">';
            svg += '<line x1="' + padL + '" y1="' + h + '" x2="' + totalW + '" y2="' + h + '" stroke="#e2e8f0" stroke-width="1"/>';
            items.forEach(function(r, i) {
                const cost = r.metrics.totalAnnualCost;
                const savings = r.metrics.potentialSavings;
                const costH = Math.max(2, (cost / maxVal) * (h - 10));
                const savH = Math.max(2, (savings / maxVal) * (h - 10));
                const x = padL + i * (pairW + gap) + gap / 2;
                svg += '<rect x="' + x + '" y="' + (h - costH) + '" width="' + barW + '" height="' + costH + '" rx="3" fill="#1e40af" opacity="0.7"/>';
                svg += '<rect x="' + (x + barW + pairGap) + '" y="' + (h - savH) + '" width="' + barW + '" height="' + savH + '" rx="3" fill="#16a34a" opacity="0.7"/>';
                const dateStr = new Date(r.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                svg += '<text x="' + (x + pairW / 2) + '" y="' + (h + 14) + '" text-anchor="middle" font-size="8" fill="#94a3b8" font-family="Work Sans,sans-serif">' + dateStr + '</text>';
            });
            svg += '</svg>';
            const legend = '<div class="chart-legend"><span class="chart-legend-item"><span class="chart-legend-dot" style="background:#1e40af;"></span>Annual Cost</span><span class="chart-legend-item"><span class="chart-legend-dot" style="background:#16a34a;"></span>Potential Savings</span></div>';
            el.innerHTML = svg + legend;
        }

        /* ── Redesign helpers ─────────────────────────── */
        function esc(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
        function changeColor(type) {
            const m = { removed: 'var(--red)', merged: '#854d0e', automated: '#7c3aed', simplified: '#1e40af', added: 'var(--green)', reordered: '#a21caf' };
            return m[type] || 'var(--border)';
        }

        /* ── Redesign modal ────────────────────────── */
        let _currentRedesignReportId = null;

        async function openRedesign(reportId, regenerate) {
            _currentRedesignReportId = reportId;
            document.getElementById('redesignModal').style.display = '';
            document.getElementById('redesignActions').style.display = 'none';
            const loadMsg = regenerate ? 'Regenerating your operating model redesign...' : 'Generating your operating model redesign...';
            document.getElementById('redesignBody').innerHTML = '<div class="loading-state" style="padding:60px 20px;"><div class="spinner"></div><p>' + loadMsg + '</p><p style="font-size:0.78rem;opacity:0.6;margin-top:4px;">This may take 30\u201360 seconds.</p></div>';
            document.body.style.overflow = 'hidden';

            try {
                const payload = { email: currentUser.email, reportId: reportId };
                if (regenerate) payload.regenerate = true;
                const resp = await fetch('/api/generate-redesign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();

                if (!resp.ok || !data.success) {
                    const errMsg = data.error || 'Failed to generate redesign.';
                    let debugHtml = '';
                    if (data.debug) {
                        console.error('Redesign debug:', data.debug);
                        debugHtml = '<details style="margin-top:8px;font-size:0.72rem;color:#94a3b8;"><summary style="cursor:pointer;">Debug info</summary><pre style="white-space:pre-wrap;word-break:break-all;text-align:left;max-height:150px;overflow:auto;margin-top:6px;background:#f8fafc;padding:8px;border-radius:4px;">' + JSON.stringify(data.debug, null, 2) + '</pre></details>';
                    }
                    document.getElementById('redesignBody').innerHTML = '<div class="empty-state"><p style="color:var(--red);">' + errMsg + '</p>' + debugHtml + '<button class="retry-btn" onclick="openRedesign(\'' + reportId + '\')">Retry</button></div>';
                    return;
                }

                const r = data.redesign;
                let html = '';

                if (data.cached) {
                    html += '<div style="display:inline-block;margin-bottom:12px;padding:4px 12px;background:#f0fdf4;color:#16a34a;border-radius:6px;font-size:0.75rem;font-weight:500;">Previously generated redesign · <a href="#" onclick="regenerateRedesign();return false;" style="color:#16a34a;text-decoration:underline;">Regenerate</a></div>';
                }

                if (r.executiveSummary) {
                    html += '<h3>Executive Summary</h3><p>' + esc(r.executiveSummary) + '</p>';
                }

                if (r.optimisedProcesses && r.optimisedProcesses.length) {
                    html += '<h3>Optimised Process Flow</h3>';
                    r.optimisedProcesses.forEach(function(proc) {
                        html += '<div class="rd-process-name">' + esc(proc.processName || 'Process') + '</div>';
                        html += '<div class="rd-flow">';
                        let activeNum = 0;
                        (proc.steps || []).forEach(function(s, i) {
                            const cls = s.removed ? 'removed' : s.isNew ? 'new' : s.automated ? 'automated' : s.changed ? 'changed' : '';
                            if (!s.removed) activeNum++;
                            const displayNum = s.removed ? '✕' : activeNum;
                            html += '<div class="rd-step ' + cls + '">';
                            html += '<div class="rd-step-num">' + displayNum + '</div>';
                            html += '<div class="rd-step-body">';
                            html += '<div class="rd-step-name">' + esc(s.name) + '</div>';
                            html += '<div class="rd-step-meta">' + esc(s.department || '');
                            if (s.automated) html += ' · <span style="color:#7c3aed;font-weight:600;">Automated</span>';
                            html += '</div>';
                            if (s.note) html += '<div class="rd-step-note">' + esc(s.note) + '</div>';
                            html += '</div>';
                            const tag = s.removed ? '<span class="rd-step-tag" style="background:#fef2f2;color:var(--red);">REMOVED</span>' :
                                      s.isNew ? '<span class="rd-step-tag" style="background:#f0fdf4;color:var(--green);">NEW</span>' :
                                      s.automated ? '<span class="rd-step-tag" style="background:#f5f0ff;color:#7c3aed;">AUTO</span>' :
                                      s.changed ? '<span class="rd-step-tag" style="background:#fffbeb;color:var(--amber);">CHANGED</span>' : '';
                            html += tag;
                            html += '</div>';
                            if (i < proc.steps.length - 1 && !s.removed) html += '<div class="rd-arrow">↓</div>';
                        });
                        html += '</div>';
                    });
                    html += '<div style="text-align:center;margin:1.2rem 0 0.5rem;">';
                    html += '<button onclick="viewRedesignFlowchart()" style="background:var(--primary);color:white;border:none;padding:0.6rem 1.5rem;border-radius:8px;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s;">View Full Flowchart</button>';
                    html += '</div>';
                    window._redesignProcesses = r.optimisedProcesses;
                }

                if (r.changeLog && r.changeLog.length) {
                    html += '<h3>What Changed &amp; Why</h3>';
                    r.changeLog.forEach(function(c) {
                        const ct = (c.changeType || 'simplified').toLowerCase();
                        html += '<div class="rd-change" style="border-left-color:' + changeColor(ct) + ';">';
                        html += '<span class="rd-change-type ' + ct + '">' + ct + '</span> ';
                        html += '<strong style="font-size:0.82rem;">' + esc(c.step || c.process || '') + '</strong>';
                        if (c.before) html += '<div class="rd-change-before">' + esc(c.before) + '</div>';
                        if (c.after) html += '<div class="rd-change-after">→ ' + esc(c.after) + '</div>';
                        if (c.rationale) html += '<div class="rd-change-why">' + esc(c.rationale) + '</div>';
                        html += '</div>';
                    });
                }

                if (r.efficiencyGains && r.efficiencyGains.length) {
                    html += '<h3>Efficiency Gains</h3>';
                    const gainIcons = { time: '⏱', cost: '💰', quality: '✓', 'handoff-reduction': '🔗', 'error-reduction': '🛡', 'bottleneck-removal': '⚡' };
                    r.efficiencyGains.forEach(function(g) {
                        const mag = (g.magnitude || 'medium').toLowerCase();
                        const icon = gainIcons[g.gainType] || '📈';
                        html += '<div class="rd-gain">';
                        html += '<div class="rd-gain-icon ' + mag + '">' + icon + '</div>';
                        html += '<div class="rd-gain-body">';
                        html += '<div class="rd-gain-area">' + esc(g.area || '') + '</div>';
                        html += '<div class="rd-gain-desc">' + esc(g.description || '') + '</div>';
                        html += '</div>';
                        html += '<span class="rd-gain-mag ' + mag + '">' + mag.toUpperCase() + '</span>';
                        html += '</div>';
                    });
                }

                if (r.implementationPriority && r.implementationPriority.length) {
                    html += '<h3>Implementation Priority</h3><ol style="padding-left:20px;">';
                    r.implementationPriority.forEach(function(item) {
                        const effort = item.effort ? ' <span style="font-size:0.7rem;padding:1px 5px;border-radius:3px;background:#f1f5f9;color:var(--text-light);">' + item.effort + ' effort</span>' : '';
                        html += '<li style="margin-bottom:6px;"><strong>' + esc(item.action || 'Action') + '</strong>' + (item.impact ? ' — ' + esc(item.impact) : '') + effort + '</li>';
                    });
                    html += '</ol>';
                }

                if (!html) html = '<p>Redesign generated but the response was empty. Please try again.</p>';

                document.getElementById('redesignBody').innerHTML = '<div class="fade-in">' + html + '</div>';
                document.getElementById('redesignActions').style.display = 'flex';
            } catch (err) {
                console.error(err);
                document.getElementById('redesignBody').innerHTML = '<div class="empty-state"><p style="color:var(--red);">Connection error. Please try again.</p><button class="retry-btn" onclick="openRedesign(\'' + reportId + '\')">Retry</button></div>';
            }
        }

        function closeRedesignModal() {
            document.getElementById('redesignModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function viewRedesignFlowchart() {
            if (!window._redesignProcesses) return;
            try {
                sessionStorage.setItem('redesignProcesses', JSON.stringify(window._redesignProcesses));
                window.open('/diagnostic?render-redesign', '_blank');
            } catch (e) { console.error('Could not open flowchart viewer:', e); }
        }

        function regenerateRedesign() {
            if (_currentRedesignReportId) openRedesign(_currentRedesignReportId, true);
        }

        function copyRedesign() {
            const body = document.getElementById('redesignBody');
            const text = body.innerText || body.textContent;
            navigator.clipboard.writeText(text).then(function() {
                const btn = document.querySelector('#redesignActions button:first-child');
                btn.textContent = 'Copied!';
                setTimeout(function() { btn.textContent = 'Copy to clipboard'; }, 2000);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            initSupabase();
        });
    </script>
</body>
</html>
