<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Diagnostic | Workflow Partners</title>
    <meta name="description" content="Evidence-based process diagnostic. Analyze your workflows with real data in 12-15 minutes.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles/base.css">
    <!-- jsPDF and Supabase are lazy-loaded when first needed -->
    <!-- Flow diagram rendered with custom SVG (no external dependency) -->
    <style>
        body { line-height: 1.65; }
        :root {
            --radius-md: 14px;
            --radius-lg: 20px;
            --dark: #0c1b2e;
            --border-light: #f1f5f9;
            --success: #16a34a;
            --success-bg: rgba(22,163,74,0.06);
            --warning: #f59e0b;
            --warning-bg: #fffbeb;
            --danger: #ef4444;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.06);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.08);
        }

        h1, h2, h3, h4 {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
            line-height: 1.15;
            color: var(--dark);
        }

        /* ===== Top Bar ===== */
        .top-bar {
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226,232,240,0.6);
            position: sticky;
            top: 0;
            z-index: 200;
        }

        .top-bar-inner {
            max-width: 800px;
            margin: 0 auto;
            padding: 0.9rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar a {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }

        .top-bar-badge {
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent);
            background: rgba(61,142,166,0.08);
            padding: 4px 12px;
            border-radius: 999px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* ===== Progress Bar ===== */
        .progress-bar {
            background: white;
            padding: 1rem 0;
            margin-bottom: 1.5rem;
            position: sticky;
            top: 52px;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .progress-track {
            height: 6px;
            background: var(--bg-alt);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--primary));
            transition: width 0.4s ease;
        }

        .progress-text {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-light);
            text-align: center;
        }

        .progress-bar-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .progress-bar-row .progress-track {
            flex: 1;
        }

        .save-progress-btn {
            display: none;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.85rem;
            background: transparent;
            color: var(--accent);
            border: 1.5px solid var(--accent);
            border-radius: 100px;
            font-size: 0.78rem;
            font-family: 'Work Sans', sans-serif;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .save-progress-btn:hover {
            background: var(--accent);
            color: white;
        }

        .save-progress-btn svg {
            width: 14px;
            height: 14px;
        }

        /* ===== Save Progress Modal ===== */
        .save-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            animation: modalOverlayIn 0.2s ease;
        }

        .save-modal-overlay.show {
            display: flex;
        }

        @keyframes modalOverlayIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .save-modal {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem 2.25rem;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            animation: modalSlideIn 0.25s ease;
            position: relative;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .save-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.4rem;
            color: var(--text-light);
            cursor: pointer;
            line-height: 1;
            padding: 0.2rem;
        }

        .save-modal-close:hover {
            color: var(--text);
        }

        .save-modal h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 0.5rem;
        }

        .save-modal p {
            font-size: 0.9rem;
            color: var(--text-light);
            margin: 0 0 1.25rem;
            line-height: 1.5;
        }

        .save-modal-input {
            width: 100%;
            padding: 0.8rem 1rem;
            font-size: 0.95rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'Work Sans', sans-serif;
            margin-bottom: 0.75rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .save-modal-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .save-modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .save-modal-actions .button {
            flex: 1;
            text-align: center;
        }

        .save-modal-link-box {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-alt);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .save-modal-link-box.show {
            display: block;
        }

        .save-modal-link-box label {
            display: block;
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 0.4rem;
        }

        .save-modal-link-row {
            display: flex;
            gap: 0.5rem;
        }

        .save-modal-link-row input {
            flex: 1;
            padding: 0.6rem 0.75rem;
            font-size: 0.85rem;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'Work Sans', sans-serif;
            background: white;
            color: var(--text);
        }

        .save-modal-link-row button {
            padding: 0.6rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-family: 'Work Sans', sans-serif;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .save-modal-link-row button:hover {
            background: var(--accent-dark, #2d7a90);
        }

        /* Team process selection grid inside modal */
        .team-process-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .team-process-chip {
            padding: 0.45rem 0.9rem;
            border: 1.5px solid var(--border);
            border-radius: 100px;
            font-size: 0.82rem;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            color: var(--text);
            user-select: none;
        }

        .team-process-chip:hover {
            border-color: var(--accent);
            background: #f0fafb;
        }

        .team-process-chip.selected {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }

        .save-modal-success {
            display: none;
            text-align: center;
            padding: 1rem 0;
        }

        .save-modal-success.show {
            display: block;
        }

        .save-modal-success .checkmark {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .save-modal-success h4 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 0.4rem;
        }

        .save-modal-success p {
            font-size: 0.88rem;
            margin: 0;
        }

        /* Resume banner (shown when restoring from link) */
        .resume-banner {
            display: none;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            text-align: center;
            animation: fadeIn 0.4s ease;
        }

        .resume-banner.show {
            display: block;
        }

        .resume-banner strong {
            font-weight: 600;
        }

        /* Edit mode banner */
        .edit-banner {
            display: none;
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            padding: 0.85rem 1.25rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            text-align: center;
            animation: fadeIn 0.4s ease;
        }

        .edit-banner.show { display: block; }
        .edit-banner strong { font-weight: 600; }

        .edit-banner .edit-banner-actions {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .edit-banner .edit-banner-actions button {
            padding: 0.4rem 1rem;
            border-radius: 999px;
            font-size: 0.82rem;
            font-family: 'Work Sans', sans-serif;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.15);
            color: white;
            transition: background 0.2s;
        }

        .edit-banner .edit-banner-actions button:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Auth gate overlay for edit mode */
        .auth-gate {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .auth-gate.show { display: flex; }

        .auth-gate-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
        }

        .auth-gate-card h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .auth-gate-card p {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .auth-gate-card .auth-gate-btn {
            display: inline-block;
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            color: white;
            text-decoration: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.92rem;
            transition: opacity 0.2s;
        }

        .auth-gate-card .auth-gate-btn:hover { opacity: 0.9; }

        /* ===== Screens ===== */
        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            box-shadow: var(--shadow-md);
        }

        .screen-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .screen-subtitle {
            font-size: 1.05rem;
            color: var(--text-mid);
            margin-bottom: 2rem;
        }

        /* ===== Welcome ===== */
        .welcome-hero {
            text-align: center;
            padding: 2rem 0;
        }

        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .checklist {
            background: var(--bg-alt);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            margin: 2rem 0;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            font-size: 0.98rem;
        }

        .checklist-icon {
            color: var(--success);
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        /* ===== Process Grid ===== */
        .process-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .process-card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .process-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .process-card.selected {
            border-color: var(--accent);
            background: rgba(61, 142, 166, 0.05);
        }

        .process-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .process-name {
            font-weight: 600;
            color: var(--primary);
        }

        /* ===== Form Elements ===== */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="datetime-local"],
        textarea,
        select {
            width: 100%;
            padding: 0.9rem;
            font-size: 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'Work Sans', sans-serif;
            transition: border-color 0.2s;
            background: white;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(61, 142, 166, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .helper-text {
            font-size: 0.88rem;
            color: var(--text-light);
            margin-top: 0.4rem;
            font-style: italic;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* ===== Radio & Checkbox ===== */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--bg-alt);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-option:hover {
            background: white;
            border-color: var(--accent);
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .radio-option.selected {
            background: white;
            border-color: var(--accent);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-alt);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        .checkbox-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            cursor: pointer;
            accent-color: var(--accent);
        }

        /* ===== Custom Department Tags ===== */
        .custom-dept-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .custom-dept-tags:empty {
            display: none;
        }

        .custom-dept-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--accent);
            color: white;
            padding: 0.4rem 0.65rem 0.4rem 0.8rem;
            border-radius: 100px;
            font-size: 0.85rem;
            font-family: 'Work Sans', sans-serif;
            font-weight: 500;
            animation: tagIn 0.2s ease;
        }

        @keyframes tagIn {
            from { opacity: 0; transform: scale(0.85); }
            to { opacity: 1; transform: scale(1); }
        }

        .custom-dept-tag button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.75rem;
            line-height: 1;
            padding: 0;
            transition: background 0.15s;
        }

        .custom-dept-tag button:hover {
            background: rgba(255,255,255,0.45);
        }

        .custom-dept-input-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }

        .custom-dept-text-input {
            flex: 1;
            padding: 0.7rem 0.9rem;
            font-size: 0.95rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'Work Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: border-color 0.2s;
        }

        .custom-dept-text-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .custom-dept-add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1.4rem;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            flex-shrink: 0;
        }

        .custom-dept-add-btn:hover {
            background: var(--accent-dark, #2d7a90);
            transform: scale(1.05);
        }

        .custom-dept-add-btn:active {
            transform: scale(0.95);
        }

        /* ===== Dynamic Lists ===== */
        .dynamic-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1rem 0;
        }

        .list-item {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            background: var(--bg-alt);
            padding: 1rem;
            border-radius: var(--radius-md);
        }

        .list-item-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            font-weight: 600;
            flex-shrink: 0;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .list-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .list-item-content input,
        .list-item-content select {
            width: 100%;
        }

        .step-dept-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .step-dept-row select {
            flex: 1;
        }
        .step-dept-row .int-ext-toggle {
            display: flex;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            flex-shrink: 0;
        }
        .int-ext-toggle label {
            padding: 0.45rem 0.7rem;
            font-size: 0.78rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: var(--white);
            color: var(--text-mid);
            transition: all 0.15s;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .int-ext-toggle label:first-child {
            border-right: 1px solid var(--border);
        }
        .int-ext-toggle input { position: absolute; opacity: 0; pointer-events: none; }
        .int-ext-toggle input:checked + span {
            font-weight: 600;
        }
        .int-ext-toggle label.active,
        .int-ext-toggle label:has(input:checked) {
            background: var(--primary);
            color: var(--white);
        }
        .step-custom-dept {
            margin-top: 0.3rem;
        }

        /* Decision / branch point */
        .step-decision-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.82rem;
            color: var(--text-mid);
        }

        .step-decision-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .step-decision-toggle label {
            cursor: pointer;
            user-select: none;
        }

        .step-branches {
            margin-top: 0.6rem;
            padding: 0.75rem;
            background: #f0fafb;
            border: 1.5px solid var(--accent);
            border-radius: var(--radius-sm);
            display: none;
        }

        .step-branches.show {
            display: block;
        }

        .step-branches-label {
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .branch-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .branch-row .branch-icon {
            font-size: 0.75rem;
            color: var(--accent);
            flex-shrink: 0;
            width: 20px;
            text-align: center;
        }

        .branch-row input {
            flex: 1;
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'Work Sans', sans-serif;
        }

        .branch-row input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .branch-row .branch-remove {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0 4px;
            line-height: 1;
        }

        .add-branch-btn {
            margin-top: 0.4rem;
            padding: 0.3rem 0.75rem;
            font-size: 0.78rem;
            background: white;
            border: 1px dashed var(--accent);
            border-radius: var(--radius-sm);
            color: var(--accent);
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-branch-btn:hover {
            background: var(--accent);
            color: white;
            border-style: solid;
        }

        .step-item-actions {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .insert-step-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: -0.25rem 0;
            position: relative;
            height: 28px;
            opacity: 0.35;
            transition: opacity 0.2s;
        }

        .insert-step-divider:hover {
            opacity: 1;
        }

        .insert-step-divider::before,
        .insert-step-divider::after {
            content: '';
            flex: 1;
            height: 1.5px;
            background: var(--accent);
            opacity: 0.4;
        }

        .insert-step-divider:hover::before,
        .insert-step-divider:hover::after {
            opacity: 0.7;
        }

        .insert-step-divider button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 1.5px solid var(--accent);
            background: white;
            color: var(--accent);
            font-size: 1.1rem;
            line-height: 1;
            cursor: pointer;
            margin: 0 0.5rem;
            padding: 0;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .insert-step-divider button:hover {
            background: var(--accent);
            color: white;
        }

        /* ── Drag handle for step reordering ── */
        .step-drag-handle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            cursor: grab;
            opacity: 0;
            transition: opacity 0.2s;
            flex-shrink: 0;
            margin-top: 0.5rem;
            color: var(--text-light);
            user-select: none;
            -webkit-user-select: none;
        }

        .step-drag-handle:active { cursor: grabbing; }

        .list-item:hover .step-drag-handle { opacity: 0.5; }

        .list-item.step-dragging {
            opacity: 0.35;
            background: rgba(56, 163, 165, 0.04);
            border: 2px dashed var(--accent);
            border-radius: var(--radius-md);
        }

        .list-item.step-drag-over-above {
            box-shadow: 0 -3px 0 0 var(--accent);
        }

        .list-item.step-drag-over-below {
            box-shadow: 0 3px 0 0 var(--accent);
        }

        .list-item[draggable="true"] input,
        .list-item[draggable="true"] select,
        .list-item[draggable="true"] textarea {
            -webkit-user-drag: none;
        }

        /* ── Contributor badge on steps ── */
        .step-contributor-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.7rem;
            color: var(--text-light);
            background: rgba(56, 163, 165, 0.07);
            padding: 0.12rem 0.45rem;
            border-radius: 10px;
            margin-top: 0.1rem;
        }

        .step-contributor-badge svg {
            width: 10px;
            height: 10px;
        }

        /* ── Handover banner on Screen 7 ── */
        .handover-banner {
            background: linear-gradient(135deg, rgba(56, 163, 165, 0.08), rgba(56, 163, 165, 0.02));
            border: 1px solid rgba(56, 163, 165, 0.2);
            border-radius: var(--radius-md);
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .handover-banner.show { display: block; }

        .handover-banner h4 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            margin: 0 0 0.35rem;
            color: var(--text);
        }

        .handover-banner p {
            font-size: 0.85rem;
            color: var(--text-mid);
            margin: 0;
            line-height: 1.5;
        }

        .handover-banner .handover-note {
            margin-top: 0.5rem;
            padding: 0.6rem 0.8rem;
            background: white;
            border-radius: var(--radius-sm);
            font-style: italic;
            font-size: 0.85rem;
            color: var(--text);
            border-left: 3px solid var(--accent);
        }

        /* ── Handover button ── */
        .handover-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.55rem 1rem;
            font-size: 0.85rem;
            background: linear-gradient(135deg, rgba(56, 163, 165, 0.08), rgba(56, 163, 165, 0.03));
            border: 1.5px solid rgba(56, 163, 165, 0.25);
            border-radius: var(--radius-sm);
            color: var(--accent);
            font-family: 'Work Sans', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .handover-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .handover-btn svg {
            width: 16px;
            height: 16px;
        }

        /* ── Handover modal ── */
        .handover-modal-form .handover-name-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .handover-modal-form .handover-name-row input {
            flex: 1;
        }

        .handover-modal-form textarea {
            width: 100%;
            min-height: 70px;
            padding: 0.7rem 0.9rem;
            font-size: 0.9rem;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'Work Sans', sans-serif;
            resize: vertical;
            margin-bottom: 0.75rem;
        }

        .handover-modal-form textarea:focus {
            border-color: var(--accent);
            outline: none;
            transform: scale(1.15);
        }

        .remove-item {
            padding: 0.4rem 0.8rem;
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
            border-radius: var(--radius-sm);
            cursor: pointer;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .remove-item:hover {
            background: var(--danger);
            color: white;
        }

        .add-item {
            padding: 0.75rem 1.5rem;
            background: var(--bg-alt);
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-mid);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.95rem;
        }

        .add-item:hover {
            background: white;
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ===== Calculated Display ===== */
        .calculated {
            background: linear-gradient(135deg, rgba(61, 142, 166, 0.1), rgba(61, 142, 166, 0.05));
            padding: 1.5rem;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--accent);
            margin: 1.5rem 0;
        }

        .calculated-label {
            font-size: 0.9rem;
            color: var(--text-mid);
            margin-bottom: 0.25rem;
        }

        .calculated-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
            font-family: 'Cormorant Garamond', serif;
        }

        .calculated-formula {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
            font-family: monospace;
        }

        .calculated.danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            border-left-color: var(--danger);
        }

        .calculated.danger .calculated-value {
            color: var(--danger);
        }

        .calculated.success {
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.1), rgba(22, 163, 74, 0.05));
            border-left-color: var(--success);
        }

        .calculated.success .calculated-value {
            color: var(--success);
        }

        /* ===== Warning & Error ===== */
        .warning-box {
            background: var(--warning-bg);
            border: 2px solid var(--warning);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin: 1rem 0;
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }

        .error-box {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin: 1rem 0;
            display: none;
        }

        .error-box.show {
            display: block;
        }

        .error-text {
            color: #721c24;
            font-weight: 500;
        }

        /* ===== Buttons ===== */
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }

        .button {
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Work Sans', sans-serif;
        }

        .button-primary {
            background: var(--accent);
            color: white;
            flex: 1;
        }

        .button-primary:hover:not(:disabled) {
            background: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .button-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-secondary {
            background: var(--bg-alt);
            color: var(--text-mid);
        }

        .button-secondary:hover {
            background: var(--border);
        }

        /* ===== Loading ===== */
        .loading-overlay {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading-overlay.show {
            display: block;
        }

        .spinner {
            border: 4px solid var(--bg-alt);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        /* ===== Diagram Controls ===== */
        .diagram-ctrl-btn {
            background: var(--bg-alt);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 0.35rem 0.65rem;
            font-size: 1rem;
            cursor: pointer;
            color: var(--text-dark);
            line-height: 1;
            transition: background 0.15s, border-color 0.15s;
        }
        .diagram-ctrl-btn:hover {
            background: var(--border);
            border-color: var(--text-mid);
        }
        .flow-mobile-hint {
            display: none;
            font-size: 0.78rem;
            color: var(--text-mid);
            padding: 8px 12px;
            background: #f0f9ff;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .flow-list-view { padding: 0; list-style: none; }
        .flow-list-item {
            display: flex; align-items: flex-start; gap: 12px; padding: 12px 16px;
            border-bottom: 1px solid var(--border); position: relative;
        }
        .flow-list-item:last-child { border-bottom: none; }
        .flow-list-num {
            width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.72rem; font-weight: 700; color: white;
            background: var(--primary, #1a5a6e);
        }
        .flow-list-num.decision { background: #d97706; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); width: 32px; height: 32px; }
        .flow-list-num.external { background: #7c3aed; }
        .flow-list-body { flex: 1; min-width: 0; }
        .flow-list-name { font-size: 0.88rem; font-weight: 500; color: var(--text-dark); margin-bottom: 2px; }
        .flow-list-dept { font-size: 0.72rem; color: var(--text-mid); }
        .flow-list-badge {
            font-size: 0.6rem; font-weight: 700; padding: 2px 6px; border-radius: 3px;
            letter-spacing: 0.3px; flex-shrink: 0; align-self: center;
        }
        .flow-list-arrow { text-align: center; color: var(--text-light); font-size: 0.75rem; padding: 2px 0; }
        .flow-list-branches { margin-top: 6px; padding-left: 4px; }
        .flow-list-branch { font-size: 0.78rem; color: var(--text-mid); padding: 2px 0; }
        .flow-list-branch::before { content: '↳ '; color: #d97706; font-weight: 600;
        }

        /* Fullscreen via native Fullscreen API */
        [id^="diagramFsWrap_"]:fullscreen,
        [id^="diagramFsWrap_"]:-webkit-full-screen {
            display: flex;
            flex-direction: column;
            background: white;
            padding: 1rem;
        }
        [id^="diagramFsWrap_"]:fullscreen .diagram-viewport,
        [id^="diagramFsWrap_"]:-webkit-full-screen .diagram-viewport {
            flex: 1;
            max-height: none !important;
            border-radius: 0;
        }

        /* ===== Results ===== */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .metric-card {
            background: var(--bg-alt);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Cormorant Garamond', serif;
        }

        .metric-label {
            font-size: 0.88rem;
            color: var(--text-mid);
            margin-top: 0.5rem;
        }

        .process-ref {
            font-weight: 600;
            color: var(--accent);
        }

        /* Handoff block */
        .handoff-block {
            background: var(--bg-alt);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--accent-light);
        }

        .handoff-header {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .handoff-arrow {
            color: var(--accent);
            font-weight: 700;
        }

        /* Approval entry */
        .approval-entry {
            background: var(--bg-alt);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--warning);
        }

        .approval-header {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Divider */
        .section-divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2rem 0;
        }

        /* Result section */
        .result-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .result-section:last-child {
            border-bottom: none;
        }

        .result-section h3 {
            font-size: 1.4rem;
            margin-bottom: 1rem;
        }

        /* Collapsible sections */
        .collapsible { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .collapsible:last-child { border-bottom: none; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; margin-bottom: 1rem; }
        .collapsible-header:hover .collapse-btn { background: linear-gradient(135deg, #5bb8d4, #3d8ea6); transform: scale(1.1); }
        .collapsible-header h3 { font-size: 1.4rem; margin: 0; }
        .collapse-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: linear-gradient(135deg, #3d8ea6, #1a2f4a); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 700; line-height: 1; flex-shrink: 0; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(61,142,166,0.3); }
        .collapsible-body { overflow: hidden; transition: max-height 0.35s ease, opacity 0.25s ease; max-height: 8000px; opacity: 1; }
        .collapsible.collapsed .collapsible-body { max-height: 0; opacity: 0; margin: 0; padding: 0; }
        .collapsible.collapsed .collapsible-header { margin-bottom: 0; }

        .result-item {
            padding: 0.75rem 0;
        }

        .result-item strong {
            color: var(--primary);
        }

        .confidence-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .confidence-high {
            background: var(--success-bg);
            color: var(--success);
        }

        .confidence-medium {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .confidence-low {
            background: #fef2f2;
            color: var(--danger);
        }

        /* ===== Responsive ===== */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .screen-card {
                padding: 1.5rem;
            }

            .screen-title {
                font-size: 1.6rem;
            }

            .process-grid {
                grid-template-columns: 1fr;
            }

            .input-group {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column-reverse;
            }

            .button-group .button {
                width: 100%;
                text-align: center;
                min-height: 48px;
            }

            .metric-grid {
                grid-template-columns: 1fr 1fr;
            }

            .calculated-value {
                font-size: 1.4rem;
            }

            .score-ring-container { flex-direction: column; align-items: center; }
            .score-breakdown { min-width: 0; width: 100%; }
            .score-bar-label { width: auto; max-width: 110px; }
            .roadmap-phases { grid-template-columns: 1fr; }
            .health-score-bar { font-size: 0.75rem !important; }
            .hs-label, .hs-grade { white-space: normal; }

            .roi-projections { grid-template-columns: 1fr !important; }

            .collapse-btn { width: 44px; height: 44px; min-width: 44px; }
            .custom-dept-tag button { width: 28px; height: 28px; min-width: 28px; font-size: 1rem; }
            .custom-dept-add-btn { width: 48px; height: 48px; min-width: 48px; }

            .progress-bar { padding: 0.75rem 1rem; }
            .progress-bar .step-text { font-size: 0.8rem; }

            .diagram-viewport { max-height: 400px !important; }
            .flow-view-toggle { flex-wrap: wrap; }
            .flow-view-toggle button { font-size: 0.72rem !important; padding: 0.35rem 0.7rem !important; }
            .diagram-controls { flex-wrap: wrap; gap: 0.35rem !important; }
            .diagram-controls .diagram-ctrl-btn { min-width: 36px; min-height: 36px; }
            .flow-mobile-hint { display: block !important; }
        }

        @media (max-width: 480px) {
            .screen-card { padding: 1.25rem; }
            .screen-title { font-size: 1.35rem; }
            .metric-grid { grid-template-columns: 1fr; }
            .button { padding: 0.85rem 1.5rem; font-size: 0.95rem; }
            .score-ring { width: 130px; height: 130px; }
        }

        /* Live Process Health Score */
        .health-score-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            background: var(--bg-alt);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            color: var(--text-mid);
            transition: all 0.4s ease;
        }
        .health-score-bar .hs-label {
            font-weight: 600;
            color: var(--text-dark);
            white-space: nowrap;
        }
        .health-score-bar .hs-track {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .health-score-bar .hs-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease, background 0.5s ease;
            width: 0;
        }
        .health-score-bar .hs-value {
            font-weight: 700;
            font-size: 0.9rem;
            min-width: 2rem;
            text-align: right;
        }
        .health-score-bar .hs-grade {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            color: white;
            white-space: nowrap;
        }

        /* AI Insight Cards */
        .ai-insight-card {
            margin: 1rem 0;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.06), rgba(99, 102, 241, 0.04));
            border: 1px solid rgba(124, 58, 237, 0.15);
            border-left: 4px solid #7c3aed;
            border-radius: var(--radius-sm);
            animation: insightFadeIn 0.5s ease;
        }
        .ai-insight-card .insight-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #7c3aed;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ai-insight-card .insight-body {
            font-size: 0.9rem;
            color: var(--text-dark);
            line-height: 1.5;
        }
        .ai-insight-card .insight-body strong {
            color: #7c3aed;
        }
        @keyframes insightFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Step Import Zone */
        .step-import-zone {
            margin-bottom: 1.5rem;
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-alt);
            transition: all 0.25s;
        }
        .step-import-zone.drag-over {
            border-color: var(--accent);
            background: rgba(61, 142, 166, 0.06);
        }
        .step-import-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }
        .step-import-tab {
            flex: 1;
            padding: 0.65rem 1rem;
            font-size: 0.82rem;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-mid);
            font-family: inherit;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        .step-import-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: rgba(61, 142, 166, 0.04);
        }
        .step-import-tab:hover:not(.active) {
            color: var(--text);
            background: rgba(0,0,0,0.02);
        }
        .step-import-body {
            padding: 1.25rem;
        }
        .step-import-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem;
            cursor: pointer;
        }
        .step-import-upload svg { opacity: 0.4; transition: opacity 0.2s; }
        .step-import-upload:hover svg { opacity: 0.7; }
        .step-import-upload p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-mid);
            text-align: center;
        }
        .step-import-upload .import-hint {
            font-size: 0.75rem;
            color: var(--text-light);
        }
        .step-import-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.8rem;
            font-size: 0.9rem;
            font-family: 'Work Sans', sans-serif;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            resize: vertical;
            transition: border-color 0.2s;
        }
        .step-import-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        .step-import-textarea::placeholder { color: var(--text-light); font-size: 0.82rem; }
        .step-import-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .step-import-btn {
            padding: 0.55rem 1.2rem;
            font-size: 0.82rem;
            font-weight: 500;
            border-radius: 100px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            border: none;
        }
        .step-import-btn-primary {
            background: var(--accent);
            color: white;
        }
        .step-import-btn-primary:hover { background: #2d7a8f; }
        .step-import-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .step-import-status {
            text-align: center;
            padding: 1.5rem;
        }
        .step-import-status .spinner { margin: 0 auto 0.75rem; }
        .step-import-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--radius-sm);
            margin-bottom: 0.75rem;
            object-fit: contain;
        }

        /* Step Suggestions */
        .step-suggestions {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(8,145,178,0.06), rgba(8,145,178,0.02));
            border: 1px solid rgba(8,145,178,0.15);
            border-left: 4px solid #0891b2;
            border-radius: var(--radius-sm);
            animation: insightFadeIn 0.4s ease;
        }
        .step-suggestions .ss-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: #0891b2;
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .step-suggestion-chip {
            display: inline-block;
            padding: 0.3rem 0.75rem;
            margin: 0.2rem 0.25rem;
            background: white;
            border: 1px solid rgba(8,145,178,0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            color: #0891b2;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .step-suggestion-chip:hover {
            background: #0891b2;
            color: white;
        }
        .step-suggestion-chip.used {
            opacity: 0.4;
            pointer-events: none;
            text-decoration: line-through;
        }


        /* Automation Readiness Score */
        .score-ring-container {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        .score-ring {
            position: relative;
            width: 160px;
            height: 160px;
            flex-shrink: 0;
        }
        .score-ring svg {
            transform: rotate(-90deg);
        }
        .score-ring-value {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .score-ring-value .number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }
        .score-ring-value .label {
            font-size: 0.75rem;
            color: var(--text-mid);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .score-breakdown {
            flex: 1;
            min-width: 200px;
        }
        .score-bar-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.65rem;
        }
        .score-bar-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .score-bar-label {
            width: 130px;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .score-bar-track {
            flex: 1;
            height: 10px;
            background: var(--bg-alt);
            border-radius: 5px;
            overflow: hidden;
        }
        .score-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.6s ease;
        }
        .score-bar-pct {
            width: 42px;
            text-align: right;
            font-size: 0.85rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* 90-Day Roadmap */
        .roadmap-phases {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .roadmap-phase {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        .roadmap-phase-header {
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
        }
        .roadmap-phase-body {
            padding: 0.75rem 1rem;
        }
        .roadmap-item {
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        .roadmap-item .badge {
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
            flex-shrink: 0;
        }
        .roadmap-savings {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed var(--border);
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* ROI Calculator */
        .roi-card {
            background: linear-gradient(135deg, #f0f9ff, #f0fdf4);
            border: 1px solid #bbf7d0;
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 2rem 0;
        }
        .roi-card h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .roi-slider-group {
            margin: 1.5rem 0;
        }
        .roi-slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.88rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .roi-slider-label .roi-pct {
            font-weight: 700;
            color: var(--accent);
        }
        .roi-slider {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            outline: none;
        }
        .roi-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px; height: 24px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .roi-slider::-moz-range-thumb {
            width: 24px; height: 24px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .roi-projections {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 1.25rem;
        }
        .roi-projection {
            text-align: center;
            padding: 16px 12px;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .roi-projection .roi-month {
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 4px;
        }
        .roi-projection .roi-amount {
            font-size: 1.4rem;
            font-weight: 700;
            color: #16a34a;
        }
        .roi-projection .roi-cumulative {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-inner">
            <a href="/">Workflow<span style="color:#b8976a">.</span></a>
            <span class="top-bar-badge">Process Diagnostic</span>
        </div>
    </div>

    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-bar-row">
                <div class="progress-track">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <button type="button" class="save-progress-btn" id="saveProgressBtn" onclick="openSaveModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Save &amp; get link
                </button>
            </div>
            <div class="progress-text" id="progressText">Getting Started</div>
        </div>

        <!-- Resume banner (shown when restoring from link) -->
        <div class="resume-banner" id="resumeBanner">
            <strong>Welcome back!</strong> Your progress has been restored.
        </div>

        <!-- Edit mode banner (shown when editing a completed diagnostic) -->
        <div class="edit-banner" id="editBanner">
            <strong>Edit Mode</strong> — You're editing a previously completed diagnostic.
            <div class="edit-banner-actions">
                <button onclick="editGoToProcess(0)">Review Processes</button>
                <button onclick="goToScreen(18)">Jump to Submit</button>
            </div>
        </div>

        <!-- Auth gate (shown when edit param present but user not logged in) -->
        <div class="auth-gate" id="authGate">
            <div class="auth-gate-card">
                <h3>Sign In Required</h3>
                <p>You need to be signed in to your portal account to edit a completed diagnostic.</p>
                <a class="auth-gate-btn" id="authGateLink" href="/portal">Sign In to Portal</a>
            </div>
        </div>

        <!-- Live Process Health Score -->
        <div class="health-score-bar" id="healthScoreBar" style="display: none;">
            <span class="hs-label">Process Health:</span>
            <div class="hs-track"><div class="hs-fill" id="hsFill"></div></div>
            <span class="hs-value" id="hsValue">?</span>
            <span class="hs-grade" id="hsGrade" style="display:none;"></span>
        </div>

        <!-- ========== SCREEN 0: WELCOME ========== -->
        <div class="screen active" id="screen0">
            <div class="screen-card">
                <div class="welcome-hero">
                    <div class="welcome-icon">&#127919;</div>
                    <h1 class="screen-title">Process Diagnostic</h1>
                    <p class="screen-subtitle">Evidence-based workflow analysis. 12-15 minutes per process.</p>
                </div>

                <div class="checklist">
                    <h3 style="margin-bottom: 1rem; color: var(--primary);">You'll need:</h3>
                    <div class="checklist-item"><span class="checklist-icon">&#10003;</span><span>Your calendar from last week</span></div>
                    <div class="checklist-item"><span class="checklist-icon">&#10003;</span><span>Access to your email</span></div>
                    <div class="checklist-item"><span class="checklist-icon">&#10003;</span><span>A recent example to reference</span></div>
                    <div class="checklist-item"><span class="checklist-icon">&#10003;</span><span>Honesty about what's actually happening</span></div>
                </div>

                <p style="text-align: center; color: var(--text-mid); margin-bottom: 2rem;">
                    We'll analyse 1-3 of your most critical processes.<br>
                    The more specific you are, the better we can help.
                </p>

                <div class="button-group" style="border-top: none; padding-top: 0;">
                    <button class="button button-primary" onclick="goToScreen(1)">Start Diagnostic &rarr;</button>
                </div>

                <div style="text-align: center; margin-top: 1rem;">
                    <button class="button button-secondary" onclick="openTeamModal()" style="font-size: 0.88rem; padding: 0.6rem 1.5rem; border-radius: 100px;">
                        &#128101; Start a Team Diagnostic
                    </button>
                    <p style="font-size: 0.78rem; color: var(--text-light); margin-top: 0.5rem;">
                        Get multiple perspectives on the same process from different team members.
                    </p>
                </div>

                <!-- DEV: Skip to results with sample data -->
                <div id="devToolbar" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px dashed var(--border); text-align: center;">
                    <p style="font-size: 0.8rem; color: var(--text-mid); margin-bottom: 0.75rem;">Developer Tools</p>
                    <button class="button" onclick="loadSampleData()" style="background: #475569; color: white; font-size: 0.85rem; padding: 0.6rem 1.5rem;">
                        Load Sample Data &amp; Skip to Results &rarr;
                    </button>
                    <button class="button" onclick="loadComplexitySample()" style="background: #dc2626; color: white; font-size: 0.85rem; padding: 0.6rem 1.5rem; margin-top: 0.5rem;">
                        Load Complexity-10 Workflow (Decision Points) &rarr;
                    </button>
                    <button class="button" onclick="loadTeamSampleToConsole()" style="background: #7c3aed; color: white; font-size: 0.85rem; padding: 0.6rem 1.5rem; margin-top: 0.5rem;">
                        Copy Team Sample JSON to Console
                    </button>
                    <button class="button" onclick="window.location.href='/team-results?sample'" style="background: #7c3aed; color: white; font-size: 0.85rem; padding: 0.6rem 1.5rem; margin-top: 0.5rem;">
                        Load Team Sample &amp; Show AI Analysis &rarr;
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 1: PROCESS SELECTION ========== -->
        <div class="screen" id="screen1">
            <div class="screen-card">
                <h2 class="screen-title">Select Your Process</h2>
                <p class="screen-subtitle">Which process causes you the most pain?</p>

                <div class="process-grid">
                    <div class="process-card" onclick="selectProcess(this, 'customer-onboarding', 'Customer Onboarding')">
                        <div class="process-icon">&#128230;</div>
                        <div class="process-name">Customer Onboarding</div>
                    </div>
                    <div class="process-card" onclick="selectProcess(this, 'sales-to-delivery', 'Sales to Delivery')">
                        <div class="process-icon">&#128176;</div>
                        <div class="process-name">Sales to Delivery</div>
                    </div>
                    <div class="process-card" onclick="selectProcess(this, 'employee-onboarding', 'Employee Onboarding')">
                        <div class="process-icon">&#128100;</div>
                        <div class="process-name">Employee Onboarding</div>
                    </div>
                    <div class="process-card" onclick="selectProcess(this, 'order-fulfillment', 'Order Fulfillment')">
                        <div class="process-icon">&#9989;</div>
                        <div class="process-name">Order Fulfillment</div>
                    </div>
                    <div class="process-card" onclick="selectProcess(this, 'invoice-to-payment', 'Invoice to Payment')">
                        <div class="process-icon">&#128179;</div>
                        <div class="process-name">Invoice to Payment</div>
                    </div>
                    <div class="process-card" onclick="selectProcess(this, 'issue-resolution', 'Issue Resolution')">
                        <div class="process-icon">&#128295;</div>
                        <div class="process-name">Issue Resolution</div>
                    </div>
                    <div class="process-card" onclick="selectProcess(this, 'approval-workflow', 'Approval Workflow')">
                        <div class="process-icon">&#128203;</div>
                        <div class="process-name">Approval Workflow</div>
                    </div>
                    <div class="process-card" onclick="selectProcess(this, 'product-launch', 'Product Launch')">
                        <div class="process-icon">&#128640;</div>
                        <div class="process-name">Product Launch</div>
                    </div>
                    <div class="process-card" onclick="selectProcess(this, 'reporting-cycle', 'Reporting Cycle')">
                        <div class="process-icon">&#128202;</div>
                        <div class="process-name">Reporting Cycle</div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 2rem;">
                    <label>Or describe your own:</label>
                    <input type="text" id="customProcess" placeholder="e.g., Quote to Contract" oninput="handleCustomProcess()">
                </div>

                <div id="errorBox1" class="error-box"><div class="error-text" id="errorText1"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(0)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(1)" id="continueBtn1" disabled>Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 2: NAME YOUR PROCESS ========== -->
        <div class="screen" id="screen2">
            <div class="screen-card">
                <h2 class="screen-title">Name Your Process</h2>
                <p class="screen-subtitle">You selected: <span id="selectedProcessType2" class="process-ref"></span></p>

                <div class="form-group">
                    <label for="processNameInput">What do YOU call this process?</label>
                    <input type="text" id="processNameInput" placeholder="e.g., New customer setup">
                    <p class="helper-text">Examples: "New customer setup", "Client onboarding", "Quote-to-cash", "Account activation"</p>
                </div>

                <p style="color: var(--text-mid); font-size: 0.95rem;">This helps us ask questions in your language.</p>

                <div id="errorBox2" class="error-box"><div class="error-text" id="errorText2"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(1)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(2)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 3: DEFINE BOUNDARIES ========== -->
        <div class="screen" id="screen3">
            <div class="screen-card">
                <h2 class="screen-title">Define Process Boundaries</h2>
                <p class="screen-subtitle">Let's define "<span class="process-ref" id="processRef3">your process</span>" precisely.</p>

                <div class="form-group">
                    <label for="processStarts">This process STARTS when:</label>
                    <input type="text" id="processStarts" placeholder="e.g., Contract is signed">
                </div>

                <div class="form-group">
                    <label for="processCompletes">This process is COMPLETE when:</label>
                    <input type="text" id="processCompletes" placeholder="e.g., Customer has full access and is using the product">
                </div>

                <div class="form-group">
                    <label>How many different people or roles need to be involved?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="complexity" value="1-2"> 1–2 people (Mostly self-contained)</label>
                        <label class="radio-option"><input type="radio" name="complexity" value="3-5"> 3–5 people (Cross-functional)</label>
                        <label class="radio-option"><input type="radio" name="complexity" value="6-10"> 6–10 people (Multiple teams)</label>
                        <label class="radio-option"><input type="radio" name="complexity" value="10+"> 10+ people (Organisation-wide)</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>This process typically involves which departments?</label>
                    <div class="checkbox-group">
                        <label class="checkbox-option"><input type="checkbox" name="departments" value="Sales"> Sales</label>
                        <label class="checkbox-option"><input type="checkbox" name="departments" value="Operations"> Operations</label>
                        <label class="checkbox-option"><input type="checkbox" name="departments" value="Finance"> Finance</label>
                        <label class="checkbox-option"><input type="checkbox" name="departments" value="IT"> IT</label>
                        <label class="checkbox-option"><input type="checkbox" name="departments" value="Customer Success"> Customer Success</label>
                        <label class="checkbox-option"><input type="checkbox" name="departments" value="Product"> Product</label>
                        <label class="checkbox-option"><input type="checkbox" name="departments" value="Leadership"> Leadership</label>
                        <label class="checkbox-option"><input type="checkbox" name="departments" value="HR"> HR</label>
                        <!-- Custom departments -->
                        <div id="customDeptTags" class="custom-dept-tags"></div>
                        <div class="custom-dept-input-row">
                            <input type="text" id="customDeptInput" placeholder="Add a custom department or team..." class="custom-dept-text-input" onkeydown="if(event.key==='Enter'){event.preventDefault();addCustomDepartment();}">
                            <button type="button" class="custom-dept-add-btn" onclick="addCustomDepartment()" title="Add department">+</button>
                        </div>
                    </div>
                </div>

                <div id="errorBox3" class="error-box"><div class="error-text" id="errorText3"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(2)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(3)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 4: LAST REAL EXAMPLE ========== -->
        <div class="screen" id="screen4">
            <div class="screen-card">
                <h2 class="screen-title">Last Real Example</h2>
                <p class="screen-subtitle">Think of the LAST TIME you completed "<span class="process-ref" id="processRef4">your process</span>". This must be something that actually finished.</p>

                <div class="form-group">
                    <label for="exampleName">What was it?</label>
                    <input type="text" id="exampleName" placeholder="e.g., Onboarded Acme Corporation">
                </div>

                <div class="input-group">
                    <div class="form-group">
                        <label for="startDate">When did it START?</label>
                        <input type="date" id="startDate" onchange="calculateElapsed()">
                    </div>
                    <div class="form-group">
                        <label for="endDate">When was it officially COMPLETE?</label>
                        <input type="date" id="endDate" onchange="calculateElapsed()">
                    </div>
                </div>

                <div class="calculated">
                    <div class="calculated-label">Elapsed time:</div>
                    <div class="calculated-value" id="elapsedDays">&mdash;</div>
                </div>

                <div id="dateWarning" class="warning-box" style="display: none;">
                    <span style="font-size: 1.3rem;">&#9888;&#65039;</span>
                    <span id="dateWarningText" style="color: #856404; font-size: 0.95rem;"></span>
                </div>

                <div id="errorBox4" class="error-box"><div class="error-text" id="errorText4"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(3)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(4)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 5: TIME INVESTMENT ========== -->
        <div class="screen" id="screen5">
            <div class="screen-card">
                <h2 class="screen-title">Your Time Investment</h2>
                <p class="screen-subtitle">For this specific instance of "<span class="process-ref" id="processRef5">your process</span>":</p>
                <p id="exampleSummary" class="helper-text" style="margin-bottom: 2rem;"></p>

                <div class="form-group">
                    <label>Roughly, how many hours did YOU personally spend on this from start to finish?</label>
                    <p class="helper-text" style="margin-bottom:0.5rem;">Include meetings, emails, execution, and chasing — everything.</p>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="totalTimeRange" value="0-2" onchange="recalcTimeFromRanges()"> Under 2 hours</label>
                        <label class="radio-option"><input type="radio" name="totalTimeRange" value="2-5" onchange="recalcTimeFromRanges()"> 2–5 hours</label>
                        <label class="radio-option"><input type="radio" name="totalTimeRange" value="5-10" onchange="recalcTimeFromRanges()"> 5–10 hours</label>
                        <label class="radio-option"><input type="radio" name="totalTimeRange" value="10-20" onchange="recalcTimeFromRanges()"> 10–20 hours (1–2.5 full days)</label>
                        <label class="radio-option"><input type="radio" name="totalTimeRange" value="20-40" onchange="recalcTimeFromRanges()"> 20–40 hours (half a week to a week)</label>
                        <label class="radio-option"><input type="radio" name="totalTimeRange" value="40+" onchange="recalcTimeFromRanges()"> 40+ hours (more than a working week)</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Of that time, how much was spent WAITING for other people?</label>
                    <p class="helper-text" style="margin-bottom:0.5rem;">Waiting for approvals, responses, handoffs, external parties.</p>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="waitingPortion" value="almost-none" onchange="recalcTimeFromRanges()"> Almost none — I drove it end to end</label>
                        <label class="radio-option"><input type="radio" name="waitingPortion" value="quarter" onchange="recalcTimeFromRanges()"> About a quarter — some handoff delays</label>
                        <label class="radio-option"><input type="radio" name="waitingPortion" value="half" onchange="recalcTimeFromRanges()"> About half — significant back-and-forth</label>
                        <label class="radio-option"><input type="radio" name="waitingPortion" value="most" onchange="recalcTimeFromRanges()"> Most of it — I spent more time chasing than doing</label>
                        <label class="radio-option"><input type="radio" name="waitingPortion" value="almost-all" onchange="recalcTimeFromRanges()"> Almost all — I was blocked for days at a time</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>When you WERE actively working, what consumed the most time?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="primaryActivity" value="meetings" onchange="recalcTimeFromRanges()"> Meetings &amp; calls (kickoffs, status updates, alignment)</label>
                        <label class="radio-option"><input type="radio" name="primaryActivity" value="emails" onchange="recalcTimeFromRanges()"> Emails &amp; chasing (coordination, questions, following up)</label>
                        <label class="radio-option"><input type="radio" name="primaryActivity" value="execution" onchange="recalcTimeFromRanges()"> Actual execution (configuring, creating, data entry)</label>
                        <label class="radio-option"><input type="radio" name="primaryActivity" value="rework" onchange="recalcTimeFromRanges()"> Rework &amp; corrections (fixing mistakes, re-doing work)</label>
                    </div>
                </div>

                <div class="calculated" id="timeEstimateBox" style="display:none;">
                    <div class="calculated-label">Estimated breakdown:</div>
                    <div class="calculated-value" id="timeTotal" style="font-size:1.1rem;">&mdash;</div>
                </div>

                <div id="insightCard5" style="display: none;"></div>

                <div id="errorBox5" class="error-box"><div class="error-text" id="errorText5"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(4)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(5)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 6: PERFORMANCE ASSESSMENT ========== -->
        <div class="screen" id="screen6">
            <div class="screen-card">
                <h2 class="screen-title">Performance Assessment</h2>
                <p class="screen-subtitle">Compared to a typical "<span class="process-ref" id="processRef6">your process</span>", this instance was:</p>

                <div class="form-group">
                    <div class="radio-group" id="performanceRadios">
                        <label class="radio-option"><input type="radio" name="performance" value="much-faster" onchange="toggleIssuesSection()"> Much faster than usual (lucky, smooth)</label>
                        <label class="radio-option"><input type="radio" name="performance" value="typical" onchange="toggleIssuesSection()"> About typical (normal speed)</label>
                        <label class="radio-option"><input type="radio" name="performance" value="slower" onchange="toggleIssuesSection()"> Slower than usual (some delays)</label>
                        <label class="radio-option"><input type="radio" name="performance" value="way-longer" onchange="toggleIssuesSection()"> Way longer than normal (something went wrong)</label>
                    </div>
                </div>

                <div id="issuesSection" style="display: none;">
                    <div class="form-group">
                        <label>What specifically went wrong?</label>
                        <div class="checkbox-group" id="issuesCheckboxes">
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="approval-delay" onchange="updateBiggestDelay()"> Waited for approval longer than expected</label>
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="slow-response" onchange="updateBiggestDelay()"> Customer/stakeholder was slow to respond</label>
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="missing-info" onchange="updateBiggestDelay()"> Information was missing/unclear</label>
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="wrong-person" onchange="updateBiggestDelay()"> Wrong person assigned initially</label>
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="system-issues" onchange="updateBiggestDelay()"> System issues or downtime</label>
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="unavailable" onchange="updateBiggestDelay()"> Someone was unavailable (vacation, busy)</label>
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="escalation" onchange="updateBiggestDelay()"> Required unexpected escalation</label>
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="external" onchange="updateBiggestDelay()"> External dependency delayed us</label>
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="rework" onchange="updateBiggestDelay()"> Work was done wrong, needed rework</label>
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="unclear-process" onchange="updateBiggestDelay()"> Process was unclear</label>
                            <label class="checkbox-option"><input type="checkbox" name="issues" value="other" onchange="updateBiggestDelay(); toggleOtherInput(this, 'issuesOther')"> Other</label>
                            <input type="text" id="issuesOther" placeholder="Please describe..." style="display: none; margin-top: 0.5rem;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="biggestDelay">The biggest delay was:</label>
                        <select id="biggestDelay"><option value="">Select from issues above...</option></select>
                    </div>

                    <div class="form-group">
                        <label for="delayDetails">Tell us what happened:</label>
                        <textarea id="delayDetails" maxlength="200" placeholder="e.g., Finance approval took 8 days because CFO was traveling..." rows="3"></textarea>
                    </div>
                </div>

                <div id="errorBox6" class="error-box"><div class="error-text" id="errorText6"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(5)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(6)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 7: STEP BREAKDOWN ========== -->
        <div class="screen" id="screen7">
            <div class="screen-card">
                <h2 class="screen-title">Step Breakdown</h2>
                <p class="screen-subtitle">Let's break down "<span class="process-ref" id="processRef7">your process</span>" into major steps.</p>
                <p class="helper-text" style="margin-bottom: 1.5rem;">For the instance: <span id="exampleNameRef7" class="process-ref"></span></p>

                <!-- Import zone: upload or paste steps -->
                <div class="step-import-zone" id="stepImportZone">
                    <div class="step-import-tabs">
                        <button class="step-import-tab active" onclick="switchImportTab('upload', this)">Upload Process Map</button>
                        <button class="step-import-tab" onclick="switchImportTab('paste', this)">Paste Steps</button>
                    </div>
                    <div class="step-import-body" id="importBodyUpload">
                        <div class="step-import-upload" id="importDropArea" onclick="document.getElementById('importFileInput').click()">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            <p><strong>Click to upload</strong> or drag &amp; drop</p>
                            <p class="import-hint">Process map image (PNG, JPG, GIF, WebP) or PDF</p>
                        </div>
                        <input type="file" id="importFileInput" accept="image/png,image/jpeg,image/gif,image/webp,application/pdf" style="display:none" onchange="handleImportFile(this)">
                        <div id="importFilePreview" style="display:none; text-align:center;"></div>
                    </div>
                    <div class="step-import-body" id="importBodyPaste" style="display:none;">
                        <textarea class="step-import-textarea" id="importPasteText" placeholder="Paste your steps here, e.g.:&#10;1. Receive order from customer&#10;2. Verify inventory availability&#10;3. Process payment&#10;4. Pick and pack items&#10;5. Ship to customer&#10;&#10;Or paste any format — AI will extract the steps."></textarea>
                        <div class="step-import-actions">
                            <button class="step-import-btn step-import-btn-primary" onclick="handleImportPaste()" id="importPasteBtn">Extract Steps</button>
                        </div>
                    </div>
                    <div class="step-import-status" id="importStatus" style="display:none;">
                        <div class="spinner"></div>
                        <p style="color:var(--text-mid); font-size:0.9rem;" id="importStatusText">Analysing your process map...</p>
                    </div>
                </div>

                <!-- Handover banner (shown when colleague opens a shared link) -->
                <div class="handover-banner" id="handoverBanner">
                    <h4 id="handoverBannerTitle">A colleague shared this diagnostic with you</h4>
                    <p id="handoverBannerDesc">Review the steps below and add any that are missing. You can reorder steps by dragging, or insert new ones anywhere.</p>
                    <div class="handover-note" id="handoverBannerNote" style="display:none;"></div>
                </div>

                <p class="helper-text" style="margin-bottom:0.75rem; color: var(--text-mid); font-size: 0.82rem;">
                    <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:2px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/><path d="M12 16v-4"/><circle cx="12" cy="8" r="0.5" fill="currentColor"/></svg>
                    Drag steps to reorder. Don't know every step? Add what you know and hand over to a colleague.
                </p>

                <div class="dynamic-list" id="stepsList"></div>

                <button type="button" class="add-item" onclick="addStep()" id="addStepBtn">+ Add Step</button>
                <p class="helper-text">Minimum 3 steps. Maximum 50.</p>

                <!-- AI Step Suggestions -->
                <div id="stepSuggestionsBox" class="step-suggestions" style="display: none;">
                    <div class="ss-header">Suggested steps you might be missing</div>
                    <div id="stepSuggestionsChips"></div>
                </div>

                <div id="insightCard7" style="display: none;"></div>

                <div id="errorBox7" class="error-box"><div class="error-text" id="errorText7"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(6)">&larr; Back</button>
                    <button type="button" class="handover-btn" onclick="openHandoverModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4-4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                        Hand over to colleague
                    </button>
                    <button class="button button-primary" onclick="validateAndContinue(7)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 8: HANDOFF ANALYSIS ========== -->
        <div class="screen" id="screen8">
            <div class="screen-card">
                <h2 class="screen-title">Handoff Analysis</h2>
                <p class="screen-subtitle">Let's look at what happens between steps.</p>

                <div id="handoffContainer"></div>

                <p class="helper-text" style="margin-top: 1rem;">Handoff delays are often the biggest source of waste in any process.</p>

                <div id="insightCard8" style="display: none;"></div>

                <div id="errorBox8" class="error-box"><div class="error-text" id="errorText8"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(7)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(8)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 9: BOTTLENECK IDENTIFICATION ========== -->
        <div class="screen" id="screen9">
            <div class="screen-card">
                <h2 class="screen-title">Bottleneck Identification</h2>
                <p class="screen-subtitle">Where did time get stuck?</p>

                <div id="bottleneckSummary"></div>

                <div class="form-group">
                    <label for="longestStep">Which step took the LONGEST to complete?</label>
                    <select id="longestStep"><option value="">Select step...</option></select>
                </div>

                <div class="form-group">
                    <label>Why did this step take so long?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="bottleneckReason" value="busy"> Person was busy with other priorities</label>
                        <label class="radio-option"><input type="radio" name="bottleneckReason" value="no-info"> Needed information that wasn't available</label>
                        <label class="radio-option"><input type="radio" name="bottleneckReason" value="approvals"> Required multiple approvals</label>
                        <label class="radio-option"><input type="radio" name="bottleneckReason" value="complex"> Work was complex/difficult</label>
                        <label class="radio-option"><input type="radio" name="bottleneckReason" value="external"> Waiting for external party</label>
                        <label class="radio-option"><input type="radio" name="bottleneckReason" value="system"> System was slow/broken</label>
                        <label class="radio-option"><input type="radio" name="bottleneckReason" value="unclear"> Unclear what to do</label>
                        <label class="radio-option"><input type="radio" name="bottleneckReason" value="other" onchange="toggleRadioOther('bottleneckReason', 'bottleneckReasonOther')"> Other</label>
                        <input type="text" id="bottleneckReasonOther" placeholder="Please describe..." style="display: none; margin-top: 0.5rem;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="biggestBottleneck">If you could eliminate ONE bottleneck, which would have the biggest impact?</label>
                    <select id="biggestBottleneck"><option value="">Select one...</option></select>
                </div>

                <div class="form-group">
                    <label for="bottleneckWhy">Why this one?</label>
                    <textarea id="bottleneckWhy" maxlength="200" rows="3" placeholder="e.g., Customer Success didn't know account was ready. No automated notification."></textarea>
                </div>

                <div id="insightCard9" style="display: none;"></div>

                <div id="errorBox9" class="error-box"><div class="error-text" id="errorText9"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(8)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(9)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 10: SYSTEMS & TOOLS ========== -->
        <div class="screen" id="screen10">
            <div class="screen-card">
                <h2 class="screen-title">Systems &amp; Tools</h2>
                <p class="screen-subtitle">Which systems did you use for "<span class="process-ref" id="processRef10">your process</span>"?</p>
                <p class="helper-text" style="margin-bottom: 1.5rem;">Think of the <span id="exampleNameRef10" class="process-ref"></span> instance. Every system you touched.</p>

                <div class="dynamic-list" id="systemsList"></div>

                <button type="button" class="add-item" onclick="addSystem()">+ Add System</button>

                <div class="calculated" id="systemsSummaryCalc">
                    <div class="calculated-label">Summary:</div>
                    <div class="calculated-value" id="systemsSummary" style="font-size: 1.1rem;">Systems used: 0</div>
                </div>

                <div id="errorBox10" class="error-box"><div class="error-text" id="errorText10"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(9)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(10)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 11: APPROVALS & DECISIONS ========== -->
        <div class="screen" id="screen11">
            <div class="screen-card">
                <h2 class="screen-title">Approvals &amp; Decisions</h2>
                <p class="screen-subtitle">In "<span class="process-ref" id="processRef11">your process</span>", how many approval points exist?</p>
                <p class="helper-text" style="margin-bottom: 1.5rem;">Approval points = decisions where someone must explicitly approve before work continues.</p>

                <div class="form-group">
                    <label for="approvalCount">How many approval points?</label>
                    <input type="number" id="approvalCount" min="0" max="10" value="0" oninput="buildApprovalEntries()">
                </div>

                <div id="approvalsList"></div>

                <div id="errorBox11" class="error-box"><div class="error-text" id="errorText11"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(10)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(11)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 12: KNOWLEDGE & DOCUMENTATION ========== -->
        <div class="screen" id="screen12">
            <div class="screen-card">
                <h2 class="screen-title">Knowledge &amp; Documentation</h2>
                <p class="screen-subtitle">You're doing "<span class="process-ref" id="processRef12">your process</span>" and realise:<br><em>"Wait, what's the approval threshold for this?"</em></p>

                <div class="form-group">
                    <label>Where do you look FIRST?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="knowledgeFirst" value="documentation" onchange="toggleAskWho()"> Written documentation (wiki, process doc)</label>
                        <label class="radio-option"><input type="radio" name="knowledgeFirst" value="ask-someone" onchange="toggleAskWho()"> Ask someone (Slack, Teams, email)</label>
                        <label class="radio-option"><input type="radio" name="knowledgeFirst" value="search-email" onchange="toggleAskWho()"> Search my email history</label>
                        <label class="radio-option"><input type="radio" name="knowledgeFirst" value="spreadsheet" onchange="toggleAskWho()"> Check a spreadsheet or shared file</label>
                        <label class="radio-option"><input type="radio" name="knowledgeFirst" value="system" onchange="toggleAskWho()"> Look in the system itself</label>
                        <label class="radio-option"><input type="radio" name="knowledgeFirst" value="just-know" onchange="toggleAskWho()"> I just... know this already</label>
                    </div>
                </div>

                <div id="askWhoSection" style="display: none;">
                    <div class="form-group">
                        <label for="askWho">Who do you ask?</label>
                        <input type="text" id="askWho" placeholder="e.g., Finance Manager">
                    </div>

                    <div class="form-group">
                        <label>Is this person:</label>
                        <div class="radio-group">
                            <label class="radio-option"><input type="radio" name="personType" value="owner"> The designated owner of this process</label>
                            <label class="radio-option"><input type="radio" name="personType" value="happens-to-know"> Someone who happens to know</label>
                            <label class="radio-option"><input type="radio" name="personType" value="only-one"> The ONLY person who knows this</label>
                            <label class="radio-option"><input type="radio" name="personType" value="bottleneck"> A bottleneck (everyone asks them)</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>What if they were on vacation for 2 weeks?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="vacationImpact" value="fine"> Fine - documentation exists</label>
                        <label class="radio-option"><input type="radio" name="vacationImpact" value="ask-else"> Would ask someone else</label>
                        <label class="radio-option"><input type="radio" name="vacationImpact" value="slows-down"> Work would slow down significantly</label>
                        <label class="radio-option"><input type="radio" name="vacationImpact" value="stops"> Work would completely stop</label>
                        <label class="radio-option"><input type="radio" name="vacationImpact" value="guess"> We'd guess and maybe get it wrong</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>How long to find this answer?</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="timeToAnswer" value="<1min"> &lt; 1 minute (I know where to look)</label>
                        <label class="radio-option"><input type="radio" name="timeToAnswer" value="1-5min"> 1-5 minutes (quick search/ask)</label>
                        <label class="radio-option"><input type="radio" name="timeToAnswer" value="5-15min"> 5-15 minutes (hunting around)</label>
                        <label class="radio-option"><input type="radio" name="timeToAnswer" value="15-30min"> 15-30 minutes (multiple people)</label>
                        <label class="radio-option"><input type="radio" name="timeToAnswer" value="30+min"> 30+ minutes (or never found it)</label>
                    </div>
                </div>

                <div id="errorBox12" class="error-box"><div class="error-text" id="errorText12"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(11)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(12)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 13: NEW HIRE REALITY ========== -->
        <div class="screen" id="screen13">
            <div class="screen-card">
                <h2 class="screen-title">New Hire Reality</h2>
                <p class="screen-subtitle">If someone new started tomorrow and needed to do "<span class="process-ref" id="processRef13">your process</span>", how would they learn it?</p>

                <div class="form-group">
                    <label>How would they learn?</label>
                    <div class="checkbox-group">
                        <label class="checkbox-option"><input type="checkbox" name="learningMethod" value="documentation"> Read written documentation</label>
                        <label class="checkbox-option"><input type="checkbox" name="learningMethod" value="shadow"> Shadow someone</label>
                        <label class="checkbox-option"><input type="checkbox" name="learningMethod" value="trial-error"> Trial and error (learn by doing)</label>
                        <label class="checkbox-option"><input type="checkbox" name="learningMethod" value="ask-questions"> Ask questions constantly</label>
                        <label class="checkbox-option"><input type="checkbox" name="learningMethod" value="training"> Training session/walkthrough</label>
                        <label class="checkbox-option"><input type="checkbox" name="learningMethod" value="video"> Video recording exists</label>
                        <label class="checkbox-option"><input type="checkbox" name="learningMethod" value="tribal"> It's all tribal knowledge</label>
                        <label class="checkbox-option"><input type="checkbox" name="learningMethod" value="other" onchange="toggleOtherInput(this, 'learningMethodOther')"> Other</label>
                        <input type="text" id="learningMethodOther" placeholder="Please describe..." style="display: none; margin-top: 0.5rem;">
                    </div>
                </div>

                <div class="form-group">
                    <label>Time for a new hire to do this process independently:</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="timeToCompetence" value="1-2d"> 1-2 days</label>
                        <label class="radio-option"><input type="radio" name="timeToCompetence" value="3-5d"> 3-5 days</label>
                        <label class="radio-option"><input type="radio" name="timeToCompetence" value="1-2w"> 1-2 weeks</label>
                        <label class="radio-option"><input type="radio" name="timeToCompetence" value="3-4w"> 3-4 weeks</label>
                        <label class="radio-option"><input type="radio" name="timeToCompetence" value="1-2m"> 1-2 months</label>
                        <label class="radio-option"><input type="radio" name="timeToCompetence" value="3m+"> 3+ months</label>
                        <label class="radio-option"><input type="radio" name="timeToCompetence" value="unsure"> Honestly, not sure</label>
                    </div>
                </div>

                <hr class="section-divider">

                <p style="font-weight: 600; margin-bottom: 1rem;">Your last new hire who learned this process:</p>
                <div class="input-group">
                    <div class="form-group">
                        <label for="lastHireTime">Time to competence:</label>
                        <input type="text" id="lastHireTime" placeholder="e.g., 3 weeks">
                    </div>
                    <div class="form-group">
                        <label for="lastHireStruggle">Biggest struggle:</label>
                        <input type="text" id="lastHireStruggle" placeholder="e.g., Understanding approval rules">
                    </div>
                </div>

                <div id="errorBox13" class="error-box"><div class="error-text" id="errorText13"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(12)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(13)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 14: FREQUENCY & VOLUME ========== -->
        <div class="screen" id="screen14">
            <div class="screen-card">
                <h2 class="screen-title">Frequency &amp; Volume</h2>
                <p class="screen-subtitle">How often does "<span class="process-ref" id="processRef14">your process</span>" occur?</p>

                <div class="form-group">
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="frequency" value="multi-daily" onchange="updateAnnualInstances()"> Multiple times per day (50+/month)</label>
                        <label class="radio-option"><input type="radio" name="frequency" value="daily" onchange="updateAnnualInstances()"> Daily (20-30/month)</label>
                        <label class="radio-option"><input type="radio" name="frequency" value="2-3-week" onchange="updateAnnualInstances()"> 2-3 times per week (8-12/month)</label>
                        <label class="radio-option"><input type="radio" name="frequency" value="weekly" onchange="updateAnnualInstances()"> Weekly (4-5/month)</label>
                        <label class="radio-option"><input type="radio" name="frequency" value="2-3-month" onchange="updateAnnualInstances()"> 2-3 times per month</label>
                        <label class="radio-option"><input type="radio" name="frequency" value="monthly" onchange="updateAnnualInstances()"> Monthly</label>
                        <label class="radio-option"><input type="radio" name="frequency" value="less" onchange="updateAnnualInstances()"> Less than monthly</label>
                    </div>
                </div>

                <div class="calculated">
                    <div class="calculated-label">Annual instances:</div>
                    <div class="calculated-value" id="annualInstances">&mdash;</div>
                </div>

                <div class="form-group">
                    <label for="inFlight">Right now, how many instances are "in flight"? (Started but not yet complete)</label>
                    <input type="number" id="inFlight" min="0" placeholder="e.g., 12">
                </div>

                <p style="font-weight: 500; margin-bottom: 0.75rem;">Of those in flight, how many are:</p>
                <div class="input-group" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label for="progressing" style="font-size: 0.85rem;">Progressing normally:</label>
                        <input type="number" id="progressing" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="stuck" style="font-size: 0.85rem;">Delayed/stuck:</label>
                        <input type="number" id="stuck" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="waitingFor" style="font-size: 0.85rem;">Waiting for someone:</label>
                        <input type="number" id="waitingFor" min="0" placeholder="0">
                    </div>
                </div>

                <div id="errorBox14" class="error-box"><div class="error-text" id="errorText14"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(13)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(14)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 15: COST CALCULATION ========== -->
        <div class="screen" id="screen15">
            <div class="screen-card">
                <h2 class="screen-title">Let's Calculate the Real Cost</h2>
                <p class="screen-subtitle">The numbers behind "<span class="process-ref" id="processRef15">your process</span>"</p>

                <div class="form-group">
                    <label for="hourlyRate">Your estimated hourly rate:</label>
                    <input type="number" id="hourlyRate" value="50" min="10" step="5" oninput="calculateCosts()">
                    <p class="helper-text">Industry average for your role: &pound;50/hr</p>
                </div>

                <div id="costBreakdown" class="calculated">
                    <div class="calculated-label">From earlier, you spent:</div>
                    <div class="calculated-value" id="costBreakdownValue" style="font-size: 1.1rem;"></div>
                </div>

                <div class="calculated">
                    <div class="calculated-label">Your personal cost (this instance):</div>
                    <div class="calculated-value" id="instanceCost">&mdash;</div>
                    <div class="calculated-formula" id="instanceCostFormula"></div>
                </div>

                <div class="calculated">
                    <div class="calculated-label">This is ONE instance. Annual instances:</div>
                    <div class="calculated-value" id="annualInstancesCost">&mdash;</div>
                </div>

                <div class="calculated" style="background: linear-gradient(135deg, rgba(61, 142, 166, 0.15), rgba(61, 142, 166, 0.05)); border-left: 4px solid var(--primary);">
                    <div class="calculated-label" style="font-weight: 600;">YOUR annual cost:</div>
                    <div class="calculated-value" id="annualUserCost" style="font-size: 2.2rem; color: var(--primary);">&mdash;</div>
                    <div class="calculated-formula" id="annualUserCostFormula"></div>
                </div>

                <div id="errorBox15" class="error-box"><div class="error-text" id="errorText15"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(14)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(15)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 16: TEAM COST & SAVINGS ========== -->
        <div class="screen" id="screen16">
            <div class="screen-card">
                <h2 class="screen-title">Team Cost &amp; Savings</h2>
                <p class="screen-subtitle">How many OTHER people are involved in "<span class="process-ref" id="processRef16">your process</span>"?</p>

                <div class="form-group">
                    <label for="teamPeopleCount">Count everyone who touches any step:</label>
                    <input type="number" id="teamPeopleCount" min="1" value="1" oninput="calculateTeamCost()">
                </div>

                <div id="teamRecap"></div>

                <div class="calculated danger">
                    <div class="calculated-label" style="font-weight: 600;">TOTAL PROCESS COST:</div>
                    <div class="calculated-value" id="totalAnnualCost" style="font-size: 2.5rem;">&mdash;</div>
                    <div class="calculated-formula" id="totalAnnualCostFormula"></div>
                </div>

                <hr class="section-divider">

                <h3 style="margin-bottom: 1rem;">If you could make this 50% faster:</h3>

                <div class="input-group">
                    <div class="calculated">
                        <div class="calculated-label">Current average:</div>
                        <div class="calculated-value" id="currentAvg" style="font-size: 1.4rem;">&mdash;</div>
                    </div>
                    <div class="calculated success">
                        <div class="calculated-label">50% faster:</div>
                        <div class="calculated-value" id="halfTime" style="font-size: 1.4rem;">&mdash;</div>
                    </div>
                </div>

                <div class="calculated success">
                    <div class="calculated-label" style="font-weight: 600;">Annual savings:</div>
                    <div class="calculated-value" id="annualSavings" style="font-size: 2rem;">&mdash;</div>
                    <div class="calculated-formula" id="annualSavingsFormula"></div>
                </div>

                <div class="form-group">
                    <label>What would you do with this capacity?</label>
                    <div class="checkbox-group">
                        <label class="checkbox-option"><input type="checkbox" name="savingsUse" value="2x-volume"> Handle 2x volume (growth)</label>
                        <label class="checkbox-option"><input type="checkbox" name="savingsUse" value="reduce-team"> Reduce team size (cost savings)</label>
                        <label class="checkbox-option"><input type="checkbox" name="savingsUse" value="strategic-work"> Redeploy people to strategic work</label>
                        <label class="checkbox-option"><input type="checkbox" name="savingsUse" value="improve-quality"> Improve quality (less rushing)</label>
                        <label class="checkbox-option"><input type="checkbox" name="savingsUse" value="better-cx"> Better customer experience</label>
                        <label class="checkbox-option"><input type="checkbox" name="savingsUse" value="reduce-stress"> Reduce stress/overtime</label>
                        <label class="checkbox-option"><input type="checkbox" name="savingsUse" value="other" onchange="toggleOtherInput(this, 'savingsUseOther')"> Other</label>
                        <input type="text" id="savingsUseOther" placeholder="Please describe..." style="display: none; margin-top: 0.5rem;">
                    </div>
                </div>

                <div class="form-group">
                    <label>Expected impact if biggest bottleneck is fixed:</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="expectedImpact" value="<10%"> Save &lt; 10% of time</label>
                        <label class="radio-option"><input type="radio" name="expectedImpact" value="10-25%"> Save 10-25% of time</label>
                        <label class="radio-option"><input type="radio" name="expectedImpact" value="25-50%"> Save 25-50% of time</label>
                        <label class="radio-option"><input type="radio" name="expectedImpact" value="50%+"> Save 50%+ of time</label>
                        <label class="radio-option"><input type="radio" name="expectedImpact" value="transform"> Would transform the process</label>
                    </div>
                </div>

                <div id="errorBox16" class="error-box"><div class="error-text" id="errorText16"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(15)">&larr; Back</button>
                    <button class="button button-primary" onclick="validateAndContinue(16)">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 17: PRIORITY ASSESSMENT ========== -->
        <div class="screen" id="screen17">
            <div class="screen-card">
                <h2 class="screen-title">Priority Assessment</h2>
                <p class="screen-subtitle">Based on everything you've shared about "<span class="process-ref" id="processRef17">your process</span>":</p>

                <div id="prioritySummary"></div>

                <div class="form-group">
                    <label>Is optimising this process:</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="priority" value="top"> Top priority - critical to fix</label>
                        <label class="radio-option"><input type="radio" name="priority" value="important"> Important - should address soon</label>
                        <label class="radio-option"><input type="radio" name="priority" value="medium"> Medium priority - nice to have</label>
                        <label class="radio-option"><input type="radio" name="priority" value="low"> Low priority - not urgent</label>
                        <label class="radio-option"><input type="radio" name="priority" value="not-worth"> Not worth optimising</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="priorityReason">Why?</label>
                    <textarea id="priorityReason" maxlength="150" rows="2" placeholder="e.g., Huge cost, clear bottleneck, easy to fix"></textarea>
                </div>

                <hr class="section-divider">

                <div class="form-group">
                    <label>Do you want to analyse another process?</label>
                    <p class="helper-text" style="margin-bottom: 0.75rem;">You can analyse up to 3 processes total. Each takes about 12-15 minutes.</p>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="anotherProcess" value="yes"> Yes - analyse another process</label>
                        <label class="radio-option"><input type="radio" name="anotherProcess" value="no"> No - finish diagnostic and see results</label>
                    </div>
                </div>

                <div id="errorBox17" class="error-box"><div class="error-text" id="errorText17"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(16)">&larr; Back</button>
                    <button class="button button-primary" onclick="handleProcessComplete()">Continue &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 18: CONTACT INFO ========== -->
        <div class="screen" id="screen18">
            <div class="screen-card">
                <h2 class="screen-title">Your Details</h2>
                <p class="screen-subtitle">Where should we send your detailed analysis?</p>

                <div id="processesSummary"></div>

                <hr class="section-divider">

                <div class="input-group">
                    <div class="form-group">
                        <label for="contactName">Full name:</label>
                        <input type="text" id="contactName" placeholder="Your full name">
                    </div>
                    <div class="form-group">
                        <label for="contactEmail">Work email:</label>
                        <input type="email" id="contactEmail" placeholder="you@company.com">
                    </div>
                </div>

                <div class="input-group">
                    <div class="form-group">
                        <label for="contactCompany">Company:</label>
                        <input type="text" id="contactCompany" placeholder="Company name">
                    </div>
                    <div class="form-group">
                        <label for="contactTitle">Job title:</label>
                        <input type="text" id="contactTitle" placeholder="Your role">
                    </div>
                </div>

                <div class="form-group">
                    <label>Team size:</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="teamSize" value="1-10"> 1-10</label>
                        <label class="radio-option"><input type="radio" name="teamSize" value="11-50"> 11-50</label>
                        <label class="radio-option"><input type="radio" name="teamSize" value="51-100"> 51-100</label>
                        <label class="radio-option"><input type="radio" name="teamSize" value="101-250"> 101-250</label>
                        <label class="radio-option"><input type="radio" name="teamSize" value="250+"> 250+</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="contactIndustry">Industry:</label>
                    <select id="contactIndustry" onchange="toggleOtherSelect(this, 'industryOther')">
                        <option value="">Select industry...</option>
                        <option value="Technology">Technology</option>
                        <option value="Financial Services">Financial Services</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Professional Services">Professional Services</option>
                        <option value="Retail & E-commerce">Retail &amp; E-commerce</option>
                        <option value="Real Estate">Real Estate</option>
                        <option value="Education">Education</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="industryOther" placeholder="Please specify your industry..." style="display: none; margin-top: 0.5rem;">
                </div>

                <div id="errorBox18" class="error-box"><div class="error-text" id="errorText18"></div></div>

                <div class="button-group">
                    <button class="button button-secondary" onclick="goToScreen(17)">&larr; Back</button>
                    <button class="button button-primary" onclick="submitDiagnostic()">Generate My Analysis &rarr;</button>
                </div>
            </div>
        </div>

        <!-- ========== SCREEN 19: RESULTS ========== -->
        <div class="screen" id="screen19">
            <div class="screen-card">
                <div class="loading-overlay" id="loadingState">
                    <div class="spinner"></div>
                    <h3>Analysing your processes...</h3>
                    <p style="color: var(--text-mid); margin-top: 0.5rem;">This takes a few seconds.</p>
                </div>

                <div id="resultsContainer" style="display: none;">
                    <div class="welcome-hero" style="padding-bottom: 1rem;">
                        <div class="welcome-icon">&#127881;</div>
                        <h1 class="screen-title">Diagnostic Complete!</h1>
                    </div>

                    <div id="processResults"></div>

                    <!-- Process Flow Diagrams (one per process) -->
                    <div id="flowDiagramSection" style="display: none;">
                        <div id="flowDiagramLoading" style="text-align: center; padding: 2rem;">
                            <div class="spinner"></div>
                            <p style="color: var(--text-mid);">Generating flow diagrams...</p>
                        </div>
                        <div id="flowDiagramsContainer" style="display: none;"></div>
                        <div id="flowDiagramError" style="display: none;" class="warning-box">
                            <span style="font-size: 1.3rem;">&#9888;&#65039;</span>
                            <span style="color: #856404; font-size: 0.95rem;">Flow diagram generation is pending. It will be emailed to you shortly.</span>
                        </div>
                    </div>

                    <!-- Automation Readiness Score -->
                    <div id="automationScoreSection" style="display: none;"></div>

                    <div id="analysisResults"></div>

                    <!-- 90-Day Roadmap -->
                    <div id="roadmapSection" style="display: none;"></div>

                    <!-- ROI Projection Calculator -->
                    <div id="roiCalculator" style="display: none;"></div>

                    <div class="button-group" style="flex-direction: column; gap: 1rem;">
                        <button class="button button-primary" onclick="downloadPDFReport()" id="downloadPdfBtn">
                            <span id="pdfBtnText">Download PDF Report</span>
                        </button>
                        <button class="button button-accent" onclick="emailDiagnosticReport()" id="emailReportBtn" style="background: linear-gradient(135deg, #7c3aed, #6d28d9); border: none;">
                            <span id="emailBtnText">&#9993; Email Report to Me</span>
                        </button>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
                            <button class="button button-secondary" onclick="exportCSV()" style="flex: 1; min-width: 120px; font-size: 0.85rem;">&#128202; CSV</button>
                            <button class="button button-secondary" onclick="exportNotionMarkdown()" style="flex: 1; min-width: 120px; font-size: 0.85rem;">&#128221; Notion</button>
                            <button class="button button-secondary" onclick="exportJSON()" style="flex: 1; min-width: 120px; font-size: 0.85rem;">&#128196; JSON</button>
                            <button class="button button-secondary" onclick="exportBPMN()" style="flex: 1; min-width: 120px; font-size: 0.85rem;">&#9881; BPMN</button>
                        </div>
                        <a href="mailto:hopektettey@gmail.com?subject=Process%20Diagnostic%20-%20Discovery%20Call" class="button button-secondary" style="text-align: center; text-decoration: none;">Book Discovery Call</a>
                        <a href="index.html" class="button button-secondary" style="text-align: center; text-decoration: none;">Back to Home</a>
                    </div>

                    <!-- Email sent confirmation -->
                    <div id="emailSentConfirmation" style="display: none; margin-top: 1rem; padding: 1.2rem; background: linear-gradient(135deg, rgba(22, 163, 74, 0.1), rgba(22, 163, 74, 0.05)); border: 1px solid rgba(22, 163, 74, 0.3); border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">&#9989;</div>
                        <div style="font-weight: 600; color: #16a34a;" id="emailConfirmText">Report sent!</div>
                        <div style="color: var(--text-mid); font-size: 0.9rem; margin-top: 0.3rem;" id="emailConfirmDetail"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        function esc(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

        function showBanner(msg, type) {
            var existing = document.getElementById('inlineBanner');
            if (existing) existing.remove();
            var div = document.createElement('div');
            div.id = 'inlineBanner';
            var bg = type === 'error' ? '#fef2f2' : type === 'success' ? '#f0fdf4' : '#fffbeb';
            var border = type === 'error' ? '#fca5a5' : type === 'success' ? '#86efac' : '#fcd34d';
            var color = type === 'error' ? '#991b1b' : type === 'success' ? '#166534' : '#92400e';
            div.style.cssText = 'position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:10001;padding:12px 24px;border-radius:8px;background:' + bg + ';border:1px solid ' + border + ';color:' + color + ';font-size:0.88rem;max-width:500px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.1);animation:fadeIn 0.3s;';
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(function() { if (div.parentNode) div.remove(); }, 5000);
        }

        // ============================================================
        // GLOBAL STATE
        // ============================================================
        let currentScreen = 0;
        const TOTAL_SCREENS = 19;
        let completedProcesses = [];
        let stepCount = 0;
        let systemCount = 0;

        function toggleSection(header) {
            const section = header.parentElement;
            const btn = header.querySelector('.collapse-btn');
            section.classList.toggle('collapsed');
            btn.textContent = section.classList.contains('collapsed') ? '+' : '−';
        }

        // Current process being analyzed
        let processData = createEmptyProcess();

        function createEmptyProcess() {
            return {
                processType: '',
                processName: '',
                definition: { startsWhen: '', completesWhen: '', complexity: '', departments: [] },
                lastExample: { name: '', startDate: '', endDate: '', elapsedDays: 0 },
                userTime: { meetings: 0, emails: 0, execution: 0, waiting: 0, total: 0 },
                timeRangeSelections: { totalTimeRange: '', waitingPortion: '', primaryActivity: '' },
                performance: '',
                issues: [],
                biggestDelay: '',
                delayDetails: '',
                steps: [],
                handoffs: [],
                systems: [],
                approvals: [],
                knowledge: {},
                newHire: {},
                frequency: { type: '', annual: 0, inFlight: 0, progressing: 0, stuck: 0, waiting: 0 },
                costs: { hourlyRate: 50, instanceCost: 0, annualUserCost: 0, totalAnnualCost: 0, teamSize: 1 },
                savings: {},
                priority: {},
                bottleneck: {}
            };
        }

        // ============================================================
        // NAVIGATION
        // ============================================================
        function goToScreen(screenNum) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById('screen' + screenNum);
            if (screen) {
                screen.classList.add('active');
                currentScreen = screenNum;
                updateProgress();
                updateHealthScore();
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Populate dynamic content when entering screens
                if (screenNum === 2) populateScreen2();
                if (screenNum === 3) updateProcessRefs();
                if (screenNum === 4) updateProcessRefs();
                if (screenNum === 5) { populateScreen5(); showInsightCard(5); }
                if (screenNum === 6) updateProcessRefs();
                if (screenNum === 7) { populateScreen7(); setTimeout(buildStepSuggestions, 200); showInsightCard(7); }
                if (screenNum === 8) { buildHandoffBlocks(); showInsightCard(8); }
                if (screenNum === 9) { populateScreen9(); showInsightCard(9); }
                if (screenNum === 10) populateScreen10();
                if (screenNum === 11) updateProcessRefs();
                if (screenNum === 12) updateProcessRefs();
                if (screenNum === 13) updateProcessRefs();
                if (screenNum === 14) updateProcessRefs();
                if (screenNum === 15) populateScreen15();
                if (screenNum === 16) populateScreen16();
                if (screenNum === 17) populateScreen17();
                if (screenNum === 18) populateScreen18();
            }
        }

        function updateProgress() {
            const progress = (currentScreen / TOTAL_SCREENS) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            const screenLabels = {
                0: 'Getting Started', 1: 'Process Selection', 2: 'Process Name', 3: 'Define Boundaries',
                4: 'Last Example', 5: 'Time Investment', 6: 'Performance', 7: 'Step Breakdown',
                8: 'Handoff Analysis', 9: 'Bottlenecks', 10: 'Systems & Tools', 11: 'Approvals',
                12: 'Knowledge', 13: 'New Hire', 14: 'Frequency', 15: 'Cost Calculation',
                16: 'Team Cost & Savings', 17: 'Priority', 18: 'Your Details', 19: 'Results'
            };

            document.getElementById('progressText').textContent =
                currentScreen === 0 ? screenLabels[0] :
                currentScreen === TOTAL_SCREENS ? 'Complete!' :
                `Step ${currentScreen} of ${TOTAL_SCREENS - 1} — ${screenLabels[currentScreen] || ''}`;
        }

        function updateProcessRefs() {
            const name = processData.processName || 'your process';
            document.querySelectorAll('.process-ref').forEach(el => {
                if (!el.id || el.id.startsWith('processRef')) el.textContent = name;
            });
        }

        // ============================================================
        // SCREEN 1: PROCESS SELECTION
        // ============================================================
        function selectProcess(card, processType, processName) {
            document.querySelectorAll('.process-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            processData.processType = processType;
            processData.processName = processName;
            document.getElementById('customProcess').value = '';
            document.getElementById('continueBtn1').disabled = false;
        }

        function handleCustomProcess() {
            const custom = document.getElementById('customProcess').value.trim();
            if (custom) {
                document.querySelectorAll('.process-card').forEach(c => c.classList.remove('selected'));
                processData.processType = 'custom';
                processData.processName = custom;
                document.getElementById('continueBtn1').disabled = false;
            }
        }

        // ============================================================
        // SCREEN 2: NAME YOUR PROCESS
        // ============================================================
        function populateScreen2() {
            document.getElementById('selectedProcessType2').textContent = processData.processName;
            const input = document.getElementById('processNameInput');
            if (!input.value && processData.processName) input.value = processData.processName;
        }

        // ============================================================
        // SCREEN 4: DATE CALCULATIONS
        // ============================================================
        function calculateElapsed() {
            const startVal = document.getElementById('startDate').value;
            const endVal = document.getElementById('endDate').value;
            const warning = document.getElementById('dateWarning');

            if (!startVal || !endVal) {
                document.getElementById('elapsedDays').textContent = '\u2014';
                return;
            }

            const start = new Date(startVal);
            const end = new Date(endVal);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            warning.style.display = 'none';

            if (end <= start) {
                document.getElementById('dateWarningText').textContent = 'End date must be after start date.';
                warning.style.display = 'flex';
                return;
            }

            const daysSinceStart = Math.floor((today - start) / (1000 * 60 * 60 * 24));
            if (daysSinceStart > 90) {
                document.getElementById('dateWarningText').textContent = 'This example is over 3 months old. Pick something more recent if possible.';
                warning.style.display = 'flex';
            }

            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            document.getElementById('elapsedDays').textContent = days + ' days';
            processData.lastExample.elapsedDays = days;
            processData.lastExample.startDate = startVal;
            processData.lastExample.endDate = endVal;
        }

        // ============================================================
        // SCREEN 5: TIME INVESTMENT
        // ============================================================
        function populateScreen5() {
            updateProcessRefs();
            const ex = processData.lastExample;
            const summary = document.getElementById('exampleSummary');
            if (ex.name && ex.startDate && ex.endDate) {
                summary.textContent = `${ex.name} — ${formatDate(ex.startDate)} to ${formatDate(ex.endDate)}, ${ex.elapsedDays} days`;
            }
        }

        const _timeRangeMidpoints = { '0-2': 1, '2-5': 3.5, '5-10': 7.5, '10-20': 15, '20-40': 30, '40+': 55 };
        const _waitingFractions = { 'almost-none': 0.05, 'quarter': 0.25, 'half': 0.5, 'most': 0.75, 'almost-all': 0.9 };
        const _activitySplits = {
            'meetings':  { meetings: 0.50, emails: 0.25, execution: 0.25 },
            'emails':    { meetings: 0.20, emails: 0.50, execution: 0.30 },
            'execution': { meetings: 0.15, emails: 0.20, execution: 0.65 },
            'rework':    { meetings: 0.10, emails: 0.15, execution: 0.75 }
        };

        function recalcTimeFromRanges() {
            const rangeVal = getRadioValue('totalTimeRange');
            const waitVal = getRadioValue('waitingPortion');
            const actVal = getRadioValue('primaryActivity');

            if (!rangeVal) { processData.userTime = { meetings: 0, emails: 0, execution: 0, waiting: 0, total: 0 }; return; }

            const total = _timeRangeMidpoints[rangeVal] || 0;
            const waitFrac = _waitingFractions[waitVal] || 0.25;
            const waiting = Math.round(total * waitFrac * 10) / 10;
            const active = total - waiting;

            const split = _activitySplits[actVal] || _activitySplits['execution'];
            const meetings = Math.round(active * split.meetings * 10) / 10;
            const emails = Math.round(active * split.emails * 10) / 10;
            const execution = Math.round((active - meetings - emails) * 10) / 10;

            processData.userTime = { meetings, emails, execution, waiting, total };

            const days = processData.lastExample.elapsedDays || 1;
            const box = document.getElementById('timeEstimateBox');
            const display = document.getElementById('timeTotal');
            if (box && display) {
                box.style.display = 'block';
                display.innerHTML =
                    `~${total}h total over ${days} days` +
                    `<br><span style="font-size:0.85rem;font-weight:400;color:var(--text-mid);">` +
                    `Meetings ~${meetings}h · Emails ~${emails}h · Execution ~${execution}h · Waiting ~${waiting}h</span>`;
            }
        }

        function calculateTimeTotal() { recalcTimeFromRanges(); }

        // ============================================================
        // SCREEN 6: PERFORMANCE
        // ============================================================
        function toggleIssuesSection() {
            const perf = getRadioValue('performance');
            const section = document.getElementById('issuesSection');
            section.style.display = (perf === 'slower' || perf === 'way-longer') ? 'block' : 'none';
        }

        function updateBiggestDelay() {
            const checked = document.querySelectorAll('input[name="issues"]:checked');
            const select = document.getElementById('biggestDelay');
            const issueLabels = {
                'approval-delay': 'Approval delay',
                'slow-response': 'Slow response',
                'missing-info': 'Missing information',
                'wrong-person': 'Wrong person assigned',
                'system-issues': 'System issues',
                'unavailable': 'Person unavailable',
                'escalation': 'Unexpected escalation',
                'external': 'External dependency',
                'rework': 'Rework needed',
                'unclear-process': 'Unclear process'
            };

            select.innerHTML = '<option value="">Select from issues above...</option>';
            checked.forEach(cb => {
                const opt = document.createElement('option');
                opt.value = cb.value;
                opt.textContent = issueLabels[cb.value] || cb.value;
                select.appendChild(opt);
            });
        }

        // ============================================================
        // SCREEN 7: STEP BREAKDOWN
        // ============================================================
        const DEPT_OPTIONS = '<option value="">Department...</option>' +
            '<optgroup label="Internal">' +
            '<option value="Sales">Sales</option>' +
            '<option value="Operations">Operations</option>' +
            '<option value="Finance">Finance</option>' +
            '<option value="IT">IT</option>' +
            '<option value="Customer Success">Customer Success</option>' +
            '<option value="Product">Product</option>' +
            '<option value="Leadership">Leadership</option>' +
            '<option value="HR">HR</option>' +
            '<option value="Legal">Legal</option>' +
            '<option value="Procurement">Procurement</option>' +
            '<option value="Compliance">Compliance</option>' +
            '<option value="Marketing">Marketing</option>' +
            '<option value="Engineering">Engineering</option>' +
            '<option value="Quality Assurance">Quality Assurance</option>' +
            '</optgroup>' +
            '<optgroup label="External">' +
            '<option value="External Vendor">External Vendor</option>' +
            '<option value="External Client">External Client</option>' +
            '<option value="External Regulator">External Regulator</option>' +
            '<option value="External Consultant">External Consultant</option>' +
            '<option value="External Legal">External Legal</option>' +
            '</optgroup>' +
            '<option value="Other">Custom...</option>';

        // Toggle "Other" text input for checkboxes
        function toggleOtherInput(checkbox, inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.style.display = checkbox.checked ? 'block' : 'none';
                if (!checkbox.checked) input.value = '';
                if (checkbox.checked) input.focus();
            }
        }

        // ============================================================
        // CUSTOM DEPARTMENTS
        // ============================================================
        const customDepartments = [];

        function addCustomDepartment() {
            const input = document.getElementById('customDeptInput');
            const name = input.value.trim();
            if (!name) return;

            // Prevent duplicates (case-insensitive)
            const nameLower = name.toLowerCase();
            const builtInDepts = ['sales','operations','finance','it','customer success','product','leadership','hr'];
            if (builtInDepts.includes(nameLower)) {
                // Check the built-in checkbox instead
                const cb = document.querySelector(`input[name="departments"][value="${name}"]`) ||
                           [...document.querySelectorAll('input[name="departments"]')].find(c => c.value.toLowerCase() === nameLower);
                if (cb && !cb.checked) cb.click();
                input.value = '';
                return;
            }
            if (customDepartments.some(d => d.toLowerCase() === nameLower)) {
                input.value = '';
                return;
            }

            customDepartments.push(name);
            input.value = '';
            renderCustomDeptTags();
            syncCustomDeptsToStepDropdowns();
        }

        function removeCustomDepartment(name) {
            const idx = customDepartments.indexOf(name);
            if (idx > -1) customDepartments.splice(idx, 1);
            renderCustomDeptTags();
            syncCustomDeptsToStepDropdowns();
        }

        function renderCustomDeptTags() {
            const container = document.getElementById('customDeptTags');
            container.innerHTML = '';
            customDepartments.forEach(name => {
                const tag = document.createElement('span');
                tag.className = 'custom-dept-tag';
                tag.textContent = name + ' ';
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.title = 'Remove';
                btn.innerHTML = '&times;';
                btn.addEventListener('click', () => removeCustomDepartment(name));
                tag.appendChild(btn);
                container.appendChild(tag);
            });
        }

        function syncCustomDeptsToStepDropdowns() {
            // Update all existing step department selects with custom departments
            document.querySelectorAll('select[id^="step_"][id$="_dept"]').forEach(select => {
                const currentVal = select.value;
                // Remove old custom optgroup if present
                const oldGroup = select.querySelector('optgroup[label="Custom"]');
                if (oldGroup) oldGroup.remove();

                if (customDepartments.length > 0) {
                    // Insert custom optgroup before the "Custom..." option
                    const customOptgroup = document.createElement('optgroup');
                    customOptgroup.label = 'Custom';
                    customDepartments.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        customOptgroup.appendChild(opt);
                    });
                    const otherOpt = select.querySelector('option[value="Other"]');
                    if (otherOpt) select.insertBefore(customOptgroup, otherOpt);
                    else select.appendChild(customOptgroup);
                }
                // Restore selection
                select.value = currentVal;
            });
        }

        function getDeptOptionsHTML() {
            let html = DEPT_OPTIONS;
            if (customDepartments.length > 0) {
                const customGroup = '<optgroup label="Custom">' +
                    customDepartments.map(d => `<option value="${d}">${d}</option>`).join('') +
                    '</optgroup>';
                html = html.replace('<option value="Other">Custom...</option>', customGroup + '<option value="Other">Custom...</option>');
            }
            return html;
        }

        // Toggle "Other" text input for radio groups
        function toggleRadioOther(radioName, inputId) {
            const selected = document.querySelector('input[name="' + radioName + '"]:checked');
            const input = document.getElementById(inputId);
            if (input) {
                input.style.display = (selected && selected.value === 'other') ? 'block' : 'none';
                if (selected && selected.value === 'other') input.focus();
                else input.value = '';
            }
        }

        // Toggle "Other" text input for select dropdowns
        function toggleOtherSelect(select, inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.style.display = select.value === 'Other' ? 'block' : 'none';
                if (select.value !== 'Other') input.value = '';
                if (select.value === 'Other') input.focus();
            }
        }

        // Toggle "Other" text input for step department selects (dynamic)
        function toggleStepDeptOther(select, stepIdx) {
            const inputId = 'step_' + stepIdx + '_deptOther';
            let input = document.getElementById(inputId);
            if (select.value === 'Other') {
                if (!input) {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.id = inputId;
                    input.className = 'step-custom-dept';
                    input.placeholder = 'Type custom department or team name...';
                    input.style.width = '100%';
                    input.style.padding = '0.9rem';
                    input.style.fontSize = '1rem';
                    input.style.border = '2px solid var(--border)';
                    input.style.borderRadius = 'var(--radius-sm)';
                    input.style.fontFamily = "'Work Sans', sans-serif";
                    select.closest('.list-item-content').appendChild(input);
                }
                input.style.display = 'block';
                input.focus();
            } else if (input) {
                input.style.display = 'none';
                input.value = '';
            }

            // Auto-set external toggle when an "External" department is selected
            if (select.value.startsWith('External')) {
                const extRadio = document.querySelector('input[name="step_' + stepIdx + '_ext"][value="external"]');
                if (extRadio) extRadio.checked = true;
            } else if (select.value && select.value !== 'Other') {
                const intRadio = document.querySelector('input[name="step_' + stepIdx + '_ext"][value="internal"]');
                if (intRadio) intRadio.checked = true;
            }
        }

        function populateScreen7() {
            updateProcessRefs();
            document.getElementById('exampleNameRef7').textContent = processData.lastExample.name || '';
            if (stepCount === 0) {
                addStep(); addStep(); addStep();
            }
        }

        // ── Step Import (upload image / paste text) ──
        function switchImportTab(tab, btn) {
            document.querySelectorAll('.step-import-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('importBodyUpload').style.display = tab === 'upload' ? '' : 'none';
            document.getElementById('importBodyPaste').style.display = tab === 'paste' ? '' : 'none';
        }

        // Drag-and-drop
        (function() {
            document.addEventListener('DOMContentLoaded', function() {
                var zone = document.getElementById('stepImportZone');
                if (!zone) return;
                var drop = document.getElementById('importDropArea');
                if (!drop) return;
                ['dragenter', 'dragover'].forEach(function(ev) {
                    drop.addEventListener(ev, function(e) { e.preventDefault(); zone.classList.add('drag-over'); });
                });
                ['dragleave', 'drop'].forEach(function(ev) {
                    drop.addEventListener(ev, function(e) { e.preventDefault(); zone.classList.remove('drag-over'); });
                });
                drop.addEventListener('drop', function(e) {
                    var files = e.dataTransfer.files;
                    if (files.length > 0) processImportFile(files[0]);
                });
            });
        })();

        function handleImportFile(input) {
            if (input.files && input.files[0]) processImportFile(input.files[0]);
        }

        function processImportFile(file) {
            var allowed = ['image/png', 'image/jpeg', 'image/gif', 'image/webp', 'application/pdf'];
            if (allowed.indexOf(file.type) === -1) {
                showBanner('Unsupported file type. Please upload an image (PNG, JPG, GIF, WebP) or PDF.', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                showBanner('File is too large. Maximum 10MB.', 'error');
                return;
            }

            var preview = document.getElementById('importFilePreview');
            var reader = new FileReader();
            reader.onload = function(e) {
                var base64Full = e.target.result;
                var base64Data = base64Full.split(',')[1];
                var mediaType = file.type;

                if (file.type.startsWith('image/')) {
                    preview.innerHTML = '<img src="' + base64Full + '" style="max-height:120px;max-width:100%;border-radius:8px;margin:0.5rem 0;" alt="Preview"><p style="font-size:0.82rem;color:var(--text-mid);">' + esc(file.name) + '</p>';
                } else {
                    preview.innerHTML = '<div style="padding:1rem;"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p style="font-size:0.82rem;color:var(--text-mid);margin-top:0.5rem;">' + esc(file.name) + '</p></div>';
                }
                preview.style.display = '';
                document.getElementById('importDropArea').style.display = 'none';

                sendExtractRequest({ imageBase64: base64Data, imageMediaType: mediaType });
            };
            reader.readAsDataURL(file);
        }

        function handleImportPaste() {
            var text = document.getElementById('importPasteText').value.trim();
            if (!text) { showBanner('Please paste your steps first.', 'error'); return; }
            sendExtractRequest({ text: text });
        }

        function sendExtractRequest(payload) {
            var status = document.getElementById('importStatus');
            var statusText = document.getElementById('importStatusText');
            status.style.display = 'flex';
            statusText.textContent = payload.imageBase64 ? 'Analysing your process map...' : 'Extracting steps from text...';

            var body = { mode: 'extract-steps' };
            if (payload.imageBase64) {
                body.imageBase64 = payload.imageBase64;
                body.imageMediaType = payload.imageMediaType;
            } else {
                body.text = payload.text;
            }

            fetch('/api/analyze-symptoms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                status.style.display = 'none';
                if (!data.success || !data.steps || data.steps.length === 0) {
                    showBanner('Could not extract steps: ' + (data.error || 'No steps found. Try a clearer image or more detailed text.'), 'error');
                    resetImportUI();
                    return;
                }
                if (data.processName) {
                    var nameInput = document.getElementById('processName');
                    if (nameInput && !nameInput.value.trim()) nameInput.value = data.processName;
                }
                populateStepsFromImport(data.steps);
            })
            .catch(function(err) {
                status.style.display = 'none';
                showBanner('Extraction failed. Please try again.', 'error');
                resetImportUI();
            });
        }

        function resetImportUI() {
            document.getElementById('importFilePreview').style.display = 'none';
            document.getElementById('importDropArea').style.display = '';
            document.getElementById('importFileInput').value = '';
        }

        function populateStepsFromImport(steps) {
            var list = document.getElementById('stepsList');
            list.innerHTML = '';
            stepCount = 0;
            _stepUid = 0;

            steps.forEach(function(s) {
                var div = addStep();
                var pfx = getStepPrefix(div);

                var nameEl = document.getElementById(pfx + '_name');
                if (nameEl) nameEl.value = s.name || '';

                var deptEl = document.getElementById(pfx + '_dept');
                if (deptEl && s.department) {
                    var opts = Array.from(deptEl.options).map(function(o) { return o.value; });
                    if (opts.indexOf(s.department) >= 0) {
                        deptEl.value = s.department;
                    } else if (s.department.includes('External')) {
                        var extOpt = opts.find(function(o) { return o.startsWith('External'); });
                        if (extOpt) deptEl.value = extOpt;
                        else deptEl.value = 'Other';
                    } else {
                        deptEl.value = 'Other';
                    }
                }

                if (s.isExternal) {
                    var extRadio = document.querySelector('input[name="' + pfx + '_ext"][value="external"]');
                    if (extRadio) { extRadio.checked = true; extRadio.dispatchEvent(new Event('change')); }
                }

                if (s.isDecision && s.branches && s.branches.length > 0) {
                    var uid = div.dataset.stepUid;
                    var uidKey = 'u' + uid;
                    var cb = document.getElementById(pfx + '_decision');
                    if (cb) { cb.checked = true; toggleDecisionBranches(uidKey); }
                    s.branches.forEach(function(br, bi) {
                        if (bi >= 2) addBranch(uidKey);
                        var lbl = document.getElementById(pfx + '_branch_' + bi + '_label');
                        var tgt = document.getElementById(pfx + '_branch_' + bi + '_target');
                        if (lbl) lbl.value = br.label || '';
                        if (tgt) tgt.value = br.target || '';
                    });
                }
            });

            // Collapse the import zone to show the populated steps
            var zone = document.getElementById('stepImportZone');
            zone.style.maxHeight = '0';
            zone.style.overflow = 'hidden';
            zone.style.padding = '0';
            zone.style.border = 'none';
            zone.style.marginBottom = '0';

            // Add a small banner showing import was successful
            var banner = document.createElement('div');
            banner.style.cssText = 'padding:0.6rem 1rem;background:linear-gradient(135deg,rgba(22,163,74,0.08),rgba(22,163,74,0.03));border:1px solid rgba(22,163,74,0.2);border-radius:var(--radius-sm);margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between;font-size:0.85rem;';
            banner.innerHTML = '<span style="color:#16a34a;font-weight:500;">&#10003; ' + steps.length + ' steps imported — review and adjust below</span><button onclick="this.parentElement.remove();var z=document.getElementById(\'stepImportZone\');z.style.maxHeight=\'\';z.style.overflow=\'\';z.style.padding=\'\';z.style.border=\'\';z.style.marginBottom=\'\';" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:0.82rem;font-family:inherit;">Import again</button>';
            var list = document.getElementById('stepsList');
            list.parentElement.insertBefore(banner, list);
        }

        const MAX_STEPS = 50;
        let _stepUid = 0;
        let _currentContributor = '';
        let _handoverData = null;
        let _dragHandleActive = false;

        document.addEventListener('pointerup', function() { _dragHandleActive = false; });

        function addStep(afterElement, beforeElement) {
            if (stepCount >= MAX_STEPS) return;
            const list = document.getElementById('stepsList');
            const uid = _stepUid++;

            const div = document.createElement('div');
            div.className = 'list-item';
            div.dataset.stepUid = uid;
            if (_currentContributor) div.dataset.contributor = _currentContributor;
            div.innerHTML = `
                <div class="step-drag-handle" title="Drag to reorder">
                    <svg width="12" height="18" viewBox="0 0 12 18" fill="currentColor"><circle cx="3" cy="3" r="1.5"/><circle cx="9" cy="3" r="1.5"/><circle cx="3" cy="9" r="1.5"/><circle cx="9" cy="9" r="1.5"/><circle cx="3" cy="15" r="1.5"/><circle cx="9" cy="15" r="1.5"/></svg>
                </div>
                <div class="list-item-number"></div>
                <div class="list-item-content">
                    <input type="text" id="step_u${uid}_name" placeholder="Step name, e.g., Create customer account">
                    <div class="step-dept-row">
                        <select id="step_u${uid}_dept" onchange="toggleStepDeptOther(this, 'u${uid}')">${getDeptOptionsHTML()}</select>
                        <div class="int-ext-toggle">
                            <label title="Internal team/department">
                                <input type="radio" name="step_u${uid}_ext" value="internal" checked>
                                <span>INT</span>
                            </label>
                            <label title="External party (vendor, client, regulator, etc.)">
                                <input type="radio" name="step_u${uid}_ext" value="external">
                                <span>EXT</span>
                            </label>
                        </div>
                    </div>
                    <div class="step-decision-toggle">
                        <input type="checkbox" id="step_u${uid}_decision" onchange="toggleDecisionBranches('u${uid}')">
                        <label for="step_u${uid}_decision">This step has a decision / routing point</label>
                    </div>
                    <div class="step-branches" id="step_u${uid}_branches">
                        <div class="step-branches-label">&#9670; Define the possible routes from this step:</div>
                        <div id="step_u${uid}_branchList">
                            <div class="branch-row">
                                <span class="branch-icon">&#10132;</span>
                                <input type="text" id="step_u${uid}_branch_0_label" placeholder="Route label, e.g., Approved">
                                <input type="text" id="step_u${uid}_branch_0_target" placeholder="Goes to... e.g., Step 5 or Send Invoice" style="max-width: 180px;">
                            </div>
                            <div class="branch-row">
                                <span class="branch-icon">&#10132;</span>
                                <input type="text" id="step_u${uid}_branch_1_label" placeholder="Route label, e.g., Rejected">
                                <input type="text" id="step_u${uid}_branch_1_target" placeholder="Goes to... e.g., Step 3 or Review" style="max-width: 180px;">
                            </div>
                        </div>
                        <button type="button" class="add-branch-btn" onclick="addBranch('u${uid}')">+ Add another route</button>
                    </div>
                    <div class="step-contributor-badge" style="display:none;" id="step_u${uid}_contributor"></div>
                </div>
                <div class="step-item-actions">
                    <button type="button" class="remove-item" onclick="removeStep(this)">Remove</button>
                </div>
            `;

            if (beforeElement) {
                list.insertBefore(div, beforeElement);
            } else if (afterElement) {
                const afterDivider = afterElement.nextElementSibling;
                if (afterDivider && afterDivider.classList.contains('insert-step-divider')) {
                    afterDivider.after(div);
                } else {
                    afterElement.after(div);
                }
            } else {
                list.appendChild(div);
            }

            const insertDiv = document.createElement('div');
            insertDiv.className = 'insert-step-divider';
            insertDiv.innerHTML = '<button type="button" onclick="insertStepAfter(this)" title="Insert a step here">+</button>';
            div.after(insertDiv);

            // Wire drag handle — flag-based so browser sees draggable before gesture starts
            div.setAttribute('draggable', 'true');
            const handle = div.querySelector('.step-drag-handle');
            handle.addEventListener('pointerdown', function() { _dragHandleActive = true; });

            // Show contributor badge if tagged
            if (div.dataset.contributor) {
                const badge = document.getElementById('step_u' + uid + '_contributor');
                if (badge) {
                    badge.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4-4v2"/><circle cx="12" cy="7" r="4"/></svg> ' + esc(div.dataset.contributor);
                    badge.style.display = 'inline-flex';
                }
            }

            div.querySelectorAll('.int-ext-toggle input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const toggle = this.closest('.int-ext-toggle');
                    toggle.querySelectorAll('label').forEach(lbl => lbl.classList.remove('active'));
                    this.closest('label').classList.add('active');
                });
            });
            const checkedRadio = div.querySelector('.int-ext-toggle input:checked');
            if (checkedRadio) checkedRadio.closest('label').classList.add('active');

            renumberSteps();
            return div;
        }

        function insertStepAfter(btn) {
            const divider = btn.closest('.insert-step-divider');
            if (!divider) return;
            const prevStep = divider.previousElementSibling;
            if (!prevStep || !prevStep.classList.contains('list-item')) return;
            if (stepCount >= MAX_STEPS) return;
            const newStep = addStep(prevStep);
            if (newStep) {
                const nameInput = newStep.querySelector('input[type="text"]');
                if (nameInput) {
                    nameInput.focus();
                    nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function toggleDecisionBranches(idx) {
            const cb = document.getElementById('step_' + idx + '_decision');
            const panel = document.getElementById('step_' + idx + '_branches');
            if (cb.checked) {
                panel.classList.add('show');
            } else {
                panel.classList.remove('show');
            }
        }

        const branchCounts = {};
        function addBranch(stepIdx) {
            if (!branchCounts[stepIdx]) branchCounts[stepIdx] = 2;
            const bIdx = branchCounts[stepIdx];
            branchCounts[stepIdx]++;

            const row = document.createElement('div');
            row.className = 'branch-row';
            row.innerHTML = `
                <span class="branch-icon">&#10132;</span>
                <input type="text" id="step_${stepIdx}_branch_${bIdx}_label" placeholder="Route label">
                <input type="text" id="step_${stepIdx}_branch_${bIdx}_target" placeholder="Goes to..." style="max-width: 180px;">
                <button type="button" class="branch-remove" onclick="this.parentElement.remove()">&times;</button>
            `;
            document.getElementById('step_' + stepIdx + '_branchList').appendChild(row);
        }

        function removeStep(elOrIdx) {
            let el;
            if (typeof elOrIdx === 'object') {
                el = elOrIdx.closest('.list-item');
            } else {
                el = document.querySelector('[data-step-index="' + elOrIdx + '"]') ||
                     document.querySelector('[data-step-uid="' + elOrIdx + '"]');
            }
            if (el) {
                const nextSib = el.nextElementSibling;
                if (nextSib && nextSib.classList.contains('insert-step-divider')) {
                    nextSib.remove();
                }
                el.remove();
            }
            renumberSteps();
        }

        function renumberSteps() {
            const list = document.getElementById('stepsList');
            const items = list.querySelectorAll('.list-item');
            items.forEach((item, i) => {
                const num = item.querySelector('.list-item-number');
                if (num) num.textContent = i + 1;
                const actions = item.querySelector('.step-item-actions');
                if (actions) {
                    const removeBtn = actions.querySelector('.remove-item');
                    if (removeBtn) removeBtn.style.display = items.length <= 3 ? 'none' : '';
                }
            });
            stepCount = items.length;
            const atMax = stepCount >= MAX_STEPS;
            document.getElementById('addStepBtn').style.display = atMax ? 'none' : '';
            list.querySelectorAll('.insert-step-divider').forEach(d => {
                d.style.display = atMax ? 'none' : '';
            });

            // Ensure a leading insert divider exists before the first step
            if (items.length > 0) {
                const first = list.firstElementChild;
                if (!first || !first.classList.contains('insert-step-divider')) {
                    const leadDiv = document.createElement('div');
                    leadDiv.className = 'insert-step-divider insert-step-leading';
                    leadDiv.innerHTML = '<button type="button" onclick="insertStepAtStart()" title="Insert a step at the beginning">+</button>';
                    list.insertBefore(leadDiv, first);
                    if (atMax) leadDiv.style.display = 'none';
                }
            }
        }

        function insertStepAtStart() {
            if (stepCount >= MAX_STEPS) return;
            const firstStep = document.querySelector('#stepsList .list-item');
            if (!firstStep) return;
            const newStep = addStep(null, firstStep);
            if (newStep) {
                const nameInput = newStep.querySelector('input[type="text"]');
                if (nameInput) {
                    nameInput.focus();
                    nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function getStepPrefix(item) {
            if (item.dataset.stepUid !== undefined) return 'step_u' + item.dataset.stepUid;
            return 'step_' + item.dataset.stepIndex;
        }

        function collectSteps() {
            const items = document.querySelectorAll('#stepsList .list-item');
            const steps = [];
            items.forEach((item, i) => {
                const pfx = getStepPrefix(item);
                const name = document.getElementById(pfx + '_name')?.value?.trim() || '';
                let dept = document.getElementById(pfx + '_dept')?.value || '';
                if (dept === 'Other') {
                    const otherVal = document.getElementById(pfx + '_deptOther')?.value?.trim();
                    if (otherVal) dept = otherVal;
                }
                const extRadio = document.querySelector('input[name="' + pfx + '_ext"]:checked');
                const isExternal = extRadio ? extRadio.value === 'external' : false;

                const isDecision = document.getElementById(pfx + '_decision')?.checked || false;
                let branches = [];
                if (isDecision) {
                    const branchList = document.getElementById(pfx + '_branchList');
                    if (branchList) {
                        branchList.querySelectorAll('.branch-row').forEach(row => {
                            const inputs = row.querySelectorAll('input[type="text"]');
                            const label = inputs[0]?.value?.trim() || '';
                            const target = inputs[1]?.value?.trim() || '';
                            if (label) branches.push({ label, target });
                        });
                    }
                }

                if (name) {
                    const step = { number: i + 1, name, department: dept, isExternal };
                    if (isDecision && branches.length > 0) {
                        step.isDecision = true;
                        step.branches = branches;
                    }
                    if (item.dataset.contributor) step.contributor = item.dataset.contributor;
                    steps.push(step);
                }
            });
            return steps;
        }

        // ============================================================
        // SCREEN 8: HANDOFF ANALYSIS
        // ============================================================
        function buildHandoffBlocks() {
            processData.steps = collectSteps();
            const container = document.getElementById('handoffContainer');
            container.innerHTML = '';

            if (processData.steps.length < 2) {
                container.innerHTML = '<p style="color: var(--text-mid);">Need at least 2 steps to analyse handoffs.</p>';
                return;
            }

            for (let i = 0; i < processData.steps.length - 1; i++) {
                const from = processData.steps[i];
                const to = processData.steps[i + 1];

                const block = document.createElement('div');
                block.className = 'handoff-block';
                const fromBadge = from.isExternal ? '<span style="font-size:0.7rem;background:#fef3c7;color:#92400e;padding:1px 6px;border-radius:3px;margin-left:4px;">EXT</span>' : '';
                const toBadge = to.isExternal ? '<span style="font-size:0.7rem;background:#fef3c7;color:#92400e;padding:1px 6px;border-radius:3px;margin-left:4px;">EXT</span>' : '';
                const decBadge = from.isDecision ? '<span style="font-size:0.7rem;background:#ede9fe;color:#6d28d9;padding:1px 6px;border-radius:3px;margin-left:4px;">&#9670; DECISION</span>' : '';
                const branchNote = from.isDecision && from.branches ? '<div style="font-size:0.8rem;color:#6d28d9;margin-top:4px;padding:4px 8px;background:#f5f3ff;border-radius:4px;">Routes: ' + from.branches.map(b => '<strong>' + b.label + '</strong>' + (b.target ? ' → ' + b.target : '')).join(' · ') + '</div>' : '';
                block.innerHTML = `
                    <div class="handoff-header">
                        Step ${from.number}: ${from.name} (${from.department || '?'})${fromBadge}${decBadge}
                        <span class="handoff-arrow"> &rarr; </span>
                        Step ${to.number}: ${to.name} (${to.department || '?'})${toBadge}
                    </div>
                    ${branchNote}
                    <div class="form-group">
                        <label>How did ${from.department || 'Step ' + from.number} notify ${to.department || 'Step ' + to.number}?</label>
                        <div class="radio-group">
                            <label class="radio-option"><input type="radio" name="handoffMethod_${i}" value="email-details"> Email with all details</label>
                            <label class="radio-option"><input type="radio" name="handoffMethod_${i}" value="email-check"> Email saying "check the system"</label>
                            <label class="radio-option"><input type="radio" name="handoffMethod_${i}" value="slack"> Slack/Teams message</label>
                            <label class="radio-option"><input type="radio" name="handoffMethod_${i}" value="spreadsheet"> Updated a shared spreadsheet</label>
                            <label class="radio-option"><input type="radio" name="handoffMethod_${i}" value="in-person"> In-person handoff</label>
                            <label class="radio-option"><input type="radio" name="handoffMethod_${i}" value="verbal"> Phone/meeting</label>
                            <label class="radio-option"><input type="radio" name="handoffMethod_${i}" value="they-knew"> They just... knew to check</label>
                            <label class="radio-option"><input type="radio" name="handoffMethod_${i}" value="other" onchange="toggleRadioOther('handoffMethod_${i}', 'handoffMethodOther_${i}')"> Other</label>
                            <input type="text" id="handoffMethodOther_${i}" placeholder="Please describe..." style="display: none; margin-top: 0.5rem;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Did ${to.department || 'Step ' + to.number} come back asking for clarification?</label>
                        <div class="radio-group">
                            <label class="radio-option"><input type="radio" name="handoffClarity_${i}" value="no"> No - had everything needed</label>
                            <label class="radio-option"><input type="radio" name="handoffClarity_${i}" value="yes-once"> Yes - once (minor clarification)</label>
                            <label class="radio-option"><input type="radio" name="handoffClarity_${i}" value="yes-multiple"> Yes - 2-3 back and forth</label>
                            <label class="radio-option"><input type="radio" name="handoffClarity_${i}" value="yes-major"> Yes - 4+ exchanges (major issues)</label>
                        </div>
                    </div>
                `;
                container.appendChild(block);
            }
        }

        function collectHandoffs() {
            const handoffs = [];
            for (let i = 0; i < processData.steps.length - 1; i++) {
                handoffs.push({
                    from: processData.steps[i],
                    to: processData.steps[i + 1],
                    method: getRadioValue('handoffMethod_' + i),
                    clarity: getRadioValue('handoffClarity_' + i)
                });
            }
            return handoffs;
        }

        // ============================================================
        // SCREEN 9: BOTTLENECK
        // ============================================================
        function populateScreen9() {
            processData.handoffs = collectHandoffs();

            // Populate step dropdowns
            const longestSelect = document.getElementById('longestStep');
            const bottleneckSelect = document.getElementById('biggestBottleneck');
            longestSelect.innerHTML = '<option value="">Select step...</option>';
            bottleneckSelect.innerHTML = '<option value="">Select one...</option>';

            processData.steps.forEach((s, i) => {
                const opt1 = document.createElement('option');
                opt1.value = 'step-' + i;
                opt1.textContent = `Step ${s.number}: ${s.name}`;
                longestSelect.appendChild(opt1);

                const opt2 = opt1.cloneNode(true);
                bottleneckSelect.appendChild(opt2);
            });

            // Add handoffs to bottleneck dropdown
            for (let i = 0; i < processData.steps.length - 1; i++) {
                const opt = document.createElement('option');
                opt.value = 'handoff-' + i;
                opt.textContent = `Handoff: ${processData.steps[i].name} \u2192 ${processData.steps[i + 1].name}`;
                bottleneckSelect.appendChild(opt);
            }
        }

        // ============================================================
        // SCREEN 10: SYSTEMS
        // ============================================================
        function populateScreen10() {
            updateProcessRefs();
            document.getElementById('exampleNameRef10').textContent = processData.lastExample.name || '';
            if (systemCount === 0) addSystem();
        }

        function addSystem() {
            const list = document.getElementById('systemsList');
            const idx = systemCount;
            systemCount++;

            const div = document.createElement('div');
            div.className = 'list-item';
            div.dataset.systemIndex = idx;
            div.innerHTML = `
                <div class="list-item-number">${systemCount}</div>
                <div class="list-item-content">
                    <input type="text" id="system_${idx}_name" placeholder="e.g., Salesforce, Gmail, NetSuite..." oninput="updateSystemsSummary()">
                    <input type="text" id="system_${idx}_purpose" placeholder="Purpose: e.g., Check deal status">
                    <div class="checkbox-group" style="margin-top: 0.5rem;">
                        <label class="checkbox-option" style="padding: 0.4rem;"><input type="checkbox" name="system_${idx}_actions" value="read" onchange="updateSystemsSummary()"> Read data only</label>
                        <label class="checkbox-option" style="padding: 0.4rem;"><input type="checkbox" name="system_${idx}_actions" value="copy-out" onchange="updateSystemsSummary()"> Copy data OUT</label>
                        <label class="checkbox-option" style="padding: 0.4rem;"><input type="checkbox" name="system_${idx}_actions" value="copy-in" onchange="updateSystemsSummary()"> Copy data IN</label>
                        <label class="checkbox-option" style="padding: 0.4rem;"><input type="checkbox" name="system_${idx}_actions" value="reconcile" onchange="updateSystemsSummary()"> Manual reconciliation</label>
                    </div>
                </div>
                ${systemCount > 1 ? '<button type="button" class="remove-item" onclick="removeSystem(' + idx + ')">Remove</button>' : ''}
            `;
            list.appendChild(div);
        }

        function removeSystem(idx) {
            const el = document.querySelector('[data-system-index="' + idx + '"]');
            if (el) el.remove();
            renumberSystems();
            updateSystemsSummary();
        }

        function renumberSystems() {
            const items = document.querySelectorAll('#systemsList .list-item');
            items.forEach((item, i) => {
                const num = item.querySelector('.list-item-number');
                if (num) num.textContent = i + 1;
            });
            systemCount = items.length;
        }

        function collectSystems() {
            const items = document.querySelectorAll('#systemsList .list-item');
            const systems = [];
            items.forEach(item => {
                const idx = item.dataset.systemIndex;
                const name = document.getElementById('system_' + idx + '_name')?.value?.trim();
                if (name) {
                    const actions = [];
                    document.querySelectorAll('input[name="system_' + idx + '_actions"]:checked').forEach(cb => actions.push(cb.value));
                    systems.push({
                        name,
                        purpose: document.getElementById('system_' + idx + '_purpose')?.value?.trim() || '',
                        actions
                    });
                }
            });
            return systems;
        }

        function updateSystemsSummary() {
            const systems = collectSystems();
            const copyCount = systems.filter(s => s.actions.includes('copy-out') || s.actions.includes('copy-in')).length;
            const reconcileCount = systems.filter(s => s.actions.includes('reconcile')).length;
            document.getElementById('systemsSummary').textContent =
                `Systems used: ${systems.length} | Manual copy: ${copyCount} | Reconciliation: ${reconcileCount}`;
        }

        // ============================================================
        // SCREEN 11: APPROVALS
        // ============================================================
        function buildApprovalEntries() {
            const count = parseInt(document.getElementById('approvalCount').value) || 0;
            const container = document.getElementById('approvalsList');
            container.innerHTML = '';

            for (let i = 0; i < Math.min(count, 10); i++) {
                const entry = document.createElement('div');
                entry.className = 'approval-entry';
                entry.innerHTML = `
                    <div class="approval-header">Approval #${i + 1}</div>
                    <div class="form-group">
                        <label>Approval name:</label>
                        <input type="text" id="approval_${i}_name" placeholder="e.g., Finance approval for new account">
                    </div>
                    <div class="form-group">
                        <label>Who must approve?</label>
                        <input type="text" id="approval_${i}_who" placeholder="e.g., CFO or Finance Director">
                    </div>
                    <div class="form-group">
                        <label>Rounds of back-and-forth:</label>
                        <div class="radio-group">
                            <label class="radio-option"><input type="radio" name="approval_${i}_rounds" value="one"> Approved immediately</label>
                            <label class="radio-option"><input type="radio" name="approval_${i}_rounds" value="2-3"> 2-3 minor revisions</label>
                            <label class="radio-option"><input type="radio" name="approval_${i}_rounds" value="4-6"> 4-6 multiple iterations</label>
                            <label class="radio-option"><input type="radio" name="approval_${i}_rounds" value="7+"> 7+ painful process</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>For this amount/risk, this approval process is:</label>
                        <div class="radio-group">
                            <label class="radio-option"><input type="radio" name="approval_${i}_assessment" value="too-loose"> Too loose - needs MORE oversight</label>
                            <label class="radio-option"><input type="radio" name="approval_${i}_assessment" value="just-right"> Just right - appropriate</label>
                            <label class="radio-option"><input type="radio" name="approval_${i}_assessment" value="too-tight"> Too tight - slows things down</label>
                            <label class="radio-option"><input type="radio" name="approval_${i}_assessment" value="bureaucratic"> Way too bureaucratic</label>
                        </div>
                    </div>
                `;
                container.appendChild(entry);
            }
        }

        // ============================================================
        // SCREEN 12: KNOWLEDGE
        // ============================================================
        function toggleAskWho() {
            const val = getRadioValue('knowledgeFirst');
            document.getElementById('askWhoSection').style.display = val === 'ask-someone' ? 'block' : 'none';
        }

        // ============================================================
        // SCREEN 14: FREQUENCY
        // ============================================================
        const FREQUENCY_MAP = {
            'multi-daily': 600, 'daily': 300, '2-3-week': 120, 'weekly': 54,
            '2-3-month': 30, 'monthly': 12, 'less': 6
        };

        function updateAnnualInstances() {
            const freq = getRadioValue('frequency');
            const annual = FREQUENCY_MAP[freq] || 0;
            processData.frequency.type = freq;
            processData.frequency.annual = annual;
            document.getElementById('annualInstances').textContent = annual + ' per year';
        }

        // ============================================================
        // SCREEN 15: COST CALCULATION
        // ============================================================
        function populateScreen15() {
            updateProcessRefs();
            const t = processData.userTime;
            document.getElementById('costBreakdownValue').innerHTML =
                `Meetings: ~${t.meetings}h &middot; Emails: ~${t.emails}h &middot; Execution: ~${t.execution}h &middot; Waiting: ~${t.waiting}h<br><strong>Total: ~${t.total} hours</strong>`;
            calculateCosts();
        }

        function calculateCosts() {
            const rate = parseFloat(document.getElementById('hourlyRate').value) || 50;
            const totalHours = processData.userTime.total;
            const annual = processData.frequency.annual;

            const instanceCost = totalHours * rate;
            const involvement = 0.75;
            const annualUserCost = instanceCost * annual * involvement;

            processData.costs.hourlyRate = rate;
            processData.costs.instanceCost = instanceCost;
            processData.costs.annualUserCost = annualUserCost;

            document.getElementById('instanceCost').textContent = formatCurrency(instanceCost);
            document.getElementById('instanceCostFormula').textContent = `${totalHours} hours \u00D7 \u00A3${rate}/hr`;
            document.getElementById('annualInstancesCost').textContent = annual + ' per year';
            document.getElementById('annualUserCost').textContent = formatCurrency(annualUserCost);
            document.getElementById('annualUserCostFormula').textContent =
                `\u00A3${formatCurrency(instanceCost)} \u00D7 ${annual} instances \u00D7 75% involvement`;
        }

        // ============================================================
        // SCREEN 16: TEAM COST & SAVINGS
        // ============================================================
        function populateScreen16() {
            updateProcessRefs();
            calculateTeamCost();

            const days = processData.lastExample.elapsedDays;
            document.getElementById('currentAvg').textContent = days + ' days';
            document.getElementById('halfTime').textContent = Math.round(days / 2) + ' days';
        }

        function calculateTeamCost() {
            const teamSize = parseInt(document.getElementById('teamPeopleCount').value) || 1;
            processData.costs.teamSize = teamSize;

            const totalAnnual = processData.costs.annualUserCost * teamSize;
            processData.costs.totalAnnualCost = totalAnnual;

            document.getElementById('totalAnnualCost').textContent = formatCurrency(totalAnnual);
            document.getElementById('totalAnnualCostFormula').textContent =
                `\u00A3${formatCurrency(processData.costs.annualUserCost)} \u00D7 ${teamSize} people`;

            const savings = totalAnnual * 0.5;
            processData.savings.if50Faster = savings;
            document.getElementById('annualSavings').textContent = formatCurrency(savings);
            document.getElementById('annualSavingsFormula').textContent =
                `\u00A3${formatCurrency(totalAnnual)} \u00D7 50% improvement`;

            // Team recap from steps
            const teamRecap = document.getElementById('teamRecap');
            if (processData.steps.length > 0) {
                const depts = [...new Set(processData.steps.map(s => s.department).filter(Boolean))];
                teamRecap.innerHTML = '<p class="helper-text" style="margin-bottom: 1rem;">Departments from your steps: <strong>' + depts.join(', ') + '</strong></p>';
            }
        }

        // ============================================================
        // SCREEN 17: PRIORITY
        // ============================================================
        function populateScreen17() {
            updateProcessRefs();
            const summary = document.getElementById('prioritySummary');
            const days = processData.lastExample.elapsedDays;
            const cost = processData.costs.totalAnnualCost;
            const annual = processData.frequency.annual;

            summary.innerHTML = `
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value">${days} days</div>
                        <div class="metric-label">Average cycle time</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${formatCurrency(cost)}</div>
                        <div class="metric-label">Annual cost</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${processData.costs.teamSize}</div>
                        <div class="metric-label">People involved</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${annual}/yr</div>
                        <div class="metric-label">Annual instances</div>
                    </div>
                </div>
            `;
        }

        function handleProcessComplete() {
            // Collect final data for this process
            collectAllProcessData();

            const another = getRadioValue('anotherProcess');
            if (!another) {
                showError(17, 'Please select whether you want to analyse another process.');
                return;
            }

            // Save completed process
            completedProcesses.push(JSON.parse(JSON.stringify(processData)));

            if (another === 'yes' && completedProcesses.length < 3) {
                processData = createEmptyProcess();
                stepCount = 0;
                _stepUid = 0;
                systemCount = 0;
                document.getElementById('stepsList').innerHTML = '';
                document.getElementById('systemsList').innerHTML = '';
                goToScreen(1);
            } else {
                if (completedProcesses.length >= 2) {
                    showDependencyMapping();
                } else {
                    goToScreen(18);
                }
            }
        }

        // ============================================================
        // EDIT A COMPLETED PROCESS (used in edit mode)
        // ============================================================
        let editingProcessIndex = -1;

        function editProcess(index) {
            if (index < 0 || index >= completedProcesses.length) return;

            // Pull the process out and load it into processData
            editingProcessIndex = index;
            processData = JSON.parse(JSON.stringify(completedProcesses[index]));

            // Rebuild steps DOM from processData.steps
            rebuildStepsFromData(processData.steps || []);

            // Rebuild systems DOM from processData.systems
            rebuildSystemsFromData(processData.systems || []);

            // Navigate to screen 2 (process name) so the user can walk through
            goToScreen(2);

            // Show a banner
            const banner = document.getElementById('resumeBanner');
            if (banner) {
                banner.innerHTML = '<strong>Editing:</strong> ' +
                    (processData.processName || 'Process #' + (index + 1)).replace(/</g, '&lt;') +
                    '. Walk through each section and update as needed. When done, continue to re-submit.';
                banner.style.background = 'linear-gradient(135deg, rgba(61,142,166,0.08), rgba(61,142,166,0.03))';
                banner.style.color = 'var(--accent)';
                banner.style.borderColor = 'rgba(61,142,166,0.2)';
                banner.classList.add('show');
            }
        }

        function rebuildStepsFromData(steps) {
            const list = document.getElementById('stepsList');
            list.innerHTML = '';
            stepCount = 0;
            _stepUid = 0;

            if (steps.length === 0) {
                addStep(); addStep(); addStep();
                return;
            }

            steps.forEach((s) => {
                const prevContributor = _currentContributor;
                if (s.contributor) _currentContributor = s.contributor;
                const div = addStep();
                _currentContributor = prevContributor;
                const pfx = getStepPrefix(div);

                const nameEl = document.getElementById(pfx + '_name');
                if (nameEl) nameEl.value = s.name || '';

                const deptEl = document.getElementById(pfx + '_dept');
                if (deptEl && s.department) {
                    const options = Array.from(deptEl.options).map(o => o.value);
                    if (options.includes(s.department)) {
                        deptEl.value = s.department;
                    } else {
                        deptEl.value = 'Other';
                    }
                }

                if (s.isExternal) {
                    const extRadio = document.querySelector('input[name="' + pfx + '_ext"][value="external"]');
                    if (extRadio) {
                        extRadio.checked = true;
                        extRadio.dispatchEvent(new Event('change'));
                    }
                }

                const uid = div.dataset.stepUid;
                const uidKey = 'u' + uid;
                if (s.isDecision) {
                    const cb = document.getElementById(pfx + '_decision');
                    if (cb) {
                        cb.checked = true;
                        toggleDecisionBranches(uidKey);
                    }
                    if (s.branches && s.branches.length > 0) {
                        s.branches.forEach((br, bi) => {
                            if (bi >= 2) addBranch(uidKey);
                            const labelEl = document.getElementById(pfx + '_branch_' + bi + '_label');
                            const targetEl = document.getElementById(pfx + '_branch_' + bi + '_target');
                            if (labelEl) labelEl.value = br.label || '';
                            if (targetEl) targetEl.value = br.target || '';
                        });
                    }
                }
            });
        }

        function rebuildSystemsFromData(systems) {
            const list = document.getElementById('systemsList');
            list.innerHTML = '';
            systemCount = 0;

            if (systems.length === 0) {
                addSystem(); addSystem();
                return;
            }

            systems.forEach((sys, i) => {
                addSystem();
                const idx = i;
                const nameEl = document.getElementById('system_' + idx + '_name');
                if (nameEl) nameEl.value = sys.name || '';

                const purposeEl = document.getElementById('system_' + idx + '_purpose');
                if (purposeEl) purposeEl.value = sys.purpose || '';

                if (sys.actions && sys.actions.length > 0) {
                    sys.actions.forEach(action => {
                        const cb = document.getElementById('system_' + idx + '_' + action);
                        if (cb) cb.checked = true;
                    });
                }
            });
        }

        // Override handleProcessComplete for edit mode: replace the process instead of pushing
        const _origHandleProcessComplete = handleProcessComplete;
        handleProcessComplete = function() {
            if (editingProcessIndex >= 0) {
                collectAllProcessData();

                const another = getRadioValue('anotherProcess');
                if (!another) {
                    showError(17, 'Please select whether you want to analyse another process.');
                    return;
                }

                // Replace the process at the editing index
                completedProcesses[editingProcessIndex] = JSON.parse(JSON.stringify(processData));
                editingProcessIndex = -1;

                if (another === 'yes' && completedProcesses.length < 3) {
                    processData = createEmptyProcess();
                    stepCount = 0;
                    _stepUid = 0;
                    systemCount = 0;
                    document.getElementById('stepsList').innerHTML = '';
                    document.getElementById('systemsList').innerHTML = '';
                    goToScreen(1);
                } else {
                    goToScreen(18);
                }
            } else {
                _origHandleProcessComplete();
            }
        };

        // ============================================================
        // SCREEN 18: CONTACT
        // ============================================================
        function populateScreen18() {
            const summary = document.getElementById('processesSummary');
            let totalCost = 0;
            let html = '<h3 style="margin-bottom: 1rem;">You\'ve analysed:</h3>';

            completedProcesses.forEach((p, i) => {
                totalCost += p.costs.totalAnnualCost;
                const editBtn = editingReportId
                    ? ` <button onclick="editProcess(${i})" style="float:right;padding:4px 14px;background:transparent;color:var(--accent);border:1.5px solid var(--accent);border-radius:100px;font-size:0.78rem;font-weight:500;cursor:pointer;font-family:inherit;">Edit</button>`
                    : '';
                html += `<div class="calculated">
                    <div class="calculated-label">Process #${i + 1}: ${p.processName}${editBtn}</div>
                    <div class="calculated-value" style="font-size: 1.3rem;">${formatCurrency(p.costs.totalAnnualCost)}/year</div>
                    <div class="calculated-formula">${p.lastExample.elapsedDays} day cycle &middot; ${p.frequency.annual} instances/year &middot; ${p.costs.teamSize} people</div>
                </div>`;
            });

            html += `<div class="calculated" style="background: linear-gradient(135deg, rgba(61, 142, 166, 0.15), rgba(61, 142, 166, 0.05)); border-left: 4px solid var(--primary);">
                <div class="calculated-label" style="font-weight: 600;">Total annual cost:</div>
                <div class="calculated-value" style="font-size: 2rem; color: var(--primary);">${formatCurrency(totalCost)}</div>
                <div class="calculated-formula">Potential savings (50% improvement): ${formatCurrency(totalCost * 0.5)}</div>
            </div>`;

            summary.innerHTML = html;
        }

        // ============================================================
        // SUBMIT & RESULTS
        // ============================================================
        async function submitDiagnostic() {
            // Validate contact info
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            if (!name || !email) {
                showError(18, 'Please provide your name and email.');
                return;
            }

            const contact = {
                name,
                email,
                company: document.getElementById('contactCompany').value.trim(),
                title: document.getElementById('contactTitle').value.trim(),
                teamSize: getRadioValue('teamSize'),
                industry: document.getElementById('contactIndustry').value === 'Other'
                    ? (document.getElementById('industryOther')?.value?.trim() || 'Other')
                    : document.getElementById('contactIndustry').value
            };

            // Submit team response if in team mode
            submitTeamResponse();

            goToScreen(19);
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';

            const payload = {
                processes: completedProcesses,
                contact,
                qualityScore: calculateQualityScore(),
                timestamp: new Date().toISOString()
            };

            try {
                const resp = await fetch('/api/process-diagnostic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) throw new Error('API returned ' + resp.status);
                const result = await resp.json();
                displayResults(result, contact);
                autoSaveReport(result, contact);
            } catch (err) {
                console.warn('API unavailable, using client-side analysis:', err.message);
                const result = buildLocalResults(completedProcesses, contact);
                displayResults(result, contact);
                autoSaveReport(result, contact);
            }
        }

        async function autoSaveReport(result, contact) {
            try {
                var scoreData = typeof lastScoreData !== 'undefined' ? lastScoreData : null;
                var roadmapData = typeof lastRoadmapData !== 'undefined' ? lastRoadmapData : null;
                var payload = {
                    contact: {
                        name: contact.name || '',
                        email: contact.email || '',
                        company: contact.company || '',
                        title: contact.title || '',
                        industry: contact.industry || '',
                        teamSize: contact.teamSize || ''
                    },
                    summary: {
                        totalProcesses: (result.processes || []).length,
                        totalAnnualCost: result.totalCost || 0,
                        potentialSavings: result.potentialSavings || 0,
                        analysisType: result.analysisType || 'rule-based',
                        qualityScore: result.qualityScore?.averageScore || 0
                    },
                    recommendations: result.recommendations || [],
                    automationScore: scoreData ? {
                        percentage: scoreData.readinessScore,
                        grade: scoreData.scoreGrade,
                        categories: scoreData.cats,
                        totalSteps: scoreData.totalSteps,
                        totalAutomatable: scoreData.totalAutomatable
                    } : {},
                    roadmap: roadmapData ? {
                        phases: roadmapData.phases,
                        totalSavings: roadmapData.annualSavings,
                        cumulative: roadmapData.cumulative
                    } : {},
                    processes: result.processes || [],
                    rawProcesses: completedProcesses || [],
                    customDepartments: (typeof customDepartments !== 'undefined' ? customDepartments : []),
                    pdfBase64: null,
                    timestamp: new Date().toISOString()
                };
                var resp = await fetch('/api/send-diagnostic-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                var data = await resp.json();
                if (data.success && data.reportId) {
                    window._autoSavedReportId = data.reportId;
                    console.log('Report auto-saved:', data.reportId);
                }
            } catch (e) {
                console.warn('Auto-save failed:', e.message);
            }
        }

        function buildLocalResults(processes, contact) {
            let totalCost = 0;
            const processResults = processes.map(p => {
                totalCost += p.costs.totalAnnualCost;
                const quality = calculateProcessQuality(p);
                return {
                    name: p.processName,
                    elapsedDays: p.lastExample.elapsedDays,
                    annualCost: p.costs.totalAnnualCost,
                    annualInstances: p.frequency.annual,
                    teamSize: p.costs.teamSize,
                    stepsCount: p.steps.length,
                    quality,
                    bottleneck: p.bottleneck || {},
                    priority: p.priority || {}
                };
            });

            return {
                processes: processResults,
                totalCost,
                potentialSavings: totalCost * 0.5,
                recommendations: generateRecommendations(processes),
                analysisType: 'client-side'
            };
        }

        function generateRecommendations(processes) {
            const recs = [];
            processes.forEach(p => {
                // Handoff quality
                const poorHandoffs = (p.handoffs || []).filter(h =>
                    h.clarity === 'yes-multiple' || h.clarity === 'yes-major' || h.method === 'they-knew'
                );
                if (poorHandoffs.length > 0) {
                    recs.push({
                        type: 'handoff',
                        process: p.processName,
                        text: `${poorHandoffs.length} handoff(s) in "${p.processName}" show poor information transfer. Automating notifications and standardising handoff checklists could eliminate delays.`
                    });
                }

                // Systems integration
                const copySystems = (p.systems || []).filter(s =>
                    s.actions.includes('copy-in') || s.actions.includes('copy-out')
                );
                if (copySystems.length >= 2) {
                    recs.push({
                        type: 'integration',
                        process: p.processName,
                        text: `${copySystems.length} systems in "${p.processName}" require manual data copying. Integration could save ${Math.round(copySystems.length * 15)} minutes per instance.`
                    });
                }

                // Approval bottlenecks
                const bureaucratic = (p.approvals || []).filter(a => a.assessment === 'too-tight' || a.assessment === 'bureaucratic');
                if (bureaucratic.length > 0) {
                    recs.push({
                        type: 'approval',
                        process: p.processName,
                        text: `${bureaucratic.length} approval point(s) in "${p.processName}" are overly restrictive. Consider pre-approval rules or delegation matrices.`
                    });
                }

                // Knowledge risk
                if (p.knowledge.vacationImpact === 'stops' || p.knowledge.vacationImpact === 'slows-down') {
                    recs.push({
                        type: 'knowledge',
                        process: p.processName,
                        text: `"${p.processName}" has critical knowledge risk. Key person absence would ${p.knowledge.vacationImpact === 'stops' ? 'halt' : 'significantly slow'} operations. Document and cross-train urgently.`
                    });
                }
            });

            if (recs.length === 0) {
                recs.push({ type: 'general', process: 'Overall', text: 'Your processes show room for optimisation. A detailed discovery call will identify the highest-impact improvements.' });
            }

            return recs;
        }

        // Store results globally for PDF generation
        let lastResult = null;
        let lastContact = null;
        let flowDiagramUrl = null;
        let lastScoreData = null;
        let lastRoadmapData = null;

        // ============================================================
        // AUTOMATION READINESS SCORE
        // ============================================================
        function buildAutomationScore(processes) {
            const section = document.getElementById('automationScoreSection');
            if (!processes || processes.length === 0) { section.style.display = 'none'; return; }

            // Classify every step across all processes
            let totalSteps = 0;
            const counts = { 'simple': 0, 'agent': 0, 'human-loop': 0, 'multi-agent': 0 };

            processes.forEach(p => {
                const steps = p.steps || [];
                totalSteps += steps.length;
                steps.forEach((s, i) => {
                    const auto = classifyAutomation(s, i, p);
                    if (auto) counts[auto.key]++;
                });
            });

            const totalAutomatable = counts.simple + counts.agent + counts['human-loop'] + counts['multi-agent'];
            const readinessScore = totalSteps > 0 ? Math.round((totalAutomatable / totalSteps) * 100) : 0;

            // Determine score colour and label
            let scoreColor, scoreGrade;
            if (readinessScore >= 70) { scoreColor = '#059669'; scoreGrade = 'High'; }
            else if (readinessScore >= 40) { scoreColor = '#d97706'; scoreGrade = 'Moderate'; }
            else { scoreColor = '#64748b'; scoreGrade = 'Low'; }

            // Category data for bars
            const cats = [
                { ...AUTOMATION_CATEGORIES.simple, count: counts.simple },
                { ...AUTOMATION_CATEGORIES.agent, count: counts.agent },
                { ...AUTOMATION_CATEGORIES.humanLoop, count: counts['human-loop'] },
                { ...AUTOMATION_CATEGORIES.multiAgent, count: counts['multi-agent'] }
            ];

            // SVG ring (circumference for r=65 = 408.4)
            const circ = 2 * Math.PI * 65;
            const filled = (readinessScore / 100) * circ;
            const empty = circ - filled;

            let html = `<div class="result-section">`;
            html += `<h3>Automation Readiness Score</h3>`;
            html += `<p class="helper-text" style="margin-bottom:1.25rem;">How much of your current workflow could be automated or agent-assisted today.</p>`;

            html += `<div class="score-ring-container">`;

            // Ring
            html += `<div class="score-ring">`;
            html += `<svg width="160" height="160" viewBox="0 0 160 160">`;
            html += `<circle cx="80" cy="80" r="65" fill="none" stroke="#e2e8f0" stroke-width="12"/>`;
            html += `<circle cx="80" cy="80" r="65" fill="none" stroke="${scoreColor}" stroke-width="12" stroke-linecap="round" stroke-dasharray="${filled} ${empty}"/>`;
            html += `</svg>`;
            html += `<div class="score-ring-value">`;
            html += `<span class="number" style="color:${scoreColor};">${readinessScore}%</span>`;
            html += `<span class="label">${scoreGrade} readiness</span>`;
            html += `</div></div>`;

            // Breakdown bars
            html += `<div class="score-breakdown">`;
            cats.forEach(cat => {
                const pct = totalSteps > 0 ? Math.round((cat.count / totalSteps) * 100) : 0;
                html += `<div class="score-bar-row">`;
                html += `<div class="score-bar-badge" style="background:${cat.color};">${cat.badge}</div>`;
                html += `<div class="score-bar-label">${cat.label}</div>`;
                html += `<div class="score-bar-track"><div class="score-bar-fill" style="width:${pct}%;background:${cat.color};"></div></div>`;
                html += `<div class="score-bar-pct" style="color:${cat.color};">${cat.count}/${totalSteps}</div>`;
                html += `</div>`;
            });

            const nonAuto = totalSteps - totalAutomatable;
            const nonPct = totalSteps > 0 ? Math.round((nonAuto / totalSteps) * 100) : 0;
            html += `<div class="score-bar-row">`;
            html += `<div class="score-bar-badge" style="background:#94a3b8;">—</div>`;
            html += `<div class="score-bar-label" style="color:var(--text-mid);">Manual (no change)</div>`;
            html += `<div class="score-bar-track"><div class="score-bar-fill" style="width:${nonPct}%;background:#cbd5e1;"></div></div>`;
            html += `<div class="score-bar-pct" style="color:#94a3b8;">${nonAuto}/${totalSteps}</div>`;
            html += `</div>`;

            html += `</div></div>`; // close breakdown + container

            // Contextual insight
            html += `<div style="margin-top:1.25rem;padding:1rem;background:linear-gradient(135deg,${scoreColor}11,${scoreColor}05);border-left:4px solid ${scoreColor};border-radius:var(--radius-sm);">`;
            if (readinessScore >= 70) {
                html += `<p style="margin:0;font-size:0.9rem;"><strong style="color:${scoreColor};">High automation potential.</strong> ${totalAutomatable} of ${totalSteps} steps can be improved. ${counts.simple > 0 ? counts.simple + ' step(s) are quick wins that can be automated this week with simple integrations.' : ''} ${counts.agent > 0 ? counts.agent + ' step(s) would benefit from an AI agent.' : ''}</p>`;
            } else if (readinessScore >= 40) {
                html += `<p style="margin:0;font-size:0.9rem;"><strong style="color:${scoreColor};">Moderate automation potential.</strong> ${totalAutomatable} of ${totalSteps} steps have improvement opportunities. Focus on the ${counts.simple} simple automation(s) first for quick wins, then build toward agent-assisted workflows.</p>`;
            } else {
                html += `<p style="margin:0;font-size:0.9rem;"><strong style="color:${scoreColor};">Process optimisation recommended first.</strong> ${totalAutomatable} of ${totalSteps} steps show automation potential. Before automating, consider simplifying the process — removing unnecessary steps and standardising handoffs will increase automation readiness.</p>`;
            }
            html += `</div>`;

            html += `</div>`;

            section.innerHTML = html;
            section.style.display = 'block';

            // Return data for PDF
            return { readinessScore, scoreColor, scoreGrade, cats, totalSteps, totalAutomatable, nonAuto };
        }

        // ============================================================
        // 90-DAY ROADMAP
        // ============================================================
        function buildRoadmap(processes, totalAnnualCost) {
            const section = document.getElementById('roadmapSection');
            if (!processes || processes.length === 0) { section.style.display = 'none'; return; }

            // Classify all steps into phases
            const phases = {
                quick:   { items: [], label: 'Quick Wins',       timeline: 'Week 1–2',    color: '#0891b2', savingsPct: 0 },
                agent:   { items: [], label: 'AI Agents',        timeline: 'Month 1',     color: '#7c3aed', savingsPct: 0 },
                human:   { items: [], label: 'Agent + Human',    timeline: 'Month 2',     color: '#ea580c', savingsPct: 0 },
                multi:   { items: [], label: 'Multi-Agent',      timeline: 'Month 2–3',   color: '#be185d', savingsPct: 0 }
            };

            processes.forEach(p => {
                const steps = p.steps || [];
                steps.forEach((s, i) => {
                    const auto = classifyAutomation(s, i, p);
                    if (!auto) return;
                    const item = { step: s.name, process: p.processName, reason: auto.reason };
                    if (auto.key === 'simple')       phases.quick.items.push(item);
                    else if (auto.key === 'agent')   phases.agent.items.push(item);
                    else if (auto.key === 'human-loop') phases.human.items.push(item);
                    else if (auto.key === 'multi-agent') phases.multi.items.push(item);
                });
            });

            // Estimate savings per phase (weighted by complexity)
            const totalItems = phases.quick.items.length + phases.agent.items.length + phases.human.items.length + phases.multi.items.length;
            if (totalItems === 0) { section.style.display = 'none'; return null; }

            // Savings weights: simple automation saves the most per-effort, multi-agent least immediate
            const weights = { quick: 1.5, agent: 1.2, human: 0.8, multi: 0.5 };
            let totalWeight = 0;
            Object.keys(phases).forEach(k => { totalWeight += phases[k].items.length * weights[k]; });

            const annualSavings = (totalAnnualCost || 0) * 0.5; // 50% improvement target
            Object.keys(phases).forEach(k => {
                const phaseWeight = phases[k].items.length * weights[k];
                phases[k].savingsPct = totalWeight > 0 ? phaseWeight / totalWeight : 0;
                phases[k].savings = Math.round(annualSavings * phases[k].savingsPct);
            });

            // Cumulative savings timeline
            let cumulative = 0;
            const phaseOrder = ['quick', 'agent', 'human', 'multi'];

            let html = `<div class="result-section">`;
            html += `<h3>90-Day Implementation Roadmap</h3>`;
            html += `<p class="helper-text" style="margin-bottom:0.75rem;">A phased approach starting with quick wins, progressing to intelligent automation. Estimated savings based on ${formatCurrency(totalAnnualCost || 0)} annual process cost.</p>`;

            // Phase cards
            html += `<div class="roadmap-phases">`;

            phaseOrder.forEach(k => {
                const phase = phases[k];
                if (phase.items.length === 0) return;

                cumulative += phase.savings;

                html += `<div class="roadmap-phase">`;
                html += `<div class="roadmap-phase-header" style="background:${phase.color};">`;
                html += `<div>${phase.timeline}</div>`;
                html += `<div style="font-size:0.75rem;opacity:0.85;font-weight:400;">${phase.label}</div>`;
                html += `</div>`;

                html += `<div class="roadmap-phase-body">`;
                phase.items.forEach(item => {
                    html += `<div class="roadmap-item">`;
                    html += `<span class="badge" style="background:${phase.color};">${k === 'quick' ? 'S' : k === 'agent' ? 'A' : k === 'human' ? 'H' : 'M'}</span>`;
                    html += `<span><strong>${escSvg(item.step)}</strong></span>`;
                    html += `</div>`;
                });

                // Phase savings
                if (phase.savings > 0) {
                    html += `<div class="roadmap-savings" style="color:${phase.color};">`;
                    html += `Est. savings: ${formatCurrency(phase.savings)}/yr`;
                    html += `</div>`;
                }

                html += `</div></div>`;
            });

            html += `</div>`;

            // Cumulative impact
            if (cumulative > 0) {
                html += `<div style="margin-top:1.25rem;padding:1rem;background:linear-gradient(135deg,rgba(5,150,105,0.1),rgba(5,150,105,0.03));border-left:4px solid #059669;border-radius:var(--radius-sm);">`;
                html += `<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">`;
                html += `<div>`;
                html += `<div style="font-weight:600;color:#059669;font-size:0.95rem;">Projected 90-Day Impact</div>`;
                html += `<div style="font-size:0.8rem;color:var(--text-mid);">Cumulative annual savings once all phases are live</div>`;
                html += `</div>`;
                html += `<div style="font-size:1.8rem;font-weight:700;color:#059669;">${formatCurrency(cumulative)}<span style="font-size:0.85rem;font-weight:400;">/yr</span></div>`;
                html += `</div>`;

                // ROI teaser
                html += `<div style="margin-top:0.75rem;padding-top:0.75rem;border-top:1px dashed rgba(5,150,105,0.3);display:flex;gap:1.5rem;flex-wrap:wrap;">`;

                const quickSavings = phases.quick.savings;
                if (quickSavings > 0) {
                    html += `<div style="font-size:0.85rem;"><strong style="color:#0891b2;">${formatCurrency(quickSavings)}</strong> in first 2 weeks</div>`;
                }

                const monthOneSavings = quickSavings + phases.agent.savings;
                if (phases.agent.savings > 0) {
                    html += `<div style="font-size:0.85rem;"><strong style="color:#7c3aed;">${formatCurrency(monthOneSavings)}</strong> by end of month 1</div>`;
                }

                html += `<div style="font-size:0.85rem;"><strong style="color:#059669;">${formatCurrency(cumulative)}</strong> full 90-day potential</div>`;
                html += `</div>`;

                html += `</div>`;
            }

            // CTA
            html += `<div style="margin-top:1.25rem;padding:1.25rem;text-align:center;background:var(--bg-alt);border-radius:var(--radius-md);border:1px dashed var(--border);">`;
            html += `<p style="margin:0 0 0.5rem;font-weight:600;color:var(--primary);">Want this roadmap built for you?</p>`;
            html += `<p style="margin:0;font-size:0.85rem;color:var(--text-mid);">Book a discovery call and we'll turn this analysis into a concrete implementation plan with timelines, costs, and expected ROI.</p>`;
            html += `</div>`;

            html += `</div>`;

            section.innerHTML = html;
            section.style.display = 'block';

            return { phases, cumulative, annualSavings };
        }

        // ============================================================
        // ROI PROJECTION CALCULATOR
        // ============================================================
        function buildROICalculator(totalCost, potentialSavings) {
            const section = document.getElementById('roiCalculator');
            if (!totalCost || totalCost <= 0) { section.style.display = 'none'; return; }

            const maxSavings = potentialSavings || totalCost * 0.5;

            section.innerHTML = `
                <div class="roi-card">
                    <h3>ROI Projection</h3>
                    <p style="color: var(--text-mid); font-size: 0.9rem; margin-bottom: 0.5rem;">
                        Drag the slider to estimate what percentage of recommendations your team will implement.
                    </p>
                    <div class="roi-slider-group">
                        <div class="roi-slider-label">
                            <span>Implementation level</span>
                            <span class="roi-pct" id="roiPctLabel">50%</span>
                        </div>
                        <input type="range" class="roi-slider" id="roiSlider" min="10" max="100" step="5" value="50"
                               oninput="updateROIProjection(this.value, ${maxSavings})">
                    </div>
                    <div class="roi-projections" id="roiProjections"></div>
                    <p style="font-size: 0.78rem; color: var(--text-light); margin-top: 12px; text-align: center;">
                        Based on your annual process cost of ${formatCurrency(totalCost)} and ${formatCurrency(maxSavings)} potential savings.
                    </p>
                </div>`;

            section.style.display = 'block';
            updateROIProjection(50, maxSavings);
        }

        function updateROIProjection(pct, maxSavings) {
            document.getElementById('roiPctLabel').textContent = pct + '%';
            const factor = pct / 100;

            // Month 3: quick wins only (~30% of savings realised)
            const m3 = Math.round(maxSavings * factor * 0.3 / 12 * 3);
            // Month 6: agents + quick wins (~60% realised)
            const m6 = Math.round(maxSavings * factor * 0.6 / 12 * 6);
            // Month 12: full annual projection
            const m12 = Math.round(maxSavings * factor);

            const grid = document.getElementById('roiProjections');
            grid.innerHTML = `
                <div class="roi-projection">
                    <div class="roi-month">Month 3</div>
                    <div class="roi-amount">${formatCurrency(m3)}</div>
                    <div class="roi-cumulative">Quick wins</div>
                </div>
                <div class="roi-projection">
                    <div class="roi-month">Month 6</div>
                    <div class="roi-amount">${formatCurrency(m6)}</div>
                    <div class="roi-cumulative">+ Agent automation</div>
                </div>
                <div class="roi-projection">
                    <div class="roi-month">Year 1</div>
                    <div class="roi-amount">${formatCurrency(m12)}</div>
                    <div class="roi-cumulative">Full implementation</div>
                </div>`;
        }

        // ============================================================
        // PROCESS DEPENDENCY MAPPING
        // ============================================================
        let processDependencies = [];

        function showDependencyMapping() {
            const names = completedProcesses.map(p => p.processName);
            let html = '<div class="screen-card"><h2 class="screen-title">Process Dependencies</h2>';
            html += '<p class="screen-subtitle">Do any of these processes depend on each other? Select all that apply.</p>';

            let pairIdx = 0;
            for (let i = 0; i < names.length; i++) {
                for (let j = i + 1; j < names.length; j++) {
                    html += `<div class="form-group" style="padding: 1rem; background: var(--bg-alt); border-radius: var(--radius-sm); margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">${names[i]} &harr; ${names[j]}</label>
                        <div class="radio-group">
                            <label class="radio-option"><input type="radio" name="dep_${pairIdx}" value="a-blocks-b" data-from="${i}" data-to="${j}"> "${names[i]}" must complete before "${names[j]}" can start</label>
                            <label class="radio-option"><input type="radio" name="dep_${pairIdx}" value="b-blocks-a" data-from="${j}" data-to="${i}"> "${names[j]}" must complete before "${names[i]}" can start</label>
                            <label class="radio-option"><input type="radio" name="dep_${pairIdx}" value="shared-resource"> They compete for the same people/resources</label>
                            <label class="radio-option"><input type="radio" name="dep_${pairIdx}" value="none"> No dependency</label>
                        </div>
                    </div>`;
                    pairIdx++;
                }
            }

            html += `<div class="button-group">
                <button class="button button-secondary" onclick="goToScreen(17)">&larr; Back</button>
                <button class="button button-primary" onclick="collectDependencies(${pairIdx}); goToScreen(18);">Continue &rarr;</button>
            </div></div>`;

            // Inject into a temp container in Screen 17's area
            const screen17 = document.getElementById('screen17');
            let depDiv = document.getElementById('dependencyMapping');
            if (!depDiv) {
                depDiv = document.createElement('div');
                depDiv.id = 'dependencyMapping';
                depDiv.className = 'screen';
                screen17.parentNode.insertBefore(depDiv, screen17.nextSibling);
            }
            depDiv.innerHTML = html;

            // Show dependency screen
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            depDiv.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function collectDependencies(pairCount) {
            processDependencies = [];
            const names = completedProcesses.map(p => p.processName);

            for (let k = 0; k < pairCount; k++) {
                const selected = document.querySelector(`input[name="dep_${k}"]:checked`);
                if (!selected || selected.value === 'none') continue;

                const from = parseInt(selected.dataset.from);
                const to = parseInt(selected.dataset.to);

                if (selected.value === 'a-blocks-b') {
                    processDependencies.push({ from: names[from], to: names[to], type: 'blocks' });
                } else if (selected.value === 'b-blocks-a') {
                    processDependencies.push({ from: names[to], to: names[from], type: 'blocks' });
                } else if (selected.value === 'shared-resource') {
                    processDependencies.push({ from: names[from], to: names[to], type: 'shared-resource' });
                }
            }
        }

        function renderDependencyGraph() {
            if (processDependencies.length === 0) return '';
            const names = [...new Set(completedProcesses.map(p => p.processName))];

            const W = 640, chromeH = 36, titleH = 40;
            const contentTop = chromeH + titleH;
            const nodeW = 220, nodeH = 52;
            const H = Math.max(260, contentTop + names.length * 85 + 60);
            const positions = names.map((n, i) => ({
                name: n,
                x: i % 2 === 0 ? 50 : W - nodeW - 50,
                y: contentTop + 20 + i * 75
            }));

            let svg = `<svg viewBox="0 0 ${W} ${H}" style="width: 100%; max-height: 400px;" xmlns="http://www.w3.org/2000/svg">`;

            // Card background
            svg += `<rect x="0" y="0" width="${W}" height="${H}" fill="#ffffff" rx="16" filter="url(#depCardShadow)"/>`;

            // Browser chrome header
            svg += `<rect x="0" y="0" width="${W}" height="${chromeH}" rx="16" fill="#f8fafb"/>`;
            svg += `<rect x="0" y="24" width="${W}" height="12" fill="#f8fafb"/>`;
            svg += `<circle cx="18" cy="18" r="3.5" fill="#e5e7eb"/><circle cx="30" cy="18" r="3.5" fill="#e5e7eb"/><circle cx="42" cy="18" r="3.5" fill="#e5e7eb"/>`;
            svg += `<text x="${W/2}" y="20" text-anchor="middle" font-size="9" font-weight="400" fill="#94a3b8" letter-spacing="0.5" font-family="Work Sans,sans-serif">dependency-map</text>`;

            // Title area
            svg += `<text x="${W/2}" y="${chromeH + 18}" text-anchor="middle" font-size="14" font-weight="600" fill="#1a2f4a" letter-spacing="-0.3" font-family="Work Sans,sans-serif">Process Dependency Map</text>`;
            svg += `<text x="${W/2}" y="${chromeH + 33}" text-anchor="middle" font-size="10" fill="#94a3b8" font-family="Work Sans,sans-serif">Solid arrows = blocking · Dashed lines = shared resource</text>`;

            // Defs
            svg += `<defs>`;
            svg += `<marker id="arrowDep" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#3d8ea6"/></marker>`;
            svg += `<marker id="arrowDepWarn" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#d97706"/></marker>`;
            svg += `<filter id="depShadow" x="-8%" y="-8%" width="116%" height="120%"><feDropShadow dx="0" dy="2" stdDeviation="4" flood-opacity="0.06"/></filter>`;
            svg += `<filter id="depCardShadow" x="-2%" y="-2%" width="104%" height="106%"><feDropShadow dx="0" dy="4" stdDeviation="12" flood-opacity="0.04"/><feDropShadow dx="0" dy="1" stdDeviation="3" flood-opacity="0.03"/></filter>`;
            svg += `<filter id="depGlow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="2" stdDeviation="6" flood-opacity="0.12" flood-color="#3d8ea6"/></filter>`;
            svg += `</defs>`;

            // CSS
            svg += `<style>
                @keyframes depDash { to { stroke-dashoffset: -30; } }
                @keyframes depNodeIn { from { opacity: 0; transform: translateY(8px) scale(0.96); } to { opacity: 1; transform: none; } }
                .dep-edge { animation: depDash 2s linear infinite; }
                .dep-node { cursor: pointer; transition: filter 0.25s ease, transform 0.25s cubic-bezier(0.16,1,0.3,1); transform-origin: center; transform-box: fill-box; animation: depNodeIn 0.5s cubic-bezier(0.16,1,0.3,1) both; }
                .dep-node:hover { filter: url(#depGlow); transform: scale(1.04) translateY(-2px); }
            </style>`;

            // Draw edges (curved Bezier paths)
            processDependencies.forEach(dep => {
                const fromNode = positions.find(p => p.name === dep.from);
                const toNode = positions.find(p => p.name === dep.to);
                if (!fromNode || !toNode) return;

                const x1 = fromNode.x + nodeW / 2, y1 = fromNode.y + nodeH / 2;
                const x2 = toNode.x + nodeW / 2, y2 = toNode.y + nodeH / 2;
                const isBlock = dep.type === 'blocks';
                const color = isBlock ? '#3d8ea6' : '#d97706';
                const dash = isBlock ? 'stroke-dasharray="8,6"' : 'stroke-dasharray="6,4"';
                const marker = isBlock ? 'marker-end="url(#arrowDep)"' : 'marker-end="url(#arrowDepWarn)"';

                const dx = x2 - x1, dy = y2 - y1;
                const len = Math.sqrt(dx * dx + dy * dy) || 1;
                const offX = (-dy / len) * 20;
                const offY = (dx / len) * 20;
                const mx = (x1 + x2) / 2 + offX;
                const my = (y1 + y2) / 2 + offY;
                const pathD = `M ${x1} ${y1} Q ${mx} ${my} ${x2} ${y2}`;
                svg += `<path d="${pathD}" fill="none" stroke="${color}" stroke-width="1.8" ${dash} ${marker} class="dep-edge" opacity="0.55"/>`;

                const lx = (x1 + 2 * mx + x2) / 4, ly = (y1 + 2 * my + y2) / 4;
                const label = isBlock ? 'blocks' : 'shared resource';
                const tw = label.length * 5 + 12;
                svg += `<rect x="${lx - tw/2}" y="${ly - 9}" width="${tw}" height="14" rx="4" fill="#fff" stroke="${color}" stroke-width="0.5" opacity="0.92"/>`;
                svg += `<text x="${lx}" y="${ly + 1}" text-anchor="middle" font-size="8" fill="${color}" font-weight="600" font-family="Work Sans,sans-serif">${label}</text>`;
            });

            // Draw nodes (each with unique accent color)
            function depWrap(text, maxC) {
                const words = text.split(/\s+/);
                const lines = []; let cur = '';
                words.forEach(w => { const t = cur ? cur + ' ' + w : w; if (t.length > maxC && cur) { lines.push(cur); cur = w; } else { cur = t; } });
                if (cur) lines.push(cur);
                return lines;
            }
            const depColors = ['#3d8ea6', '#2563eb', '#059669', '#7c3aed', '#d97706', '#dc2626', '#0891b2', '#6366f1'];
            positions.forEach((p, i) => {
                const nc = depColors[i % depColors.length];
                svg += `<g class="dep-node" style="animation-delay:${i * 0.08}s">`;
                svg += `<rect x="${p.x}" y="${p.y}" width="${nodeW}" height="${nodeH}" rx="12" fill="#ffffff" stroke="${nc}" stroke-width="1.5" filter="url(#depShadow)"/>`;
                svg += `<rect x="${p.x}" y="${p.y}" width="${nodeW}" height="${nodeH}" rx="12" fill="${nc}" opacity="0.06"/>`;
                svg += `<circle cx="${p.x + 18}" cy="${p.y + nodeH/2}" r="11" fill="${nc}" opacity="0.12"/>`;
                svg += `<text x="${p.x + 18}" y="${p.y + nodeH/2 + 4}" text-anchor="middle" font-size="9" font-weight="700" fill="${nc}">${i + 1}</text>`;
                const nameLines = depWrap(p.name, 26);
                const nFS = nameLines.length > 2 ? 9 : 10.5;
                const nLH = nFS + 2;
                const nBH = nameLines.length * nLH;
                const nSY = p.y + (nodeH - nBH) / 2 + nFS;
                nameLines.forEach((line, li) => {
                    svg += `<text x="${p.x + 38}" y="${nSY + li * nLH}" font-size="${nFS}" fill="#1e293b" font-weight="500" font-family="Work Sans,sans-serif">${escSvg(line)}</text>`;
                });
                svg += `</g>`;
            });

            // Legend
            const lastNodeY = positions.length > 0 ? positions[positions.length - 1].y + nodeH : contentTop + 60;
            const legY = lastNodeY + 20;
            let lx = 60;
            svg += `<path d="M ${lx} ${legY + 5} Q ${lx + 12} ${legY - 2} ${lx + 24} ${legY + 5}" fill="none" stroke="#3d8ea6" stroke-width="2" stroke-dasharray="8,6"/>`;
            svg += `<polygon points="${lx + 22},${legY + 2} ${lx + 28},${legY + 5} ${lx + 22},${legY + 8}" fill="#3d8ea6"/>`;
            svg += `<text x="${lx + 34}" y="${legY + 9}" font-size="9" fill="#64748b" font-family="Work Sans,sans-serif">Blocking dependency</text>`;
            lx += 170;
            svg += `<line x1="${lx}" y1="${legY + 5}" x2="${lx + 24}" y2="${legY + 5}" stroke="#d97706" stroke-width="2" stroke-dasharray="6,4"/>`;
            svg += `<text x="${lx + 30}" y="${legY + 9}" font-size="9" fill="#64748b" font-family="Work Sans,sans-serif">Shared resource</text>`;

            svg += '</svg>';

            return `<div style="margin: 2rem 0; padding: 0; background: transparent; border-radius: var(--radius-lg); overflow: hidden;">
                ${svg}
            </div>`;
        }

        function dsec(title, bodyHtml, startOpen = false) {
            const cls = startOpen ? 'collapsible' : 'collapsible collapsed';
            const icon = startOpen ? '−' : '+';
            return `<div class="${cls}">
                <div class="collapsible-header" onclick="toggleSection(this)">
                    <h3>${title}</h3>
                    <span class="collapse-btn">${icon}</span>
                </div>
                <div class="collapsible-body">${bodyHtml}</div>
            </div>`;
        }

        function displayResults(result, contact) {
            lastResult = result;
            lastContact = contact;

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';

            // Process cards — each process as a collapsible section
            const processResultsDiv = document.getElementById('processResults');
            let html = '';

            (result.processes || []).forEach((p, i) => {
                const cardBody = `<div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value">${formatCurrency(p.annualCost)}</div>
                        <div class="metric-label">Annual cost</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${p.elapsedDays} days</div>
                        <div class="metric-label">Average cycle</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${p.stepsCount}</div>
                        <div class="metric-label">Steps</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value"><span class="confidence-badge confidence-${(p.quality?.grade || 'medium').toLowerCase()}">${p.quality?.grade || 'MEDIUM'}</span></div>
                        <div class="metric-label">Confidence (${p.quality?.score || '\u2014'}/100)</div>
                    </div>
                </div>`;
                html += dsec(`${i + 1}. ${p.name}`, cardBody);
            });

            // Totals (always open)
            html += dsec('Cost Summary', `
                <div class="calculated" style="background: linear-gradient(135deg, rgba(61, 142, 166, 0.15), rgba(61, 142, 166, 0.05)); border-left: 4px solid var(--primary);">
                    <div class="calculated-label" style="font-weight: 600;">Total Annual Cost:</div>
                    <div class="calculated-value" style="font-size: 2.2rem; color: var(--primary);">${formatCurrency(result.totalCost)}</div>
                </div>
                <div class="calculated success">
                    <div class="calculated-label" style="font-weight: 600;">Potential Annual Savings (50% improvement):</div>
                    <div class="calculated-value" style="font-size: 2rem;">${formatCurrency(result.potentialSavings)}</div>
                </div>`, true);

            processResultsDiv.innerHTML = html;

            // Recommendations (collapsible, starts open)
            const analysisDiv = document.getElementById('analysisResults');
            let recBody = '';
            (result.recommendations || []).forEach(rec => {
                recBody += `<div class="result-item" style="padding: 1rem; margin-bottom: 0.5rem; background: var(--bg-alt); border-radius: var(--radius-sm);">
                    <strong>${rec.process}:</strong> ${rec.text}
                </div>`;
            });

            let nextBody = `<div class="checklist">
                <div class="checklist-item"><span class="checklist-icon">&#9744;</span><span>Review this analysis</span></div>
                <div class="checklist-item"><span class="checklist-icon">&#9744;</span><span>Book a discovery call to discuss findings</span></div>
                <div class="checklist-item"><span class="checklist-icon">&#9744;</span><span>Connect tools for deeper automated analysis</span></div>
                <div class="checklist-item"><span class="checklist-icon">&#9744;</span><span>Complete manual survey for offline workflows</span></div>
            </div>
            <p style="color: var(--text-mid); margin-top: 1rem;">Analysis sent to: <strong>${contact?.email || ''}</strong></p>`;

            analysisDiv.innerHTML = dsec('Recommendations', recBody) + dsec('Next Steps', nextBody);

            // Automation Readiness Score
            const scoreData = buildAutomationScore(completedProcesses);

            // 90-Day Roadmap
            const roadmapData = buildRoadmap(completedProcesses, result.totalCost);

            // ROI Projection Calculator
            buildROICalculator(result.totalCost, result.potentialSavings);

            // Process Dependency Graph
            const depGraphHtml = renderDependencyGraph();
            if (depGraphHtml) {
                const roiSection = document.getElementById('roiCalculator');
                roiSection.insertAdjacentHTML('afterend', depGraphHtml);
            }

            // Store for PDF
            lastScoreData = scoreData;
            lastRoadmapData = roadmapData;

            // Trigger n8n flow diagram generation
            triggerFlowDiagram(completedProcesses, contact);

            // Handle flow diagram from API response
            if (result.flowDiagramUrl) {
                showFlowDiagram(result.flowDiagramUrl);
            }

            // Wrap existing sections that are rendered by other functions in collapsible containers
            wrapExistingSections();
        }

        function wrapExistingSections() {
            const wrappable = [
                { id: 'automationScoreSection', title: 'Automation Readiness Score', open: false },
                { id: 'roadmapSection', title: '90-Day Transformation Roadmap', open: false },
                { id: 'roiCalculator', title: 'ROI Projection Calculator', open: false },
                { id: 'flowDiagramSection', title: 'Process Flow Diagrams', open: false }
            ];

            wrappable.forEach(({ id, title, open }) => {
                const el = document.getElementById(id);
                if (!el || el.dataset.wrapped) return;
                el.dataset.wrapped = 'true';

                const wrapper = document.createElement('div');
                wrapper.className = open ? 'collapsible' : 'collapsible collapsed';
                const icon = open ? '−' : '+';
                const header = document.createElement('div');
                header.className = 'collapsible-header';
                header.onclick = function() { toggleSection(this); };
                header.innerHTML = `<h3>${title}</h3><span class="collapse-btn">${icon}</span>`;

                const body = document.createElement('div');
                body.className = 'collapsible-body';

                el.parentNode.insertBefore(wrapper, el);
                wrapper.appendChild(header);
                wrapper.appendChild(body);
                body.appendChild(el);

                // Make the inner element always visible (the collapsible wrapper controls visibility)
                el.style.display = 'block';
            });
        }

        // ============================================================
        // QUALITY SCORING
        // ============================================================
        function calculateQualityScore() {
            let totalScore = 0;
            let count = completedProcesses.length;
            completedProcesses.forEach(p => {
                const q = calculateProcessQuality(p);
                totalScore += q.score;
            });
            return { averageScore: count > 0 ? Math.round(totalScore / count) : 0 };
        }

        function calculateProcessQuality(p) {
            let score = 100;
            const flags = [];

            // Date recency
            if (p.lastExample.startDate) {
                const age = (new Date() - new Date(p.lastExample.startDate)) / (1000 * 60 * 60 * 24);
                if (age > 60) { score -= 10; flags.push('Example over 60 days old'); }
            } else { score -= 15; }

            // Round numbers
            if (p.userTime.total % 5 === 0 && p.userTime.total > 0) {
                score -= 5; flags.push('Round numbers suggest estimation');
            }

            // Detail level
            if (p.steps.length < 5) { score -= 10; flags.push('Limited step detail'); }
            if (p.steps.length >= 8) { score += 5; }

            // Bonuses
            if (p.lastExample.startDate && p.lastExample.endDate) score += 10;
            if (p.costs.totalAnnualCost > 0) score += 5;
            if (p.handoffs.length > 0) score += 5;
            if (p.systems.length > 0) score += 5;

            score = Math.max(0, Math.min(100, score));

            return {
                score,
                grade: score > 85 ? 'HIGH' : score > 65 ? 'MEDIUM' : 'LOW',
                flags
            };
        }

        // ============================================================
        // DATA COLLECTION
        // ============================================================
        function collectAllProcessData() {
            // Screen 2
            processData.processName = document.getElementById('processNameInput')?.value?.trim() || processData.processName;

            // Screen 3
            processData.definition.startsWhen = document.getElementById('processStarts')?.value?.trim() || '';
            processData.definition.completesWhen = document.getElementById('processCompletes')?.value?.trim() || '';
            processData.definition.complexity = getRadioValue('complexity');
            processData.definition.departments = [
                ...getCheckedValues('departments'),
                ...customDepartments
            ];

            // Screen 4
            processData.lastExample.name = document.getElementById('exampleName')?.value?.trim() || '';

            // Screen 5
            recalcTimeFromRanges();
            processData.timeRangeSelections = {
                totalTimeRange: getRadioValue('totalTimeRange'),
                waitingPortion: getRadioValue('waitingPortion'),
                primaryActivity: getRadioValue('primaryActivity')
            };

            // Screen 6
            processData.performance = getRadioValue('performance');
            processData.issues = getCheckedValues('issues');
            processData.biggestDelay = document.getElementById('biggestDelay')?.value || '';
            processData.delayDetails = document.getElementById('delayDetails')?.value?.trim() || '';

            // Screen 7
            processData.steps = collectSteps();

            // Screen 8
            processData.handoffs = collectHandoffs();

            // Screen 9
            processData.bottleneck = {
                longestStep: document.getElementById('longestStep')?.value || '',
                reason: getRadioValue('bottleneckReason'),
                biggestBottleneck: document.getElementById('biggestBottleneck')?.value || '',
                why: document.getElementById('bottleneckWhy')?.value?.trim() || ''
            };

            // Screen 10
            processData.systems = collectSystems();

            // Screen 11
            const approvalCount = parseInt(document.getElementById('approvalCount')?.value) || 0;
            processData.approvals = [];
            for (let i = 0; i < approvalCount; i++) {
                processData.approvals.push({
                    name: document.getElementById('approval_' + i + '_name')?.value?.trim() || '',
                    who: document.getElementById('approval_' + i + '_who')?.value?.trim() || '',
                    rounds: getRadioValue('approval_' + i + '_rounds'),
                    assessment: getRadioValue('approval_' + i + '_assessment')
                });
            }

            // Screen 12
            processData.knowledge = {
                firstLook: getRadioValue('knowledgeFirst'),
                askWho: document.getElementById('askWho')?.value?.trim() || '',
                personType: getRadioValue('personType'),
                vacationImpact: getRadioValue('vacationImpact'),
                timeToAnswer: getRadioValue('timeToAnswer')
            };

            // Screen 13
            processData.newHire = {
                learningMethod: getCheckedValues('learningMethod'),
                timeToCompetence: getRadioValue('timeToCompetence'),
                lastHireTime: document.getElementById('lastHireTime')?.value?.trim() || '',
                lastHireStruggle: document.getElementById('lastHireStruggle')?.value?.trim() || ''
            };

            // Screen 14
            processData.frequency.inFlight = parseInt(document.getElementById('inFlight')?.value) || 0;
            processData.frequency.progressing = parseInt(document.getElementById('progressing')?.value) || 0;
            processData.frequency.stuck = parseInt(document.getElementById('stuck')?.value) || 0;
            processData.frequency.waiting = parseInt(document.getElementById('waitingFor')?.value) || 0;

            // Screen 16
            processData.savings.wouldDo = getCheckedValues('savingsUse');
            processData.savings.expectedImpact = getRadioValue('expectedImpact');

            // Screen 17
            processData.priority = {
                level: getRadioValue('priority'),
                reason: document.getElementById('priorityReason')?.value?.trim() || ''
            };
        }

        // ============================================================
        // VALIDATION
        // ============================================================
        // #5 — LIVE PROCESS HEALTH SCORE
        // Updates a running score bar below the progress bar.
        // Score reflects data quality and process complexity signals.
        // ============================================================
        function updateHealthScore() {
            const bar = document.getElementById('healthScoreBar');
            const fill = document.getElementById('hsFill');
            const valueEl = document.getElementById('hsValue');
            const gradeEl = document.getElementById('hsGrade');

            if (currentScreen < 1) { bar.style.display = 'none'; return; }
            if (currentScreen >= 19) { bar.style.display = 'none'; return; }

            bar.style.display = 'flex';

            // Build a score from 0-100 based on what the user has filled so far
            let score = 0;
            let maxScore = 0;

            // Screen 1: process selected (10pts)
            maxScore += 10;
            if (processData.processType) score += 10;

            // Screen 2: process named (5pts)
            maxScore += 5;
            if (processData.processName && processData.processName !== processData.processType) score += 5;

            // Screen 3: boundaries (10pts)
            maxScore += 10;
            if (processData.definition?.startsWhen) score += 3;
            if (processData.definition?.completesWhen) score += 3;
            if (processData.definition?.complexity) score += 2;
            if (processData.definition?.departments?.length > 0) score += 2;

            // Screen 4: example (10pts)
            maxScore += 10;
            if (processData.lastExample?.name) score += 4;
            if (processData.lastExample?.startDate) score += 3;
            if (processData.lastExample?.endDate) score += 3;

            // Screen 5: time investment (10pts)
            maxScore += 10;
            if (processData.userTime?.total > 0) score += 10;

            // Screen 7: steps (15pts, scaled by count)
            maxScore += 15;
            const steps = processData.steps || [];
            if (steps.length >= 3) score += 5;
            if (steps.length >= 5) score += 5;
            if (steps.length >= 8) score += 5;

            // Screen 8: handoffs (10pts)
            maxScore += 10;
            const handoffs = processData.handoffs || [];
            if (handoffs.length > 0) score += 5;
            if (handoffs.every(h => h.method)) score += 5;

            // Screen 9: bottleneck (10pts)
            maxScore += 10;
            if (processData.bottleneck?.longestStep) score += 5;
            if (processData.bottleneck?.reason) score += 5;

            // Screen 10: systems (5pts)
            maxScore += 5;
            if ((processData.systems || []).length > 0) score += 5;

            // Screen 11: approvals (5pts)
            maxScore += 5;
            if ((processData.approvals || []).length > 0 || processData.approvalCount === 0) score += 5;

            // Screen 14: frequency (5pts)
            maxScore += 5;
            if (processData.frequency?.type) score += 5;

            const pct = maxScore > 0 ? Math.round((score / maxScore) * 100) : 0;

            let color, grade;
            if (pct >= 75) { color = '#059669'; grade = 'Strong'; }
            else if (pct >= 50) { color = '#d97706'; grade = 'Building'; }
            else if (pct >= 25) { color = '#64748b'; grade = 'Early'; }
            else { color = '#94a3b8'; grade = 'Starting'; }

            fill.style.width = pct + '%';
            fill.style.background = color;
            valueEl.textContent = pct + '%';
            valueEl.style.color = color;
            gradeEl.textContent = grade;
            gradeEl.style.background = color;
            gradeEl.style.display = 'inline-block';
        }

        // ============================================================
        // #6 — AI STEP SUGGESTIONS
        // Shows suggested missing steps based on process type.
        // ============================================================
        const STEP_SUGGESTIONS = {
            'customer-onboarding': [
                'Send welcome email', 'Collect requirements', 'Create customer account',
                'Configure permissions', 'Import data', 'Schedule kickoff call',
                'Assign account manager', 'Run training session', 'Verify access',
                'Send handover pack', 'First check-in call', 'Compliance check'
            ],
            'sales-to-delivery': [
                'Qualify lead', 'Send proposal', 'Contract negotiation',
                'Sign contract', 'Internal handover meeting', 'Create project plan',
                'Assign delivery team', 'Kick off delivery', 'Status update to client',
                'Invoice milestone', 'Quality review', 'Project close'
            ],
            'employee-onboarding': [
                'Send offer letter', 'Background check', 'IT equipment request',
                'Create accounts', 'Prepare workspace', 'Day 1 induction',
                'Assign buddy', 'Department intro', 'System training',
                'First week check-in', '30-day review', 'Probation review'
            ],
            'order-fulfillment': [
                'Receive order', 'Validate order details', 'Check inventory',
                'Pick items', 'Quality check', 'Pack order',
                'Generate shipping label', 'Dispatch', 'Send tracking info',
                'Monitor delivery', 'Confirm receipt', 'Process returns'
            ],
            'invoice-to-payment': [
                'Generate invoice', 'Approve invoice', 'Send to client',
                'Track receipt confirmation', 'Log in accounting system',
                'Follow up on overdue', 'Receive payment', 'Reconcile payment',
                'Issue receipt', 'Update revenue records', 'Chase disputes'
            ],
            'issue-resolution': [
                'Log issue', 'Triage priority', 'Assign to team',
                'Investigate root cause', 'Propose fix', 'Get approval',
                'Implement fix', 'Test resolution', 'Notify stakeholders',
                'Update documentation', 'Close ticket', 'Post-mortem review'
            ],
            'approval-workflow': [
                'Submit request', 'Initial review', 'Route to approver',
                'Manager review', 'Finance review', 'Compliance check',
                'Final approval', 'Notify requestor', 'Execute action',
                'Record in system', 'Audit trail update'
            ],
            'product-launch': [
                'Define requirements', 'Market research', 'Design phase',
                'Development', 'QA testing', 'Stakeholder review',
                'Marketing prep', 'Sales enablement', 'Soft launch',
                'Monitor metrics', 'Full launch', 'Post-launch review'
            ],
            'reporting-cycle': [
                'Define report scope', 'Gather data sources', 'Extract data',
                'Clean and validate', 'Run analysis', 'Build visualisations',
                'Draft report', 'Peer review', 'Management review',
                'Distribute report', 'Collect feedback', 'Archive'
            ]
        };

        function buildStepSuggestions() {
            const box = document.getElementById('stepSuggestionsBox');
            const chips = document.getElementById('stepSuggestionsChips');
            const pType = processData.processType;

            if (!pType || !STEP_SUGGESTIONS[pType]) { box.style.display = 'none'; return; }

            const suggestions = STEP_SUGGESTIONS[pType];
            const currentSteps = collectSteps().map(s => s.name.toLowerCase());

            // Filter out steps that already exist
            const unused = suggestions.filter(s =>
                !currentSteps.some(cs => cs.includes(s.toLowerCase().substring(0, 8)))
            );

            if (unused.length === 0) { box.style.display = 'none'; return; }

            chips.innerHTML = '';
            unused.slice(0, 8).forEach(s => {
                const chip = document.createElement('span');
                chip.className = 'step-suggestion-chip';
                chip.textContent = '+ ' + s;
                chip.onclick = function() {
                    const newDiv = addStep();
                    const pfx = getStepPrefix(newDiv);
                    const nameInput = document.getElementById(pfx + '_name');
                    if (nameInput) nameInput.value = s;
                    chip.classList.add('used');
                    // Refresh suggestions after a short delay
                    setTimeout(() => buildStepSuggestions(), 300);
                };
                chips.appendChild(chip);
            });

            box.style.display = 'block';
        }

        // ============================================================
        // #2 — AI INSIGHT CARDS
        // Pattern-matched insights shown after key screens.
        // ============================================================
        function showInsightCard(screenNum) {
            const container = document.getElementById('insightCard' + screenNum);
            if (!container) return;

            let insight = null;

            switch (screenNum) {
                case 5: insight = generateInsight5(); break;
                case 7: insight = generateInsight7(); break;
                case 8: insight = generateInsight8(); break;
                case 9: insight = generateInsight9(); break;
            }

            if (!insight) { container.style.display = 'none'; return; }

            container.innerHTML = `
                <div class="ai-insight-card">
                    <div class="insight-header">
                        <span>&#9889;</span> AI Insight
                    </div>
                    <div class="insight-body">${insight}</div>
                </div>
            `;
            container.style.display = 'block';
        }

        function generateInsight5() {
            const t = processData.userTime;
            if (!t || t.total <= 0) return null;

            const parts = [];
            const waitPct = t.total > 0 ? Math.round((t.waiting / t.total) * 100) : 0;
            const meetPct = t.total > 0 ? Math.round((t.meetings / t.total) * 100) : 0;
            const emailPct = t.total > 0 ? Math.round((t.emails / t.total) * 100) : 0;
            const execPct = t.total > 0 ? Math.round((t.execution / t.total) * 100) : 0;

            if (waitPct > 30) {
                parts.push(`You spent <strong>${waitPct}%</strong> of your time waiting for others. In optimised processes, waiting time typically drops to 10-15% with automated notifications and SLA tracking.`);
            }
            if (meetPct > 25) {
                parts.push(`<strong>${meetPct}%</strong> of your time went to meetings. Async handoffs and status dashboards can reduce coordination meetings by 40-60%.`);
            }
            if (emailPct > 25) {
                parts.push(`<strong>${emailPct}%</strong> of your time was spent on email. Structured workflow tools with auto-notifications typically cut email coordination by 50-70%.`);
            }
            if (execPct < 30 && t.total > 2) {
                parts.push(`Only <strong>${execPct}%</strong> of your time was actual execution. The rest is overhead — a strong signal that process automation could reclaim significant capacity.`);
            }

            if (parts.length === 0 && t.total > 5) {
                parts.push(`You invested <strong>${t.total} hours</strong> in a single instance. At your process frequency, that's a meaningful time investment worth optimising.`);
            }

            return parts.length > 0 ? parts.join('<br style="margin-bottom:0.3rem;">') : null;
        }

        function generateInsight7() {
            const steps = processData.steps || [];
            if (steps.length < 3) return null;

            const parts = [];
            const depts = [...new Set(steps.map(s => s.department).filter(Boolean))];
            const handoffCount = steps.length - 1;
            const extSteps = steps.filter(s => s.isExternal);
            const intSteps = steps.filter(s => !s.isExternal);

            if (depts.length >= 3) {
                parts.push(`Your process spans <strong>${depts.length} departments</strong> across ${steps.length} steps. Each department transition is a potential delay point — cross-functional processes benefit most from orchestration automation.`);
            }

            if (steps.length > 10) {
                parts.push(`With <strong>${steps.length} steps</strong>, this is a complex process. Research shows processes with 10+ steps have 3x more failure points than simpler ones. Consider whether any steps can be combined or eliminated.`);
            }

            // External party insights
            if (extSteps.length > 0) {
                const extDepts = [...new Set(extSteps.map(s => s.department).filter(Boolean))];
                parts.push(`<strong>${extSteps.length} of ${steps.length} steps involve external parties</strong> (${extDepts.join(', ')}). External handoffs are typically 2-5x slower than internal ones — these are prime candidates for automated tracking and SLA monitoring.`);
            }

            // Internal-to-external transitions (high-friction points)
            let intExtTransitions = 0;
            for (let i = 1; i < steps.length; i++) {
                if (steps[i].isExternal !== steps[i-1].isExternal) intExtTransitions++;
            }
            if (intExtTransitions >= 3) {
                parts.push(`Your process crosses the <strong>internal/external boundary ${intExtTransitions} times</strong>. Each boundary crossing introduces communication latency, data format mismatches, and compliance checkpoints. An orchestration agent can bridge these gaps.`);
            }

            // Check for duplicate departments (back-and-forth)
            let backAndForth = 0;
            for (let i = 2; i < steps.length; i++) {
                if (steps[i].department && steps[i].department === steps[i-2].department && steps[i].department !== steps[i-1].department) {
                    backAndForth++;
                }
            }
            if (backAndForth > 0) {
                parts.push(`We spotted <strong>${backAndForth} back-and-forth handoff(s)</strong> between departments — work bouncing between teams is a classic inefficiency that agents can eliminate by bridging the gap.`);
            }

            return parts.length > 0 ? parts.join('<br style="margin-bottom:0.3rem;">') : null;
        }

        function generateInsight8() {
            const handoffs = processData.handoffs || [];
            if (handoffs.length === 0) return null;

            const parts = [];
            const emailHandoffs = handoffs.filter(h => h.method === 'email').length;
            const badHandoffs = handoffs.filter(h => h.clarity === 'yes-multiple' || h.clarity === 'yes-major').length;
            const verbalHandoffs = handoffs.filter(h => h.method === 'verbal' || h.method === 'they-knew').length;

            if (emailHandoffs > handoffs.length * 0.5) {
                parts.push(`<strong>${emailHandoffs} of ${handoffs.length}</strong> handoffs use email. Email-based handoffs average <strong>3.2x longer</strong> delays than system-triggered transitions, because they depend on someone reading and acting on a message.`);
            }
            if (badHandoffs > 0) {
                parts.push(`<strong>${badHandoffs} handoff(s)</strong> have clarity issues. Unclear handoffs are the #1 source of rework — they cause an average <strong>2-5 day delay</strong> per occurrence. Each one is a prime candidate for agent automation.`);
            }
            if (verbalHandoffs > 0) {
                parts.push(`<strong>${verbalHandoffs} handoff(s)</strong> rely on verbal/informal communication. These are fragile — they break when people are sick, on holiday, or just busy. A simple notification automation eliminates this risk entirely.`);
            }
            if (parts.length === 0 && handoffs.length > 3) {
                parts.push(`With <strong>${handoffs.length} handoff points</strong>, even small delays compound. If each handoff adds just 30 minutes of waiting, that's <strong>${Math.round(handoffs.length * 0.5)} hours</strong> of dead time per instance.`);
            }

            return parts.length > 0 ? parts.join('<br style="margin-bottom:0.3rem;">') : null;
        }

        function generateInsight9() {
            const bn = processData.bottleneck;
            if (!bn?.longestStep) return null;

            const parts = [];
            const reason = bn.reason || '';
            const steps = processData.steps || [];
            const bnIdx = parseInt(String(bn.longestStep).replace('step-', ''));
            const bnStep = steps[bnIdx];

            if (reason === 'busy') {
                parts.push(`The bottleneck is caused by <strong>competing priorities</strong>. This is the most common pattern — it means the work itself isn't complex, just deprioritised. An AI agent can auto-assign, escalate, and track SLAs to prevent this.`);
            } else if (reason === 'approvals') {
                parts.push(`<strong>Multiple approvals</strong> are creating the bottleneck. Consider whether all approval levels are necessary, or if conditional auto-approval (e.g., under a threshold amount) could eliminate the delay entirely.`);
            } else if (reason === 'no-info') {
                parts.push(`The bottleneck is <strong>missing information</strong>. An agent that pre-validates data completeness at the start of the process could catch this early — moving the problem from a blocking delay to a 2-minute fix.`);
            } else if (reason === 'external') {
                parts.push(`An <strong>external dependency</strong> is causing the delay. While you can't control external parties, automated follow-up agents can chase responses at optimal intervals and escalate when SLAs are breached.`);
            } else if (reason === 'unclear') {
                parts.push(`The bottleneck stems from <strong>process ambiguity</strong>. This is a documentation and knowledge issue — an AI agent can surface the right procedure based on context, reducing decision paralysis.`);
            }

            if (bnStep && parts.length > 0) {
                parts.push(`Step "${bnStep.name}" in ${bnStep.department || 'your team'} is the critical path constraint. Fixing this single point would accelerate every instance of this process.`);
            }

            return parts.length > 0 ? parts.join('<br style="margin-bottom:0.3rem;">') : null;
        }

        // ============================================================
        function validateAndContinue(screen) {
            clearError(screen);
            let valid = true;
            let msg = '';

            switch (screen) {
                case 1:
                    if (!processData.processName) { valid = false; msg = 'Please select or describe a process.'; }
                    break;
                case 2:
                    const nameVal = document.getElementById('processNameInput').value.trim();
                    if (!nameVal) { valid = false; msg = 'Please enter what you call this process.'; }
                    else processData.processName = nameVal;
                    break;
                case 3:
                    if (!document.getElementById('processStarts').value.trim()) { valid = false; msg = 'Please describe when this process starts.'; }
                    else if (!document.getElementById('processCompletes').value.trim()) { valid = false; msg = 'Please describe when this process is complete.'; }
                    break;
                case 4:
                    if (!document.getElementById('exampleName').value.trim()) { valid = false; msg = 'Please describe a specific instance.'; }
                    else if (!document.getElementById('startDate').value) { valid = false; msg = 'Please enter a start date.'; }
                    else if (!document.getElementById('endDate').value) { valid = false; msg = 'Please enter an end date.'; }
                    else {
                        const s = new Date(document.getElementById('startDate').value);
                        const e = new Date(document.getElementById('endDate').value);
                        if (e <= s) { valid = false; msg = 'End date must be after start date.'; }
                        processData.lastExample.name = document.getElementById('exampleName').value.trim();
                    }
                    break;
                case 5:
                    if (!getRadioValue('totalTimeRange')) { valid = false; msg = 'Please select how much time you spent.'; }
                    else if (!getRadioValue('waitingPortion')) { valid = false; msg = 'Please select how much time was spent waiting.'; }
                    else if (!getRadioValue('primaryActivity')) { valid = false; msg = 'Please select your primary activity.'; }
                    break;
                case 6:
                    if (!getRadioValue('performance')) { valid = false; msg = 'Please select a performance assessment.'; }
                    break;
                case 7:
                    const steps = collectSteps();
                    if (steps.length < 3) { valid = false; msg = 'Please enter at least 3 steps.'; }
                    break;
                case 14:
                    if (!getRadioValue('frequency')) { valid = false; msg = 'Please select how often this process occurs.'; }
                    break;
            }

            if (!valid) {
                showError(screen, msg);
                return;
            }

            goToScreen(screen + 1);
        }

        function showError(screen, msg) {
            const box = document.getElementById('errorBox' + screen);
            const text = document.getElementById('errorText' + screen);
            if (box && text) {
                text.textContent = msg;
                box.classList.add('show');
            }
        }

        function clearError(screen) {
            const box = document.getElementById('errorBox' + screen);
            if (box) box.classList.remove('show');
        }

        // ============================================================
        // N8N FLOW DIAGRAM INTEGRATION
        // ============================================================
        const N8N_WEBHOOK_URL = window.N8N_WEBHOOK_URL || '/api/n8n-flow-diagram';

        async function triggerFlowDiagram(processes, contact) {
            const section = document.getElementById('flowDiagramSection');
            const loading = document.getElementById('flowDiagramLoading');
            const container = document.getElementById('flowDiagramsContainer');
            const errorDiv = document.getElementById('flowDiagramError');

            section.style.display = 'block';
            loading.style.display = 'block';
            container.style.display = 'none';
            errorDiv.style.display = 'none';

            // Build the payload for n8n
            const flowData = processes.map(p => ({
                processName: p.processName,
                processType: p.processType,
                startsWhen: p.definition?.startsWhen || '',
                completesWhen: p.definition?.completesWhen || '',
                steps: (p.steps || []).map(s => ({
                    number: s.number,
                    name: s.name,
                    department: s.department,
                    isExternal: s.isExternal || false
                })),
                handoffs: (p.handoffs || []).map(h => ({
                    from: { name: h.from?.name, department: h.from?.department, isExternal: h.from?.isExternal },
                    to: { name: h.to?.name, department: h.to?.department, isExternal: h.to?.isExternal },
                    method: h.method,
                    clarity: h.clarity
                })),
                approvals: (p.approvals || []).map(a => ({
                    name: a.name,
                    who: a.who,
                    assessment: a.assessment
                })),
                systems: (p.systems || []).map(s => ({
                    name: s.name,
                    purpose: s.purpose,
                    actions: s.actions
                })),
                bottleneck: p.bottleneck || {},
                costs: {
                    totalAnnualCost: p.costs?.totalAnnualCost || 0,
                    elapsedDays: p.lastExample?.elapsedDays || 0
                }
            }));

            try {
                const resp = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        processes: flowData,
                        contact: {
                            name: contact?.name || '',
                            email: contact?.email || '',
                            company: contact?.company || ''
                        },
                        requestType: 'flow-diagram',
                        timestamp: new Date().toISOString()
                    })
                });

                if (!resp.ok) throw new Error('n8n returned ' + resp.status);

                const result = await resp.json();

                if (result.diagramUrl) {
                    showFlowDiagram(result.diagramUrl);
                } else if (result.diagramBase64) {
                    // n8n returned a rendered image; still render our local diagrams
                    renderFlowDiagram(processes);
                } else if (result.mermaidCode) {
                    // n8n returned mermaid code; render our own swimlane instead
                    renderFlowDiagram(processes);
                } else {
                    // n8n accepted but diagram will be sent async (email)
                    loading.style.display = 'none';
                    errorDiv.querySelector('span:last-child').textContent =
                        'Flow diagram is being generated. It will be emailed to ' + (contact?.email || 'you') + ' shortly.';
                    errorDiv.style.display = 'flex';
                }
            } catch (err) {
                console.warn('n8n flow diagram unavailable, using local renderer:', err.message);
                renderFlowDiagram(processes);
            }
        }

        function showFlowDiagram(url) {
            // If n8n returns an external URL, just render local diagrams instead
            // (our custom renderer is more consistent)
            renderFlowDiagram(completedProcesses);
        }

        // ============================================================
        // CUSTOM SVG SWIMLANE RENDERER
        // No external dependencies. Produces SVG string directly.
        // ============================================================
        let lastRenderedSvg = null;

        // ============================================================
        // AUTOMATION OPPORTUNITY CLASSIFIER
        // Returns { category, label, reason } or null.
        //
        // Categories:
        //   'simple'      – Rule-based automation, no AI needed
        //   'agent'       – Autonomous AI agent
        //   'human-loop'  – Agent with human-in-the-loop oversight
        //   'multi-agent' – Multi-agent orchestration system
        // ============================================================
        const AUTOMATION_CATEGORIES = {
            simple:     { key: 'simple',     label: 'Simple Automation',  badge: 'S',  color: '#0891b2', bg: '#ecfeff' },
            agent:      { key: 'agent',      label: 'AI Agent',           badge: 'A',  color: '#7c3aed', bg: '#f5f3ff' },
            humanLoop:  { key: 'human-loop', label: 'Agent + Human',      badge: 'H',  color: '#ea580c', bg: '#fff7ed' },
            multiAgent: { key: 'multi-agent',label: 'Multi-Agent System', badge: 'M',  color: '#be185d', bg: '#fdf2f8' }
        };

        function classifyAutomation(step, stepIdx, process) {
            const name = (step.name || '').toLowerCase();
            const handoffs = process.handoffs || [];
            const systems = process.systems || [];
            const steps = process.steps || [];
            const handoff = handoffs[stepIdx];
            const prevHandoff = stepIdx > 0 ? handoffs[stepIdx - 1] : null;
            const hasCopy = systems.some(s => (s.actions || []).some(a => a === 'copy-in' || a === 'copy-out'));

            // Count how many departments this step touches (cross-dept context)
            const stepDept = step.department || 'Other';
            const prevDept = stepIdx > 0 ? (steps[stepIdx - 1]?.department || 'Other') : null;
            const nextDept = stepIdx < steps.length - 1 ? (steps[stepIdx + 1]?.department || 'Other') : null;
            const crossesDepts = (prevDept && prevDept !== stepDept) || (nextDept && nextDept !== stepDept);

            // Is this the bottleneck step?
            let isBottleneckStep = false;
            if (process.bottleneck?.longestStep) {
                const bnIdx = parseInt(String(process.bottleneck.longestStep).replace('step-', ''));
                isBottleneckStep = (bnIdx === stepIdx);
            }
            const hasBadHandoff = handoff && (handoff.clarity === 'yes-multiple' || handoff.clarity === 'yes-major');
            const hadBadHandoffIn = prevHandoff && (prevHandoff.clarity === 'yes-multiple' || prevHandoff.clarity === 'yes-major');

            // ─── MULTI-AGENT SYSTEM ───────────────────────────────────
            // Cross-department orchestration with complexity signals

            // Bad handoffs on BOTH sides = orchestration gap across teams
            if (hasBadHandoff && hadBadHandoffIn && crossesDepts) {
                return { ...AUTOMATION_CATEGORIES.multiAgent, reason: 'Cross-department orchestration gap — needs coordinated agents with routing, escalation, and status tracking' };
            }

            // Onboarding / provisioning that spans multiple departments
            if ((name.includes('onboard') || name.includes('provision')) && crossesDepts) {
                return { ...AUTOMATION_CATEGORIES.multiAgent, reason: 'Multi-department onboarding — needs provisioning agent, notification agent, and verification agent working in concert' };
            }

            // Complex coordination across teams
            if (name.includes('coordinate') && crossesDepts) {
                return { ...AUTOMATION_CATEGORIES.multiAgent, reason: 'Cross-team coordination — requires orchestrator agent delegating to specialist agents per department' };
            }

            // ─── AGENT + HUMAN-IN-THE-LOOP ────────────────────────────
            // Tasks where AI adds value but human judgment is essential

            // Approvals (especially bottlenecks) — agent pre-processes, human decides
            if (name.includes('approv')) {
                const extra = isBottleneckStep ? ' (bottleneck — agent can auto-route and prepare decision summary)' : '';
                return { ...AUTOMATION_CATEGORIES.humanLoop, reason: 'Approval decision — agent prepares context, validates criteria, and routes; human makes final call' + extra };
            }

            // Review / QA — agent can pre-check but human signs off
            if (name.includes('review') || name.includes('qa') || name.includes('audit')) {
                return { ...AUTOMATION_CATEGORIES.humanLoop, reason: 'Quality review — agent performs automated checks and flags anomalies; human confirms' };
            }

            // Validate / verify — agent checks rules, human handles exceptions
            if (name.includes('validate') || name.includes('verify')) {
                return { ...AUTOMATION_CATEGORIES.humanLoop, reason: 'Validation step — agent checks against business rules; human handles edge cases and exceptions' };
            }

            // Escalation — agent triages, human resolves
            if (name.includes('escalat') || name.includes('exception') || name.includes('dispute')) {
                return { ...AUTOMATION_CATEGORIES.humanLoop, reason: 'Exception handling — agent triages and categorises; human resolves complex cases' };
            }

            // Complex configuration / setup requiring judgment
            if ((name.includes('configure') || name.includes('design') || name.includes('plan')) && crossesDepts) {
                return { ...AUTOMATION_CATEGORIES.humanLoop, reason: 'Complex setup — agent drafts configuration; human reviews and adjusts' };
            }

            // ─── AUTONOMOUS AI AGENT ──────────────────────────────────
            // Needs intelligence / context but can run without human

            // Data matching / reconciliation (fuzzy logic, AI-powered)
            if (name.includes('match') || name.includes('reconcil') || name.includes('compare')) {
                return { ...AUTOMATION_CATEGORIES.agent, reason: 'Data reconciliation — agent uses fuzzy matching and context to auto-reconcile across sources' };
            }

            // Intelligent scheduling (optimisation, conflict resolution)
            if (name.includes('schedule') || name.includes('book') || name.includes('prioriti')) {
                return { ...AUTOMATION_CATEGORIES.agent, reason: 'Intelligent scheduling — agent optimises timing, resolves conflicts, and balances workload' };
            }

            // Follow-up / chasing (context-aware, adaptive)
            if (name.includes('follow up') || name.includes('chase') || name.includes('wait') || name.includes('remind')) {
                return { ...AUTOMATION_CATEGORIES.agent, reason: 'Adaptive follow-up — agent tracks status, adjusts urgency, and escalates when thresholds hit' };
            }

            // Classification / routing / triage
            if (name.includes('classify') || name.includes('categoris') || name.includes('categoriz') || name.includes('triage') || name.includes('assess')) {
                return { ...AUTOMATION_CATEGORIES.agent, reason: 'Intelligent classification — agent analyses content and routes to the right team/workflow' };
            }

            // Checking with context (not just rule-based)
            if (name.includes('check') && hasCopy) {
                return { ...AUTOMATION_CATEGORIES.agent, reason: 'Cross-system validation — agent checks data consistency across integrated systems' };
            }

            // Poor handoff bridge (agent manages the transition)
            if (hasBadHandoff && crossesDepts) {
                return { ...AUTOMATION_CATEGORIES.agent, reason: 'Handoff bridge — agent manages the transition, ensures data completeness, and confirms receipt' };
            }

            // Assign with context (needs some intelligence to pick the right person)
            if (name.includes('assign') || name.includes('allocat')) {
                return { ...AUTOMATION_CATEGORIES.agent, reason: 'Smart assignment — agent evaluates workload, skills, and availability to assign optimally' };
            }

            // ─── SIMPLE AUTOMATION ────────────────────────────────────
            // Deterministic, rule-based — no AI required

            // Send notification / email
            if (name.includes('send') || name.includes('notify') || name.includes('email')) {
                return { ...AUTOMATION_CATEGORIES.simple, reason: 'Notification trigger — automate with a rule: when step completes, fire templated message' };
            }

            // Data entry / copy-paste
            if (name.includes('enter') || name.includes('log') || name.includes('record') || name.includes('copy') || name.includes('input')) {
                return { ...AUTOMATION_CATEGORIES.simple, reason: 'Data entry — automate with direct API integration between source and target systems' };
            }

            // System update / transfer
            if (hasCopy && (name.includes('update') || name.includes('transfer') || name.includes('move') || name.includes('sync'))) {
                return { ...AUTOMATION_CATEGORIES.simple, reason: 'System sync — automate with API-to-API data pipeline, no human or AI needed' };
            }

            // Simple setup / provisioning (single department, no cross-dept)
            if ((name.includes('setup') || name.includes('provision') || name.includes('create account')) && !crossesDepts) {
                return { ...AUTOMATION_CATEGORIES.simple, reason: 'Provisioning — automate with scripted API calls to create/configure resources' };
            }

            // Status update / logging
            if (name.includes('status') || name.includes('stamp') || name.includes('mark as') || name.includes('close') || name.includes('archive')) {
                return { ...AUTOMATION_CATEGORIES.simple, reason: 'Status update — automate with a trigger rule that updates the record state' };
            }

            // Generate / produce standard output
            if (name.includes('generate') || name.includes('produce') || name.includes('print') || name.includes('export')) {
                return { ...AUTOMATION_CATEGORIES.simple, reason: 'Report/output generation — automate with templated generation triggered on completion' };
            }

            // Poor handoff within same department — simple routing fix
            if (hasBadHandoff && !crossesDepts) {
                return { ...AUTOMATION_CATEGORIES.simple, reason: 'Handoff automation — automate with a queue/notification that pushes work to the next person' };
            }

            return null;
        }

        // ============================================================
        // SVG SWIMLANE RENDERER (single process)
        // ============================================================
        // ── Current view mode: 'grid' (compact) or 'swimlane' (classic horizontal)
        let _flowViewMode = 'grid';
        let _flowProcesses = [];

        function buildFlowSVG(process) {
            return _flowViewMode === 'swimlane' ? buildSwimlaneSVG(process) : buildGridSVG(process);
        }

        // ============================================================
        // GRID VIEW (compact serpentine layout)
        // ============================================================
        /*
         * GRID FLOWCHART ROUTING CONTRACT
         * ────────────────────────────────
         * 1. LINE_GAP (32px) between every pair of parallel routing lines.
         * 2. Global channel allocator — unique channel per inter-row gap across ALL decisions.
         * 3. 32px minimum clearance between any node edge and the nearest routing line.
         * 4. Loop-backs route vertically through the LEFT margin (outside node columns).
         * 5. Forward same-row / multi-row routes use the RIGHT margin for vertical segments.
         * 6. Next-row forward uses a simple L-route through the inter-row gap (no margin).
         * 7. All branch lines enter target nodes from ABOVE (gap above target row).
         * 8. PAD_L expands dynamically to fit left-margin channels.
         * 9. SVG width expands to fit right-margin channels.
         * 10. Labels render AFTER all paths and nodes (always in front).
         * 11. Labels are positioned on their path's actual horizontal segment.
         * 12. Label collision avoidance: horizontal nudge first, then vertical.
         */
        function buildGridSVG(process) {
            const NODE_W = 210;
            const NODE_H = 76;
            const NODE_GAP_X = 60;
            const NODE_GAP_Y = 70;
            const COLS = Math.min(6, Math.max(4, Math.ceil(Math.sqrt((process.steps || []).length * 1.5))));
            let PAD_L = 80;
            const PAD_T = 180;
            const TERM_W = 180;
            const TERM_H = 50;
            const TERM_RX = 25;
            const AGENT_BADGE_R = 10;

            const deptColors = {
                'Sales': { bg: '#dbeafe', stroke: '#3b82f6' },
                'Operations': { bg: '#fef3c7', stroke: '#f59e0b' },
                'Finance': { bg: '#dcfce7', stroke: '#22c55e' },
                'IT': { bg: '#e0e7ff', stroke: '#6366f1' },
                'Customer Success': { bg: '#fce7f3', stroke: '#ec4899' },
                'Product': { bg: '#f3e8ff', stroke: '#a855f7' },
                'Leadership': { bg: '#fef9c3', stroke: '#ca8a04' },
                'HR': { bg: '#ffedd5', stroke: '#ea580c' },
                'Procurement': { bg: '#e0f2fe', stroke: '#0284c7' },
                'Legal': { bg: '#fce4ec', stroke: '#e91e63' },
                'Compliance': { bg: '#f3e5f5', stroke: '#9c27b0' },
                'Engineering': { bg: '#e8eaf6', stroke: '#3f51b5' },
                'Risk': { bg: '#fff3e0', stroke: '#e65100' },
                'Data Protection': { bg: '#e8f5e9', stroke: '#2e7d32' },
                'Quality Assurance': { bg: '#e1f5fe', stroke: '#0277bd' },
                'Quality': { bg: '#e1f5fe', stroke: '#0277bd' },
                'Facilities': { bg: '#efebe9', stroke: '#795548' },
                'Executive Board': { bg: '#fef9c3', stroke: '#ca8a04' }
            };
            function getDeptColor(dept) {
                if (deptColors[dept]) return deptColors[dept];
                if (dept && dept.includes('External')) return { bg: '#fffbeb', stroke: '#d97706' };
                return { bg: '#f1f5f9', stroke: '#94a3b8' };
            }

            const p = process;
            const steps = p.steps || [];
            const handoffs = p.handoffs || [];
            const approvals = p.approvals || [];
            const startLabel = p.definition?.startsWhen || 'Start';
            const endLabel = p.definition?.completesWhen || 'Complete';
            if (steps.length === 0) return '';

            const allSteps = steps.map((s, i) => {
                const isApproval = approvals.some(a =>
                    s.name && (s.name.toLowerCase().includes('approv') || s.name.toLowerCase().includes('review'))
                );
                let isBottleneck = false;
                if (p.bottleneck?.longestStep) {
                    const bnIdx = parseInt(String(p.bottleneck.longestStep).replace('step-', ''));
                    if (bnIdx === i) isBottleneck = true;
                }
                const auto = classifyAutomation(s, i, p);
                return {
                    idx: i, name: s.name || 'Step ' + (i + 1),
                    department: s.department || 'Other',
                    isApproval, isBottleneck,
                    isDecision: !!s.isDecision, branches: s.branches || [],
                    isExternal: !!s.isExternal, auto
                };
            });

            const handoffMap = {};
            handoffs.forEach((h, i) => {
                if (i + 1 < allSteps.length) {
                    handoffMap[i + '->' + (i + 1)] = {
                        method: h.method ? h.method.replace(/-/g, ' ') : '',
                        isBad: h.clarity === 'yes-multiple' || h.clarity === 'yes-major'
                    };
                }
            });

            // ── Grid layout: serpentine rows ──
            const DIAMOND_W = 170;
            const DIAMOND_H = 110;
            const LINE_GAP = 32;
            const colW = NODE_W + NODE_GAP_X;
            const hasDecisions = allSteps.some(s => s.isDecision && s.branches.length > 0);
            const numRows = Math.ceil(allSteps.length / COLS);

            // Pre-count branch lines per inter-row gap to size rows dynamically
            const gapLineCount = {};
            allSteps.forEach((s, i) => {
                if (!s.isDecision || !s.branches || s.branches.length === 0) return;
                const srcRow = Math.floor(i / COLS);
                s.branches.forEach(br => {
                    const m = (br.target || '').match(/(\d+)/);
                    if (!m) return;
                    const tgtIdx = parseInt(m[1]) - 1;
                    if (tgtIdx < 0 || tgtIdx >= allSteps.length) return;
                    const tgtRow = Math.floor(tgtIdx / COLS);
                    if (tgtIdx < i) {
                        const gapKey = 'above_' + srcRow;
                        gapLineCount[gapKey] = (gapLineCount[gapKey] || 0) + 1;
                    } else if (tgtRow > srcRow) {
                        const gapKey = 'below_' + srcRow;
                        gapLineCount[gapKey] = (gapLineCount[gapKey] || 0) + 1;
                    } else {
                        const gapKey = 'above_' + srcRow;
                        gapLineCount[gapKey] = (gapLineCount[gapKey] || 0) + 1;
                    }
                });
            });
            const maxLinesInAnyGap = Math.max(1, ...Object.values(gapLineCount), 0);
            const minGapForLines = maxLinesInAnyGap * LINE_GAP + 2 * LINE_GAP;
            const baseRowH = NODE_H + NODE_GAP_Y + (hasDecisions ? 40 : 20);
            const rowH = Math.max(baseRowH, NODE_H + minGapForLines);

            // Ensure left margin has room for loop-back routing channels
            PAD_L = Math.max(80, maxLinesInAnyGap * LINE_GAP + 40);

            const nodePos = [];

            allSteps.forEach((s, i) => {
                const row = Math.floor(i / COLS);
                let col = i % COLS;
                if (row % 2 === 1) col = COLS - 1 - col;
                const nx = PAD_L + col * colW;
                const ny = PAD_T + row * rowH;
                nodePos[i] = { x: nx, y: ny, cx: nx + NODE_W / 2, cy: ny + NODE_H / 2, row, col };
            });

            // SVG dimensions — include space for right-margin routing channels
            const contentW = PAD_L + COLS * colW + maxLinesInAnyGap * LINE_GAP + 60;
            const contentH = PAD_T + numRows * rowH + 60;
            const totalW = Math.max(contentW, 700);
            const totalH = contentH;

            let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${totalW} ${totalH}" width="${totalW}" height="${totalH}" style="font-family: 'Work Sans', Arial, sans-serif;">`;
            svg += `<rect x="0" y="0" width="${totalW}" height="${totalH}" fill="#ffffff" rx="16" filter="url(#gridCardShadow)"/>`;

            // Card header bar (browser chrome)
            svg += `<rect x="0" y="0" width="${totalW}" height="36" rx="16" fill="#f8fafb"/>`;
            svg += `<rect x="0" y="24" width="${totalW}" height="12" fill="#f8fafb"/>`;
            svg += `<circle cx="18" cy="18" r="3.5" fill="#e5e7eb"/><circle cx="30" cy="18" r="3.5" fill="#e5e7eb"/><circle cx="42" cy="18" r="3.5" fill="#e5e7eb"/>`;
            svg += `<text x="${totalW / 2}" y="20" text-anchor="middle" font-size="9" font-weight="400" fill="#94a3b8" letter-spacing="0.5">grid</text>`;

            // Title
            svg += `<text x="${totalW / 2}" y="56" text-anchor="middle" font-size="14" font-weight="600" fill="#1a2f4a" letter-spacing="-0.3">${escSvg(p.processName || 'Process Flow')}</text>`;
            const decCount = allSteps.filter(s => s.isDecision).length;
            const extCount = allSteps.filter(s => s.isExternal).length;
            svg += `<text x="${totalW / 2}" y="72" text-anchor="middle" font-size="10" fill="#94a3b8" letter-spacing="0.3">${allSteps.length} steps · ${[...new Set(allSteps.map(s => s.department))].length} depts${decCount ? ' · ' + decCount + ' decisions' : ''}${extCount ? ' · ' + extCount + ' external' : ''}</text>`;

            // Defs
            svg += `<defs>`;
            svg += `<marker id="arw" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto"><path d="M 0 1 L 10 5 L 0 9 z" fill="#94a3b8"/></marker>`;
            svg += `<marker id="arw-bad" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto"><path d="M 0 1 L 10 5 L 0 9 z" fill="#ef4444"/></marker>`;
            ['#7c3aed','#2563eb','#059669','#d97706','#dc2626'].forEach((c, ci) => {
                svg += `<marker id="arwc${ci}" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto"><path d="M 0 1 L 10 5 L 0 9 z" fill="${c}"/></marker>`;
            });
            svg += `<filter id="shadow" x="-8%" y="-8%" width="116%" height="120%"><feDropShadow dx="0" dy="2" stdDeviation="4" flood-opacity="0.06"/></filter>`;
            svg += `<filter id="gridCardShadow" x="-2%" y="-2%" width="104%" height="106%"><feDropShadow dx="0" dy="4" stdDeviation="12" flood-opacity="0.04"/><feDropShadow dx="0" dy="1" stdDeviation="3" flood-opacity="0.03"/></filter>`;
            svg += `<filter id="gridGlow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="2" stdDeviation="6" flood-opacity="0.12" flood-color="#3d8ea6"/></filter>`;
            svg += `</defs>`;

            // CSS: animate lines + hover interactivity on nodes
            svg += `<style>
                @keyframes flowDash { to { stroke-dashoffset: -40; } }
                @keyframes particleMove { 0% { offset-distance: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { offset-distance: 100%; opacity: 0; } }
                @keyframes nodeIn { from { opacity: 0; transform: translateY(8px) scale(0.96); } to { opacity: 1; transform: none; } }
                .flow-arrow { stroke-dasharray: 8 6; animation: flowDash 1.5s linear infinite; }
                .flow-particle { r: 3; fill: #3d8ea6; animation: particleMove 3s linear infinite; }
                .gnode { cursor: pointer; transition: filter 0.25s ease, transform 0.25s cubic-bezier(0.16,1,0.3,1); transform-origin: center; transform-box: fill-box; animation: nodeIn 0.5s cubic-bezier(0.16,1,0.3,1) both; }
                .gnode:hover { filter: url(#gridGlow); transform: scale(1.04) translateY(-2px); }
            </style>`;

            // ── Draw sequential arrows (orthogonal 90°) ──
            function drawSeqArrow(fromIdx, toIdx) {
                const fp = nodePos[fromIdx], tp = nodePos[toIdx];
                const hk = fromIdx + '->' + toIdx;
                const hd = handoffMap[hk] || { method: '', isBad: false };
                const color = hd.isBad ? '#ef4444' : '#94a3b8';
                const marker = hd.isBad ? 'url(#arw-bad)' : 'url(#arw)';
                const fromIsDec = allSteps[fromIdx].isDecision && (allSteps[fromIdx].branches || []).length > 0;
                const toIsDec = allSteps[toIdx].isDecision && (allSteps[toIdx].branches || []).length > 0;
                let pathD;

                if (fp.row === tp.row) {
                    const goRight = fp.col < tp.col;
                    const x1 = goRight
                        ? (fromIsDec ? fp.cx + DIAMOND_W / 2 : fp.x + NODE_W)
                        : (fromIsDec ? fp.cx - DIAMOND_W / 2 : fp.x);
                    const x2 = goRight
                        ? (toIsDec ? tp.cx - DIAMOND_W / 2 : tp.x)
                        : (toIsDec ? tp.cx + DIAMOND_W / 2 : tp.x + NODE_W);
                    pathD = `M ${x1} ${fp.cy} L ${x2} ${tp.cy}`;
                } else {
                    const x1 = fp.cx;
                    const y1 = fromIsDec ? fp.cy + DIAMOND_H / 2 : fp.y + NODE_H;
                    const channelY = fp.y + NODE_H + (rowH - NODE_H) / 2;
                    const x2 = tp.cx;
                    const y2 = toIsDec ? tp.cy - DIAMOND_H / 2 : tp.y;
                    pathD = `M ${x1} ${y1} L ${x1} ${channelY} L ${x2} ${channelY} L ${x2} ${y2}`;
                }
                svg += `<path d="${pathD}" fill="none" stroke="${color}" stroke-width="1.8" class="flow-arrow" marker-end="${marker}" opacity="0.5"/>`;
                svg += `<circle class="flow-particle" style="offset-path:path('${pathD}');animation-duration:2.5s;fill:${hd.isBad ? '#ef4444' : '#3d8ea6'};"/>`;
            }

            // Build set of nodes that receive at least one incoming connection
            const hasIncoming = new Set();
            for (let i = 0; i < allSteps.length - 1; i++) {
                if (!(allSteps[i].isDecision && allSteps[i].branches && allSteps[i].branches.length > 0)) {
                    hasIncoming.add(i + 1);
                    drawSeqArrow(i, i + 1);
                }
            }
            // Decision branches also provide incoming connections
            allSteps.forEach((s, i) => {
                if (!s.isDecision || !s.branches) return;
                s.branches.forEach(br => {
                    const m = (br.target || '').match(/(\d+)/);
                    if (m) hasIncoming.add(parseInt(m[1]) - 1);
                });
            });
            // Draw arrows to orphaned nodes (no sequential and no branch targets them)
            for (let i = 1; i < allSteps.length; i++) {
                if (!hasIncoming.has(i)) drawSeqArrow(i - 1, i);
            }

            // ── Build incoming-route map for target badges ──
            const branchColors = ['#7c3aed', '#2563eb', '#059669', '#d97706', '#dc2626'];
            const incomingRoutes = {};
            allSteps.forEach((s, i) => {
                if (!s.isDecision || s.branches.length === 0) return;
                s.branches.forEach((br, bi) => {
                    const targetMatch = (br.target || '').match(/(\d+)/);
                    const targetIdx = targetMatch ? parseInt(targetMatch[1]) - 1 : -1;
                    if (targetIdx >= 0 && targetIdx < allSteps.length) {
                        if (!incomingRoutes[targetIdx]) incomingRoutes[targetIdx] = [];
                        incomingRoutes[targetIdx].push({ fromStep: i + 1, color: branchColors[bi % branchColors.length], label: br.label });
                    }
                });
            });

            // ── Decision branch connecting lines (rendered BEFORE nodes so lines appear behind) ──
            // Routes through inter-row gaps with globally allocated channels for consistent LINE_GAP spacing.
            const TITLE_ZONE = 90;
            function rowGapMidY(row) {
                const raw = PAD_T + row * rowH - (rowH - NODE_H) / 2;
                return Math.max(raw, TITLE_ZONE);
            }

            // Global channel allocator: each gap gets unique channel indices across ALL decisions
            const gapChannels = {};
            function allocateChannel(gapKey) {
                if (!(gapKey in gapChannels)) gapChannels[gapKey] = 0;
                return gapChannels[gapKey]++;
            }
            const pendingLabels = [];
            const RIGHT_MARGIN_BASE = PAD_L + COLS * colW + 30;

            allSteps.forEach((s, i) => {
                if (!s.isDecision || !s.branches || s.branches.length === 0) return;
                const pos = nodePos[i];
                if (!pos) return;
                const cx = pos.cx, cy = pos.cy;
                const hw = DIAMOND_W / 2, hh = DIAMOND_H / 2;

                s.branches.forEach((br, bi) => {
                    const color = branchColors[bi % branchColors.length];
                    const targetMatch = (br.target || '').match(/(\d+)/);
                    const targetIdx = targetMatch ? parseInt(targetMatch[1]) - 1 : -1;
                    if (targetIdx < 0 || targetIdx >= allSteps.length) return;

                    const tp = nodePos[targetIdx];
                    if (!tp) return;
                    const isTargetDec = allSteps[targetIdx].isDecision && (allSteps[targetIdx].branches || []).length > 0;
                    const tHH = isTargetDec ? DIAMOND_H / 2 : 0;
                    const goesBack = targetIdx < i;
                    const sameRow = pos.row === tp.row;

                    const entryX = tp.cx;
                    const entryY = isTargetDec ? tp.cy - tHH : tp.y;
                    const clampY = y => Math.max(y, TITLE_ZONE);

                    let pathD;
                    let chOff;
                    let ch;
                    let labelSegX1, labelSegX2, labelSegY;

                    if (goesBack) {
                        // LOOP-BACK: route through LEFT margin, enter target from ABOVE
                        const gapKey = 'above_' + tp.row;
                        ch = allocateChannel(gapKey);
                        chOff = ch * LINE_GAP;
                        const exitX = cx - hw;
                        const exitY = cy;
                        const marginX = Math.max(8, PAD_L - 30 - ch * LINE_GAP);
                        const tgtGapY = clampY(rowGapMidY(tp.row) - chOff);
                        pathD = `M ${exitX} ${exitY} L ${marginX} ${exitY} L ${marginX} ${tgtGapY} L ${entryX} ${tgtGapY} L ${entryX} ${entryY}`;
                        labelSegX1 = marginX; labelSegX2 = entryX; labelSegY = tgtGapY;

                    } else if (sameRow) {
                        // Same-row forward branch: exit towards the target
                        const gapKey = 'above_' + pos.row;
                        ch = allocateChannel(gapKey);
                        chOff = ch * LINE_GAP;
                        const targetIsRight = tp.col > pos.col;
                        const exitX = targetIsRight ? cx + hw : cx - hw;
                        const exitY = cy;
                        const gapY = clampY(rowGapMidY(pos.row) - chOff);
                        pathD = `M ${exitX} ${exitY} L ${exitX} ${gapY} L ${entryX} ${gapY} L ${entryX} ${entryY}`;
                        labelSegX1 = Math.min(exitX, entryX); labelSegX2 = Math.max(exitX, entryX); labelSegY = gapY;

                    } else if (tp.row > pos.row) {
                        // FORWARD to later row
                        const gapKey = 'below_' + pos.row;
                        ch = allocateChannel(gapKey);
                        chOff = ch * LINE_GAP;
                        const exitX = cx;
                        const exitY = cy + hh;
                        const gapY = rowGapMidY(pos.row + 1) + chOff;
                        if (tp.row === pos.row + 1) {
                            pathD = `M ${exitX} ${exitY} L ${exitX} ${gapY} L ${entryX} ${gapY} L ${entryX} ${entryY}`;
                            labelSegX1 = Math.min(exitX, entryX); labelSegX2 = Math.max(exitX, entryX); labelSegY = gapY;
                        } else {
                            const marginX = RIGHT_MARGIN_BASE + ch * LINE_GAP;
                            const targetGapY = clampY(rowGapMidY(tp.row) - chOff);
                            pathD = `M ${exitX} ${exitY} L ${exitX} ${gapY} L ${marginX} ${gapY} L ${marginX} ${targetGapY} L ${entryX} ${targetGapY} L ${entryX} ${entryY}`;
                            labelSegX1 = Math.min(exitX, marginX); labelSegX2 = Math.max(exitX, marginX); labelSegY = gapY;
                        }

                    } else {
                        // Forward to earlier row (rare): enter target from ABOVE
                        const gapKey = 'above_' + pos.row;
                        ch = allocateChannel(gapKey);
                        chOff = ch * LINE_GAP;
                        const exitX = cx;
                        const exitY = cy - hh;
                        const gapY = clampY(rowGapMidY(pos.row) - chOff);
                        const marginX = RIGHT_MARGIN_BASE + ch * LINE_GAP;
                        const targetGapY = clampY(rowGapMidY(tp.row) - chOff);
                        pathD = `M ${exitX} ${exitY} L ${exitX} ${gapY} L ${marginX} ${gapY} L ${marginX} ${targetGapY} L ${entryX} ${targetGapY} L ${entryX} ${entryY}`;
                        labelSegX1 = Math.min(exitX, marginX); labelSegX2 = Math.max(exitX, marginX); labelSegY = gapY;
                    }

                    // Draw line
                    const dashAttr = goesBack ? 'stroke-dasharray="6,4"' : '';
                    svg += `<path d="${pathD}" fill="none" stroke="${color}" stroke-width="2" ${dashAttr} marker-end="url(#arwc${bi % 5})" opacity="0.75"/>`;

                    // Animated particle
                    svg += `<circle r="3" fill="${color}" opacity="0.8"><animateMotion dur="${2.5 + bi * 0.5}s" repeatCount="indefinite" begin="${bi * 0.4}s" path="${pathD}"><\/animateMotion><\/circle>`;

                    // Collect label: position between source & target, clamped to the actual line segment
                    const brText = escSvg(br.label);
                    const pillW = brText.length * 4.8 + 14;
                    const pillH = 15;
                    const idealX = (cx + entryX) / 2;
                    const segMin = Math.min(labelSegX1, labelSegX2);
                    const segMax = Math.max(labelSegX1, labelSegX2);
                    let elX = Math.max(segMin + pillW / 2, Math.min(idealX, segMax - pillW / 2));
                    let elY = labelSegY;
                    elX = Math.max(pillW / 2 + 10, Math.min(elX, totalW - pillW / 2 - 10));
                    pendingLabels.push({ x: elX, y: elY, w: pillW, h: pillH, color, text: brText });
                });
            });

            // ── Helper: word-wrap text to N chars per line ──
            function wrapText(text, maxChars) {
                const words = text.split(/\s+/);
                const lines = []; let cur = '';
                words.forEach(w => { const t = cur ? cur + ' ' + w : w; if (t.length > maxChars && cur) { lines.push(cur); cur = w; } else { cur = t; } });
                if (cur) lines.push(cur);
                return lines;
            }

            // ── Draw nodes ──
            allSteps.forEach((s, i) => {
                const pos = nodePos[i];
                if (!pos) return;
                const dc = getDeptColor(s.department);
                const isDecNode = s.isDecision && s.branches.length > 0;

                svg += `<g class="gnode" style="animation-delay:${i * 0.06}s">`;

                if (isDecNode) {
                    // ── DIAMOND (standard flowchart decision symbol) ──
                    const cx = pos.cx, cy = pos.cy;
                    const hw = DIAMOND_W / 2, hh = DIAMOND_H / 2;
                    svg += `<polygon points="${cx},${cy - hh} ${cx + hw},${cy} ${cx},${cy + hh} ${cx - hw},${cy}" fill="#f5f3ff" stroke="#7c3aed" stroke-width="2" filter="url(#shadow)"/>`;

                    // Step number badge (top)
                    svg += `<circle cx="${cx}" cy="${cy - hh + 8}" r="8" fill="#7c3aed" opacity="0.15"/>`;
                    svg += `<text x="${cx}" y="${cy - hh + 11}" text-anchor="middle" font-size="8" font-weight="700" fill="#7c3aed">${i + 1}</text>`;

                    // Name inside diamond (full text)
                    let dLines = wrapText(s.name, 20);
                    const dFontSize = dLines.length > 3 ? 7.5 : 9;
                    const dLineH = dFontSize + 2.5;
                    const dBlockH = dLines.length * dLineH;
                    const dStartY = cy - dBlockH / 2 + dFontSize;
                    dLines.forEach((line, li) => {
                        svg += `<text x="${cx}" y="${dStartY + li * dLineH}" text-anchor="middle" font-size="${dFontSize}" fill="#4c1d95" font-weight="500">${escSvg(line)}</text>`;
                    });

                    // Dept label below name
                    svg += `<text x="${cx}" y="${cy + hh - 10}" text-anchor="middle" font-size="7" fill="#7c3aed" opacity="0.6">${escSvg(s.department)}</text>`;

                    // Auto badge
                    if (s.auto) {
                        svg += `<circle cx="${cx + hw - 4}" cy="${cy - hh + 4}" r="8" fill="${s.auto.color}" stroke="#fff" stroke-width="1.5"/>`;
                        svg += `<text x="${cx + hw - 4}" y="${cy - hh + 7}" text-anchor="middle" font-size="7" fill="#fff" font-weight="700">${s.auto.badge}</text>`;
                    }

                    // Incoming route indicators on diamond
                    const incoming = incomingRoutes[i] || [];
                    incoming.forEach((inc, ii) => {
                        const ix = cx - hw + 4;
                        const iy = cy - 10 + ii * 12;
                        svg += `<circle cx="${ix}" cy="${iy}" r="5" fill="${inc.color}" stroke="#fff" stroke-width="1"/>`;
                        svg += `<text x="${ix}" y="${iy + 2}" text-anchor="middle" font-size="5" fill="#fff" font-weight="700">${inc.fromStep}</text>`;
                        svg += `<title>From Step ${inc.fromStep}: ${escSvg(inc.label)}</title>`;
                    });

                } else {
                    // ── RECTANGLE (regular process step) ──
                    const incoming = incomingRoutes[i] || [];
                    let fill = dc.bg, stroke = dc.stroke, sw = 1.5, textCol = '#1e293b';
                    if (s.isBottleneck) { fill = '#fee2e2'; stroke = '#ef4444'; sw = 2; textCol = '#991b1b'; }
                    else if (s.isApproval) { fill = '#fef3c7'; stroke = '#d97706'; sw = 1.8; textCol = '#92400e'; }
                    else if (incoming.length === 1) { stroke = incoming[0].color; sw = 1.8; }
                    const rx = s.isApproval ? 14 : 10;

                    svg += `<rect x="${pos.x}" y="${pos.y}" width="${NODE_W}" height="${NODE_H}" rx="${rx}" fill="#ffffff" stroke="${stroke}" stroke-width="${sw}" filter="url(#shadow)"/>`;
                    svg += `<rect x="${pos.x}" y="${pos.y}" width="${NODE_W}" height="${NODE_H}" rx="${rx}" fill="${fill}" opacity="0.45"/>`;

                    // Step badge
                    const badgeBg = s.isBottleneck ? '#ef4444' : s.isApproval ? '#d97706' : stroke;
                    svg += `<circle cx="${pos.x + 15}" cy="${pos.y + 15}" r="10" fill="${badgeBg}" opacity="0.12"/>`;
                    svg += `<text x="${pos.x + 15}" y="${pos.y + 19}" text-anchor="middle" font-size="9" font-weight="700" fill="${badgeBg}">${i + 1}</text>`;

                    // Department label (full text)
                    svg += `<text x="${pos.x + NODE_W - 6}" y="${pos.y + 12}" text-anchor="end" font-size="7" fill="${stroke}" opacity="0.7">${escSvg(s.department)}</text>`;

                    // Incoming route indicators
                    incoming.forEach((inc, ii) => {
                        const by = pos.y + 14 + ii * 12;
                        svg += `<circle cx="${pos.x - 1}" cy="${by}" r="5" fill="${inc.color}" stroke="#fff" stroke-width="1.5"/>`;
                        svg += `<text x="${pos.x - 1}" y="${by + 2}" text-anchor="middle" font-size="5" fill="#fff" font-weight="700">${inc.fromStep}</text>`;
                        svg += `<title>From Step ${inc.fromStep}: ${escSvg(inc.label)}</title>`;
                    });

                    // Name (full text, auto-sized to fit wider nodes)
                    let lines = wrapText(s.name, 28);
                    const fontSize = lines.length > 3 ? 8.5 : 10.5;
                    const lineH = fontSize + 2;
                    const blockH = lines.length * lineH;
                    const textStartY = pos.y + 18 + (NODE_H - 18 - blockH) / 2 + fontSize;
                    lines.forEach((line, li) => {
                        svg += `<text x="${pos.x + NODE_W / 2}" y="${textStartY + li * lineH}" text-anchor="middle" font-size="${fontSize}" fill="${textCol}" font-weight="500">${escSvg(line)}</text>`;
                    });

                    // Auto badge
                    if (s.auto) {
                        const bx = pos.x + NODE_W - 6, by = pos.y - 4;
                        svg += `<circle cx="${bx}" cy="${by}" r="${AGENT_BADGE_R}" fill="${s.auto.color}" stroke="#fff" stroke-width="2"/>`;
                        svg += `<text x="${bx}" y="${by + 4}" text-anchor="middle" font-size="9" fill="#fff" font-weight="700">${s.auto.badge}</text>`;
                    }
                }

                svg += `</g>`;
            });

            // ── Render deferred labels (in front of all lines and nodes) with collision avoidance ──
            const placedLabels = [];
            function labelsOverlap(ax, ay, aw, ah) {
                return placedLabels.some(p =>
                    Math.abs(ax - p.x) < (aw + p.w) / 2 + 6 &&
                    Math.abs(ay - p.y) < (ah + p.h) / 2 + 2
                );
            }
            pendingLabels.forEach(lbl => {
                let { x, y, w, h, color, text } = lbl;
                if (labelsOverlap(x, y, w, h)) {
                    // Try horizontal nudge first (left then right)
                    let resolved = false;
                    for (let dx = 1; dx <= 6 && !resolved; dx++) {
                        const shift = dx * (w * 0.6);
                        if (!labelsOverlap(x - shift, y, w, h)) { x -= shift; resolved = true; }
                        else if (!labelsOverlap(x + shift, y, w, h)) { x += shift; resolved = true; }
                    }
                    // Fall back to vertical nudge (max 3 steps)
                    if (!resolved) {
                        for (let dy = 1; dy <= 3; dy++) {
                            y += h + 4;
                            if (!labelsOverlap(x, y, w, h)) break;
                        }
                    }
                }
                x = Math.max(w / 2 + 4, Math.min(x, totalW - w / 2 - 4));
                placedLabels.push({ x, y, w, h });
                svg += `<rect x="${x - w / 2}" y="${y - h / 2}" width="${w}" height="${h}" rx="${h / 2}" fill="#fff" stroke="${color}" stroke-width="0.8" opacity="0.97"/>`;
                svg += `<text x="${x}" y="${y + 4}" text-anchor="middle" font-size="7" fill="${color}" font-weight="600">${text}</text>`;
            });

            // ── Legend ──
            const autoCount = allSteps.filter(s => s.auto).length;
            const legendY = totalH - 50;
            svg += `<line x1="${PAD_L}" y1="${legendY - 8}" x2="${totalW - PAD_L}" y2="${legendY - 8}" stroke="#e2e8f0" stroke-width="0.5"/>`;
            let lx = PAD_L;
            svg += `<rect x="${lx}" y="${legendY}" width="14" height="14" rx="4" fill="#fff" stroke="#94a3b8" stroke-width="1.2"/>`;
            svg += `<text x="${lx + 20}" y="${legendY + 11}" font-size="9" fill="#64748b">Process Step</text>`;
            lx += 100;
            if (hasDecisions) {
                const dx = lx + 7, dy = legendY + 7, dd = 7;
                svg += `<polygon points="${dx},${dy - dd} ${dx + dd},${dy} ${dx},${dy + dd} ${dx - dd},${dy}" fill="#f5f3ff" stroke="#7c3aed" stroke-width="1.2"/>`;
                svg += `<text x="${lx + 20}" y="${legendY + 11}" font-size="9" fill="#64748b">Decision</text>`;
                lx += 80;
            }
            svg += `<rect x="${lx}" y="${legendY}" width="14" height="14" rx="4" fill="#fee2e2" stroke="#ef4444" stroke-width="1.2"/>`;
            svg += `<text x="${lx + 20}" y="${legendY + 11}" font-size="9" fill="#64748b">Bottleneck</text>`;
            lx += 90;
            svg += `<rect x="${lx}" y="${legendY}" width="14" height="14" rx="4" fill="#fef3c7" stroke="#d97706" stroke-width="1.2"/>`;
            svg += `<text x="${lx + 20}" y="${legendY + 11}" font-size="9" fill="#64748b">Approval</text>`;
            lx += 85;
            svg += `<line x1="${lx}" y1="${legendY + 7}" x2="${lx + 20}" y2="${legendY + 7}" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="5,3"/>`;
            svg += `<text x="${lx + 26}" y="${legendY + 11}" font-size="9" fill="#64748b">Bad handoff</text>`;
            if (hasDecisions) {
                lx += 100;
                svg += `<line x1="${lx}" y1="${legendY + 7}" x2="${lx + 20}" y2="${legendY + 7}" stroke="#7c3aed" stroke-width="2"/>`;
                svg += `<polygon points="${lx + 18},${legendY + 4} ${lx + 24},${legendY + 7} ${lx + 18},${legendY + 10}" fill="#7c3aed"/>`;
                svg += `<text x="${lx + 30}" y="${legendY + 11}" font-size="9" fill="#64748b">Alternate path</text>`;
            }

            if (autoCount > 0) {
                const row2Y = legendY + 18;
                lx = PAD_L;
                svg += `<text x="${lx}" y="${row2Y + 10}" font-size="9" font-weight="600" fill="#475569">Auto:</text>`;
                lx += 40;
                const cats = [AUTOMATION_CATEGORIES.simple, AUTOMATION_CATEGORIES.agent, AUTOMATION_CATEGORIES.humanLoop, AUTOMATION_CATEGORIES.multiAgent];
                cats.forEach(cat => {
                    const count = allSteps.filter(s => s.auto && s.auto.key === cat.key).length;
                    if (count > 0) {
                        svg += `<circle cx="${lx + 7}" cy="${row2Y + 6}" r="7" fill="${cat.color}" stroke="#fff" stroke-width="1.5"/>`;
                        svg += `<text x="${lx + 7}" y="${row2Y + 9}" text-anchor="middle" font-size="7" fill="#fff" font-weight="700">${cat.badge}</text>`;
                        svg += `<text x="${lx + 18}" y="${row2Y + 10}" font-size="9" fill="${cat.color}" font-weight="500">${cat.label} (${count})</text>`;
                        lx += 18 + cat.label.length * 6 + 26;
                    }
                });
            }

            svg += '</svg>';
            return svg;
        }

        // ============================================================
        // SWIMLANE VIEW (classic horizontal department lanes)
        // ============================================================
        function buildSwimlaneSVG(process) {
            const LANE_LABEL_W = 140;
            const NODE_W = 190;
            const NODE_H = 72;
            const NODE_GAP_X = 60;
            const LANE_PAD_Y = 28;
            const LANE_GAP = 3;
            const START_X = LANE_LABEL_W + 30;
            const TOP_PAD = 130;
            const TERM_W = 160;
            const TERM_H = 46;
            const TERM_RX = 23;

            const deptColors = {
                'Sales': { bg: '#dbeafe', stroke: '#3b82f6' },
                'Operations': { bg: '#fef3c7', stroke: '#f59e0b' },
                'Finance': { bg: '#dcfce7', stroke: '#22c55e' },
                'IT': { bg: '#e0e7ff', stroke: '#6366f1' },
                'Customer Success': { bg: '#fce7f3', stroke: '#ec4899' },
                'Product': { bg: '#f3e8ff', stroke: '#a855f7' },
                'Leadership': { bg: '#fef9c3', stroke: '#ca8a04' },
                'HR': { bg: '#ffedd5', stroke: '#ea580c' },
                'Procurement': { bg: '#e0f2fe', stroke: '#0284c7' },
                'Legal': { bg: '#fce4ec', stroke: '#e91e63' },
                'Compliance': { bg: '#f3e5f5', stroke: '#9c27b0' },
                'Engineering': { bg: '#e8eaf6', stroke: '#3f51b5' },
                'Risk': { bg: '#fff3e0', stroke: '#e65100' },
                'Data Protection': { bg: '#e8f5e9', stroke: '#2e7d32' },
                'Quality Assurance': { bg: '#e1f5fe', stroke: '#0277bd' },
                'Quality': { bg: '#e1f5fe', stroke: '#0277bd' },
                'Facilities': { bg: '#efebe9', stroke: '#795548' },
                'Executive Board': { bg: '#fef9c3', stroke: '#ca8a04' }
            };
            function getDC(dept) {
                if (deptColors[dept]) return deptColors[dept];
                if (dept && dept.includes('External')) return { bg: '#fffbeb', stroke: '#d97706' };
                return { bg: '#f1f5f9', stroke: '#94a3b8' };
            }

            const p = process;
            const steps = p.steps || [];
            const handoffs = p.handoffs || [];
            const approvals = p.approvals || [];
            const startLabel = p.definition?.startsWhen || 'Start';
            const endLabel = p.definition?.completesWhen || 'Complete';
            if (steps.length === 0) return '';

            const allSteps = steps.map((s, i) => {
                const isApproval = approvals.some(() =>
                    s.name && (s.name.toLowerCase().includes('approv') || s.name.toLowerCase().includes('review'))
                );
                let isBottleneck = false;
                if (p.bottleneck?.longestStep) {
                    const bnIdx = parseInt(String(p.bottleneck.longestStep).replace('step-', ''));
                    if (bnIdx === i) isBottleneck = true;
                }
                const auto = classifyAutomation(s, i, p);
                return {
                    idx: i, name: s.name || 'Step ' + (i + 1),
                    department: s.department || 'Other',
                    isApproval, isBottleneck,
                    isDecision: !!s.isDecision, branches: s.branches || [],
                    isExternal: !!s.isExternal, auto
                };
            });

            const handoffMap = {};
            handoffs.forEach((h, i) => {
                if (i + 1 < allSteps.length) {
                    handoffMap[i + '->' + (i + 1)] = {
                        method: h.method ? h.method.replace(/-/g, ' ') : '',
                        isBad: h.clarity === 'yes-multiple' || h.clarity === 'yes-major'
                    };
                }
            });

            // Department grouping
            const deptOrder = [];
            const deptMap = {};
            allSteps.forEach(s => {
                if (!deptMap[s.department]) { deptMap[s.department] = []; deptOrder.push(s.department); }
                deptMap[s.department].push(s);
            });

            // Sequential connections
            const connections = [];
            connections.push({ fromType: 'start', toIdx: 0 });
            for (let i = 0; i < allSteps.length - 1; i++) {
                // Skip sequential arrow FROM decision steps — branches define the paths
                if (allSteps[i].isDecision && allSteps[i].branches && allSteps[i].branches.length > 0) continue;
                const hk = i + '->' + (i + 1);
                const hd = handoffMap[hk] || { method: '', isBad: false };
                connections.push({ fromIdx: i, toIdx: i + 1, method: hd.method, isBad: hd.isBad });
            }
            connections.push({ fromIdx: allSteps.length - 1, toType: 'end' });

            // Layout: each step = column, each dept = row (lane)
            const colW = NODE_W + NODE_GAP_X;
            const nodePos = [];
            let laneY = TOP_PAD;
            const lanes = [];

            deptOrder.forEach(dept => {
                const dc = getDC(dept);
                const deptSteps = deptMap[dept] || [];
                const hasDecInLane = deptSteps.some(s => s.isDecision && (s.branches || []).length > 0);
                const extraForDiamond = hasDecInLane ? 50 : 0;
                const laneH = NODE_H + LANE_PAD_Y * 2 + extraForDiamond;
                lanes.push({ dept, y: laneY, h: laneH, bg: dc.bg, stroke: dc.stroke });
                deptMap[dept].forEach(s => {
                    const nx = START_X + s.idx * colW;
                    const ny = laneY + LANE_PAD_Y;
                    nodePos[s.idx] = { x: nx, y: ny, cx: nx + NODE_W / 2, cy: ny + NODE_H / 2, dept };
                });
                laneY += laneH + LANE_GAP;
            });

            const firstLane = lanes.find(l => l.dept === allSteps[0].department);
            const lastLane = lanes.find(l => l.dept === allSteps[allSteps.length - 1].department);

            const startPos = {
                x: START_X - TERM_W - NODE_GAP_X,
                y: firstLane.y + (firstLane.h - TERM_H) / 2,
                cx: START_X - TERM_W - NODE_GAP_X + TERM_W / 2,
                cy: firstLane.y + firstLane.h / 2
            };
            const endPos = {
                x: START_X + allSteps.length * colW + 10,
                y: lastLane.y + (lastLane.h - TERM_H) / 2,
                cx: START_X + allSteps.length * colW + 10 + TERM_W / 2,
                cy: lastLane.y + lastLane.h / 2
            };

            const totalW = endPos.x + TERM_W + 30;
            const autoCount = allSteps.filter(s => s.auto).length;
            const totalH = laneY + (autoCount > 0 ? 70 : 50);

            let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${totalW} ${totalH}" width="${totalW}" height="${totalH}" style="font-family:'Work Sans',Arial,sans-serif;">`;
            svg += `<rect x="0" y="0" width="${totalW}" height="${totalH}" fill="#ffffff" rx="16" filter="url(#slCardShadow)"/>`;

            // Card header bar (browser chrome)
            svg += `<rect x="0" y="0" width="${totalW}" height="36" rx="16" fill="#f8fafb"/>`;
            svg += `<rect x="0" y="24" width="${totalW}" height="12" fill="#f8fafb"/>`;
            svg += `<circle cx="18" cy="18" r="3.5" fill="#e5e7eb"/><circle cx="30" cy="18" r="3.5" fill="#e5e7eb"/><circle cx="42" cy="18" r="3.5" fill="#e5e7eb"/>`;

            // Title
            svg += `<text x="${totalW / 2}" y="20" text-anchor="middle" font-size="9" font-weight="400" fill="#94a3b8" letter-spacing="0.5">swimlane</text>`;
            svg += `<text x="${totalW / 2}" y="54" text-anchor="middle" font-size="14" font-weight="600" fill="#1a2f4a" letter-spacing="-0.3">${escSvg(p.processName || 'Process Flow')}</text>`;
            svg += `<text x="${totalW / 2}" y="70" text-anchor="middle" font-size="10" fill="#94a3b8" letter-spacing="0.3">Swimlane view · ${allSteps.length} steps · ${deptOrder.length} departments</text>`;

            // Lane bands
            lanes.forEach(l => {
                svg += `<rect x="0" y="${l.y}" width="${totalW}" height="${l.h}" fill="${l.bg}" stroke="${l.stroke}" stroke-width="0.5" rx="0"/>`;
                svg += `<rect x="0" y="${l.y}" width="${LANE_LABEL_W}" height="${l.h}" fill="${l.stroke}" opacity="0.1" rx="0"/>`;
                svg += `<rect x="0" y="${l.y}" width="4" height="${l.h}" fill="${l.stroke}" rx="0"/>`;
                svg += `<text x="${LANE_LABEL_W / 2 + 2}" y="${l.y + l.h / 2 + 5}" text-anchor="middle" font-size="11" font-weight="600" fill="${l.stroke}">${escSvg(l.dept)}</text>`;
            });

            // Defs
            svg += `<defs>`;
            svg += `<marker id="sarw" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto"><path d="M 0 1 L 10 5 L 0 9 z" fill="#475569"/></marker>`;
            svg += `<marker id="sarw-bad" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto"><path d="M 0 1 L 10 5 L 0 9 z" fill="#ef4444"/></marker>`;
            ['#7c3aed','#2563eb','#059669','#d97706','#dc2626'].forEach((c, ci) => {
                svg += `<marker id="sarwc${ci}" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto"><path d="M 0 1 L 10 5 L 0 9 z" fill="${c}"/></marker>`;
            });
            svg += `<filter id="sshadow" x="-8%" y="-8%" width="116%" height="120%"><feDropShadow dx="0" dy="2" stdDeviation="4" flood-opacity="0.06"/></filter>`;
            svg += `<filter id="slCardShadow" x="-2%" y="-2%" width="104%" height="106%"><feDropShadow dx="0" dy="4" stdDeviation="12" flood-opacity="0.04"/><feDropShadow dx="0" dy="1" stdDeviation="3" flood-opacity="0.03"/></filter>`;
            svg += `<filter id="slGlow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="2" stdDeviation="6" flood-opacity="0.12" flood-color="#3d8ea6"/></filter>`;
            svg += `</defs>`;

            // CSS: animate lines + hover effects on nodes
            svg += `<style>
                @keyframes flowDash { to { stroke-dashoffset: -40; } }
                @keyframes particleMove { 0% { offset-distance: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { offset-distance: 100%; opacity: 0; } }
                @keyframes slNodeIn { from { opacity: 0; transform: translateY(6px) scale(0.96); } to { opacity: 1; transform: none; } }
                .sl-arrow { stroke-dasharray: 8 6; animation: flowDash 1.5s linear infinite; }
                .sl-particle { r: 3; fill: #3d8ea6; animation: particleMove 3s linear infinite; }
                .sl-node { cursor: pointer; transition: filter 0.25s ease, transform 0.25s cubic-bezier(0.16,1,0.3,1); transform-origin: center; transform-box: fill-box; animation: slNodeIn 0.5s cubic-bezier(0.16,1,0.3,1) both; }
                .sl-node:hover { filter: url(#slGlow); transform: scale(1.04) translateY(-2px); }
            </style>`;

            // Draw sequential arrows
            function drawSLArrow(x1, y1, x2, y2, isCross, isBad) {
                const color = isBad ? '#ef4444' : '#3d8ea6';
                const marker = isBad ? 'url(#sarw-bad)' : 'url(#sarw)';
                let pathD;
                if (isCross && Math.abs(y1 - y2) > 10) {
                    // Orthogonal: horizontal to midpoint, vertical to target row, horizontal to target
                    const mx = (x1 + x2) / 2;
                    pathD = `M ${x1} ${y1} L ${mx} ${y1} L ${mx} ${y2} L ${x2} ${y2}`;
                } else {
                    pathD = `M ${x1} ${y1} L ${x2} ${y2}`;
                }
                svg += `<path d="${pathD}" fill="none" stroke="${color}" stroke-width="1.8" class="sl-arrow" marker-end="${marker}" opacity="0.55"/>`;
                svg += `<circle class="sl-particle" style="offset-path:path('${pathD}');animation-duration:2.5s;fill:${isBad ? '#ef4444' : '#3d8ea6'};"/>`;
            }

            connections.forEach(c => {
                let x1, y1, x2, y2, isCross;
                if (c.fromType === 'start') {
                    x1 = startPos.x + TERM_W; y1 = startPos.cy;
                    x2 = nodePos[c.toIdx].x; y2 = nodePos[c.toIdx].cy;
                    isCross = Math.abs(y1 - y2) > 10;
                } else if (c.toType === 'end') {
                    x1 = nodePos[c.fromIdx].x + NODE_W; y1 = nodePos[c.fromIdx].cy;
                    x2 = endPos.x; y2 = endPos.cy;
                    isCross = Math.abs(y1 - y2) > 10;
                } else {
                    x1 = nodePos[c.fromIdx].x + NODE_W; y1 = nodePos[c.fromIdx].cy;
                    x2 = nodePos[c.toIdx].x; y2 = nodePos[c.toIdx].cy;
                    isCross = nodePos[c.fromIdx].dept !== nodePos[c.toIdx].dept;
                }
                drawSLArrow(x1, y1, x2, y2, isCross, c.isBad || false);
            });

            // Start terminal (static, wrapped text)
            svg += `<rect x="${startPos.x}" y="${startPos.y}" width="${TERM_W}" height="${TERM_H}" rx="${TERM_RX}" fill="#d1fae5" stroke="#059669" stroke-width="2" filter="url(#sshadow)"/>`;
            {
                const tLines = slWrapText(startLabel, 22);
                const tFS = tLines.length > 2 ? 6.5 : 7.5;
                const tLH = tFS + 2;
                const tSY = startPos.cy - ((tLines.length - 1) * tLH) / 2 + tFS / 2;
                tLines.forEach((line, li) => {
                    svg += `<text x="${startPos.cx}" y="${tSY + li * tLH}" text-anchor="middle" font-size="${tFS}" font-weight="600" fill="#064e3b">${escSvg(line)}</text>`;
                });
            }

            // End terminal (static, wrapped text)
            svg += `<rect x="${endPos.x}" y="${endPos.y}" width="${TERM_W}" height="${TERM_H}" rx="${TERM_RX}" fill="#d1fae5" stroke="#059669" stroke-width="2" filter="url(#sshadow)"/>`;
            {
                const tLines = slWrapText(endLabel, 22);
                const tFS = tLines.length > 2 ? 6.5 : 7.5;
                const tLH = tFS + 2;
                const tSY = endPos.cy - ((tLines.length - 1) * tLH) / 2 + tFS / 2;
                tLines.forEach((line, li) => {
                    svg += `<text x="${endPos.cx}" y="${tSY + li * tLH}" text-anchor="middle" font-size="${tFS}" font-weight="600" fill="#064e3b">${escSvg(line)}</text>`;
                });
            }

            // Build incoming route map for target badges
            const slBranchColors = ['#7c3aed', '#2563eb', '#059669', '#d97706', '#dc2626'];
            const slIncoming = {};
            allSteps.forEach((s, i) => {
                if (!s.isDecision || s.branches.length === 0) return;
                s.branches.forEach((br, bi) => {
                    const targetMatch = (br.target || '').match(/(\d+)/);
                    const targetIdx = targetMatch ? parseInt(targetMatch[1]) - 1 : -1;
                    if (targetIdx >= 0 && targetIdx < allSteps.length) {
                        if (!slIncoming[targetIdx]) slIncoming[targetIdx] = [];
                        slIncoming[targetIdx].push({ fromStep: i + 1, color: slBranchColors[bi % slBranchColors.length], label: br.label });
                    }
                });
            });

            // Step nodes — with diamond decisions
            function slWrapText(text, maxC) {
                const words = text.split(/\s+/);
                const lines = []; let cur = '';
                words.forEach(w => { const t = cur ? cur + ' ' + w : w; if (t.length > maxC && cur) { lines.push(cur); cur = w; } else { cur = t; } });
                if (cur) lines.push(cur);
                return lines;
            }

            allSteps.forEach((s, i) => {
                const pos = nodePos[i];
                if (!pos) return;
                const isDecNode = s.isDecision && s.branches.length > 0;

                svg += `<g class="sl-node" style="animation-delay:${i * 0.06}s">`;

                if (isDecNode) {
                    // ── DIAMOND decision symbol ──
                    const cx = pos.cx, cy = pos.cy;
                    const hw = 65, hh = 40;
                    svg += `<polygon points="${cx},${cy - hh} ${cx + hw},${cy} ${cx},${cy + hh} ${cx - hw},${cy}" fill="#f5f3ff" stroke="#7c3aed" stroke-width="2" filter="url(#sshadow)"/>`;

                    // Step number
                    svg += `<text x="${cx}" y="${cy - hh + 12}" text-anchor="middle" font-size="8" font-weight="700" fill="#7c3aed">${i + 1}</text>`;

                    // Name inside diamond (full text)
                    let dLines = slWrapText(s.name, 16);
                    const slDFS = dLines.length > 3 ? 7 : 8;
                    const slDLH = slDFS + 2;
                    const slDBH = dLines.length * slDLH;
                    const slDSY = cy - slDBH / 2 + slDFS;
                    dLines.forEach((line, li) => {
                        svg += `<text x="${cx}" y="${slDSY + li * slDLH}" text-anchor="middle" font-size="${slDFS}" fill="#4c1d95" font-weight="500">${escSvg(line)}</text>`;
                    });

                    // Auto badge
                    if (s.auto) {
                        svg += `<circle cx="${cx + hw - 4}" cy="${cy - hh + 4}" r="7" fill="${s.auto.color}" stroke="#fff" stroke-width="1.5"/>`;
                        svg += `<text x="${cx + hw - 4}" y="${cy - hh + 7}" text-anchor="middle" font-size="6" fill="#fff" font-weight="700">${s.auto.badge}</text>`;
                    }

                    // Incoming route indicators on diamond
                    const incoming = slIncoming[i] || [];
                    incoming.forEach((inc, ii) => {
                        const ix = cx - hw + 4;
                        const iy = cy - 8 + ii * 11;
                        svg += `<circle cx="${ix}" cy="${iy}" r="4.5" fill="${inc.color}" stroke="#fff" stroke-width="1"/>`;
                        svg += `<text x="${ix}" y="${iy + 2}" text-anchor="middle" font-size="4.5" fill="#fff" font-weight="700">${inc.fromStep}</text>`;
                        svg += `<title>From Step ${inc.fromStep}: ${escSvg(inc.label)}</title>`;
                    });

                } else {
                    // ── RECTANGLE (regular step) ──
                    const incoming = slIncoming[i] || [];
                    const laneData = lanes.find(l => l.dept === pos.dept);
                    let deptStroke = laneData ? laneData.stroke : '#cbd5e1';
                    let deptBg = laneData ? laneData.bg : '#f8fafc';
                    let fill = '#ffffff', stroke = deptStroke, sw = 1.5, textCol = '#1e293b';
                    if (s.isBottleneck) { fill = '#fee2e2'; deptBg = '#fee2e2'; stroke = '#ef4444'; sw = 2.5; textCol = '#991b1b'; }
                    else if (s.isApproval) { fill = '#fef3c7'; deptBg = '#fef3c7'; stroke = '#d97706'; sw = 2; textCol = '#92400e'; }
                    else if (incoming.length === 1) { stroke = incoming[0].color; sw = 1.8; }
                    const rx = s.isApproval ? 14 : 10;

                    svg += `<rect x="${pos.x}" y="${pos.y}" width="${NODE_W}" height="${NODE_H}" rx="${rx}" fill="#ffffff" stroke="${stroke}" stroke-width="${sw}" filter="url(#sshadow)"/>`;
                    svg += `<rect x="${pos.x}" y="${pos.y}" width="${NODE_W}" height="${NODE_H}" rx="${rx}" fill="${deptBg}" opacity="0.45"/>`;

                    const badgeBg = s.isBottleneck ? '#ef4444' : s.isApproval ? '#d97706' : stroke;
                    svg += `<circle cx="${pos.x + 14}" cy="${pos.y + 14}" r="10" fill="${badgeBg}" opacity="0.12"/>`;
                    svg += `<text x="${pos.x + 14}" y="${pos.y + 18}" text-anchor="middle" font-size="9" font-weight="700" fill="${badgeBg}">${i + 1}</text>`;

                    // Incoming route indicators
                    incoming.forEach((inc, ii) => {
                        const by = pos.y + 14 + ii * 12;
                        svg += `<circle cx="${pos.x - 1}" cy="${by}" r="4.5" fill="${inc.color}" stroke="#fff" stroke-width="1"/>`;
                        svg += `<text x="${pos.x - 1}" y="${by + 2}" text-anchor="middle" font-size="4.5" fill="#fff" font-weight="700">${inc.fromStep}</text>`;
                        svg += `<title>From Step ${inc.fromStep}: ${escSvg(inc.label)}</title>`;
                    });

                    // Name (full text, auto-sized)
                    let lines = slWrapText(s.name, 22);
                    const slFS = lines.length > 3 ? 8 : 9.5;
                    const lineH = slFS + 2.5;
                    const slBH = lines.length * lineH;
                    const textStartY = pos.y + 16 + (NODE_H - 16 - slBH) / 2 + slFS;
                    lines.forEach((line, li) => {
                        svg += `<text x="${pos.x + NODE_W / 2}" y="${textStartY + li * lineH}" text-anchor="middle" font-size="${slFS}" fill="${textCol}" font-weight="500">${escSvg(line)}</text>`;
                    });

                    if (s.auto) {
                        const bx = pos.x + NODE_W - 6, by = pos.y - 4;
                        svg += `<circle cx="${bx}" cy="${by}" r="9" fill="${s.auto.color}" stroke="#fff" stroke-width="2"/>`;
                        svg += `<text x="${bx}" y="${by + 3}" text-anchor="middle" font-size="8" fill="#fff" font-weight="700">${s.auto.badge}</text>`;
                    }
                }
                svg += `</g>`;
            });

            // ── Decision branch connecting lines (swimlane) ──
            // Orthogonal routing: loop-backs go above lanes, forward lines jog at midpoint between columns.
            // Lines enter target top when crossing lanes vertically, avoiding node overlap.
            const SL_DIA_HW = 65, SL_DIA_HH = 40;

            allSteps.forEach((s, i) => {
                if (!s.isDecision || !s.branches || s.branches.length === 0) return;
                const pos = nodePos[i];
                if (!pos) return;
                const cx = pos.cx, cy = pos.cy;
                const brCount = s.branches.length;

                s.branches.forEach((br, bi) => {
                    const color = slBranchColors[bi % slBranchColors.length];
                    const targetMatch = (br.target || '').match(/(\d+)/);
                    const targetIdx = targetMatch ? parseInt(targetMatch[1]) - 1 : -1;
                    if (targetIdx < 0 || targetIdx >= allSteps.length) return;

                    const tp = nodePos[targetIdx];
                    if (!tp) return;
                    const isTargetDec = allSteps[targetIdx].isDecision && (allSteps[targetIdx].branches || []).length > 0;
                    const goesBack = targetIdx < i;
                    const chOff = bi * 12;

                    let pathD;
                    let lblX, lblY, anchor;

                    if (goesBack) {
                        // LOOP-BACK: exit top of diamond → up above lanes → left to target col → down into target top
                        const exitX = cx + (bi - (brCount - 1) / 2) * 14;
                        const exitY = cy - SL_DIA_HH;
                        const channelY = TOP_PAD - 28 - chOff;
                        const entryX = tp.cx;
                        const entryY = isTargetDec ? tp.cy - SL_DIA_HH : tp.y;
                        pathD = `M ${exitX} ${exitY} L ${exitX} ${channelY} L ${entryX} ${channelY} L ${entryX} ${entryY}`;
                        lblX = Math.min(exitX, entryX) + Math.abs(entryX - exitX) / 2;
                        lblY = channelY - 3;
                        anchor = 'middle';

                    } else {
                        // FORWARD: exit bottom of diamond → down to lane gap → right to column gap → vertical to target lane → left to target
                        const exitX = cx + (bi - (brCount - 1) / 2) * 14;
                        const exitY = cy + SL_DIA_HH;
                        const entryX = isTargetDec ? tp.cx - SL_DIA_HW : tp.x;
                        const entryY = isTargetDec ? tp.cy : tp.cy;

                        // Find the lane bottom for the source node
                        const srcLane = lanes.find(l => l.dept === pos.dept);
                        const laneBottom = srcLane ? srcLane.y + srcLane.h : exitY + 20;
                        const jogY = laneBottom + chOff;
                        const gapMidX = pos.x + NODE_W + NODE_GAP_X / 2 + chOff;

                        if (Math.abs(exitY - entryY) < 5 && Math.abs(exitX - entryX) < colW * 2) {
                            // Near same lane — go down, across bottom gap, up to target
                            pathD = `M ${exitX} ${exitY} L ${exitX} ${jogY} L ${entryX} ${jogY} L ${entryX} ${entryY}`;
                        } else {
                            // Cross-lane: down to lane bottom gap, right to column gap, vertical to target lane, left to target
                            pathD = `M ${exitX} ${exitY} L ${exitX} ${jogY} L ${gapMidX} ${jogY} L ${gapMidX} ${entryY} L ${entryX} ${entryY}`;
                        }
                        // Label along the horizontal segment at lane bottom (in the gap, clear of nodes)
                        lblX = exitX + 4;
                        lblY = jogY - 2;
                        anchor = 'start';
                    }

                    // Draw branch line (solid for forward, dashed for loop-back)
                    const slDashAttr = goesBack ? 'stroke-dasharray="6,4"' : '';
                    svg += `<path d="${pathD}" fill="none" stroke="${color}" stroke-width="2" ${slDashAttr} marker-end="url(#sarwc${bi % 5})" opacity="0.8"/>`;

                    // Animated particle following the branch path
                    svg += `<circle r="3" fill="${color}" opacity="0.85"><animateMotion dur="${2.5 + bi * 0.5}s" repeatCount="indefinite" begin="${bi * 0.4}s" path="${pathD}"><\/animateMotion><\/circle>`;

                    // Prominent exit label pill at the diamond side — full text, no truncation
                    const brText = escSvg(br.label);
                    const slPillW = brText.length * 5.2 + 18;
                    const slPillH = 18;
                    if (goesBack) {
                        const elX = cx + (bi - (brCount - 1) / 2) * 14;
                        const elY = cy - SL_DIA_HH - 20;
                        svg += `<rect x="${elX - slPillW / 2}" y="${elY - slPillH / 2}" width="${slPillW}" height="${slPillH}" rx="${slPillH / 2}" fill="#fff" stroke="${color}" stroke-width="1" opacity="0.95"/>`;
                        svg += `<text x="${elX}" y="${elY + 4}" text-anchor="middle" font-size="8" fill="${color}" font-weight="700">${brText}</text>`;
                    } else {
                        const elX = cx + (bi - (brCount - 1) / 2) * 14;
                        const elY = cy + SL_DIA_HH + 22;
                        svg += `<rect x="${elX - slPillW / 2}" y="${elY - slPillH / 2}" width="${slPillW}" height="${slPillH}" rx="${slPillH / 2}" fill="#fff" stroke="${color}" stroke-width="1" opacity="0.95"/>`;
                        svg += `<text x="${elX}" y="${elY + 4}" text-anchor="middle" font-size="8" fill="${color}" font-weight="700">${brText}</text>`;
                    }
                });
            });

            // Legend
            const legendY = laneY + 8;
            const hasDecisions = allSteps.some(s => s.isDecision && s.branches.length > 0);
            let slx = LANE_LABEL_W + 10;
            svg += `<rect x="${slx}" y="${legendY}" width="14" height="14" rx="3" fill="#d1fae5" stroke="#059669" stroke-width="1.5"/>`;
            svg += `<text x="${slx + 20}" y="${legendY + 11}" font-size="9" fill="#64748b">Start / End</text>`;
            slx += 90;
            svg += `<rect x="${slx}" y="${legendY}" width="14" height="14" rx="3" fill="#fff" stroke="#cbd5e1" stroke-width="1.5"/>`;
            svg += `<text x="${slx + 20}" y="${legendY + 11}" font-size="9" fill="#64748b">Step</text>`;
            slx += 60;
            if (hasDecisions) {
                const dx = slx + 7, dy = legendY + 7, dd = 7;
                svg += `<polygon points="${dx},${dy - dd} ${dx + dd},${dy} ${dx},${dy + dd} ${dx - dd},${dy}" fill="#f5f3ff" stroke="#7c3aed" stroke-width="1.5"/>`;
                svg += `<text x="${slx + 20}" y="${legendY + 11}" font-size="9" fill="#64748b">Decision</text>`;
                slx += 80;
            }
            svg += `<rect x="${slx}" y="${legendY}" width="14" height="14" rx="3" fill="#fee2e2" stroke="#ef4444" stroke-width="1.5"/>`;
            svg += `<text x="${slx + 20}" y="${legendY + 11}" font-size="9" fill="#64748b">Bottleneck</text>`;
            slx += 90;
            svg += `<rect x="${slx}" y="${legendY}" width="14" height="14" rx="3" fill="#fef3c7" stroke="#d97706" stroke-width="1.5"/>`;
            svg += `<text x="${slx + 20}" y="${legendY + 11}" font-size="9" fill="#64748b">Approval</text>`;
            slx += 85;
            svg += `<line x1="${slx}" y1="${legendY + 7}" x2="${slx + 20}" y2="${legendY + 7}" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="5,3"/>`;
            svg += `<text x="${slx + 26}" y="${legendY + 11}" font-size="9" fill="#64748b">Bad handoff</text>`;
            if (hasDecisions) {
                slx += 100;
                svg += `<line x1="${slx}" y1="${legendY + 7}" x2="${slx + 20}" y2="${legendY + 7}" stroke="#7c3aed" stroke-width="2"/>`;
                svg += `<polygon points="${slx + 18},${legendY + 4} ${slx + 24},${legendY + 7} ${slx + 18},${legendY + 10}" fill="#7c3aed"/>`;
                svg += `<text x="${slx + 30}" y="${legendY + 11}" font-size="9" fill="#64748b">Alternate path</text>`;
            }

            if (autoCount > 0) {
                const row2Y = legendY + 18;
                slx = LANE_LABEL_W + 10;
                svg += `<text x="${slx}" y="${row2Y + 10}" font-size="9" font-weight="600" fill="#475569">Auto:</text>`;
                slx += 40;
                const cats = [AUTOMATION_CATEGORIES.simple, AUTOMATION_CATEGORIES.agent, AUTOMATION_CATEGORIES.humanLoop, AUTOMATION_CATEGORIES.multiAgent];
                cats.forEach(cat => {
                    const count = allSteps.filter(s => s.auto && s.auto.key === cat.key).length;
                    if (count > 0) {
                        svg += `<circle cx="${slx + 7}" cy="${row2Y + 6}" r="7" fill="${cat.color}" stroke="#fff" stroke-width="1.5"/>`;
                        svg += `<text x="${slx + 7}" y="${row2Y + 9}" text-anchor="middle" font-size="7" fill="#fff" font-weight="700">${cat.badge}</text>`;
                        svg += `<text x="${slx + 18}" y="${row2Y + 10}" font-size="9" fill="${cat.color}" font-weight="500">${cat.label} (${count})</text>`;
                        slx += 18 + cat.label.length * 6 + 26;
                    }
                });
            }

            svg += '</svg>';
            return svg;
        }

        function escSvg(str) {
            return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // ============================================================
        // RENDER FLOW DIAGRAMS (one per process)
        // ============================================================
        function switchFlowView(mode) {
            _flowViewMode = mode;
            if (_flowProcesses.length > 0) renderFlowDiagram(_flowProcesses);
        }

        function buildListView(process, classified) {
            const steps = process.steps || [];
            const classMap = {};
            (classified || []).forEach(c => { classMap[c.step] = c; });

            let html = '<div style="background:#f8fafb;border-radius:var(--radius-md);overflow:hidden;border:1px solid var(--border);">';
            html += '<div class="flow-list-view">';

            steps.forEach((s, i) => {
                const isDecision = s.isDecision;
                const isExt = s.isExternal;
                const auto = classMap[s.name];
                const catInfo = auto ? AUTOMATION_CATEGORIES[auto.key === 'human-loop' ? 'humanLoop' : auto.key === 'multi-agent' ? 'multiAgent' : auto.key] : null;

                html += '<div class="flow-list-item">';
                html += `<div class="flow-list-num${isDecision ? ' decision' : ''}${isExt ? ' external' : ''}">${s.number || (i + 1)}</div>`;
                html += '<div class="flow-list-body">';
                html += `<div class="flow-list-name">${escSvg(s.name)}</div>`;
                html += `<div class="flow-list-dept">${escSvg(s.department || 'Unknown')}${isExt ? ' (External)' : ''}</div>`;

                if (isDecision && s.branches && s.branches.length) {
                    html += '<div class="flow-list-branches">';
                    s.branches.forEach(b => {
                        html += `<div class="flow-list-branch">${escSvg(b.label || '')}${b.target ? ' → ' + escSvg(b.target) : ''}</div>`;
                    });
                    html += '</div>';
                }
                html += '</div>';

                if (catInfo) {
                    html += `<span class="flow-list-badge" style="background:${catInfo.bg};color:${catInfo.color};">${catInfo.badge}</span>`;
                }

                html += '</div>';

                if (i < steps.length - 1 && !isDecision) {
                    html += '<div class="flow-list-arrow">↓</div>';
                }
            });

            html += '</div></div>';
            return html;
        }

        function renderRedesignView() {
            try {
                const raw = sessionStorage.getItem('redesignProcesses');
                if (!raw) {
                    document.body.innerHTML = '<div style="max-width:700px;margin:60px auto;padding:20px;font-family:Work Sans,sans-serif;text-align:center;"><h2>No redesign data found</h2><p style="color:#64748b;">Please generate a redesign from the <a href="/portal">portal</a> first.</p></div>';
                    return;
                }
                const procs = JSON.parse(raw);
                document.title = 'Redesigned Process Flow | Workflow Partners';

                // Hide all screens and show a custom container
                document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) progressBar.style.display = 'none';

                const wrap = document.createElement('div');
                wrap.style.cssText = 'max-width:1100px;margin:0 auto;padding:2rem 1.5rem;';
                wrap.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:12px;">' +
                    '<div><h1 style="font-family:Cormorant Garamond,serif;font-size:1.8rem;font-weight:700;color:#1a5a6e;margin:0;">Redesigned Process Flow</h1>' +
                    '<p style="font-size:0.88rem;color:#64748b;margin-top:4px;">AI-generated optimised operating model</p></div>' +
                    '<a href="/portal" style="padding:8px 20px;background:#1a5a6e;color:white;text-decoration:none;border-radius:8px;font-size:0.85rem;font-weight:500;">\u2190 Back to Portal</a></div>' +
                    '<div id="flowDiagramLoading" style="display:none;"></div>' +
                    '<div id="flowDiagramError" style="display:none;"><span></span><span></span></div>' +
                    '<div id="flowDiagramsContainer"></div>';
                document.querySelector('.container').appendChild(wrap);

                // Convert AI steps to the format buildGridSVG expects
                const flowProcesses = procs.map(function(p) {
                    var activeSteps = (p.steps || []).filter(function(s) { return !s.removed; });
                    return {
                        processName: p.processName || 'Redesigned Process',
                        steps: activeSteps.map(function(s, i) {
                            return {
                                number: i + 1,
                                name: s.name,
                                department: s.department || 'Operations',
                                isDecision: s.isDecision || false,
                                isExternal: s.isExternal || false,
                                branches: (s.branches || []).map(function(b) {
                                    var tgt = b.target || '';
                                    if (typeof b.targetStep === 'number') tgt = 'Step ' + b.targetStep;
                                    return { label: b.label || '', target: tgt };
                                })
                            };
                        }),
                        handoffs: [],
                        systems: [],
                        approvals: []
                    };
                });

                _flowViewMode = 'grid';
                renderFlowDiagram(flowProcesses);
            } catch (e) {
                console.error('Failed to render redesign:', e);
                document.body.innerHTML = '<div style="max-width:700px;margin:60px auto;padding:20px;font-family:Work Sans,sans-serif;text-align:center;"><h2>Error loading redesign</h2><p style="color:#dc2626;">' + e.message + '</p><a href="/portal">Back to Portal</a></div>';
            }
        }

        function renderFlowDiagram(processes) {
            _flowProcesses = processes;
            const loading = document.getElementById('flowDiagramLoading');
            const container = document.getElementById('flowDiagramsContainer');
            const errorDiv = document.getElementById('flowDiagramError');

            try {
                let allHtml = '';
                const allSvgs = [];

                // View toggle
                const isList = _flowViewMode === 'list';
                const activeStyle = 'background:var(--primary,#1a5a6e);color:white;box-shadow:0 1px 3px rgba(0,0,0,0.15);';
                const inactiveStyle = 'background:transparent;color:var(--text-mid,#64748b);';
                const btnBase = 'padding:0.4rem 1rem;font-size:0.8rem;font-weight:600;border:none;border-radius:6px;cursor:pointer;transition:all 0.2s;';
                allHtml += `<div class="flow-view-toggle" style="display:flex;align-items:center;gap:0.25rem;margin-bottom:1rem;background:var(--bg-light,#f1f5f9);padding:4px;border-radius:8px;width:fit-content;">`;
                allHtml += `<button onclick="switchFlowView('grid')" style="${btnBase}${_flowViewMode === 'grid' ? activeStyle : inactiveStyle}">&#9638; Grid</button>`;
                allHtml += `<button onclick="switchFlowView('swimlane')" style="${btnBase}${_flowViewMode === 'swimlane' ? activeStyle : inactiveStyle}">&#9776; Swimlane</button>`;
                allHtml += `<button onclick="switchFlowView('list')" style="${btnBase}${isList ? activeStyle : inactiveStyle}">&#9776; List</button>`;
                allHtml += `</div>`;

                processes.forEach((p, pi) => {
                    const steps = p.steps || [];
                    const classified = steps.map((s, i) => {
                        const auto = classifyAutomation(s, i, p);
                        return auto ? { step: s.name, ...auto } : null;
                    }).filter(Boolean);

                    allHtml += `<div class="result-section" style="margin-bottom: 2rem;">`;
                    allHtml += `<h3 style="margin-bottom: 0.5rem;">${pi + 1}. ${escSvg(p.processName || 'Process')} — Flow Diagram</h3>`;

                    if (isList) {
                        allHtml += buildListView(p, classified);
                    } else {
                        const svg = buildFlowSVG(p);
                        allSvgs.push(svg);

                        allHtml += `<div class="flow-mobile-hint">&#128588; Pinch to zoom · Drag to pan · Use Fullscreen for best mobile viewing</div>`;
                        allHtml += `<p class="helper-text" style="margin-bottom: 0.75rem;">Zoom: scroll wheel · Pan: click &amp; drag · Coloured badges show automation type (hover for details)</p>`;

                        // Zoom controls
                        allHtml += `<div class="diagram-controls" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;flex-wrap:wrap;">`;
                        allHtml += `<button onclick="diagramZoomFor(${pi},-0.2)" class="diagram-ctrl-btn">&#8722;</button>`;
                        allHtml += `<span id="zoomLabel_${pi}" style="font-size:0.8rem;color:var(--text-mid);min-width:3rem;text-align:center;">100%</span>`;
                        allHtml += `<button onclick="diagramZoomFor(${pi},0.2)" class="diagram-ctrl-btn">&#43;</button>`;
                        allHtml += `<button onclick="diagramResetFor(${pi})" class="diagram-ctrl-btn" style="font-size:0.75rem;padding:0.35rem 0.75rem;">Fit</button>`;
                        allHtml += `<button onclick="diagramFsFor(${pi})" class="diagram-ctrl-btn" id="fsBtn_${pi}" style="margin-left:auto;font-size:0.75rem;padding:0.35rem 0.75rem;">&#x26F6; Fullscreen</button>`;
                        allHtml += `</div>`;

                        // Diagram viewport
                        allHtml += `<div id="diagramFsWrap_${pi}">`;
                        allHtml += `<div id="diagramVp_${pi}" class="diagram-viewport" style="background:#f8fafb;border:none;border-radius:var(--radius-md);overflow:hidden;cursor:grab;position:relative;max-height:500px;">`;
                        allHtml += `<div id="diagramInner_${pi}" class="diagram-inner" style="transform-origin:0 0;transition:transform 0.15s ease;padding:1rem;min-width:100%;">`;
                        allHtml += svg;
                        allHtml += `</div></div></div>`;
                    }

                    // Automation opportunities
                    if (classified.length > 0) {
                        allHtml += `<div style="margin-top:1.25rem;">`;
                        allHtml += `<h4 style="margin-bottom:0.75rem;font-size:1rem;color:var(--text-dark);">Automation Opportunities (${classified.length} steps)</h4>`;

                        const catOrder = [
                            { key: 'simple',      ...AUTOMATION_CATEGORIES.simple },
                            { key: 'agent',       ...AUTOMATION_CATEGORIES.agent },
                            { key: 'human-loop',  ...AUTOMATION_CATEGORIES.humanLoop },
                            { key: 'multi-agent', ...AUTOMATION_CATEGORIES.multiAgent }
                        ];

                        catOrder.forEach(cat => {
                            const items = classified.filter(c => c.key === cat.key);
                            if (items.length === 0) return;

                            allHtml += `<div style="margin-bottom:0.75rem;padding:0.75rem 1rem;background:${cat.bg};border:1px solid ${cat.color}22;border-left:4px solid ${cat.color};border-radius:var(--radius-sm);">`;
                            allHtml += `<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;">`;
                            allHtml += `<span style="background:${cat.color};color:white;font-size:0.65rem;font-weight:700;padding:2px 7px;border-radius:3px;letter-spacing:0.5px;">${cat.badge}</span>`;
                            allHtml += `<strong style="color:${cat.color};font-size:0.9rem;">${cat.label}</strong>`;
                            allHtml += `<span style="color:var(--text-mid);font-size:0.8rem;">(${items.length} step${items.length > 1 ? 's' : ''})</span>`;
                            allHtml += `</div>`;

                            items.forEach(item => {
                                allHtml += `<div style="display:flex;gap:0.5rem;align-items:baseline;margin-bottom:0.3rem;padding-left:1.5rem;">`;
                                allHtml += `<span style="color:${cat.color};font-size:0.85rem;">&#x2022;</span>`;
                                allHtml += `<span style="font-size:0.85rem;"><strong>${escSvg(item.step)}</strong> — <span style="color:var(--text-mid);">${escSvg(item.reason)}</span></span>`;
                                allHtml += `</div>`;
                            });

                            allHtml += `</div>`;
                        });

                        allHtml += `</div>`;
                    }

                    allHtml += `</div>`;
                });

                lastRenderedSvg = allSvgs.join('|||');
                container.innerHTML = allHtml;

                container.querySelectorAll('svg').forEach(el => {
                    el.style.maxWidth = '100%';
                    el.style.height = 'auto';
                    el.removeAttribute('height');
                });

                loading.style.display = 'none';
                container.style.display = 'block';
                flowDiagramUrl = 'local-svg';

                diagramStates = {};
                processes.forEach((_, pi) => {
                    diagramStates[pi] = { scale: 1, pan: { x: 0, y: 0 } };
                });
            } catch (e) {
                console.error('Flow diagram render error:', e);
                loading.style.display = 'none';
                errorDiv.style.display = 'flex';
            }
        }

        // ============================================================
        // PER-DIAGRAM ZOOM / PAN / FULLSCREEN
        // ============================================================
        let diagramStates = {}; // { [idx]: { scale, pan: {x,y} } }
        let activeDragIdx = -1;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let panStart = { x: 0, y: 0 };

        function getState(idx) {
            if (!diagramStates[idx]) diagramStates[idx] = { scale: 1, pan: { x: 0, y: 0 } };
            return diagramStates[idx];
        }

        function applyTransform(idx) {
            const s = getState(idx);
            const inner = document.getElementById('diagramInner_' + idx);
            if (inner) inner.style.transform = `translate(${s.pan.x}px, ${s.pan.y}px) scale(${s.scale})`;
            const lbl = document.getElementById('zoomLabel_' + idx);
            if (lbl) lbl.textContent = Math.round(s.scale * 100) + '%';
        }

        function diagramZoomFor(idx, delta) {
            const s = getState(idx);
            s.scale = Math.max(0.3, Math.min(5, s.scale + delta));
            applyTransform(idx);
        }
        function diagramResetFor(idx) {
            diagramStates[idx] = { scale: 1, pan: { x: 0, y: 0 } };
            applyTransform(idx);
        }
        function diagramFsFor(idx) {
            const wrap = document.getElementById('diagramFsWrap_' + idx);
            if (!wrap) return;
            const isFs = document.fullscreenElement || document.webkitFullscreenElement;
            if (isFs) { (document.exitFullscreen || document.webkitExitFullscreen).call(document); }
            else { (wrap.requestFullscreen || wrap.webkitRequestFullscreen).call(wrap); }
        }

        // Legacy single-diagram compat
        function diagramZoom(d) { diagramZoomFor(0, d); }
        function diagramZoomReset() { diagramResetFor(0); }
        function diagramFullscreen() { diagramFsFor(0); }

        // Fullscreen label update
        document.addEventListener('fullscreenchange', function() {
            const isFs = document.fullscreenElement || document.webkitFullscreenElement;
            document.querySelectorAll('[id^="fsBtn_"]').forEach(btn => {
                btn.innerHTML = isFs ? '&#x2715; Exit' : '&#x26F6; Fullscreen';
            });
        });

        // Find which diagram index a target element belongs to
        function findDiagramIdx(el) {
            const vp = el.closest('.diagram-viewport');
            if (!vp) return -1;
            const m = vp.id.match(/diagramVp_(\d+)/);
            return m ? parseInt(m[1]) : -1;
        }

        // Mouse wheel zoom (any diagram)
        document.addEventListener('wheel', function(e) {
            const idx = findDiagramIdx(e.target);
            if (idx < 0) return;
            e.preventDefault();
            diagramZoomFor(idx, e.deltaY > 0 ? -0.1 : 0.1);
        }, { passive: false });

        // Mouse drag
        document.addEventListener('mousedown', function(e) {
            const idx = findDiagramIdx(e.target);
            if (idx < 0) return;
            isDragging = true;
            activeDragIdx = idx;
            const s = getState(idx);
            dragStart = { x: e.clientX, y: e.clientY };
            panStart = { ...s.pan };
            e.target.closest('.diagram-viewport').style.cursor = 'grabbing';
            e.preventDefault();
        });
        document.addEventListener('mousemove', function(e) {
            if (!isDragging || activeDragIdx < 0) return;
            const s = getState(activeDragIdx);
            s.pan.x = panStart.x + (e.clientX - dragStart.x);
            s.pan.y = panStart.y + (e.clientY - dragStart.y);
            applyTransform(activeDragIdx);
        });
        document.addEventListener('mouseup', function() {
            if (!isDragging) return;
            isDragging = false;
            const vp = document.getElementById('diagramVp_' + activeDragIdx);
            if (vp) vp.style.cursor = 'grab';
            activeDragIdx = -1;
        });

        // Touch
        let lastTouchDist = 0;
        document.addEventListener('touchstart', function(e) {
            const idx = findDiagramIdx(e.target);
            if (idx < 0) return;
            activeDragIdx = idx;
            if (e.touches.length === 1) {
                isDragging = true;
                dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                panStart = { ...getState(idx).pan };
            } else if (e.touches.length === 2) {
                isDragging = false;
                lastTouchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            }
        }, { passive: true });
        document.addEventListener('touchmove', function(e) {
            if (activeDragIdx < 0) return;
            if (e.touches.length === 1 && isDragging) {
                const s = getState(activeDragIdx);
                s.pan.x = panStart.x + (e.touches[0].clientX - dragStart.x);
                s.pan.y = panStart.y + (e.touches[0].clientY - dragStart.y);
                applyTransform(activeDragIdx);
                e.preventDefault();
            } else if (e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                if (lastTouchDist > 0) diagramZoomFor(activeDragIdx, (dist - lastTouchDist) * 0.005);
                lastTouchDist = dist;
                e.preventDefault();
            }
        }, { passive: false });
        document.addEventListener('touchend', function() { isDragging = false; lastTouchDist = 0; });

        // ============================================================
        // EMBED FLOW DIAGRAM IN PDF
        // ============================================================
        async function embedFlowDiagramInPDF(doc, margin, contentW, pageW, pageH, primary, textMid) {
            // Render one flow diagram page per process
            for (let pi = 0; pi < completedProcesses.length; pi++) {
                try {
                    let svgText = null;

                    // Try stored SVGs first (separated by |||)
                    if (lastRenderedSvg) {
                        const parts = lastRenderedSvg.split('|||');
                        if (parts[pi]) svgText = parts[pi];
                    }

                    // Fallback: re-generate
                    if (!svgText) {
                        svgText = buildFlowSVG(completedProcesses[pi]);
                    }
                    if (!svgText) continue;

                    // Parse SVG dimensions
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                    const svgEl = svgDoc.querySelector('svg');
                    if (!svgEl) continue;

                    let svgW = parseFloat(svgEl.getAttribute('width')) || 800;
                    let svgH = parseFloat(svgEl.getAttribute('height')) || 600;
                    const vb = svgEl.getAttribute('viewBox');
                    if (vb) {
                        const parts = vb.split(/[\s,]+/).map(Number);
                        if (parts.length === 4) { svgW = parts[2]; svgH = parts[3]; }
                    }

                    svgEl.setAttribute('width', String(svgW));
                    svgEl.setAttribute('height', String(svgH));
                    svgEl.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                    const fixedSvg = new XMLSerializer().serializeToString(svgEl);

                    // SVG -> Canvas -> PNG
                    const blob = new Blob([fixedSvg], { type: 'image/svg+xml;charset=utf-8' });
                    const blobUrl = URL.createObjectURL(blob);
                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = (e) => { console.warn('SVG load fail', e); reject(e); };
                        img.src = blobUrl;
                    });

                    const scale = 2;
                    const canvas = document.createElement('canvas');
                    canvas.width = svgW * scale;
                    canvas.height = svgH * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.scale(scale, scale);
                    ctx.drawImage(img, 0, 0, svgW, svgH);
                    URL.revokeObjectURL(blobUrl);

                    const pngData = canvas.toDataURL('image/png');

                    // Add landscape page for wide diagrams
                    const isLandscape = svgW > svgH * 1.2;
                    doc.addPage('a4', isLandscape ? 'landscape' : 'portrait');

                    const pW = isLandscape ? 297 : 210;
                    const pH = isLandscape ? 210 : 297;
                    const cW = pW - margin * 2;
                    let y = margin;

                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...primary);
                    doc.text(`Flow Diagram: ${completedProcesses[pi].processName || 'Process ' + (pi + 1)}`, margin, y);
                    y += 5;

                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textMid);
                    doc.text('Swimlanes by department. Red = bottleneck, amber = approval, dotted = unclear handoff. Badges: S = simple automation, A = AI agent, H = agent + human, M = multi-agent.', margin, y + 4);
                    y += 14;

                    const ratio = svgW / svgH;
                    let imgW = cW;
                    let imgH = imgW / ratio;
                    if (imgH > pH - y - margin) { imgH = pH - y - margin; imgW = imgH * ratio; }

                    doc.addImage(pngData, 'PNG', margin, y, imgW, imgH);
                } catch (err) {
                    console.warn(`Could not embed diagram for process ${pi + 1}:`, err);
                }
            }
        }

        // ============================================================
        // EMAIL DIAGNOSTIC REPORT (n8n integration)
        // Sends report + data to backend → n8n webhook for:
        //   1. Email delivery to client
        //   2. CRM lead capture
        //   3. Team notification
        // ============================================================
        // ============================================================
        // EXPORT FUNCTIONS (CSV, Notion, JSON)
        // ============================================================
        function getExportData() {
            if (!lastResult) return { recommendations: [], processes: [] };
            const recs = lastResult.recommendations || [];
            const procs = completedProcesses.map(p => ({
                name: p.processName,
                annualCost: p.costs?.totalAnnualCost || 0,
                elapsedDays: p.lastExample?.elapsedDays || 0,
                steps: (p.steps || []).length,
                handoffs: (p.handoffs || []).length,
                performance: p.performance || '',
                decisionPoints: (p.steps || []).filter(s => s.isDecision).map(s => ({
                    step: s.number,
                    name: s.name,
                    branches: s.branches || []
                }))
            }));
            return { recommendations: recs, processes: procs, totalCost: lastResult.totalCost, potentialSavings: lastResult.potentialSavings };
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function exportCSV() {
            const data = getExportData();
            let csv = 'Type,Process,Recommendation,Priority\n';
            data.recommendations.forEach((r, i) => {
                const text = (r.text || '').replace(/"/g, '""');
                csv += `"${r.type || 'general'}","${r.process || ''}","${text}","${i < 3 ? 'High' : 'Medium'}"\n`;
            });
            csv += '\n\nProcess,Annual Cost,Cycle Days,Steps,Handoffs\n';
            data.processes.forEach(p => {
                csv += `"${p.name}",${p.annualCost},${p.elapsedDays},${p.steps},${p.handoffs}\n`;
            });
            downloadFile(csv, 'diagnostic-recommendations.csv', 'text/csv');
        }

        function exportNotionMarkdown() {
            const data = getExportData();
            let md = '# Process Diagnostic — Action Items\n\n';
            md += `Total annual process cost: £${(data.totalCost / 1000).toFixed(0)}K | Potential savings: £${((data.potentialSavings || 0) / 1000).toFixed(0)}K\n\n`;
            md += '## Recommendations\n\n';
            data.recommendations.forEach((r, i) => {
                md += `- [ ] **[${(r.type || 'general').toUpperCase()}]** ${r.text || ''}`;
                if (r.process) md += ` _(${r.process})_`;
                md += '\n';
            });
            md += '\n## Processes Analysed\n\n';
            md += '| Process | Annual Cost | Cycle Time | Steps |\n|---|---|---|---|\n';
            data.processes.forEach(p => {
                md += `| ${p.name} | £${(p.annualCost / 1000).toFixed(0)}K | ${p.elapsedDays} days | ${p.steps} |\n`;
            });
            downloadFile(md, 'diagnostic-notion-tasks.md', 'text/markdown');
        }

        function exportJSON() {
            const data = getExportData();
            const exportObj = {
                exportedAt: new Date().toISOString(),
                summary: { totalAnnualCost: data.totalCost, potentialSavings: data.potentialSavings },
                recommendations: data.recommendations.map((r, i) => ({
                    type: r.type || 'general',
                    process: r.process || '',
                    text: r.text || '',
                    priority: i < 3 ? 'high' : 'medium',
                    status: 'todo'
                })),
                processes: data.processes
            };
            downloadFile(JSON.stringify(exportObj, null, 2), 'diagnostic-export.json', 'application/json');
        }

        function exportBPMN() {
            if (!completedProcesses || completedProcesses.length === 0) return;
            const p = completedProcesses[0];
            const steps = p.steps || [];
            const depts = [...new Set(steps.map(s => s.department).filter(Boolean))];
            const processId = 'Process_' + (p.processName || 'Main').replace(/[^a-zA-Z0-9]/g, '_');
            let flowId = 0;

            let xml = `<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
             id="Definitions_1"
             targetNamespace="http://workflowpartners.com/bpmn"
             exporter="Workflow Partners Diagnostic"
             exporterVersion="1.0">
  <collaboration id="Collaboration_1">
    <participant id="Participant_1" name="${escXml(p.processName || 'Process')}" processRef="${processId}" />\n`;

            depts.forEach((dept, i) => {
                xml += `    <participant id="Lane_${i}" name="${escXml(dept)}" />\n`;
            });

            xml += `  </collaboration>
  <process id="${processId}" name="${escXml(p.processName || 'Process')}" isExecutable="false">\n`;

            xml += `    <startEvent id="Start_1" name="Process Start" />\n`;

            steps.forEach((s, i) => {
                const taskType = (s.isExternal) ? 'serviceTask' : 'userTask';
                xml += `    <${taskType} id="Task_${i + 1}" name="${escXml(s.name || 'Step ' + (i + 1))}" />\n`;
                if (s.isDecision && s.branches && s.branches.length > 0) {
                    xml += `    <exclusiveGateway id="Gateway_${i + 1}" name="${escXml(s.name + '?')}" />\n`;
                }
            });

            xml += `    <endEvent id="End_1" name="Process Complete" />\n`;

            xml += `    <sequenceFlow id="Flow_${++flowId}" sourceRef="Start_1" targetRef="Task_1" />\n`;
            steps.forEach((s, i) => {
                const taskId = `Task_${i + 1}`;
                const defaultNext = i < steps.length - 1 ? `Task_${i + 2}` : 'End_1';

                if (s.isDecision && s.branches && s.branches.length > 0) {
                    xml += `    <sequenceFlow id="Flow_${++flowId}" sourceRef="${taskId}" targetRef="Gateway_${i + 1}" />\n`;
                    s.branches.forEach((br) => {
                        let targetRef = defaultNext;
                        if (br.target) {
                            const match = br.target.match(/step\s*(\d+)/i);
                            if (match && parseInt(match[1]) <= steps.length) {
                                targetRef = `Task_${parseInt(match[1])}`;
                            }
                        }
                        xml += `    <sequenceFlow id="Flow_${++flowId}" name="${escXml(br.label)}" sourceRef="Gateway_${i + 1}" targetRef="${targetRef}" />\n`;
                    });
                } else {
                    xml += `    <sequenceFlow id="Flow_${++flowId}" sourceRef="${taskId}" targetRef="${defaultNext}" />\n`;
                }
            });

            xml += `  </process>\n`;

            let xPos = 160;
            const shapes = [];
            const yMain = 100;

            shapes.push({ id: 'Start_1', x: xPos, y: yMain, w: 36, h: 36 });
            xPos += 100;

            steps.forEach((s, i) => {
                shapes.push({ id: `Task_${i + 1}`, x: xPos, y: yMain - 20, w: 120, h: 80 });
                xPos += 160;
                if (s.isDecision && s.branches && s.branches.length > 0) {
                    shapes.push({ id: `Gateway_${i + 1}`, x: xPos - 80, y: yMain + 80, w: 50, h: 50, isGateway: true });
                }
            });

            shapes.push({ id: 'End_1', x: xPos, y: yMain, w: 36, h: 36 });

            xml += `  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Collaboration_1">\n`;

            shapes.forEach(sh => {
                xml += `      <bpmndi:BPMNShape id="${sh.id}_di" bpmnElement="${sh.id}"${sh.isGateway ? ' isMarkerVisible="true"' : ''}>
        <dc:Bounds x="${sh.x}" y="${sh.y}" width="${sh.w}" height="${sh.h}" />
      </bpmndi:BPMNShape>\n`;
            });

            xml += `    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>`;

            const filename = (p.processName || 'process').replace(/[^a-zA-Z0-9]/g, '-') + '.bpmn';
            downloadFile(xml, filename, 'application/xml');
        }

        function escXml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        }

        async function emailDiagnosticReport() {
            const btn = document.getElementById('emailReportBtn');
            const btnText = document.getElementById('emailBtnText');
            const confirmation = document.getElementById('emailSentConfirmation');
            btn.disabled = true;
            btnText.textContent = 'Generating report...';

            try {
                btnText.textContent = 'Building PDF...';
                const pdfBase64 = await generatePDFBase64();

                btnText.textContent = 'Sending report...';
                const contact = lastContact || {};
                const result = lastResult || {};

                if (window._autoSavedReportId) {
                    btnText.innerHTML = '&#10003; Report Saved!';
                    btn.style.background = 'linear-gradient(135deg, #16a34a, #15803d)';
                    confirmation.style.display = 'block';
                    var confText = document.getElementById('emailConfirmText');
                    var confDetail = document.getElementById('emailConfirmDetail');
                    confText.textContent = 'Your report has been saved to your portal.';
                    confDetail.innerHTML = '<a href="/portal" style="color: #6366f1; font-weight: 600;">View in Portal &rarr;</a>';
                    return;
                }

                const payload = {
                    contact: {
                        name: contact.name || '',
                        email: contact.email || '',
                        company: contact.company || '',
                        title: contact.title || '',
                        industry: contact.industry || '',
                        teamSize: contact.teamSize || '',
                        phone: contact.phone || ''
                    },
                    summary: {
                        totalProcesses: (result.processes || []).length,
                        totalAnnualCost: result.totalCost || 0,
                        potentialSavings: result.potentialSavings || 0,
                        analysisType: result.analysisType || 'rule-based',
                        qualityScore: result.qualityScore?.averageScore || 0
                    },
                    recommendations: result.recommendations || [],
                    automationScore: lastScoreData ? {
                        percentage: lastScoreData.readinessScore,
                        grade: lastScoreData.scoreGrade,
                        categories: lastScoreData.cats,
                        totalSteps: lastScoreData.totalSteps,
                        totalAutomatable: lastScoreData.totalAutomatable,
                        insight: lastScoreData.scoreGrade === 'High'
                            ? `High automation potential. ${lastScoreData.totalAutomatable} of ${lastScoreData.totalSteps} steps can be improved.`
                            : lastScoreData.scoreGrade === 'Moderate'
                            ? `Moderate automation potential. ${lastScoreData.totalAutomatable} of ${lastScoreData.totalSteps} steps have improvement opportunities.`
                            : `Process optimisation recommended first. ${lastScoreData.totalAutomatable} of ${lastScoreData.totalSteps} steps show automation potential.`
                    } : {},
                    roadmap: lastRoadmapData ? {
                        phases: lastRoadmapData.phases,
                        totalSavings: lastRoadmapData.annualSavings,
                        cumulative: lastRoadmapData.cumulative
                    } : {},
                    processes: result.processes || [],
                    rawProcesses: completedProcesses || [],
                    customDepartments: customDepartments || [],
                    pdfBase64,
                    timestamp: new Date().toISOString()
                };

                // Step 3: Send to API
                const resp = await fetch('/api/send-diagnostic-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await resp.json();

                if (data.success) {
                    btnText.innerHTML = '&#10003; Report Sent!';
                    btn.style.background = 'linear-gradient(135deg, #16a34a, #15803d)';

                    // Show confirmation
                    confirmation.style.display = 'block';
                    const confText = document.getElementById('emailConfirmText');
                    const confDetail = document.getElementById('emailConfirmDetail');

                    if (data.webhookConfigured === false) {
                        confText.textContent = 'Report generated (email delivery pending setup)';
                        confDetail.textContent = 'n8n webhook not yet configured. Configure N8N_WEBHOOK_URL to enable automatic email delivery.';
                        confText.style.color = '#d97706';
                    } else {
                        confText.textContent = 'Report sent successfully!';
                        confDetail.textContent = 'Check ' + (contact.email || 'your inbox') + ' for your diagnostic report.';
                    }

                    if (data.leadScore) {
                        confDetail.textContent += ' (Lead score: ' + data.leadScore.score + '/100 - ' + data.leadScore.grade + ')';
                    }

                    // Show report link if stored in Supabase
                    if (data.reportUrl) {
                        confDetail.innerHTML += '<br><br><a href="' + data.reportUrl + '" target="_blank" style="color: #6366f1; font-weight: 600;">View & Download Report Online &rarr;</a>';
                    }
                } else {
                    throw new Error(data.error || 'Failed to send report');
                }

            } catch (err) {
                console.error('Email report error:', err);
                btnText.innerHTML = '&#9888; Failed - Try Again';
                btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                btn.disabled = false;
                setTimeout(() => {
                    btnText.innerHTML = '&#9993; Email Report to Me';
                    btn.style.background = 'linear-gradient(135deg, #7c3aed, #6d28d9)';
                }, 3000);
            }
        }

        // Generate PDF and return as base64 string (reuses buildPDFDocument)
        async function generatePDFBase64() {
            const doc = await buildPDFDocument();
            return doc.output('datauristring').split(',')[1]; // strip data URI prefix, return base64 only
        }

        // ============================================================
        // PDF REPORT GENERATION
        // ============================================================
        async function downloadPDFReport() {
            const btn = document.getElementById('downloadPdfBtn');
            const btnText = document.getElementById('pdfBtnText');
            btn.disabled = true;
            btnText.textContent = 'Generating PDF...';

            try {
                const doc = await buildPDFDocument();
                const fileName = `process-diagnostic-${(lastContact?.company || 'report').replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
            } catch (err) {
                console.error('PDF generation error:', err);
                showBanner('PDF generation failed. Check the browser console for details.', 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Download PDF Report';
            }
        }

        async function loadJsPDF() {
            if (window.jspdf) return;
            return new Promise(function(resolve, reject) {
                var s = document.createElement('script');
                s.src = '/assets/jspdf.umd.min.js';
                s.onload = resolve;
                s.onerror = function() { reject(new Error('Failed to load jsPDF')); };
                document.head.appendChild(s);
            });
        }

        async function buildPDFDocument() {
                await loadJsPDF();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageW = 210;
                const pageH = 297;
                const margin = 20;
                const contentW = pageW - margin * 2;
                let y = margin;

                // Colours
                const primary = [26, 47, 74];
                const accent = [61, 142, 166];
                const textDark = [30, 41, 59];
                const textMid = [71, 85, 105];
                const textLight = [100, 116, 139];
                const white = [255, 255, 255];
                const bgAlt = [241, 245, 249];
                const danger = [239, 68, 68];
                const success = [22, 163, 74];

                function checkNewPage(needed) {
                    if (y + needed > pageH - margin) {
                        doc.addPage();
                        y = margin;
                        return true;
                    }
                    return false;
                }

                function drawLine() {
                    doc.setDrawColor(...bgAlt);
                    doc.setLineWidth(0.5);
                    doc.line(margin, y, pageW - margin, y);
                    y += 5;
                }

                // ===== COVER PAGE =====
                // Background header block
                doc.setFillColor(...primary);
                doc.rect(0, 0, pageW, 100, 'F');

                // Brand
                doc.setTextColor(...white);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
                doc.text('WORKFLOW PARTNERS', margin, 25);

                // Title
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text('Process Diagnostic', margin, 50);
                doc.text('Report', margin, 62);

                // Date & contact
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text('Generated: ' + new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }), margin, 80);

                if (lastContact) {
                    doc.text(`${lastContact.name || ''} | ${lastContact.company || ''} | ${lastContact.email || ''}`, margin, 88);
                }

                y = 120;

                // Executive summary
                doc.setTextColor(...textDark);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Executive Summary', margin, y);
                y += 10;

                const totalCost = lastResult?.totalCost || 0;
                const savings = lastResult?.potentialSavings || 0;

                // Summary metrics boxes
                const boxW = contentW / 3 - 4;
                const metrics = [
                    { label: 'Processes Analysed', value: String(completedProcesses.length) },
                    { label: 'Total Annual Cost', value: formatCurrencyPlain(totalCost) },
                    { label: 'Potential Savings', value: formatCurrencyPlain(savings) }
                ];

                metrics.forEach((m, i) => {
                    const bx = margin + i * (boxW + 6);
                    doc.setFillColor(...bgAlt);
                    doc.roundedRect(bx, y, boxW, 28, 3, 3, 'F');
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...accent);
                    doc.text(m.value, bx + boxW / 2, y + 12, { align: 'center' });
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textMid);
                    doc.text(m.label, bx + boxW / 2, y + 22, { align: 'center' });
                });

                y += 40;

                // ===== PER-PROCESS SECTIONS =====
                completedProcesses.forEach((p, pi) => {
                    checkNewPage(60);

                    doc.setTextColor(...primary);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${pi + 1}. ${p.processName}`, margin, y);
                    y += 3;

                    // Accent underline
                    doc.setDrawColor(...accent);
                    doc.setLineWidth(1);
                    doc.line(margin, y, margin + 60, y);
                    y += 8;

                    // Process overview
                    doc.setTextColor(...textDark);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');

                    const overviewLines = [
                        ['Type', p.processType],
                        ['Starts when', p.definition?.startsWhen || '—'],
                        ['Completes when', p.definition?.completesWhen || '—'],
                        ['Complexity', p.definition?.complexity || '—'],
                        ['Departments', (p.definition?.departments || []).join(', ') || '—']
                    ];

                    overviewLines.forEach(([label, value]) => {
                        checkNewPage(8);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...textMid);
                        doc.text(label + ':', margin, y);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...textDark);
                        const lines = doc.splitTextToSize(String(value), contentW - 45);
                        doc.text(lines, margin + 42, y);
                        y += lines.length * 5 + 2;
                    });

                    y += 3;
                    checkNewPage(40);

                    // Last example section
                    doc.setFillColor(...bgAlt);
                    doc.roundedRect(margin, y, contentW, 32, 3, 3, 'F');
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...accent);
                    doc.text('Last Example: ' + (p.lastExample?.name || '—'), margin + 5, y + 8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textDark);
                    doc.text(`Duration: ${p.lastExample?.elapsedDays || '?'} days`, margin + 5, y + 16);
                    doc.text(`Your time: ${p.userTime?.total || 0} hours (Meetings: ${p.userTime?.meetings || 0}h, Emails: ${p.userTime?.emails || 0}h, Execution: ${p.userTime?.execution || 0}h, Waiting: ${p.userTime?.waiting || 0}h)`, margin + 5, y + 24);
                    y += 40;

                    // Steps table
                    if (p.steps && p.steps.length > 0) {
                        checkNewPage(20 + p.steps.length * 8);

                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...primary);
                        doc.text('Process Steps', margin, y);
                        y += 7;

                        // Table header
                        doc.setFillColor(...primary);
                        doc.rect(margin, y, contentW, 8, 'F');
                        doc.setTextColor(...white);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.text('#', margin + 3, y + 5.5);
                        doc.text('Step Name', margin + 15, y + 5.5);
                        doc.text('Department', margin + 105, y + 5.5);
                        doc.text('Type', margin + 155, y + 5.5);
                        y += 8;

                        // Table rows
                        p.steps.forEach((s, si) => {
                            checkNewPage(8);
                            if (si % 2 === 0) {
                                doc.setFillColor(...bgAlt);
                                doc.rect(margin, y, contentW, 8, 'F');
                            }
                            doc.setTextColor(...textDark);
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(8);
                            doc.text(String(s.number), margin + 3, y + 5.5);
                            doc.text(String(s.name || '').substring(0, 48), margin + 15, y + 5.5);
                            doc.text(String(s.department || '').substring(0, 22), margin + 105, y + 5.5);
                            // Internal/External badge
                            if (s.isExternal) {
                                doc.setFillColor(254, 243, 199);
                                doc.roundedRect(margin + 155, y + 1, 14, 5, 1, 1, 'F');
                                doc.setFontSize(6);
                                doc.setFont('helvetica', 'bold');
                                doc.setTextColor(146, 64, 14);
                                doc.text('EXT', margin + 156, y + 4.8);
                            } else {
                                doc.setFontSize(6);
                                doc.setFont('helvetica', 'normal');
                                doc.setTextColor(...textLight);
                                doc.text('INT', margin + 156, y + 4.8);
                            }
                            doc.setFontSize(8);
                            y += 8;
                        });

                        y += 5;
                    }

                    // Cost section
                    checkNewPage(45);

                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...primary);
                    doc.text('Cost Analysis', margin, y);
                    y += 8;

                    const costBoxW = contentW / 2 - 3;

                    // Instance cost
                    doc.setFillColor(...bgAlt);
                    doc.roundedRect(margin, y, costBoxW, 22, 3, 3, 'F');
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...accent);
                    doc.text(formatCurrencyPlain(p.costs?.instanceCost || 0), margin + costBoxW / 2, y + 10, { align: 'center' });
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textMid);
                    doc.text('Cost per instance', margin + costBoxW / 2, y + 18, { align: 'center' });

                    // Annual cost
                    doc.setFillColor(254, 226, 226);
                    doc.roundedRect(margin + costBoxW + 6, y, costBoxW, 22, 3, 3, 'F');
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...danger);
                    doc.text(formatCurrencyPlain(p.costs?.totalAnnualCost || 0), margin + costBoxW + 6 + costBoxW / 2, y + 10, { align: 'center' });
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textMid);
                    doc.text('Total annual cost', margin + costBoxW + 6 + costBoxW / 2, y + 18, { align: 'center' });

                    y += 30;

                    // Details line
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textMid);
                    doc.text(`${p.frequency?.annual || '?'} instances/year \u00B7 ${p.costs?.teamSize || 1} people \u00B7 \u00A3${p.costs?.hourlyRate || 50}/hr \u00B7 Priority: ${p.priority?.level || 'Not set'}`, margin, y);
                    y += 10;

                    drawLine();
                    y += 5;
                });

                // ===== RECOMMENDATIONS PAGE =====
                checkNewPage(40);

                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...primary);
                doc.text('Recommendations', margin, y);
                y += 10;

                (lastResult?.recommendations || []).forEach((rec, ri) => {
                    checkNewPage(25);

                    doc.setFillColor(...bgAlt);
                    doc.roundedRect(margin, y, contentW, 0, 3, 3, 'F'); // placeholder for height calc

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...accent);
                    doc.text(`${ri + 1}. ${rec.process || 'General'}`, margin + 5, y + 7);

                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textDark);
                    const recLines = doc.splitTextToSize(rec.text || '', contentW - 12);
                    doc.text(recLines, margin + 5, y + 14);

                    const blockH = 16 + recLines.length * 4.5;
                    doc.setFillColor(...bgAlt);
                    doc.roundedRect(margin, y, contentW, blockH, 3, 3, 'F');

                    // Re-draw text on top of filled rect
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...accent);
                    doc.text(`${ri + 1}. ${rec.process || 'General'}`, margin + 5, y + 7);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textDark);
                    doc.text(recLines, margin + 5, y + 14);

                    y += blockH + 5;
                });

                // ===== FLOW DIAGRAM PAGE =====
                // Try to embed the flow diagram in the PDF
                await embedFlowDiagramInPDF(doc, margin, contentW, pageW, pageH, primary, textMid);

                // ===== AUTOMATION READINESS SCORE PAGE =====
                if (lastScoreData) {
                    doc.addPage('a4', 'portrait');
                    y = margin;

                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...primary);
                    doc.text('Automation Readiness Score', margin, y);
                    y += 10;

                    // Big score
                    const sc = lastScoreData;
                    const scoreRGB = hexToRgb(sc.scoreColor);
                    doc.setFontSize(48);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...scoreRGB);
                    doc.text(sc.readinessScore + '%', margin, y + 15);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(sc.scoreGrade + ' Readiness', margin + 50, y + 15);
                    y += 28;

                    doc.setFontSize(9);
                    doc.setTextColor(...textMid);
                    doc.text(`${sc.totalAutomatable} of ${sc.totalSteps} steps can be automated or agent-assisted.`, margin, y);
                    y += 10;

                    // Category breakdown
                    const barMaxW = contentW - 55;
                    sc.cats.forEach(cat => {
                        const pct = sc.totalSteps > 0 ? cat.count / sc.totalSteps : 0;
                        const catRgb = hexToRgb(cat.color);

                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...catRgb);
                        doc.text(`${cat.badge} ${cat.label}`, margin, y);

                        // Bar background
                        doc.setFillColor(241, 245, 249);
                        doc.roundedRect(margin + 50, y - 3, barMaxW, 5, 1, 1, 'F');
                        // Bar fill
                        if (pct > 0) {
                            doc.setFillColor(...catRgb);
                            doc.roundedRect(margin + 50, y - 3, barMaxW * pct, 5, 1, 1, 'F');
                        }

                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...textDark);
                        doc.text(`${cat.count}/${sc.totalSteps}`, margin + 50 + barMaxW + 3, y);
                        y += 9;
                    });

                    // Manual row
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textLight);
                    doc.text('— Manual', margin, y);
                    doc.setFillColor(241, 245, 249);
                    doc.roundedRect(margin + 50, y - 3, barMaxW, 5, 1, 1, 'F');
                    const manPct = sc.totalSteps > 0 ? sc.nonAuto / sc.totalSteps : 0;
                    if (manPct > 0) {
                        doc.setFillColor(203, 213, 225);
                        doc.roundedRect(margin + 50, y - 3, barMaxW * manPct, 5, 1, 1, 'F');
                    }
                    doc.text(`${sc.nonAuto}/${sc.totalSteps}`, margin + 50 + barMaxW + 3, y);
                    y += 14;
                }

                // ===== 90-DAY ROADMAP PAGE =====
                if (lastRoadmapData) {
                    doc.addPage('a4', 'portrait');
                    y = margin;

                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...primary);
                    doc.text('90-Day Implementation Roadmap', margin, y);
                    y += 10;

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textMid);
                    doc.text('Phased approach: quick wins first, then intelligent automation.', margin, y);
                    y += 10;

                    const rd = lastRoadmapData;
                    const phaseKeys = ['quick', 'agent', 'human', 'multi'];
                    const phaseLabels = { quick: 'Quick Wins (Week 1-2)', agent: 'AI Agents (Month 1)', human: 'Agent + Human (Month 2)', multi: 'Multi-Agent (Month 2-3)' };
                    const phaseBadges = { quick: 'S', agent: 'A', human: 'H', multi: 'M' };

                    phaseKeys.forEach(k => {
                        const phase = rd.phases[k];
                        if (!phase || phase.items.length === 0) return;

                        checkNewPage(20 + phase.items.length * 6);

                        const phaseRgb = hexToRgb(phase.color);

                        // Phase header bar
                        doc.setFillColor(...phaseRgb);
                        doc.roundedRect(margin, y, contentW, 8, 2, 2, 'F');
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...white);
                        doc.text(phaseLabels[k] || phase.label, margin + 4, y + 5.5);
                        y += 12;

                        // Items
                        phase.items.forEach(item => {
                            checkNewPage(7);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(...phaseRgb);
                            doc.text(phaseBadges[k], margin + 4, y);
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(...textDark);
                            const itemLines = doc.splitTextToSize(`${item.step} (${item.process})`, contentW - 20);
                            doc.text(itemLines, margin + 12, y);
                            y += itemLines.length * 4.5 + 2;
                        });

                        // Phase savings
                        if (phase.savings > 0) {
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(...phaseRgb);
                            doc.text(`Estimated savings: ${formatCurrencyPlain(phase.savings)}/yr`, margin + 4, y);
                            y += 5;
                        }

                        y += 5;
                    });

                    // Cumulative
                    if (rd.cumulative > 0) {
                        checkNewPage(20);
                        doc.setFillColor(5, 150, 105);
                        doc.roundedRect(margin, y, contentW, 14, 3, 3, 'F');
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...white);
                        doc.text('Projected 90-Day Impact: ' + formatCurrencyPlain(rd.cumulative) + '/yr', margin + 6, y + 9);
                        y += 20;
                    }
                }

                // ===== FOOTER on every page =====
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textLight);
                    doc.text('Workflow Partners \u00B7 Process Diagnostic Report \u00B7 Confidential', margin, pageH - 10);
                    doc.text(`Page ${i} of ${totalPages}`, pageW - margin, pageH - 10, { align: 'right' });
                }

                // Return the built document
                return doc;
        }

        function hexToRgb(hex) {
            hex = hex.replace('#', '');
            return [parseInt(hex.substring(0, 2), 16), parseInt(hex.substring(2, 4), 16), parseInt(hex.substring(4, 6), 16)];
        }

        function formatCurrencyPlain(amount) {
            if (amount >= 1000000) return '\u00A3' + (amount / 1000000).toFixed(2) + 'M';
            if (amount >= 1000) return '\u00A3' + Math.round(amount / 1000) + 'K';
            return '\u00A3' + Math.round(amount).toLocaleString();
        }

        // ============================================================
        // UTILITIES
        // ============================================================
        function getRadioValue(name) {
            const el = document.querySelector('input[name="' + name + '"]:checked');
            return el ? el.value : '';
        }

        function getCheckedValues(name) {
            return Array.from(document.querySelectorAll('input[name="' + name + '"]:checked')).map(cb => cb.value);
        }

        function formatCurrency(amount) {
            if (amount >= 1000000) return '\u00A3' + (amount / 1000000).toFixed(2) + 'M';
            if (amount >= 1000) return '\u00A3' + (amount / 1000).toFixed(0) + 'K';
            return '\u00A3' + Math.round(amount).toLocaleString();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // ============================================================
        // AUTO-SAVE
        // ============================================================
        function saveProgress() {
            try {
                localStorage.setItem('processDiagnosticProgress', JSON.stringify({
                    currentScreen,
                    processData,
                    completedProcesses,
                    timestamp: new Date().toISOString()
                }));
            } catch (e) { /* ignore */ }
        }

        function loadProgress() {
            try {
                const saved = localStorage.getItem('processDiagnosticProgress');
                if (saved) {
                    const data = JSON.parse(saved);
                    const age = (new Date() - new Date(data.timestamp)) / (1000 * 60 * 60);
                    if (age < 24 && data.currentScreen > 0) {
                        if (confirm('You have saved progress from ' + formatDate(data.timestamp) + '. Continue where you left off?')) {
                            processData = data.processData || createEmptyProcess();
                            completedProcesses = data.completedProcesses || [];
                            goToScreen(data.currentScreen);
                            return true;
                        }
                    }
                }
            } catch (e) { /* ignore */ }
            return false;
        }

        // ============================================================
        // RADIO HIGHLIGHT
        // ============================================================
        document.addEventListener('change', function(e) {
            if (e.target.type === 'radio') {
                const group = e.target.closest('.radio-group');
                if (group) {
                    group.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
                    e.target.closest('.radio-option')?.classList.add('selected');

                    // Auto-hide "Other" text inputs when a non-Other radio is selected
                    if (e.target.value !== 'other') {
                        const name = e.target.name;
                        const otherInput = group.parentElement?.querySelector('input[type="text"][id*="Other"]');
                        if (otherInput) {
                            otherInput.style.display = 'none';
                            otherInput.value = '';
                        }
                    }
                }
            }
        });

        // ============================================================
        // SET DATE MAX
        // ============================================================
        function setDateLimits() {
            const today = new Date().toISOString().split('T')[0];
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            if (startDate) startDate.max = today;
            if (endDate) endDate.max = today;
        }

        // ============================================================
        // SAMPLE DATA (DEV TESTING)
        // ============================================================
        function getSampleProcesses() {
            return [
                {
                    processType: 'client-onboarding',
                    processName: 'Client Onboarding',
                    definition: {
                        startsWhen: 'Contract is signed',
                        completesWhen: 'Client has live access and first report delivered',
                        complexity: 'complex',
                        departments: ['Sales', 'Operations', 'IT', 'Customer Success']
                    },
                    lastExample: {
                        name: 'Acme Corp Onboarding',
                        startDate: '2026-01-06',
                        endDate: '2026-01-27',
                        elapsedDays: 21
                    },
                    userTime: { meetings: 6, emails: 4, execution: 8, waiting: 12, total: 30 },
                    timeAccuracy: 'somewhat-confident',
                    performance: 'typical',
                    issues: ['delays-waiting', 'rework-errors', 'information-gaps'],
                    biggestDelay: 'Waiting for IT to provision accounts and integrations',
                    delayDetails: 'IT has a backlog; access requests sit in queue 3-5 business days on average.',
                    steps: [
                        { number: 1, name: 'Send welcome email & kickoff invite', department: 'Sales' },
                        { number: 2, name: 'Internal handoff meeting', department: 'Sales' },
                        { number: 3, name: 'Collect technical requirements', department: 'Operations' },
                        { number: 4, name: 'Provision accounts & integrations', department: 'IT' },
                        { number: 5, name: 'Configure client workspace', department: 'Operations' },
                        { number: 6, name: 'QA review & data validation', department: 'Operations' },
                        { number: 7, name: 'Client training session', department: 'Customer Success' },
                        { number: 8, name: 'Deliver first report & go-live', department: 'Customer Success' }
                    ],
                    handoffs: [
                        { from: { name: 'Send welcome email' }, to: { name: 'Internal handoff meeting' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'Internal handoff meeting' }, to: { name: 'Collect technical requirements' }, method: 'meeting', clarity: 'mostly-clear' },
                        { from: { name: 'Collect technical requirements' }, to: { name: 'Provision accounts' }, method: 'ticket-system', clarity: 'yes-multiple' },
                        { from: { name: 'Provision accounts' }, to: { name: 'Configure workspace' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'Configure workspace' }, to: { name: 'QA review' }, method: 'they-knew', clarity: 'yes-multiple' },
                        { from: { name: 'QA review' }, to: { name: 'Client training' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'Client training' }, to: { name: 'Deliver first report' }, method: 'meeting', clarity: 'mostly-clear' }
                    ],
                    systems: [
                        { name: 'Salesforce', purpose: 'CRM - client record', actions: ['lookup', 'update', 'copy-out'] },
                        { name: 'Jira', purpose: 'IT provisioning tickets', actions: ['create', 'update'] },
                        { name: 'Google Workspace', purpose: 'Email & shared docs', actions: ['create', 'share'] },
                        { name: 'Notion', purpose: 'Internal knowledge base', actions: ['lookup'] }
                    ],
                    approvals: [
                        { name: 'Account provisioning approval', who: 'IT Manager', rounds: '1', assessment: 'necessary', avgDays: '2' }
                    ],
                    knowledge: {
                        documentation: 'partial',
                        singlePointOfFailure: 'yes',
                        spofPerson: 'Sarah (Operations Lead)',
                        workarounds: 'yes',
                        workaroundDetails: 'Ops team keeps a personal spreadsheet to track what Jira misses.'
                    },
                    newHire: {
                        learningWeeks: '6',
                        learningMethod: 'shadow',
                        firstTimeErrors: 'yes',
                        errorDetails: 'New hires often miss the QA checklist steps and send incomplete configs to clients.'
                    },
                    frequency: { type: 'weekly', annual: 48, inFlight: 8, progressing: 5, stuck: 2, waiting: 1 },
                    costs: { hourlyRate: 55, instanceCost: 1650, annualUserCost: 79200, totalAnnualCost: 158400, teamSize: 2 },
                    savings: { targetReduction: '40', savingsUse: ['speed', 'quality'] },
                    priority: { priority: 'high', urgency: 'next-quarter' },
                    bottleneck: { longestStep: 'step-3', reason: 'waiting-other-team' }
                },
                {
                    processType: 'invoice-approval',
                    processName: 'Invoice Approval & Payment',
                    definition: {
                        startsWhen: 'Invoice received from vendor',
                        completesWhen: 'Payment is processed and recorded',
                        complexity: 'moderate',
                        departments: ['Finance', 'Operations', 'Leadership']
                    },
                    lastExample: {
                        name: 'CloudHost Inc Invoice #4821',
                        startDate: '2026-01-15',
                        endDate: '2026-01-29',
                        elapsedDays: 14
                    },
                    userTime: { meetings: 1, emails: 3, execution: 2, waiting: 8, total: 14 },
                    timeAccuracy: 'confident',
                    performance: 'typical',
                    issues: ['delays-waiting', 'too-many-steps', 'approval-bottlenecks'],
                    biggestDelay: 'Director approval sits in inbox for days',
                    delayDetails: 'Director reviews invoices in batches once a week. Urgent invoices get delayed alongside routine ones.',
                    steps: [
                        { number: 1, name: 'Receive & log invoice', department: 'Finance' },
                        { number: 2, name: 'Match to PO / contract', department: 'Finance' },
                        { number: 3, name: 'Department head review', department: 'Operations' },
                        { number: 4, name: 'Director approval', department: 'Leadership' },
                        { number: 5, name: 'Schedule payment', department: 'Finance' },
                        { number: 6, name: 'Process payment & record', department: 'Finance' }
                    ],
                    handoffs: [
                        { from: { name: 'Receive invoice' }, to: { name: 'Match to PO' }, method: 'same-person', clarity: 'mostly-clear' },
                        { from: { name: 'Match to PO' }, to: { name: 'Department head review' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'Department head review' }, to: { name: 'Director approval' }, method: 'email', clarity: 'yes-multiple' },
                        { from: { name: 'Director approval' }, to: { name: 'Schedule payment' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'Schedule payment' }, to: { name: 'Process payment' }, method: 'same-person', clarity: 'mostly-clear' }
                    ],
                    systems: [
                        { name: 'QuickBooks', purpose: 'Accounting system', actions: ['create', 'update', 'lookup'] },
                        { name: 'Email', purpose: 'Approval routing', actions: ['copy-in', 'copy-out'] },
                        { name: 'Excel', purpose: 'Payment tracking spreadsheet', actions: ['update', 'copy-in'] }
                    ],
                    approvals: [
                        { name: 'Department head sign-off', who: 'Dept Manager', rounds: '1', assessment: 'necessary', avgDays: '1' },
                        { name: 'Director approval', who: 'Finance Director', rounds: '1-2', assessment: 'could-reduce', avgDays: '4' }
                    ],
                    knowledge: {
                        documentation: 'yes',
                        singlePointOfFailure: 'yes',
                        spofPerson: 'Maria (AP Clerk)',
                        workarounds: 'yes',
                        workaroundDetails: 'Finance team texts the director directly for urgent invoices to bypass the email queue.'
                    },
                    newHire: {
                        learningWeeks: '3',
                        learningMethod: 'documented-process',
                        firstTimeErrors: 'yes',
                        errorDetails: 'New hires often misclassify expense categories in QuickBooks.'
                    },
                    frequency: { type: 'daily', annual: 240, inFlight: 15, progressing: 10, stuck: 3, waiting: 2 },
                    costs: { hourlyRate: 45, instanceCost: 630, annualUserCost: 151200, totalAnnualCost: 151200, teamSize: 1 },
                    savings: { targetReduction: '50', savingsUse: ['speed', 'cost'] },
                    priority: { priority: 'medium', urgency: 'this-quarter' },
                    bottleneck: { longestStep: 'step-3', reason: 'approval-delays' }
                },
                // ── COMPLEXITY 10: Enterprise CapEx Procurement with Routing ──
                // 22 steps, 12 departments, 6 decision/branch points, 5 approval gates,
                // external parties, regulatory compliance, cross-border routing,
                // conditional paths, exception handling, and loop-back flows.
                {
                    processType: 'other',
                    processName: 'Enterprise CapEx Procurement (IT Infrastructure)',
                    definition: {
                        startsWhen: 'Business unit submits capital expenditure request for IT infrastructure over £50K',
                        completesWhen: 'Equipment delivered, installed, asset-tagged, and first invoice reconciled in ERP',
                        complexity: 'very-complex',
                        departments: ['IT', 'Finance', 'Procurement', 'Legal', 'Compliance', 'Leadership', 'Operations', 'Engineering', 'Quality Assurance', 'Risk', 'Data Protection', 'Facilities']
                    },
                    lastExample: {
                        name: 'Data Centre Expansion — 40 Server Racks + Networking',
                        startDate: '2025-09-15',
                        endDate: '2026-01-20',
                        elapsedDays: 127
                    },
                    userTime: { meetings: 32, emails: 40, execution: 25, waiting: 90, total: 187 },
                    timeAccuracy: 'somewhat-confident',
                    performance: 'this-was-worse',
                    issues: ['delays-waiting', 'too-many-steps', 'approval-bottlenecks', 'rework-errors', 'information-gaps', 'compliance-requirements'],
                    biggestDelay: 'Multi-level approval chain — CFO + Board sign-off for CapEx over £250K takes 3-6 weeks',
                    delayDetails: 'Board meets monthly. If you miss the submission window, the entire project slips by 4+ weeks. Meanwhile, vendor quotes expire and need renegotiation.',
                    steps: [
                        { number: 1, name: 'Business case drafted by requesting department', department: 'IT', isExternal: false },
                        { number: 2, name: 'Technical architecture review & sizing', department: 'Engineering', isExternal: false },
                        { number: 3, name: 'Security & compliance impact assessment', department: 'Compliance', isExternal: false,
                          isDecision: true, branches: [
                            { label: 'Low risk — proceed', target: 'Step 4' },
                            { label: 'High risk — full audit', target: 'Step 14' },
                            { label: 'Data handling — trigger DPIA', target: 'Step 15' }
                          ]
                        },
                        { number: 4, name: 'Budget validation & cost centre allocation', department: 'Finance', isExternal: false,
                          isDecision: true, branches: [
                            { label: 'Under £50K — fast track to Step 8', target: 'Step 8' },
                            { label: '£50K–£250K — standard route', target: 'Step 5' },
                            { label: 'Over £250K — full governance', target: 'Step 5' }
                          ]
                        },
                        { number: 5, name: 'Departmental head approval (IT Director)', department: 'IT', isExternal: false,
                          isDecision: true, branches: [
                            { label: 'Approved', target: 'Step 6' },
                            { label: 'Rejected — revise business case', target: 'Step 1' },
                            { label: 'Deferred — resubmit next quarter', target: '' }
                          ]
                        },
                        { number: 6, name: 'Procurement creates RFP / RFQ package', department: 'Procurement', isExternal: false },
                        { number: 7, name: 'RFP distributed to shortlisted vendors', department: 'External Vendor', isExternal: true },
                        { number: 8, name: 'Vendor proposals received & scored', department: 'Procurement', isExternal: false },
                        { number: 9, name: 'Technical evaluation by engineering team', department: 'Engineering', isExternal: false,
                          isDecision: true, branches: [
                            { label: 'Single vendor qualifies', target: 'Step 11' },
                            { label: 'Multiple qualify — competitive round', target: 'Step 10' },
                            { label: 'None qualify — re-issue RFP', target: 'Step 6' }
                          ]
                        },
                        { number: 10, name: 'Vendor reference checks, demos & site visits', department: 'External Vendor', isExternal: true },
                        { number: 11, name: 'Commercial negotiation & terms review', department: 'Procurement', isExternal: false },
                        { number: 12, name: 'Legal contract review & redlining', department: 'Legal', isExternal: false },
                        { number: 13, name: 'External legal review (vendor T&Cs)', department: 'External Legal', isExternal: true,
                          isDecision: true, branches: [
                            { label: 'Terms accepted', target: 'Step 16' },
                            { label: 'Unacceptable clauses — renegotiate', target: 'Step 11' },
                            { label: 'Risk escalation — board review', target: 'Step 18' }
                          ]
                        },
                        { number: 14, name: 'Full security audit & penetration test', department: 'Risk', isExternal: false },
                        { number: 15, name: 'Data protection impact assessment (DPIA)', department: 'Data Protection', isExternal: false },
                        { number: 16, name: 'CFO approval for CapEx budget', department: 'Finance', isExternal: false,
                          isDecision: true, branches: [
                            { label: 'Approved (under £250K)', target: 'Step 19' },
                            { label: 'Approved — but needs Board (over £250K)', target: 'Step 17' },
                            { label: 'Rejected — reduce scope', target: 'Step 1' }
                          ]
                        },
                        { number: 17, name: 'Investment Committee pre-review', department: 'Leadership', isExternal: false },
                        { number: 18, name: 'Board approval (CapEx > £250K)', department: 'Leadership', isExternal: false },
                        { number: 19, name: 'Purchase order raised in ERP', department: 'Procurement', isExternal: false },
                        { number: 20, name: 'Vendor confirms order & delivery schedule', department: 'External Vendor', isExternal: true },
                        { number: 21, name: 'Goods received, inspected & asset-tagged', department: 'Facilities', isExternal: false },
                        { number: 22, name: 'Installation, testing, UAT & QA sign-off', department: 'Quality Assurance', isExternal: false }
                    ],
                    handoffs: [
                        { from: { name: 'Business case drafted' }, to: { name: 'Technical architecture review' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'Technical architecture review' }, to: { name: 'Security & compliance assessment' }, method: 'email', clarity: 'yes-multiple' },
                        { from: { name: 'Security & compliance assessment' }, to: { name: 'Budget validation' }, method: 'email', clarity: 'yes-multiple' },
                        { from: { name: 'Budget validation' }, to: { name: 'IT Director approval' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'IT Director approval' }, to: { name: 'Procurement creates RFP' }, method: 'ticket-system', clarity: 'mostly-clear' },
                        { from: { name: 'Procurement creates RFP' }, to: { name: 'RFP distributed to vendors' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'RFP distributed to vendors' }, to: { name: 'Vendor proposals received' }, method: 'email', clarity: 'yes-multiple' },
                        { from: { name: 'Vendor proposals received' }, to: { name: 'Technical evaluation' }, method: 'email', clarity: 'yes-multiple' },
                        { from: { name: 'Technical evaluation' }, to: { name: 'Vendor reference checks' }, method: 'meeting', clarity: 'mostly-clear' },
                        { from: { name: 'Vendor reference checks' }, to: { name: 'Commercial negotiation' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'Commercial negotiation' }, to: { name: 'Legal contract review' }, method: 'email', clarity: 'yes-multiple' },
                        { from: { name: 'Legal contract review' }, to: { name: 'External legal review' }, method: 'email', clarity: 'yes-multiple' },
                        { from: { name: 'External legal review' }, to: { name: 'Full security audit' }, method: 'email', clarity: 'yes-multiple' },
                        { from: { name: 'Full security audit' }, to: { name: 'DPIA assessment' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'DPIA assessment' }, to: { name: 'CFO approval' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'CFO approval' }, to: { name: 'Investment Committee pre-review' }, method: 'meeting', clarity: 'mostly-clear' },
                        { from: { name: 'Investment Committee pre-review' }, to: { name: 'Board approval' }, method: 'meeting', clarity: 'mostly-clear' },
                        { from: { name: 'Board approval' }, to: { name: 'Purchase order raised' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'Purchase order raised' }, to: { name: 'Vendor confirms order' }, method: 'email', clarity: 'yes-multiple' },
                        { from: { name: 'Vendor confirms order' }, to: { name: 'Goods received & inspected' }, method: 'email', clarity: 'mostly-clear' },
                        { from: { name: 'Goods received & inspected' }, to: { name: 'Installation & QA sign-off' }, method: 'they-knew', clarity: 'yes-multiple' }
                    ],
                    systems: [
                        { name: 'SAP S/4HANA', purpose: 'ERP - purchase orders, asset management, GL codes', actions: ['create', 'update', 'lookup', 'copy-out'] },
                        { name: 'Coupa', purpose: 'Procurement platform - RFPs, vendor scoring, contracts', actions: ['create', 'update', 'lookup'] },
                        { name: 'DocuSign', purpose: 'Contract & NDA signatures', actions: ['create', 'update'] },
                        { name: 'ServiceNow', purpose: 'IT request, approval workflow & change management', actions: ['create', 'update', 'lookup'] },
                        { name: 'SharePoint', purpose: 'Document storage, business cases & collaboration', actions: ['create', 'update', 'share'] },
                        { name: 'Power BI', purpose: 'Budget tracking & spend analytics dashboards', actions: ['lookup'] },
                        { name: 'Outlook / Teams', purpose: 'Communication, meetings & ad-hoc approvals', actions: ['copy-in', 'copy-out'] },
                        { name: 'OneTrust', purpose: 'DPIA & privacy compliance assessments', actions: ['create', 'update'] },
                        { name: 'Nessus / Qualys', purpose: 'Security vulnerability scanning & pen testing', actions: ['create', 'lookup'] },
                        { name: 'Jira', purpose: 'Project tracking for installation & UAT', actions: ['create', 'update', 'lookup'] }
                    ],
                    approvals: [
                        { name: 'IT Director sign-off', who: 'IT Director', rounds: '1', assessment: 'necessary', avgDays: '3' },
                        { name: 'Legal contract approval', who: 'General Counsel', rounds: '2-3', assessment: 'necessary', avgDays: '10' },
                        { name: 'DPIA sign-off', who: 'Data Protection Officer', rounds: '1', assessment: 'necessary', avgDays: '5' },
                        { name: 'CFO budget approval', who: 'CFO', rounds: '1-2', assessment: 'necessary', avgDays: '7' },
                        { name: 'Board approval (>£250K)', who: 'Board of Directors', rounds: '1', assessment: 'could-reduce', avgDays: '21' }
                    ],
                    knowledge: {
                        documentation: 'partial',
                        singlePointOfFailure: 'yes',
                        spofPerson: 'James (Senior Procurement Manager) — only person who knows the full end-to-end flow, vendor relationships, and which approval thresholds apply',
                        workarounds: 'yes',
                        workaroundDetails: 'Teams split orders under £50K to avoid the full CapEx process. Finance calls these "shadow purchases" and estimates 15% of IT spend bypasses procurement. Some managers also route through OpEx to avoid Board threshold.'
                    },
                    newHire: {
                        learningWeeks: '16',
                        learningMethod: 'shadow',
                        firstTimeErrors: 'yes',
                        errorDetails: 'New procurement staff routinely miss the Board submission deadline, select wrong GL codes, skip the DPIA for data-handling vendors, or route to the wrong approval path based on value thresholds. Average of 3 rework cycles per first attempt.'
                    },
                    frequency: { type: 'monthly', annual: 12, inFlight: 5, progressing: 2, stuck: 2, waiting: 1 },
                    costs: { hourlyRate: 75, instanceCost: 14025, annualUserCost: 168300, totalAnnualCost: 504900, teamSize: 3 },
                    savings: { targetReduction: '35', savingsUse: ['speed', 'quality', 'compliance'] },
                    priority: { priority: 'critical', urgency: 'this-quarter' },
                    bottleneck: { longestStep: 'step-17', reason: 'approval-delays' }
                }
            ];
        }

        function loadSampleData() {
            completedProcesses = getSampleProcesses();

            const contact = {
                name: 'Test User',
                email: 'hopektettey@gmail.com',
                company: 'Demo Corp',
                title: 'Operations Manager',
                teamSize: '201-500',
                industry: 'Manufacturing'
            };

            goToScreen(19);
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';

            const result = buildLocalResults(completedProcesses, contact);
            displayResults(result, contact);

            autoSaveSampleReport(result, contact);
        }

        async function autoSaveSampleReport(result, contact) {
            try {
                const payload = {
                    contact: {
                        name: contact.name || '',
                        email: contact.email || '',
                        company: contact.company || '',
                        title: contact.title || '',
                        industry: contact.industry || '',
                        teamSize: contact.teamSize || ''
                    },
                    summary: {
                        totalProcesses: (result.processes || []).length,
                        totalAnnualCost: result.totalCost || 0,
                        potentialSavings: result.potentialSavings || 0,
                        analysisType: result.analysisType || 'rule-based',
                        qualityScore: result.qualityScore?.averageScore || 0
                    },
                    recommendations: result.recommendations || [],
                    automationScore: lastScoreData ? {
                        percentage: lastScoreData.readinessScore,
                        grade: lastScoreData.scoreGrade,
                        categories: lastScoreData.cats,
                        totalSteps: lastScoreData.totalSteps,
                        totalAutomatable: lastScoreData.totalAutomatable
                    } : {},
                    roadmap: lastRoadmapData ? {
                        phases: lastRoadmapData.phases,
                        totalSavings: lastRoadmapData.annualSavings,
                        cumulative: lastRoadmapData.cumulative
                    } : {},
                    processes: result.processes || [],
                    rawProcesses: completedProcesses || [],
                    customDepartments: customDepartments || [],
                    pdfBase64: null,
                    timestamp: new Date().toISOString()
                };

                const resp = await fetch('/api/send-diagnostic-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data.success) {
                    console.log('Sample data saved to portal. Report ID:', data.reportId || 'stored');
                }
            } catch (e) {
                console.warn('Auto-save of sample data failed (portal may not show it):', e.message);
            }
        }

        function loadComplexitySample() {
            const allSamples = getSampleProcesses();
            const complex = allSamples.find(p => p.processName.includes('CapEx'));
            if (!complex) { alert('Complexity-10 sample not found'); return; }

            completedProcesses = [complex];

            const contact = {
                name: 'Test User',
                email: 'hopektettey@gmail.com',
                company: 'Meridian Manufacturing Ltd',
                title: 'Head of Procurement',
                teamSize: '501-1000',
                industry: 'Manufacturing'
            };

            goToScreen(19);
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';

            const result = buildLocalResults(completedProcesses, contact);
            displayResults(result, contact);

            autoSaveSampleReport(result, contact);

            triggerAIDiagnostic(complex, contact);
        }

        async function triggerAIDiagnostic(process, contact) {
            const aiContainer = document.getElementById('aiDiagnosticSection');
            if (!aiContainer) {
                // Create the AI section after results
                const resultsContainer = document.getElementById('resultsContainer');
                const section = document.createElement('div');
                section.id = 'aiDiagnosticSection';
                section.className = 'result-section';
                section.style.marginTop = '2rem';
                resultsContainer.appendChild(section);
            }

            const target = document.getElementById('aiDiagnosticSection');
            target.innerHTML = `<h3 style="margin-bottom: 1rem;">AI Deep Analysis <span style="display:inline-block;font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;padding:3px 10px;border-radius:100px;background:linear-gradient(135deg,#7c3aed,#1e40af);color:white;vertical-align:middle;margin-left:8px;">AI-Powered</span></h3>
                <div style="text-align:center;padding:24px;">
                    <div style="display:inline-flex;gap:4px;">
                        <span style="width:8px;height:8px;background:#7c3aed;border-radius:50%;animation:aiPulse 1.2s ease-in-out infinite;"></span>
                        <span style="width:8px;height:8px;background:#7c3aed;border-radius:50%;animation:aiPulse 1.2s ease-in-out 0.2s infinite;"></span>
                        <span style="width:8px;height:8px;background:#7c3aed;border-radius:50%;animation:aiPulse 1.2s ease-in-out 0.4s infinite;"></span>
                    </div>
                    <p style="margin-top:12px;color:var(--text-mid);font-size:0.88rem;">Analysing workflow with ${process.steps.length} steps and ${process.steps.filter(s => s.isDecision).length} decision points...</p>
                </div>
                <style>@keyframes aiPulse{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1.2)}}</style>`;

            target.scrollIntoView({ behavior: 'smooth', block: 'start' });

            const decisionPoints = process.steps.filter(s => s.isDecision);
            const deptList = [...new Set(process.steps.map(s => s.department))];
            const poorHandoffs = (process.handoffs || []).filter(h => h.clarity === 'yes-multiple' || h.clarity === 'yes-major');
            const copySystems = (process.systems || []).filter(s => s.actions.includes('copy-in') || s.actions.includes('copy-out'));
            const teamSizeNum = parseInt(contact.teamSize) || 500;

            // Build evidence object with ALL fields that analyze-symptoms.js expects
            const evidence = {
                actualTime: process.lastExample.elapsedDays,
                idealTime: Math.max(1, Math.round(process.lastExample.elapsedDays * 0.4)),
                waitTime: process.userTime.waiting,
                waitFrequency: 'every-time',
                meetingHours: process.userTime.meetings,
                meetingPeople: deptList.length,
                searchTime: 25,
                dataInconsistent: 'weekly',
                dataFigureOutTime: 30,
                copyPaste: copySystems.length * 3,
                shadowSpreadsheets: 3,
                spreadsheetHours: 4,
                toolCount: (process.systems || []).length,
                toolSwitches: (process.systems || []).length * 5,
                reportHours: 6,
                reportFrequency: 'weekly',
                onboardingWeeks: parseInt(process.newHire?.learningWeeks) || 12,
                missedOpportunities: 2,
                opportunityValue: 50000,
                crossDeptWork: 'handoff'
            };

            // Build workflows array in the format the API expects
            const workflows = [{
                name: process.processName,
                type: process.processType || 'procurement',
                departments: deptList
            }];

            const channels = (process.systems || []).map(s => s.name);

            try {
                const resp = await fetch('/api/analyze-symptoms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        evidence,
                        workflows,
                        channels,
                        toolConsent: {
                            totalSelected: 0,
                            selectedTools: [],
                            hasTools: false,
                            preferManual: true
                        },
                        contact: {
                            name: contact.name,
                            email: contact.email,
                            company: contact.company,
                            teamSize: teamSizeNum,
                            industry: contact.industry
                        }
                    })
                });

                if (!resp.ok) {
                    const errData = await resp.json().catch(() => ({}));
                    const detail = errData.details ? ` — ${JSON.stringify(errData.details).substring(0, 200)}` : '';
                    throw new Error((errData.error || `API returned ${resp.status}`) + detail);
                }

                const data = await resp.json();
                // analyze-symptoms returns { success, analysis, metrics, operatingModel }
                // Normalise to what renderAIDiagnostic expects
                const normalized = {
                    diagnosis: {
                        executiveSummary: data.analysis?.executiveSummary || '',
                        rootCauses: data.analysis?.rootCauses || []
                    },
                    recommendations: data.analysis?.transformationPlan?.phases?.flatMap(p =>
                        (p.weeks || []).flatMap(w =>
                            (w.keyTasks || []).map(t => typeof t === 'string' ? { action: t, timeframe: p.title } : { action: t.task, impact: t.deliverable, owner: (t.attendees || [])[0], timeframe: p.title })
                        )
                    ) || [],
                    operatingModel: data.analysis?.operatingModel || data.operatingModel || null,
                    workflowInsights: data.analysis?.workflowInsights || [],
                    calculatedCosts: data.analysis?.calculatedCosts || data.metrics?.costs || null,
                    healthScore: data.analysis?.healthScore || null,
                    urgencyLevel: data.analysis?.urgencyLevel || null
                };
                renderAIDiagnostic(target, normalized, process);
            } catch (err) {
                console.error('AI diagnostic error:', err);
                target.innerHTML += `<div style="padding:16px;background:#fef2f2;border-radius:8px;border-left:4px solid #dc2626;margin-top:12px;">
                    <strong style="color:#dc2626;">AI analysis unavailable</strong>
                    <p style="color:#64748b;font-size:0.85rem;margin-top:4px;">${err.message}</p>
                    <p style="color:#64748b;font-size:0.82rem;margin-top:8px;">The rule-based analysis above is still valid. AI analysis requires the ANTHROPIC_API_KEY to be configured.</p>
                </div>`;
            }
        }

        function renderAIDiagnostic(container, data, process) {
            const decisionPoints = process.steps.filter(s => s.isDecision);
            let html = `<h3 style="margin-bottom: 1rem;">AI Deep Analysis <span style="display:inline-block;font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;padding:3px 10px;border-radius:100px;background:linear-gradient(135deg,#7c3aed,#1e40af);color:white;vertical-align:middle;margin-left:8px;">AI-Powered</span></h3>`;

            // Health Score & Urgency
            if (data.healthScore || data.urgencyLevel) {
                const score = data.healthScore || 0;
                const urgency = data.urgencyLevel || 'medium';
                const scoreColor = score >= 70 ? '#16a34a' : score >= 40 ? '#d97706' : '#dc2626';
                const urgencyColor = { critical: '#dc2626', high: '#d97706', medium: '#1e40af', low: '#16a34a' }[urgency] || '#1e40af';
                html += `<div style="display:flex;gap:16px;margin-bottom:20px;">
                    <div style="flex:1;background:#f8fafc;border-radius:12px;padding:18px;text-align:center;border:1px solid #e2e8f0;">
                        <div style="font-size:2rem;font-weight:700;color:${scoreColor};">${score}/100</div>
                        <div style="font-size:0.78rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;">Health Score</div>
                    </div>
                    <div style="flex:1;background:#f8fafc;border-radius:12px;padding:18px;text-align:center;border:1px solid #e2e8f0;">
                        <div style="font-size:1.2rem;font-weight:700;color:${urgencyColor};text-transform:uppercase;">${urgency}</div>
                        <div style="font-size:0.78rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;">Urgency Level</div>
                    </div>
                </div>`;
            }

            // Decision Points Summary
            if (decisionPoints.length > 0) {
                html += `<div style="background:linear-gradient(135deg,#faf5ff,#f0f9ff);padding:20px 24px;border-radius:12px;border-left:4px solid #7c3aed;margin-bottom:20px;">
                    <h4 style="font-size:0.95rem;font-weight:600;color:#7c3aed;margin-bottom:12px;">Decision Points & Routing (${decisionPoints.length} found)</h4>`;
                decisionPoints.forEach(dp => {
                    const branches = dp.branches || [];
                    const hasLoopBack = branches.some(b => {
                        const t = parseInt((b.target || '').replace(/\D/g, ''));
                        return t && t < dp.number;
                    });
                    html += `<div style="background:white;border-radius:8px;padding:14px 16px;margin-bottom:8px;border:1px solid #e2e8f0;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <strong style="font-size:0.9rem;">Step ${dp.number}: ${dp.name}</strong>
                            <div>
                                <span style="font-size:0.7rem;padding:2px 8px;border-radius:100px;background:#f3e8ff;color:#7c3aed;font-weight:600;">${branches.length} routes</span>
                                ${hasLoopBack ? '<span style="font-size:0.7rem;padding:2px 8px;border-radius:100px;background:#fef3c7;color:#d97706;font-weight:600;margin-left:4px;">Loop-back</span>' : ''}
                            </div>
                        </div>
                        <div style="font-size:0.82rem;color:#475569;">
                            ${branches.map(b => `<span style="display:inline-block;margin:2px 4px 2px 0;padding:2px 8px;background:#f1f5f9;border-radius:4px;">${b.label} → ${b.target || 'End'}</span>`).join('')}
                        </div>
                    </div>`;
                });
                const totalRoutes = decisionPoints.reduce((s, d) => s + (d.branches || []).length, 0);
                const loopBacks = decisionPoints.filter(d => (d.branches || []).some(b => { const t = parseInt((b.target||'').replace(/\D/g,'')); return t && t < d.number; })).length;
                html += `<div style="display:flex;gap:16px;margin-top:12px;font-size:0.82rem;color:#64748b;">
                    <span><strong>${decisionPoints.length}</strong> decision gates</span>
                    <span><strong>${totalRoutes}</strong> total routes</span>
                    <span><strong>${loopBacks}</strong> loop-backs</span>
                    <span><strong>${process.steps.filter(s=>s.isExternal).length}</strong> external steps</span>
                </div></div>`;
            }

            // If API returned structured analysis
            if (data.diagnosis || data.recommendations || data.operatingModel) {
                // Executive summary from API
                if (data.diagnosis?.executiveSummary) {
                    html += `<div style="font-size:0.95rem;line-height:1.7;color:var(--text);background:linear-gradient(135deg,#f0fdf4,#eff6ff);padding:20px 24px;border-radius:12px;border-left:4px solid #16a34a;margin-bottom:20px;">
                        ${data.diagnosis.executiveSummary}
                    </div>`;
                }

                // Root causes
                if (data.diagnosis?.rootCauses && data.diagnosis.rootCauses.length > 0) {
                    html += `<h4 style="font-size:0.95rem;font-weight:600;color:var(--primary);margin:20px 0 12px;">Root Causes</h4>`;
                    data.diagnosis.rootCauses.forEach(rc => {
                        const sevColor = rc.severity === 'critical' ? '#dc2626' : rc.severity === 'high' ? '#d97706' : '#1e40af';
                        html += `<div style="background:white;border:1.5px solid #e2e8f0;border-left:4px solid ${sevColor};border-radius:12px;padding:18px 20px;margin-bottom:12px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                                <strong style="font-size:0.95rem;">${rc.title || rc.cause || ''}</strong>
                                <span style="font-size:0.7rem;font-weight:600;text-transform:uppercase;padding:2px 8px;border-radius:100px;background:${sevColor};color:white;">${rc.severity}</span>
                            </div>
                            <p style="font-size:0.88rem;color:#475569;line-height:1.6;">${rc.explanation || rc.detail || ''}</p>
                            ${rc.evidence ? `<p style="font-size:0.8rem;color:#94a3b8;font-style:italic;margin-top:4px;">Evidence: ${rc.evidence}</p>` : ''}
                        </div>`;
                    });
                }

                // Recommendations from API
                if (data.recommendations && data.recommendations.length > 0) {
                    html += `<h4 style="font-size:0.95rem;font-weight:600;color:var(--primary);margin:20px 0 12px;">AI Recommendations</h4>`;
                    data.recommendations.forEach((rec, i) => {
                        const tfColor = rec.timeframe === 'immediate' || rec.timeframe === 'quick-win' ? '#d1fae5' : rec.timeframe === '30-day' ? '#dbeafe' : '#fae8ff';
                        const tfText = rec.timeframe === 'immediate' || rec.timeframe === 'quick-win' ? '#065f46' : rec.timeframe === '30-day' ? '#1e40af' : '#7c3aed';
                        html += `<div style="display:flex;gap:14px;padding:14px 0;border-bottom:1px solid #e2e8f0;">
                            <div style="width:28px;height:28px;border-radius:50%;background:#3d8ea6;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.82rem;flex-shrink:0;">${i + 1}</div>
                            <div style="flex:1;">
                                <strong style="display:block;font-size:0.9rem;">${rec.action || rec.title || ''}</strong>
                                <p style="font-size:0.82rem;color:#475569;margin:3px 0 6px;">${rec.impact || rec.description || ''}</p>
                                <div style="display:flex;gap:6px;">
                                    ${rec.timeframe ? `<span style="font-size:0.7rem;padding:2px 8px;border-radius:100px;background:${tfColor};color:${tfText};">${rec.timeframe}</span>` : ''}
                                    ${rec.owner ? `<span style="font-size:0.7rem;padding:2px 8px;border-radius:100px;background:#f1f5f9;color:#64748b;">${rec.owner}</span>` : ''}
                                </div>
                            </div>
                        </div>`;
                    });
                }

                // Operating model
                if (data.operatingModel) {
                    html += `<div style="background:#f8fafc;border-radius:12px;padding:18px 20px;margin-top:20px;border:1px solid #e2e8f0;">
                        <h4 style="font-size:0.95rem;font-weight:600;color:var(--primary);margin-bottom:8px;">Operating Model: ${data.operatingModel.type || 'Complex'}</h4>
                        <p style="font-size:0.85rem;color:#475569;line-height:1.6;">${data.operatingModel.description || ''}</p>
                    </div>`;
                }
            } else if (typeof data === 'string') {
                html += `<div style="font-size:0.92rem;line-height:1.7;color:var(--text);white-space:pre-wrap;">${data}</div>`;
            }

            container.innerHTML = html;
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function loadTeamSampleToConsole() {
            const data = getTeamSampleResponses();
            console.log('=== TEAM SAMPLE DATA ===');
            console.log('Process:', data.processName);
            console.log('Company:', data.company);
            console.log('Respondents:', data.responses.length);
            data.responses.forEach((r, i) => {
                console.log(`  ${i + 1}. ${r.respondentName} (${r.respondentDepartment}) — ${r.responseData.processData.steps.length} steps, ${r.responseData.processData.lastExample.elapsedDays} days, ${r.responseData.processData.userTime.total}h`);
                const decisions = r.responseData.processData.steps.filter(s => s.isDecision);
                if (decisions.length) console.log(`     Decision points: ${decisions.map(d => 'Step ' + d.number + ' (' + d.branches.length + ' routes)').join(', ')}`);
            });
            console.log('\nFull JSON (copy from below):');
            console.log(JSON.stringify(data, null, 2));
            alert('Team sample data logged to browser console (F12). Copy the JSON from there to test with /api/team endpoints.');
        }

        // Returns sample team response data (4 different perspectives on Enterprise CapEx Procurement)
        // Used for testing team-results.html — can be POSTed via /api/team?action=submit
        function getTeamSampleResponses() {
            return {
                processName: 'Enterprise CapEx Procurement (IT Infrastructure)',
                company: 'GlobalTech Solutions',
                description: 'End-to-end IT capital expenditure procurement for infrastructure investments over £50K. 12 departments, 6 decision points, 5 approval gates, external vendors, regulatory compliance.',
                responses: [
                    {
                        respondentName: 'James Whitfield',
                        respondentEmail: 'j.whitfield@globaltech.io',
                        respondentDepartment: 'Procurement',
                        responseData: {
                            processData: {
                                processName: 'Enterprise CapEx Procurement (IT Infrastructure)',
                                definition: { startsWhen: 'Business unit submits CapEx request', completesWhen: 'Asset tagged and first invoice reconciled', complexity: 'very-complex', departments: ['IT', 'Finance', 'Procurement', 'Legal', 'Compliance', 'Leadership'] },
                                lastExample: { name: 'Data Centre Server Expansion', elapsedDays: 127 },
                                performance: 'this-was-worse',
                                issues: ['delays-waiting', 'approval-bottlenecks', 'too-many-steps', 'compliance-requirements'],
                                biggestDelay: 'Board approval cycle — monthly meetings mean a missed deadline adds 4+ weeks',
                                steps: [
                                    { number: 1, name: 'Business case drafted', department: 'IT', isExternal: false },
                                    { number: 2, name: 'Technical architecture review', department: 'Engineering', isExternal: false },
                                    { number: 3, name: 'Security & compliance review', department: 'Compliance', isExternal: false, isDecision: true, branches: [{ label: 'Low risk', target: 'Step 4' }, { label: 'High risk — full audit', target: 'Step 14' }] },
                                    { number: 4, name: 'Budget validation', department: 'Finance', isExternal: false, isDecision: true, branches: [{ label: 'Under £50K — fast track', target: 'Step 8' }, { label: '£50K+ — full process', target: 'Step 5' }] },
                                    { number: 5, name: 'IT Director approval', department: 'IT', isExternal: false, isDecision: true, branches: [{ label: 'Approved', target: 'Step 6' }, { label: 'Rejected — revise', target: 'Step 1' }] },
                                    { number: 6, name: 'Create RFP package', department: 'Procurement', isExternal: false },
                                    { number: 7, name: 'Distribute RFP to vendors', department: 'External Vendor', isExternal: true },
                                    { number: 8, name: 'Evaluate vendor proposals', department: 'Procurement', isExternal: false },
                                    { number: 9, name: 'Engineering technical scoring', department: 'Engineering', isExternal: false, isDecision: true, branches: [{ label: 'Single vendor qualifies', target: 'Step 11' }, { label: 'Multiple qualify', target: 'Step 10' }, { label: 'None qualify — re-issue RFP', target: 'Step 6' }] },
                                    { number: 10, name: 'Vendor demos & reference checks', department: 'External Vendor', isExternal: true },
                                    { number: 11, name: 'Commercial negotiation', department: 'Procurement', isExternal: false },
                                    { number: 12, name: 'Legal contract review', department: 'Legal', isExternal: false },
                                    { number: 13, name: 'External legal review', department: 'External Legal', isExternal: true, isDecision: true, branches: [{ label: 'Terms accepted', target: 'Step 16' }, { label: 'Renegotiate', target: 'Step 11' }] },
                                    { number: 14, name: 'Full security audit', department: 'Risk', isExternal: false },
                                    { number: 15, name: 'DPIA assessment', department: 'Data Protection', isExternal: false },
                                    { number: 16, name: 'CFO approval', department: 'Finance', isExternal: false, isDecision: true, branches: [{ label: 'Approved (under £250K)', target: 'Step 19' }, { label: 'Needs Board', target: 'Step 17' }, { label: 'Rejected', target: 'Step 1' }] },
                                    { number: 17, name: 'Investment Committee review', department: 'Leadership', isExternal: false },
                                    { number: 18, name: 'Board approval', department: 'Leadership', isExternal: false },
                                    { number: 19, name: 'Purchase order in ERP', department: 'Procurement', isExternal: false },
                                    { number: 20, name: 'Vendor confirms order', department: 'External Vendor', isExternal: true },
                                    { number: 21, name: 'Goods received & asset-tagged', department: 'Facilities', isExternal: false },
                                    { number: 22, name: 'Installation, UAT & QA sign-off', department: 'Quality Assurance', isExternal: false }
                                ],
                                handoffs: [
                                    { method: 'email', clarity: 'mostly-clear' }, { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'yes-multiple' },
                                    { method: 'email', clarity: 'mostly-clear' }, { method: 'ticket-system', clarity: 'mostly-clear' }, { method: 'email', clarity: 'mostly-clear' },
                                    { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'yes-multiple' }, { method: 'meeting', clarity: 'mostly-clear' },
                                    { method: 'email', clarity: 'mostly-clear' }, { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'yes-multiple' },
                                    { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'mostly-clear' }, { method: 'email', clarity: 'mostly-clear' },
                                    { method: 'meeting', clarity: 'mostly-clear' }, { method: 'meeting', clarity: 'mostly-clear' }, { method: 'email', clarity: 'mostly-clear' },
                                    { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'mostly-clear' }, { method: 'they-knew', clarity: 'yes-multiple' }
                                ],
                                approvals: [
                                    { name: 'IT Director', rounds: '1', assessment: 'necessary', avgDays: '3' },
                                    { name: 'Legal', rounds: '2-3', assessment: 'necessary', avgDays: '10' },
                                    { name: 'DPO', rounds: '1', assessment: 'necessary', avgDays: '5' },
                                    { name: 'CFO', rounds: '1-2', assessment: 'necessary', avgDays: '7' },
                                    { name: 'Board', rounds: '1', assessment: 'could-reduce', avgDays: '21' }
                                ],
                                systems: [{ name: 'SAP S/4HANA' }, { name: 'Coupa' }, { name: 'DocuSign' }, { name: 'ServiceNow' }, { name: 'SharePoint' }, { name: 'Power BI' }, { name: 'Outlook/Teams' }, { name: 'OneTrust' }, { name: 'Nessus' }, { name: 'Jira' }],
                                userTime: { total: 187 },
                                bottleneck: { name: 'Board approval cycle', longestStep: 'step-17' }
                            }
                        }
                    },
                    {
                        respondentName: 'Sarah Chen',
                        respondentEmail: 's.chen@globaltech.io',
                        respondentDepartment: 'Finance',
                        responseData: {
                            processData: {
                                processName: 'Enterprise CapEx Procurement (IT Infrastructure)',
                                definition: { startsWhen: 'Budget request lands in Finance queue', completesWhen: 'First invoice matched to PO in SAP', complexity: 'very-complex', departments: ['Finance', 'IT', 'Procurement', 'Leadership'] },
                                lastExample: { name: 'Server Expansion Project', elapsedDays: 98 },
                                performance: 'typical',
                                issues: ['delays-waiting', 'information-gaps', 'approval-bottlenecks'],
                                biggestDelay: 'Incomplete business cases from IT — 60% need rework before Finance can validate budget',
                                steps: [
                                    { number: 1, name: 'Receive business case from IT', department: 'Finance', isExternal: false },
                                    { number: 2, name: 'Validate budget & GL codes', department: 'Finance', isExternal: false, isDecision: true, branches: [{ label: 'Valid', target: 'Step 3' }, { label: 'Incomplete — return to IT', target: 'Step 1' }] },
                                    { number: 3, name: 'Check CapEx threshold routing', department: 'Finance', isExternal: false, isDecision: true, branches: [{ label: 'Under £50K — manager approval', target: 'Step 4' }, { label: '£50K-£250K — CFO approval', target: 'Step 5' }, { label: 'Over £250K — Board required', target: 'Step 6' }] },
                                    { number: 4, name: 'Manager sign-off', department: 'IT', isExternal: false },
                                    { number: 5, name: 'CFO review & approval', department: 'Finance', isExternal: false },
                                    { number: 6, name: 'Board paper preparation', department: 'Finance', isExternal: false },
                                    { number: 7, name: 'Board approval', department: 'Leadership', isExternal: false },
                                    { number: 8, name: 'Release budget in SAP', department: 'Finance', isExternal: false },
                                    { number: 9, name: 'Monitor PO creation', department: 'Finance', isExternal: false },
                                    { number: 10, name: 'Three-way match: PO, GRN, Invoice', department: 'Finance', isExternal: false },
                                    { number: 11, name: 'Payment authorisation', department: 'Finance', isExternal: false },
                                    { number: 12, name: 'Asset capitalisation in fixed assets register', department: 'Finance', isExternal: false }
                                ],
                                handoffs: [
                                    { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'mostly-clear' }, { method: 'email', clarity: 'mostly-clear' },
                                    { method: 'email', clarity: 'mostly-clear' }, { method: 'meeting', clarity: 'mostly-clear' }, { method: 'email', clarity: 'mostly-clear' },
                                    { method: 'email', clarity: 'mostly-clear' }, { method: 'ticket-system', clarity: 'mostly-clear' }, { method: 'email', clarity: 'yes-multiple' },
                                    { method: 'email', clarity: 'mostly-clear' }, { method: 'email', clarity: 'mostly-clear' }
                                ],
                                approvals: [
                                    { name: 'CFO', rounds: '1-2', assessment: 'necessary', avgDays: '5' },
                                    { name: 'Board', rounds: '1', assessment: 'could-reduce', avgDays: '18' }
                                ],
                                systems: [{ name: 'SAP S/4HANA' }, { name: 'Power BI' }, { name: 'Outlook' }, { name: 'Excel' }],
                                userTime: { total: 95 },
                                bottleneck: { name: 'Incomplete business cases from IT', longestStep: 'step-1' }
                            }
                        }
                    },
                    {
                        respondentName: 'David Okonkwo',
                        respondentEmail: 'd.okonkwo@globaltech.io',
                        respondentDepartment: 'Engineering',
                        responseData: {
                            processData: {
                                processName: 'Enterprise CapEx Procurement (IT Infrastructure)',
                                definition: { startsWhen: 'We need new infrastructure', completesWhen: 'Equipment is live and performing', complexity: 'complex', departments: ['Engineering', 'IT', 'Procurement'] },
                                lastExample: { name: 'DC Expansion', elapsedDays: 142 },
                                performance: 'this-was-worse',
                                issues: ['delays-waiting', 'too-many-steps', 'approval-bottlenecks', 'wrong-tools'],
                                biggestDelay: 'Procurement takes 6+ weeks to run the RFP process. We already know which vendors we want.',
                                steps: [
                                    { number: 1, name: 'Identify infrastructure need', department: 'Engineering', isExternal: false },
                                    { number: 2, name: 'Size the solution & write specs', department: 'Engineering', isExternal: false },
                                    { number: 3, name: 'Draft business case with IT', department: 'IT', isExternal: false },
                                    { number: 4, name: 'Wait for Finance validation', department: 'Finance', isExternal: false },
                                    { number: 5, name: 'Wait for approval chain', department: 'IT', isExternal: false },
                                    { number: 6, name: 'Wait for Procurement to issue RFP', department: 'Procurement', isExternal: false },
                                    { number: 7, name: 'Score vendor proposals (technical)', department: 'Engineering', isExternal: false, isDecision: true, branches: [{ label: 'Our preferred vendor wins', target: 'Step 8' }, { label: 'Unknown vendor — more diligence needed', target: 'Step 9' }] },
                                    { number: 8, name: 'Wait for legal and compliance', department: 'Legal', isExternal: false },
                                    { number: 9, name: 'Run POC / benchmark testing', department: 'Engineering', isExternal: false },
                                    { number: 10, name: 'Wait for CFO / Board approval', department: 'Finance', isExternal: false },
                                    { number: 11, name: 'Wait for vendor to deliver', department: 'External Vendor', isExternal: true },
                                    { number: 12, name: 'Rack, stack & configure', department: 'Engineering', isExternal: false },
                                    { number: 13, name: 'Run UAT & performance tests', department: 'Engineering', isExternal: false },
                                    { number: 14, name: 'Handover to operations', department: 'Operations', isExternal: false }
                                ],
                                handoffs: [
                                    { method: 'meeting', clarity: 'mostly-clear' }, { method: 'email', clarity: 'mostly-clear' }, { method: 'email', clarity: 'yes-multiple' },
                                    { method: 'they-knew', clarity: 'yes-major' }, { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'yes-multiple' },
                                    { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'mostly-clear' },
                                    { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'mostly-clear' }, { method: 'meeting', clarity: 'mostly-clear' },
                                    { method: 'they-knew', clarity: 'yes-multiple' }
                                ],
                                approvals: [
                                    { name: 'IT Director', rounds: '1', assessment: 'necessary', avgDays: '5' },
                                    { name: 'CFO', rounds: '1', assessment: 'could-reduce', avgDays: '10' },
                                    { name: 'Board', rounds: '1', assessment: 'rubber-stamp', avgDays: '25' }
                                ],
                                systems: [{ name: 'Jira' }, { name: 'Confluence' }, { name: 'Teams' }, { name: 'ServiceNow' }],
                                userTime: { total: 210 },
                                bottleneck: { name: 'RFP and approval chain', longestStep: 'step-6' }
                            }
                        }
                    },
                    {
                        respondentName: 'Lisa Morgan',
                        respondentEmail: 'l.morgan@globaltech.io',
                        respondentDepartment: 'Legal',
                        responseData: {
                            processData: {
                                processName: 'Enterprise CapEx Procurement (IT Infrastructure)',
                                definition: { startsWhen: 'Contract review request arrives', completesWhen: 'Contract executed and filed', complexity: 'complex', departments: ['Legal', 'Procurement', 'External Legal', 'Compliance'] },
                                lastExample: { name: 'Dell EMC Storage Contract', elapsedDays: 85 },
                                performance: 'typical',
                                issues: ['delays-waiting', 'rework-errors', 'information-gaps'],
                                biggestDelay: 'Vendor T&Cs are non-negotiable or arrive late. We spend 2-3 weeks in redlining cycles.',
                                steps: [
                                    { number: 1, name: 'Receive contract review request', department: 'Legal', isExternal: false },
                                    { number: 2, name: 'Initial contract triage', department: 'Legal', isExternal: false, isDecision: true, branches: [{ label: 'Standard terms — fast track', target: 'Step 5' }, { label: 'Non-standard — full review', target: 'Step 3' }, { label: 'High value (>£500K) — partner review', target: 'Step 4' }] },
                                    { number: 3, name: 'Detailed clause review & redlining', department: 'Legal', isExternal: false },
                                    { number: 4, name: 'Senior partner review', department: 'Legal', isExternal: false },
                                    { number: 5, name: 'Send redlines to vendor', department: 'External Legal', isExternal: true },
                                    { number: 6, name: 'Vendor counter-proposals', department: 'External Legal', isExternal: true, isDecision: true, branches: [{ label: 'Accepted', target: 'Step 8' }, { label: 'Further negotiation needed', target: 'Step 3' }, { label: 'Deadlock — escalate to GC', target: 'Step 7' }] },
                                    { number: 7, name: 'General Counsel escalation call', department: 'Legal', isExternal: false },
                                    { number: 8, name: 'DPIA coordination (if data processing)', department: 'Compliance', isExternal: false },
                                    { number: 9, name: 'Final contract approval', department: 'Legal', isExternal: false },
                                    { number: 10, name: 'DocuSign execution', department: 'Legal', isExternal: false },
                                    { number: 11, name: 'Contract filed & obligations logged', department: 'Legal', isExternal: false }
                                ],
                                handoffs: [
                                    { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'mostly-clear' }, { method: 'meeting', clarity: 'mostly-clear' },
                                    { method: 'email', clarity: 'mostly-clear' }, { method: 'email', clarity: 'yes-multiple' }, { method: 'email', clarity: 'yes-multiple' },
                                    { method: 'meeting', clarity: 'mostly-clear' }, { method: 'email', clarity: 'mostly-clear' }, { method: 'email', clarity: 'mostly-clear' },
                                    { method: 'email', clarity: 'mostly-clear' }
                                ],
                                approvals: [
                                    { name: 'General Counsel', rounds: '1-2', assessment: 'necessary', avgDays: '5' },
                                    { name: 'DPO (if data)', rounds: '1', assessment: 'necessary', avgDays: '3' }
                                ],
                                systems: [{ name: 'iManage' }, { name: 'DocuSign' }, { name: 'Outlook' }, { name: 'OneTrust' }, { name: 'SharePoint' }],
                                userTime: { total: 120 },
                                bottleneck: { name: 'Vendor redlining cycles', longestStep: 'step-5' }
                            }
                        }
                    }
                ]
            };
        }

        // ============================================================
        // VIEW MODE: Load and render a saved report
        // ============================================================
        async function loadReportView(reportId) {
            // Hide all screens and show the results screen directly
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen19 = document.getElementById('screen19');
            screen19.classList.add('active');
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('resultsContainer').style.display = 'none';

            // Hide progress bar and navigation
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) progressBar.style.display = 'none';

            try {
                const resp = await fetch('/api/get-diagnostic?id=' + encodeURIComponent(reportId));
                const data = await resp.json();

                if (!resp.ok || !data.success) {
                    document.getElementById('loadingState').innerHTML = '<div style="text-align:center;padding:2rem;"><h3 style="color:var(--danger);">Report Not Found</h3><p style="color:var(--text-mid);margin:1rem 0;">' + (data.error || 'This report may have been deleted or the link is invalid.') + '</p><a href="/portal" style="color:var(--accent);font-weight:500;">← Back to Portal</a></div>';
                    return;
                }

                const report = data.report;
                const dd = report.diagnosticData || {};

                // Restore completedProcesses from rawProcesses (needed for automation score, roadmap, flowcharts)
                if (dd.rawProcesses && dd.rawProcesses.length > 0) {
                    completedProcesses = dd.rawProcesses;
                } else {
                    // Build minimal completedProcesses from summary data for flowchart rendering
                    completedProcesses = (dd.processes || []).map(function(p) {
                        return {
                            processName: p.name || 'Process',
                            processType: p.type || 'other',
                            definition: { startsWhen: '', completesWhen: '', complexity: 'complex', departments: [] },
                            lastExample: { name: '', startDate: '', endDate: '', elapsedDays: p.elapsedDays || 0 },
                            userTime: { meetings: 0, emails: 0, execution: 0, waiting: 0, total: 0 },
                            timeAccuracy: 'confident',
                            performance: 'typical',
                            issues: [],
                            biggestDelay: '',
                            delayDetails: '',
                            steps: (p.steps || []).map(function(s, si) {
                                return {
                                    number: si + 1,
                                    name: s.name || 'Step ' + (si + 1),
                                    department: s.department || 'Operations',
                                    isDecision: s.isDecision || false,
                                    isExternal: s.isExternal || false,
                                    branches: s.branches || []
                                };
                            }),
                            handoffs: [],
                            systems: [],
                            approvals: [],
                            knowledge: {},
                            newHire: {},
                            frequency: { type: 'monthly', annual: 12, inFlight: 0, progressing: 0, stuck: 0, waiting: 0 },
                            costs: { hourlyRate: 50, instanceCost: 0, annualUserCost: 0, totalAnnualCost: p.annualCost || 0, teamSize: p.teamSize || 1 },
                            savings: {},
                            priority: {},
                            bottleneck: {}
                        };
                    });
                }

                // Build the result object that displayResults expects
                var processes = dd.processes || [];
                var totalCost = (dd.summary || {}).totalAnnualCost || 0;
                var potentialSavings = (dd.summary || {}).potentialSavings || 0;

                // Enrich process entries with quality data if missing
                var resultProcesses = processes.map(function(p) {
                    return {
                        name: p.name || 'Process',
                        elapsedDays: p.elapsedDays || 0,
                        annualCost: p.annualCost || 0,
                        annualInstances: p.annualInstances || 0,
                        teamSize: p.teamSize || 1,
                        stepsCount: p.stepsCount || (p.steps || []).length || 0,
                        quality: p.quality || { grade: p.qualityGrade || 'MEDIUM', score: 0 },
                        bottleneck: p.bottleneck || {},
                        priority: p.priority || {},
                        steps: p.steps || []
                    };
                });

                var result = {
                    processes: resultProcesses,
                    totalCost: totalCost,
                    potentialSavings: potentialSavings,
                    recommendations: dd.recommendations || [],
                    analysisType: (dd.summary || {}).analysisType || 'rule-based',
                    qualityScore: dd.summary ? dd.summary.qualityScore : 0
                };

                var contact = dd.contact || {
                    name: report.contactName || '',
                    email: report.contactEmail || '',
                    company: report.company || ''
                };

                // Add a back-to-portal link above the results
                var resultsContainer = document.getElementById('resultsContainer');
                var backBar = document.createElement('div');
                backBar.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding:0.75rem 1rem;background:linear-gradient(135deg,rgba(61,142,166,0.08),rgba(61,142,166,0.03));border-radius:var(--radius-sm);border:1px solid rgba(61,142,166,0.15);';
                backBar.innerHTML = '<a href="/portal" style="color:var(--accent);text-decoration:none;font-weight:500;font-size:0.9rem;">← Back to Portal</a>' +
                    '<span style="color:var(--text-mid);font-size:0.82rem;">' + (report.company || '') + ' · ' + (report.createdAt ? new Date(report.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '') + '</span>';
                resultsContainer.insertBefore(backBar, resultsContainer.firstChild);

                // Hide the email/save buttons since this is a read-only view
                var emailSection = document.getElementById('emailReportBtn');
                if (emailSection) emailSection.closest('.button-group').style.display = 'none';

                displayResults(result, contact);

            } catch (err) {
                console.error('View mode error:', err);
                document.getElementById('loadingState').innerHTML = '<div style="text-align:center;padding:2rem;"><h3 style="color:var(--danger);">Failed to Load Report</h3><p style="color:var(--text-mid);margin:1rem 0;">Unable to reach the server. Please try again.</p><a href="/portal" style="color:var(--accent);font-weight:500;">← Back to Portal</a></div>';
            }
        }

        // ============================================================
        // INIT
        // ============================================================
        document.addEventListener('DOMContentLoaded', async function() {
            setDateLimits();

            // Show dev toolbar on localhost / local dev OR when ?dev param is present
            const params = new URLSearchParams(location.search);
            const isLocal = ['localhost', '127.0.0.1', '0.0.0.0'].includes(location.hostname) || location.port;
            const showDev = isLocal || params.has('dev');
            const devToolbar = document.getElementById('devToolbar');
            if (devToolbar && showDev) {
                devToolbar.style.display = 'block';
            }

            // Render redesigned process flow from portal
            if (params.has('render-redesign')) {
                try {
                    const rdData = JSON.parse(sessionStorage.getItem('redesignProcesses') || '[]');
                    if (rdData.length > 0) {
                        document.querySelector('.container').innerHTML = `
                            <div style="padding: 1.5rem 0;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
                                    <div>
                                        <h1 style="font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:700;color:var(--primary);margin-bottom:4px;">Redesigned Process Flow</h1>
                                        <p style="color:var(--text-mid);font-size:0.9rem;">AI-generated optimised operating model</p>
                                    </div>
                                    <a href="/portal" style="font-size:0.85rem;color:var(--accent);text-decoration:none;font-weight:500;">← Back to Portal</a>
                                </div>
                                <div id="flowDiagramsContainer"></div>
                            </div>`;
                        const processes = rdData.map(function(p) {
                            return {
                                processName: p.processName,
                                steps: (p.steps || []).filter(function(s) { return !s.removed; }).map(function(s, i) {
                                    return {
                                        number: i + 1,
                                        name: s.name,
                                        department: s.department || 'Operations',
                                        isDecision: s.isDecision || false,
                                        isExternal: s.isExternal || false,
                                        branches: (s.branches || []).map(function(b) {
                                            return { label: b.label, target: b.target || ('Step ' + b.targetStep) };
                                        })
                                    };
                                })
                            };
                        });
                        _flowViewMode = 'grid';
                        renderFlowDiagram(processes);
                    }
                } catch (e) { console.error('Render redesign error:', e); }
                return;
            }

            // Render redesigned process flowchart from sessionStorage
            if (params.has('render-redesign')) {
                renderRedesignView();
                return;
            }

            // VIEW MODE: render full report from saved diagnostic data
            const viewId = params.get('view');
            if (viewId) {
                await loadReportView(viewId);
                return;
            }

            // Also support ?sample query param to skip straight to results
            if (params.has('sample')) {
                loadSampleData();
                return;
            }

            // ?complex loads the Complexity-10 CapEx workflow directly
            if (params.has('complex')) {
                loadComplexitySample();
                return;
            }

            // ?team-sample outputs team sample data to console for easy copy
            if (params.has('team-sample')) {
                loadTeamSampleToConsole();
            }

            // Check for edit mode (?edit=reportId&email=xxx)
            const editLoaded = await checkForEditMode();
            if (editLoaded) return;

            // Check for team mode (?team=CODE)
            await checkForTeamMode();

            // Check for cloud resume link (?resume=xxx)
            const cloudResumed = await checkForCloudResume();
            if (cloudResumed) return;

            if (!loadProgress()) {
                updateProgress();
            }
        });

        setInterval(saveProgress, 30000);

        // ============================================================
        // SAVE PROGRESS TO CLOUD & RESUME VIA EMAIL LINK
        // ============================================================
        let cloudProgressId = null;

        function openSaveModal() {
            collectAllProcessData();
            const modal = document.getElementById('saveModalOverlay');
            const form = document.getElementById('saveModalForm');
            const success = document.getElementById('saveModalSuccess');
            const linkBox = document.getElementById('saveModalLinkBox');
            form.style.display = 'block';
            success.classList.remove('show');
            linkBox.classList.remove('show');
            document.getElementById('saveModalEmail').value = '';
            document.getElementById('saveModalSaveBtn').disabled = false;
            document.getElementById('saveModalSaveBtn').textContent = 'Save & Email Link';
            modal.classList.add('show');
        }

        function closeSaveModal() {
            document.getElementById('saveModalOverlay').classList.remove('show');
        }

        async function saveProgressToCloud(withEmail) {
            const btn = document.getElementById('saveModalSaveBtn');
            const skipBtn = document.getElementById('saveModalSkipBtn');
            const email = withEmail ? document.getElementById('saveModalEmail').value.trim() : '';

            if (withEmail && !email) {
                document.getElementById('saveModalEmail').style.borderColor = '#dc3545';
                document.getElementById('saveModalEmail').focus();
                return;
            }

            btn.disabled = true;
            if (skipBtn) skipBtn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                collectAllProcessData();

                const body = {
                    email: email || null,
                    progressData: {
                        currentScreen,
                        processData,
                        completedProcesses,
                        customDepartments,
                        stepCount: typeof stepCount !== 'undefined' ? stepCount : 0
                    },
                    currentScreen,
                    processName: processData.processName || ''
                };

                if (cloudProgressId) {
                    body.progressId = cloudProgressId;
                }

                const resp = await fetch('/api/progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const result = await resp.json();

                if (!resp.ok || !result.success) {
                    throw new Error(result.error || 'Save failed');
                }

                cloudProgressId = result.progressId;

                // Show success state
                const form = document.getElementById('saveModalForm');
                const success = document.getElementById('saveModalSuccess');
                const linkBox = document.getElementById('saveModalLinkBox');

                form.style.display = 'none';
                success.classList.add('show');
                linkBox.classList.add('show');

                document.getElementById('saveModalLinkInput').value = result.resumeUrl;

                if (email) {
                    document.getElementById('saveModalSuccessMsg').textContent =
                        'A resume link has been sent to ' + email;
                } else {
                    document.getElementById('saveModalSuccessMsg').textContent =
                        'Copy the link below to continue on any device.';
                }

            } catch (err) {
                console.error('Save progress error:', err);
                btn.textContent = 'Error — try again';
                btn.disabled = false;
                if (skipBtn) skipBtn.disabled = false;
                setTimeout(() => { btn.textContent = 'Save & Email Link'; }, 3000);
            }
        }

        function copySaveLink() {
            const input = document.getElementById('saveModalLinkInput');
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                const btn = input.nextElementSibling;
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = orig; }, 2000);
            });
        }

        // Show save button once user is past screen 2
        function updateSaveButtonVisibility() {
            const btn = document.getElementById('saveProgressBtn');
            if (btn) {
                btn.style.display = currentScreen >= 2 ? 'inline-flex' : 'none';
            }
        }

        // Patch goToScreen to show/hide save button
        const _origGoToScreen = goToScreen;
        goToScreen = function(screenNum) {
            _origGoToScreen(screenNum);
            updateSaveButtonVisibility();
        };

        // ── Edit mode: load a completed diagnostic for editing ─────
        let editingReportId = null;

        async function checkForEditMode() {
            const params = new URLSearchParams(location.search);
            const reportId = params.get('edit');
            const email = params.get('email');
            if (!reportId) return false;

            // Email is required -- if missing, prompt user to go through portal
            if (!email) {
                const banner = document.getElementById('resumeBanner');
                if (banner) {
                    banner.innerHTML = '<strong>Authentication required.</strong> Please <a href="/portal" style="color: inherit; text-decoration: underline;">sign in to the portal</a> to edit a completed diagnostic.';
                    banner.style.background = '#fef2f2';
                    banner.style.color = '#dc2626';
                    banner.style.borderColor = '#fecaca';
                    banner.classList.add('show');
                }
                return false;
            }

            try {
                const resp = await fetch('/api/get-diagnostic?id=' + encodeURIComponent(reportId) + '&editable=true&email=' + encodeURIComponent(email));
                const result = await resp.json();

                if (!resp.ok || !result.success) {
                    console.warn('Edit load failed:', result.error);
                    const banner = document.getElementById('resumeBanner');
                    if (banner) {
                        banner.innerHTML = '<strong>Could not load diagnostic for editing.</strong> ' + (result.error || 'Unknown error.');
                        banner.style.background = '#fef2f2';
                        banner.style.color = '#dc2626';
                        banner.style.borderColor = '#fecaca';
                        banner.classList.add('show');
                        setTimeout(() => banner.classList.remove('show'), 10000);
                    }
                    return false;
                }

                // Restore raw process data
                const reportData = result.report || result;
                completedProcesses = reportData.rawProcesses || [];
                editingReportId = reportId;

                // Restore contact info if available
                const contact = reportData.contact || {};

                // Pre-fill contact fields (screen 18)
                setTimeout(() => {
                    const nameEl = document.getElementById('contactName');
                    const emailEl = document.getElementById('contactEmail');
                    const companyEl = document.getElementById('contactCompany');
                    const titleEl = document.getElementById('contactTitle');
                    if (nameEl && contact.name) nameEl.value = contact.name;
                    if (emailEl && contact.email) emailEl.value = contact.email;
                    if (companyEl && contact.company) companyEl.value = contact.company;
                    if (titleEl && contact.title) titleEl.value = contact.title;

                    // Set industry dropdown
                    const industryEl = document.getElementById('contactIndustry');
                    if (industryEl && contact.industry) {
                        const options = Array.from(industryEl.options).map(o => o.value);
                        if (options.includes(contact.industry)) {
                            industryEl.value = contact.industry;
                        } else {
                            industryEl.value = 'Other';
                        }
                    }

                    // Set team size radio
                    if (contact.teamSize) {
                        const radio = document.querySelector('input[name="teamSize"][value="' + contact.teamSize + '"]');
                        if (radio) radio.checked = true;
                    }
                }, 100);

                // If there are completed processes, load them for editing
                if (completedProcesses.length > 0) {
                    // Set the current processData to the last completed one
                    processData = completedProcesses[completedProcesses.length - 1];

                    // Restore custom departments from stored data or infer from steps
                    const storedCustomDepts = reportData.customDepartments || [];
                    if (storedCustomDepts.length > 0) {
                        storedCustomDepts.forEach(d => {
                            if (!customDepartments.includes(d)) customDepartments.push(d);
                        });
                    } else {
                        const allDepts = [];
                        completedProcesses.forEach(p => {
                            (p.steps || []).forEach(s => {
                                if (s.department && !allDepts.includes(s.department)) {
                                    allDepts.push(s.department);
                                }
                            });
                        });
                        const defaultDepts = ['Sales', 'Operations', 'Finance', 'IT', 'Customer Success', 'Product', 'Leadership', 'HR', 'Other'];
                        allDepts.forEach(d => {
                            if (!defaultDepts.includes(d) && !customDepartments.includes(d)) {
                                customDepartments.push(d);
                            }
                        });
                    }
                    if (customDepartments.length > 0) {
                        renderCustomDeptTags();
                        syncCustomDeptsToStepDropdowns();
                    }

                    // Navigate to the contact / summary screen so user can review and re-submit
                    goToScreen(18);
                }

                // Show edit banner
                const banner = document.getElementById('resumeBanner');
                if (banner) {
                    const procNames = completedProcesses.map(p => p.processName).filter(Boolean).join(', ');
                    banner.innerHTML = '<strong>Editing mode</strong> — Loaded ' + completedProcesses.length +
                        ' process' + (completedProcesses.length !== 1 ? 'es' : '') +
                        (procNames ? ' (' + procNames.replace(/</g, '&lt;') + ')' : '') +
                        '. Make your changes and re-submit.';
                    banner.style.background = 'linear-gradient(135deg, rgba(61,142,166,0.08), rgba(61,142,166,0.03))';
                    banner.style.color = 'var(--accent)';
                    banner.style.borderColor = 'rgba(61,142,166,0.2)';
                    banner.classList.add('show');
                }

                // Clean URL
                history.replaceState(null, '', location.pathname);

                return true;

            } catch (err) {
                console.error('Edit mode error:', err);
                return false;
            }
        }

        // ── Resume from cloud link ─────────────────────────────────
        async function checkForCloudResume() {
            const params = new URLSearchParams(location.search);
            const resumeId = params.get('resume');
            if (!resumeId) return false;

            try {
                const resp = await fetch('/api/progress?id=' + encodeURIComponent(resumeId));
                const result = await resp.json();

                if (!resp.ok || !result.success) {
                    console.warn('Resume failed:', result.error);
                    return false;
                }

                const data = result.progress.progressData;
                if (!data) return false;

                // Restore state
                processData = data.processData || createEmptyProcess();
                completedProcesses = data.completedProcesses || [];
                cloudProgressId = result.progress.id;

                // Restore custom departments
                if (data.customDepartments && data.customDepartments.length > 0) {
                    customDepartments.length = 0;
                    data.customDepartments.forEach(d => customDepartments.push(d));
                    renderCustomDeptTags();
                    syncCustomDeptsToStepDropdowns();
                }

                // Restore step count
                if (typeof data.stepCount === 'number' && data.stepCount > 0) {
                    stepCount = 0;
                }

                // Restore handover context if present
                if (data.handover) {
                    _handoverData = data.handover;
                    _currentContributor = '';
                }

                // Navigate to saved screen
                const targetScreen = data.currentScreen || 0;
                goToScreen(targetScreen);

                // Show handover banner if this was a handover link
                if (data.handover) {
                    const hb = document.getElementById('handoverBanner');
                    if (hb) {
                        const fromName = data.handover.from || 'A colleague';
                        document.getElementById('handoverBannerTitle').textContent =
                            fromName + ' shared this diagnostic with you';
                        const contribList = (data.handover.contributors || []).filter(Boolean);
                        let desc = 'Review the steps below and add any that are missing. You can drag to reorder or insert new steps anywhere.';
                        if (contribList.length > 0) {
                            desc += ' Contributors so far: ' + contribList.join(', ') + '.';
                        }
                        document.getElementById('handoverBannerDesc').textContent = desc;
                        const noteEl = document.getElementById('handoverBannerNote');
                        if (data.handover.note) {
                            noteEl.textContent = '"' + data.handover.note + '"';
                            noteEl.style.display = 'block';
                        }
                        hb.classList.add('show');
                    }
                }

                // Show resume banner (only if not a handover)
                if (!data.handover) {
                    const banner = document.getElementById('resumeBanner');
                    if (banner) {
                        const processName = result.progress.processName;
                        if (processName) {
                            banner.innerHTML = '<strong>Welcome back!</strong> Your progress on "' +
                                processName.replace(/</g, '&lt;') + '" has been restored.';
                        }
                        banner.classList.add('show');
                        setTimeout(() => banner.classList.remove('show'), 8000);
                    }
                }

                // Clean URL without reloading
                const cleanUrl = location.pathname;
                history.replaceState(null, '', cleanUrl);

                return true;

            } catch (err) {
                console.error('Cloud resume error:', err);
                return false;
            }
        }

        // ============================================================
        // TEAM DIAGNOSTIC MODE
        // ============================================================
        let teamMode = null; // { code, processName }
        let teamSelectedProcess = '';

        function selectTeamProcess(chip, name) {
            document.querySelectorAll('.team-process-chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            teamSelectedProcess = name;
            document.getElementById('teamProcessName').value = '';
            document.getElementById('teamProcessName').style.borderColor = '';
            document.getElementById('teamCreateBtn').disabled = false;
        }

        function handleTeamCustomProcess() {
            const val = document.getElementById('teamProcessName').value.trim();
            if (val) {
                document.querySelectorAll('.team-process-chip').forEach(c => c.classList.remove('selected'));
                teamSelectedProcess = '';
                document.getElementById('teamCreateBtn').disabled = false;
            } else if (!teamSelectedProcess) {
                document.getElementById('teamCreateBtn').disabled = true;
            }
            document.getElementById('teamProcessName').style.borderColor = '';
        }

        function getTeamProcessName() {
            const custom = document.getElementById('teamProcessName').value.trim();
            return custom || teamSelectedProcess;
        }

        function openTeamModal() {
            document.getElementById('teamModalCreate').style.display = 'block';
            document.getElementById('teamModalSuccess').style.display = 'none';
            document.getElementById('teamLinkBox').style.display = 'none';
            teamSelectedProcess = '';
            document.querySelectorAll('.team-process-chip').forEach(c => c.classList.remove('selected'));
            document.getElementById('teamProcessName').value = '';
            document.getElementById('teamCreateBtn').disabled = true;
            document.getElementById('teamModalOverlay').classList.add('show');
        }

        function closeTeamModal() {
            document.getElementById('teamModalOverlay').classList.remove('show');
        }

        async function createTeamDiagnostic() {
            const processName = getTeamProcessName();
            if (!processName) {
                document.getElementById('teamProcessName').style.borderColor = '#dc3545';
                document.getElementById('teamProcessName').focus();
                return;
            }

            const btn = document.getElementById('teamCreateBtn');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                const resp = await fetch('/api/team?action=create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        processName,
                        company: document.getElementById('teamCompany').value.trim(),
                        createdByName: document.getElementById('teamCreatorName').value.trim(),
                        createdByEmail: document.getElementById('teamCreatorEmail').value.trim()
                    })
                });

                const result = await resp.json();
                if (!resp.ok || !result.success) throw new Error(result.error || 'Failed');

                // Show success
                document.getElementById('teamModalCreate').style.display = 'none';
                document.getElementById('teamModalSuccess').style.display = 'block';
                document.getElementById('teamLinkBox').style.display = 'block';
                document.getElementById('teamSuccessMsg').textContent =
                    `Share the code below with your team. Each person visits the link and completes the diagnostic for "${processName}".`;
                document.getElementById('teamCodeDisplay').textContent = result.teamCode;
                document.getElementById('teamJoinLink').value = result.joinUrl;
                document.getElementById('teamResultsLink').href = result.resultsUrl;

                // Also start this user in team mode
                teamMode = { code: result.teamCode, processName };

            } catch (err) {
                console.error('Create team error:', err);
                btn.textContent = 'Error — try again';
                setTimeout(() => { btn.textContent = 'Create Team Session'; btn.disabled = false; }, 3000);
            }
        }

        function joinTeamDiagnostic() {
            const code = document.getElementById('teamJoinCode').value.trim().toUpperCase();
            if (!code) return;
            // Redirect to ?team=CODE which will be picked up on load
            location.href = '/diagnostic?team=' + code;
        }

        function copyTeamLink() {
            const input = document.getElementById('teamJoinLink');
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                const btn = input.nextElementSibling;
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = orig; }, 2000);
            });
        }

        // Check for ?team=CODE on load — enter team mode
        async function checkForTeamMode() {
            const params = new URLSearchParams(location.search);
            const code = params.get('team');
            if (!code) return false;

            teamMode = { code: code.toUpperCase(), processName: '' };

            // Show banner
            const banner = document.getElementById('resumeBanner');
            if (banner) {
                banner.innerHTML = '<strong>Team Diagnostic Mode</strong> — Your response will be compared with your colleagues\' perspectives.';
                banner.classList.add('show');
            }

            // Clean URL
            history.replaceState(null, '', location.pathname);
            return false; // don't skip normal init
        }

        // Submit team response when diagnostic completes (hook into submitForAnalysis)
        async         function submitTeamResponse() {
            if (!teamMode) return;

        // ============================================================
        // HANDOVER TO COLLEAGUE
        // ============================================================
        function openHandoverModal() {
            collectAllProcessData();
            const modal = document.getElementById('handoverModalOverlay');
            const form = document.getElementById('handoverModalForm');
            const success = document.getElementById('handoverModalSuccess');
            const linkBox = document.getElementById('handoverLinkBox');
            form.style.display = 'block';
            success.style.display = 'none';
            linkBox.classList.remove('show');
            document.getElementById('handoverYourName').value = _currentContributor || '';
            document.getElementById('handoverNote').value = '';
            document.getElementById('handoverColleagueEmail').value = '';
            const btn = document.getElementById('handoverSaveBtn');
            btn.disabled = false;
            btn.textContent = 'Save & Generate Link';
            modal.classList.add('show');
        }

        function closeHandoverModal() {
            document.getElementById('handoverModalOverlay').classList.remove('show');
        }

        async function saveAndHandover() {
            const btn = document.getElementById('handoverSaveBtn');
            const yourName = document.getElementById('handoverYourName').value.trim();
            const note = document.getElementById('handoverNote').value.trim();
            const colleagueEmail = document.getElementById('handoverColleagueEmail').value.trim();

            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                collectAllProcessData();

                if (yourName) {
                    _currentContributor = yourName;
                    document.querySelectorAll('#stepsList .list-item').forEach(item => {
                        if (!item.dataset.contributor) {
                            item.dataset.contributor = yourName;
                            const uid = item.dataset.stepUid;
                            const badge = document.getElementById('step_u' + uid + '_contributor');
                            if (badge) {
                                badge.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4-4v2"/><circle cx="12" cy="7" r="4"/></svg> ' + yourName.replace(/</g, '&lt;');
                                badge.style.display = 'inline-flex';
                            }
                        }
                    });
                }

                const contributors = _handoverData ? [...(_handoverData.contributors || [])] : [];
                if (yourName && !contributors.includes(yourName)) contributors.push(yourName);

                const body = {
                    email: colleagueEmail || null,
                    progressData: {
                        currentScreen: 7,
                        processData,
                        completedProcesses,
                        customDepartments,
                        stepCount: typeof stepCount !== 'undefined' ? stepCount : 0,
                        handover: {
                            from: yourName || 'A colleague',
                            note: note,
                            contributors: contributors,
                            timestamp: new Date().toISOString()
                        }
                    },
                    currentScreen: 7,
                    processName: processData.processName || ''
                };

                if (cloudProgressId) {
                    body.progressId = cloudProgressId;
                }

                const resp = await fetch('/api/progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const result = await resp.json();
                if (!resp.ok || !result.success) throw new Error(result.error || 'Save failed');

                cloudProgressId = result.progressId;

                const form = document.getElementById('handoverModalForm');
                const success = document.getElementById('handoverModalSuccess');
                const linkBox = document.getElementById('handoverLinkBox');

                form.style.display = 'none';
                success.style.display = 'block';
                linkBox.classList.add('show');

                document.getElementById('handoverLinkInput').value = result.resumeUrl;

                if (colleagueEmail) {
                    document.getElementById('handoverSuccessMsg').textContent =
                        'A link has been sent to ' + colleagueEmail + '. They can add their steps and hand over to the next person.';
                } else {
                    document.getElementById('handoverSuccessMsg').textContent =
                        'Copy the link below and send it to your colleague.';
                }

            } catch (err) {
                console.error('Handover save error:', err);
                btn.textContent = 'Error — try again';
                btn.disabled = false;
                setTimeout(() => { btn.textContent = 'Save & Generate Link'; }, 3000);
            }
        }

        function copyHandoverLink() {
            const input = document.getElementById('handoverLinkInput');
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                const btn = input.nextElementSibling;
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = orig; }, 2000);
            });
        }

        // ============================================================
        // DRAG-AND-DROP STEP REORDERING
        // ============================================================
        (function initStepsDragDrop() {
            const list = document.getElementById('stepsList');
            if (!list) return;

            let draggedItem = null;

            list.addEventListener('dragstart', function(e) {
                if (!_dragHandleActive) { e.preventDefault(); return; }
                const item = e.target.closest('.list-item');
                if (!item) { e.preventDefault(); return; }
                draggedItem = item;
                item.classList.add('step-dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', '');
            });

            list.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (!draggedItem) return;

                const target = e.target.closest('.list-item');
                if (!target || target === draggedItem) return;

                list.querySelectorAll('.list-item').forEach(el => {
                    el.classList.remove('step-drag-over-above', 'step-drag-over-below');
                });

                const rect = target.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                if (e.clientY < midY) {
                    target.classList.add('step-drag-over-above');
                } else {
                    target.classList.add('step-drag-over-below');
                }
            });

            list.addEventListener('dragleave', function(e) {
                const target = e.target.closest('.list-item');
                if (target) {
                    target.classList.remove('step-drag-over-above', 'step-drag-over-below');
                }
            });

            list.addEventListener('drop', function(e) {
                e.preventDefault();
                if (!draggedItem) return;

                const target = e.target.closest('.list-item');
                if (!target || target === draggedItem) {
                    cleanup();
                    return;
                }

                const dragDivider = draggedItem.nextElementSibling;
                if (dragDivider && dragDivider.classList.contains('insert-step-divider')) {
                    dragDivider.remove();
                }

                const rect = target.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;

                if (e.clientY < midY) {
                    list.insertBefore(draggedItem, target);
                } else {
                    const afterTarget = target.nextElementSibling;
                    if (afterTarget && afterTarget.classList.contains('insert-step-divider')) {
                        afterTarget.after(draggedItem);
                    } else {
                        target.after(draggedItem);
                    }
                }

                const newDivider = document.createElement('div');
                newDivider.className = 'insert-step-divider';
                newDivider.innerHTML = '<button type="button" onclick="insertStepAfter(this)" title="Insert a step here">+</button>';
                draggedItem.after(newDivider);

                cleanup();
                renumberSteps();
            });

            list.addEventListener('dragend', function() {
                cleanup();
            });

            function cleanup() {
                if (draggedItem) {
                    draggedItem.classList.remove('step-dragging');
                    draggedItem.removeAttribute('draggable');
                    draggedItem = null;
                }
                list.querySelectorAll('.list-item').forEach(el => {
                    el.classList.remove('step-drag-over-above', 'step-drag-over-below');
                });
            }
        })();

            try {
                collectAllProcessData();
                const contactName = document.getElementById('contactName')?.value?.trim() || 'Anonymous';
                const contactEmail = document.getElementById('contactEmail')?.value?.trim() || '';
                const contactDept = processData.definition?.departments?.[0] || '';

                await fetch('/api/team?action=submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        teamCode: teamMode.code,
                        respondentName: contactName,
                        respondentEmail: contactEmail,
                        respondentDepartment: contactDept,
                        responseData: {
                            processData,
                            completedProcesses,
                            customDepartments
                        }
                    })
                });
            } catch (err) {
                console.warn('Team response submission error:', err);
            }
        }
    </script>

    <!-- Save Progress Modal -->
    <div class="save-modal-overlay" id="saveModalOverlay" onclick="if(event.target===this)closeSaveModal()">
        <div class="save-modal">
            <button class="save-modal-close" onclick="closeSaveModal()">&times;</button>

            <div id="saveModalForm">
                <h3>Save Your Progress</h3>
                <p>Enter your email to receive a link, or save without email to get a shareable link you can bookmark.</p>

                <input type="email" class="save-modal-input" id="saveModalEmail"
                       placeholder="your@email.com (optional)"
                       onkeydown="if(event.key==='Enter'){event.preventDefault();saveProgressToCloud(true);}"
                       onfocus="this.style.borderColor='var(--accent)'">

                <div class="save-modal-actions">
                    <button class="button button-primary" id="saveModalSaveBtn"
                            onclick="saveProgressToCloud(true)">Save &amp; Email Link</button>
                    <button class="button button-secondary" id="saveModalSkipBtn"
                            onclick="saveProgressToCloud(false)">Just get link</button>
                </div>
            </div>

            <div class="save-modal-success" id="saveModalSuccess">
                <div class="checkmark">&#10003;</div>
                <h4>Progress Saved!</h4>
                <p id="saveModalSuccessMsg"></p>
            </div>

            <div class="save-modal-link-box" id="saveModalLinkBox">
                <label>Your resume link</label>
                <div class="save-modal-link-row">
                    <input type="text" id="saveModalLinkInput" readonly onclick="this.select()">
                    <button onclick="copySaveLink()">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Handover Modal -->
    <div class="save-modal-overlay" id="handoverModalOverlay" onclick="if(event.target===this)closeHandoverModal()">
        <div class="save-modal">
            <button class="save-modal-close" onclick="closeHandoverModal()">&times;</button>

            <div id="handoverModalForm" class="handover-modal-form">
                <h3>Hand Over to a Colleague</h3>
                <p>Save your progress and share a link so a colleague can add the steps they know about.</p>

                <div class="handover-name-row">
                    <input type="text" class="save-modal-input" id="handoverYourName" placeholder="Your name (so they know who shared)" style="margin-bottom:0;">
                </div>

                <textarea id="handoverNote" placeholder="Optional note for your colleague, e.g. 'I've added the intake steps — please add the approval and fulfilment steps.'"></textarea>

                <input type="email" class="save-modal-input" id="handoverColleagueEmail" placeholder="Colleague's email (optional)" style="margin-bottom:0.75rem;">

                <div class="save-modal-actions">
                    <button class="button button-primary" id="handoverSaveBtn" onclick="saveAndHandover()">Save &amp; Generate Link</button>
                </div>
            </div>

            <div class="save-modal-success" id="handoverModalSuccess">
                <div class="checkmark">&#10003;</div>
                <h4>Ready to Share!</h4>
                <p id="handoverSuccessMsg">Copy the link below and send it to your colleague.</p>
            </div>

            <div class="save-modal-link-box" id="handoverLinkBox">
                <label>Share this link with your colleague</label>
                <div class="save-modal-link-row">
                    <input type="text" id="handoverLinkInput" readonly onclick="this.select()">
                    <button onclick="copyHandoverLink()">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Diagnostic Modal -->
    <div class="save-modal-overlay" id="teamModalOverlay" onclick="if(event.target===this)closeTeamModal()">
        <div class="save-modal">
            <button class="save-modal-close" onclick="closeTeamModal()">&times;</button>

            <div id="teamModalCreate">
                <h3>Team Diagnostic</h3>
                <p>Create a team session and share the code with colleagues. Each person fills out the diagnostic independently, then you compare perspectives.</p>

                <label style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; display: block;">Select a process:</label>
                <div class="team-process-grid" id="teamProcessGrid">
                    <div class="team-process-chip" onclick="selectTeamProcess(this, 'Customer Onboarding')">&#128230; Customer Onboarding</div>
                    <div class="team-process-chip" onclick="selectTeamProcess(this, 'Sales to Delivery')">&#128176; Sales to Delivery</div>
                    <div class="team-process-chip" onclick="selectTeamProcess(this, 'Employee Onboarding')">&#128100; Employee Onboarding</div>
                    <div class="team-process-chip" onclick="selectTeamProcess(this, 'Order Fulfillment')">&#9989; Order Fulfillment</div>
                    <div class="team-process-chip" onclick="selectTeamProcess(this, 'Invoice to Payment')">&#128179; Invoice to Payment</div>
                    <div class="team-process-chip" onclick="selectTeamProcess(this, 'Issue Resolution')">&#128295; Issue Resolution</div>
                    <div class="team-process-chip" onclick="selectTeamProcess(this, 'Approval Workflow')">&#128203; Approval Workflow</div>
                    <div class="team-process-chip" onclick="selectTeamProcess(this, 'Product Launch')">&#128640; Product Launch</div>
                    <div class="team-process-chip" onclick="selectTeamProcess(this, 'Reporting Cycle')">&#128202; Reporting Cycle</div>
                </div>
                <div style="margin-top: 0.75rem;">
                    <input type="text" class="save-modal-input" id="teamProcessName" placeholder="Or type a custom process name..." oninput="handleTeamCustomProcess()">
                </div>

                <input type="text" class="save-modal-input" id="teamCompany" placeholder="Company name (optional)">
                <input type="text" class="save-modal-input" id="teamCreatorName" placeholder="Your name">
                <input type="email" class="save-modal-input" id="teamCreatorEmail" placeholder="Your email (optional)">

                <div class="save-modal-actions">
                    <button class="button button-primary" id="teamCreateBtn" onclick="createTeamDiagnostic()" disabled>Create Team Session</button>
                </div>

                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); text-align: center;">
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.5rem;">Already have a team code?</p>
                    <div style="display: flex; gap: 8px; max-width: 280px; margin: 0 auto;">
                        <input type="text" class="save-modal-input" id="teamJoinCode" placeholder="ABC123" maxlength="6" style="text-transform: uppercase; text-align: center; letter-spacing: 0.1em; margin-bottom: 0;">
                        <button class="button button-secondary" onclick="joinTeamDiagnostic()" style="white-space: nowrap;">Join</button>
                    </div>
                </div>
            </div>

            <div class="save-modal-success" id="teamModalSuccess" style="display: none;">
                <div class="checkmark">&#128101;</div>
                <h4>Team Session Created!</h4>
                <p id="teamSuccessMsg"></p>
            </div>

            <div class="save-modal-link-box" id="teamLinkBox" style="display: none;">
                <label>Share this code with your team</label>
                <div style="text-align: center; font-size: 2rem; letter-spacing: 0.2em; font-weight: 700; color: var(--accent); margin: 8px 0;" id="teamCodeDisplay"></div>
                <label style="margin-top: 12px;">Or share this link</label>
                <div class="save-modal-link-row">
                    <input type="text" id="teamJoinLink" readonly onclick="this.select()">
                    <button onclick="copyTeamLink()">Copy</button>
                </div>
                <div style="margin-top: 12px; text-align: center;">
                    <a id="teamResultsLink" href="#" style="font-size: 0.85rem; color: var(--accent);">View team results page &rarr;</a>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

</html>
