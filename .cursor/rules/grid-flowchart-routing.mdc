---
description: Routing and layout rules for the grid view SVG flowcharts generated in diagnostic.html buildGridSVG()
globs: workflow-consultancy/diagnostic.html
alwaysApply: false
---

# Grid Flowchart Routing Rules

These rules MUST be followed when generating or modifying the `buildGridSVG()` function.

## Parallel Line Spacing

- `LINE_GAP = 32` — every pair of parallel routing lines must have exactly 32px between them.
- A **global channel allocator** assigns a unique channel index per inter-row gap across ALL decisions (not per-decision).
- All routing offsets use `channel * LINE_GAP`.
- `rowH` is set dynamically: `max(baseRowH, NODE_H + maxLinesInAnyGap * LINE_GAP + 2 * LINE_GAP)` to guarantee 32px clearance from node edges.

## Node Clearance

- Routing lines must maintain at least 32px (one `LINE_GAP`) clearance from any node edge.
- The inter-row gap padding is `2 * LINE_GAP` (one LINE_GAP on each side of the line zone).

## Margin Routing (No Lines Through Nodes)

- **Loop-backs** route their vertical segment through the LEFT margin (`PAD_L - 30 - ch * LINE_GAP`), outside all node columns.
- **Same-row forward**, **multi-row forward**, and **rare** routes use the RIGHT margin (`RIGHT_MARGIN_BASE + ch * LINE_GAP`), outside all node columns.
- **Next-row forward** (target is exactly one row below) uses a simple L-route through the inter-row gap — no margin routing needed.
- Vertical segments must NEVER pass through intermediate row node areas.

## Entry Direction

- All branch lines must enter target nodes from ABOVE — use the gap above the target row (`rowGapMidY(tp.row) - chOff`), never the gap below (`rowGapMidY(tp.row + 1)`).

## Dynamic Margins

- `PAD_L` is computed dynamically: `max(80, maxLinesInAnyGap * LINE_GAP + 40)` to guarantee left-margin channel space.
- SVG width includes right-margin space: `PAD_L + COLS * colW + maxLinesInAnyGap * LINE_GAP + 60`.

## Labels

- Labels are collected during routing and rendered AFTER all paths and nodes (deferred rendering), so they always appear in front.
- Each label is positioned at the midpoint between source and target X, clamped to stay on the actual horizontal segment of its path (`labelSegX1`/`labelSegX2`/`labelSegY`).
- Collision avoidance: try horizontal nudge first (up to 6 steps), then vertical nudge (up to 3 steps). No two labels may overlap.
