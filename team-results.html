<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Diagnostic Results | Workflow Partners</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1a2f4a; --primary-light: #2a4a6b;
            --accent: #3d8ea6; --accent-light: #5bb8d4;
            --text: #1e293b; --text-mid: #475569; --text-light: #64748b;
            --bg: #fafbfc; --bg-alt: #f1f5f9; --white: #ffffff; --border: #e2e8f0;
            --green: #16a34a; --green-bg: #f0fdf4;
            --red: #dc2626; --red-bg: #fef2f2;
            --blue: #1e40af; --blue-bg: #f0f9ff;
            --purple: #7c3aed; --purple-bg: #faf5ff;
            --amber: #d97706; --amber-bg: #fffbeb;
            --shadow-md: 0 4px 20px rgba(0,0,0,0.06);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.08);
            --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
        }
        body { font-family: 'Work Sans', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 40px 0; text-align: center; }
        .header h1 { font-family: 'Cormorant Garamond', serif; font-size: 2rem; font-weight: 600; margin-bottom: 6px; }
        .header p { opacity: 0.75; font-size: 0.95rem; }
        .container { max-width: 900px; margin: -30px auto 60px; padding: 0 20px; flex: 1; }
        .card { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); overflow: hidden; }
        .card-body { padding: 40px; }

        .state { text-align: center; padding: 60px 20px; }
        .state h2 { font-size: 1.3rem; margin-bottom: 8px; }
        .state p { color: var(--text-mid); font-size: 0.95rem; }
        .loading-spinner { width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Lookup */
        .lookup-form { display: flex; gap: 12px; max-width: 420px; margin: 0 auto; }
        .lookup-form input { flex: 1; padding: 12px 16px; font-size: 1rem; border: 2px solid var(--border); border-radius: var(--radius-sm); font-family: inherit; text-transform: uppercase; letter-spacing: 0.1em; text-align: center; }
        .lookup-form input:focus { border-color: var(--accent); outline: none; }
        .lookup-form button { padding: 12px 28px; background: linear-gradient(135deg, var(--accent), var(--primary)); color: white; border: none; border-radius: var(--radius-sm); font-family: inherit; font-weight: 500; cursor: pointer; }

        .section-title { font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border); }

        /* Consensus score */
        .consensus-bar { margin-bottom: 32px; }
        .consensus-track { height: 10px; background: var(--bg-alt); border-radius: 5px; overflow: hidden; margin-bottom: 6px; }
        .consensus-fill { height: 100%; border-radius: 5px; transition: width 0.6s ease; }
        .consensus-label { display: flex; justify-content: space-between; font-size: 0.82rem; color: var(--text-light); }

        /* Metrics grid */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .metric-card { background: var(--bg-alt); border-radius: var(--radius-md); padding: 20px; text-align: center; }
        .metric-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 2px; }
        .metric-value.blue { color: var(--blue); }
        .metric-value.green { color: var(--green); }
        .metric-value.purple { color: var(--purple); }
        .metric-value.amber { color: var(--amber); }
        .metric-label { font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-range { font-size: 0.72rem; color: var(--text-light); margin-top: 4px; }

        /* Perception gaps */
        .gap-card { background: var(--white); border: 2px solid var(--border); border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px; }
        .gap-card.high { border-color: var(--red); background: var(--red-bg); }
        .gap-card.medium { border-color: var(--amber); background: var(--amber-bg); }
        .gap-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .gap-metric { font-weight: 600; font-size: 1rem; }
        .gap-severity { font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; padding: 3px 10px; border-radius: 100px; }
        .gap-severity.high { background: var(--red); color: white; }
        .gap-severity.medium { background: var(--amber); color: white; }
        .gap-detail { font-size: 0.9rem; color: var(--text-mid); margin-bottom: 10px; }
        .gap-people { list-style: none; font-size: 0.85rem; }
        .gap-people li { padding: 4px 0; color: var(--text-mid); border-top: 1px solid rgba(0,0,0,0.06); }
        .gap-people li:first-child { border-top: none; }

        /* Respondents */
        .respondent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 32px; }
        .respondent-chip { display: flex; align-items: center; gap: 10px; background: var(--bg-alt); padding: 12px 16px; border-radius: var(--radius-sm); }
        .respondent-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; flex-shrink: 0; }
        .respondent-info { font-size: 0.85rem; }
        .respondent-info strong { display: block; color: var(--text); }
        .respondent-info span { color: var(--text-light); font-size: 0.78rem; }

        /* Issues heatmap */
        .issue-bar-chart { margin-bottom: 32px; }
        .issue-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .issue-label { width: 180px; font-size: 0.85rem; color: var(--text-mid); text-align: right; flex-shrink: 0; }
        .issue-track { flex: 1; height: 24px; background: var(--bg-alt); border-radius: 4px; overflow: hidden; position: relative; }
        .issue-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--primary)); border-radius: 4px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; }
        .issue-fill span { font-size: 0.72rem; font-weight: 600; color: white; }

        /* Comparison table */
        .comp-table { width: 100%; border-collapse: collapse; margin-bottom: 32px; font-size: 0.88rem; }
        .comp-table th { text-align: left; padding: 10px 12px; background: var(--bg-alt); color: var(--text-light); font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .comp-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
        .comp-table tr:last-child td { border-bottom: none; }

        /* AI Analysis section */
        .ai-analysis { margin-bottom: 32px; }
        .ai-badge { display: inline-block; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; padding: 3px 10px; border-radius: 100px; margin-left: 8px; vertical-align: middle; }
        .ai-badge.ai { background: linear-gradient(135deg, var(--purple), var(--blue)); color: white; }
        .ai-badge.rule { background: var(--bg-alt); color: var(--text-light); }
        .ai-summary { font-size: 0.95rem; line-height: 1.7; color: var(--text); background: linear-gradient(135deg, #faf5ff, #f0f9ff); padding: 20px 24px; border-radius: var(--radius-md); border-left: 4px solid var(--purple); margin-bottom: 24px; }
        .root-cause { background: var(--white); border: 1.5px solid var(--border); border-radius: var(--radius-md); padding: 18px 20px; margin-bottom: 12px; }
        .root-cause.critical { border-left: 4px solid var(--red); }
        .root-cause.high { border-left: 4px solid var(--amber); }
        .root-cause.medium { border-left: 4px solid var(--blue); }
        .root-cause-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .root-cause-title { font-weight: 600; font-size: 0.95rem; }
        .root-cause-sev { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; padding: 2px 8px; border-radius: 100px; }
        .root-cause-sev.critical { background: var(--red); color: white; }
        .root-cause-sev.high { background: var(--amber); color: white; }
        .root-cause-sev.medium { background: var(--blue); color: white; }
        .root-cause p { font-size: 0.88rem; color: var(--text-mid); margin-bottom: 4px; line-height: 1.6; }
        .root-cause .evidence { font-size: 0.8rem; color: var(--text-light); font-style: italic; }
        .insight-card { background: linear-gradient(135deg, #fffbeb, #fef3c7); border-radius: var(--radius-sm); padding: 14px 18px; margin-bottom: 10px; }
        .insight-card strong { display: block; font-size: 0.88rem; color: var(--amber); margin-bottom: 4px; }
        .insight-card p { font-size: 0.85rem; color: var(--text-mid); margin: 0; line-height: 1.5; }
        .rec-list { list-style: none; counter-reset: rec; }
        .rec-item { display: flex; gap: 14px; padding: 14px 0; border-bottom: 1px solid var(--border); }
        .rec-item:last-child { border-bottom: none; }
        .rec-num { width: 28px; height: 28px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.82rem; flex-shrink: 0; }
        .rec-body { flex: 1; }
        .rec-body strong { display: block; font-size: 0.9rem; margin-bottom: 3px; }
        .rec-body p { font-size: 0.82rem; color: var(--text-mid); margin: 0; }
        .rec-tags { display: flex; gap: 6px; margin-top: 6px; }
        .rec-tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 100px; background: var(--bg-alt); color: var(--text-light); }
        .rec-tag.quick-win { background: #d1fae5; color: #065f46; }
        .rec-tag.thirty { background: #dbeafe; color: #1e40af; }
        .rec-tag.ninety { background: #fae8ff; color: #7c3aed; }
        .alignment-list { list-style: none; }
        .alignment-list li { padding: 8px 0 8px 24px; position: relative; font-size: 0.88rem; color: var(--text-mid); border-bottom: 1px solid var(--border); }
        .alignment-list li:last-child { border-bottom: none; }
        .alignment-list li::before { content: '→'; position: absolute; left: 0; color: var(--accent); font-weight: 700; }
        .ai-loading { text-align: center; padding: 24px; }
        .ai-loading .dot-pulse { display: inline-flex; gap: 4px; }
        .ai-loading .dot-pulse span { width: 8px; height: 8px; background: var(--purple); border-radius: 50%; animation: dot-pulse 1.2s ease-in-out infinite; }
        .ai-loading .dot-pulse span:nth-child(2) { animation-delay: 0.2s; }
        .ai-loading .dot-pulse span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes dot-pulse { 0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); } 40% { opacity: 1; transform: scale(1.2); } }

        /* Collapsible sections */
        .collapsible { margin-bottom: 24px; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; padding-bottom: 8px; border-bottom: 2px solid var(--border); margin-bottom: 16px; }
        .collapsible-header:hover .collapse-btn { background: linear-gradient(135deg, #5bb8d4, #3d8ea6); transform: scale(1.1); }
        .collapsible-header h3 { font-size: 1.1rem; font-weight: 600; color: var(--primary); margin: 0; padding: 0; border: none; }
        .collapse-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: linear-gradient(135deg, #3d8ea6, #1a2f4a); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: 700; line-height: 1; flex-shrink: 0; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(61,142,166,0.3); cursor: pointer; }
        .collapsible-body { overflow: hidden; transition: max-height 0.35s ease, opacity 0.25s ease; max-height: 5000px; opacity: 1; }
        .collapsible.collapsed .collapsible-body { max-height: 0; opacity: 0; margin: 0; padding: 0; }
        .collapsible.collapsed .collapsible-header { margin-bottom: 0; border-bottom-color: transparent; }

        .cta-section { background: linear-gradient(135deg, #eff6ff, #f0fdf4); border-radius: var(--radius-md); padding: 32px; text-align: center; margin-top: 8px; }
        .cta-section h3 { font-size: 1.1rem; margin-bottom: 8px; }
        .cta-section p { font-size: 0.9rem; color: var(--text-mid); margin-bottom: 20px; }
        .cta-button { display: inline-block; padding: 12px 32px; background: linear-gradient(135deg, var(--accent), var(--primary)); color: white; text-decoration: none; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.95rem; }
        .cta-button.secondary { background: transparent; color: var(--accent); border: 1.5px solid var(--accent); margin-left: 12px; }

        .footer { text-align: center; padding: 24px; font-size: 0.82rem; color: var(--text-light); }
        .footer a { color: var(--accent); text-decoration: none; }

        @media (max-width: 600px) {
            .card-body { padding: 20px; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .lookup-form { flex-direction: column; }
            .issue-label { width: auto; max-width: 100px; font-size: 0.78rem; }
            .respondent-grid { grid-template-columns: 1fr; }
            .collapse-btn { width: 44px; height: 44px; }
            h1 { font-size: 1.8rem; }
        }

        @media (max-width: 400px) {
            .metrics-grid { grid-template-columns: 1fr; }
            .card-body { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Team Diagnostic Comparison</h1>
        <p>See how your team's perspectives align — and where they diverge</p>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-body">

                <!-- Lookup -->
                <div id="lookupState" class="state">
                    <h2>Enter Your Team Code</h2>
                    <p style="margin-bottom: 24px;">Your team lead shared a 6-character code when they created this diagnostic.</p>
                    <form class="lookup-form" onsubmit="event.preventDefault(); loadResults();">
                        <input type="text" id="codeInput" placeholder="ABC123" maxlength="6" required autofocus>
                        <button type="submit">View Results</button>
                    </form>
                    <div id="devToolbar" style="display: none; margin-top: 24px; padding-top: 20px; border-top: 2px dashed var(--border);">
                        <p style="font-size: 0.8rem; color: var(--text-mid); margin-bottom: 10px;">Developer Tools</p>
                        <button onclick="loadSampleTeamData()" id="sampleBtn" style="padding: 10px 24px; background: var(--purple); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-family: inherit; font-weight: 500; font-size: 0.9rem;">
                            Load Sample Team Data (Complexity 10)
                        </button>
                        <p style="font-size: 0.78rem; color: var(--text-light); margin-top: 8px;">Creates a team session with 4 respondents and runs AI analysis</p>
                        <button onclick="copyTeamSampleJSON()" style="padding: 8px 20px; background: #475569; color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-family: inherit; font-weight: 500; font-size: 0.85rem; margin-top: 8px;">
                            Copy Team Sample JSON
                        </button>
                    </div>
                </div>

                <!-- Loading -->
                <div id="loadingState" class="state" style="display: none;">
                    <div class="loading-spinner"></div>
                    <h2>Aggregating team perspectives...</h2>
                </div>

                <!-- Error -->
                <div id="errorState" class="state" style="display: none;">
                    <h2 id="errorTitle">Not Found</h2>
                    <p id="errorMsg">Check the code and try again.</p>
                    <button onclick="showState('lookup')" style="margin-top: 20px; padding: 10px 24px; background: var(--accent); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-family: inherit;">Try Again</button>
                </div>

                <!-- Waiting for responses -->
                <div id="waitingState" class="state" style="display: none;">
                    <h2 id="waitingTitle">Waiting for Responses</h2>
                    <p id="waitingMsg">Share the team code with your colleagues. Results will appear once at least 2 people have responded.</p>
                    <p style="margin-top: 16px;"><strong>Team Code:</strong> <span id="waitingCode" style="font-size: 1.3rem; letter-spacing: 0.15em; color: var(--accent);"></span></p>
                </div>

                <!-- Results -->
                <div id="resultsContent" style="display: none;"></div>

            </div>
        </div>
    </div>

    <div class="footer"><a href="/">Workflow Partners</a> &middot; Technology-agnostic workflow optimisation</div>

    <script>
        const issueLabels = {
            'approval-delay': 'Approval delays',
            'slow-response': 'Slow stakeholder response',
            'missing-info': 'Missing information',
            'wrong-person': 'Wrong person assigned',
            'system-issues': 'System issues',
            'unavailable': 'Someone unavailable',
            'escalation': 'Unexpected escalation',
            'external': 'External dependency',
            'rework': 'Rework needed',
            'unclear-process': 'Process unclear',
            'other': 'Other'
        };

        let lastResultsData = null;

        function showState(name) {
            ['lookupState', 'loadingState', 'errorState', 'waitingState', 'resultsContent'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            const target = name === 'results' ? 'resultsContent' : name + 'State';
            document.getElementById(target).style.display = '';
        }

        function formatDate(d) { return new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }); }

        function toggleSection(header) {
            const section = header.parentElement;
            const btn = header.querySelector('.collapse-btn');
            section.classList.toggle('collapsed');
            btn.textContent = section.classList.contains('collapsed') ? '+' : '−';
        }


        // ═══════════════════════════════════════════════════════════
        // SAMPLE TEAM DATA — 4 respondents, complexity 10
        // ═══════════════════════════════════════════════════════════
        function getTeamSampleResponses() {
            const base = {
                processName: 'Enterprise CapEx Procurement',
                company: 'Meridian Manufacturing Ltd',
                email: 'demo@workflow.partners'
            };

            const respondents = [
                {
                    name: 'James Okafor',
                    department: 'Procurement',
                    metrics: {
                        elapsedDays: 45, stepsCount: 22, handoffCount: 18, poorHandoffs: 7,
                        totalUserHours: 32, performance: 'Below expectations',
                        biggestDelay: 'Vendor qualification & due diligence', bottleneck: 'Legal review queue'
                    },
                    issues: ['approval-delay','missing-info','slow-response','external','rework','escalation'],
                    steps: [
                        { name: 'Business unit submits CapEx request', dept: 'Engineering', mins: 45 },
                        { name: 'Procurement reviews requirement spec', dept: 'Procurement', mins: 120 },
                        { name: 'Budget validation', dept: 'Finance', mins: 60, isDecision: true, branches: [{ label: 'Under £50k', target: 'Step 5' }, { label: '£50k-250k', target: 'Step 4' }, { label: 'Over £250k', target: 'Step 6' }] },
                        { name: 'Department head approval', dept: 'Engineering', mins: 30 },
                        { name: 'RFQ preparation & distribution', dept: 'Procurement', mins: 180 },
                        { name: 'Board-level approval (high value)', dept: 'Executive Board', mins: 15 },
                        { name: 'Vendor response collection', dept: 'Procurement', mins: 0 },
                        { name: 'Technical evaluation', dept: 'Engineering', mins: 240 },
                        { name: 'Commercial evaluation', dept: 'Procurement', mins: 180 },
                        { name: 'Vendor shortlist decision', dept: 'Procurement', mins: 60, isDecision: true, branches: [{ label: 'Single vendor', target: 'Step 12' }, { label: 'Multiple finalists', target: 'Step 11' }] },
                        { name: 'Vendor presentations & demos', dept: 'Engineering', mins: 480 },
                        { name: 'Due diligence & references', dept: 'Procurement', mins: 120 },
                        { name: 'Contract negotiation', dept: 'Legal', mins: 360 },
                        { name: 'Legal review', dept: 'Legal', mins: 240, isDecision: true, branches: [{ label: 'Approved', target: 'Step 15' }, { label: 'Revisions needed', target: 'Step 13' }] },
                        { name: 'Final budget sign-off', dept: 'Finance', mins: 60, isDecision: true, branches: [{ label: 'Within budget', target: 'Step 16' }, { label: 'Over budget', target: 'Step 6' }] },
                        { name: 'PO generation', dept: 'Procurement', mins: 30 },
                        { name: 'Vendor onboarding', dept: 'Procurement', mins: 120 },
                        { name: 'Goods receipt & inspection', dept: 'Engineering', mins: 180 },
                        { name: 'Quality check', dept: 'Quality', mins: 120, isDecision: true, branches: [{ label: 'Pass', target: 'Step 20' }, { label: 'Fail - return', target: 'Step 18' }, { label: 'Fail - renegotiate', target: 'Step 13' }] },
                        { name: 'Three-way match', dept: 'Finance', mins: 90 },
                        { name: 'Payment processing', dept: 'Finance', mins: 30 },
                        { name: 'Asset registration & close', dept: 'Finance', mins: 60 }
                    ]
                },
                {
                    name: 'Sarah Chen',
                    department: 'Finance',
                    metrics: {
                        elapsedDays: 62, stepsCount: 16, handoffCount: 12, poorHandoffs: 5,
                        totalUserHours: 18, performance: 'Needs improvement',
                        biggestDelay: 'Budget reallocation across cost centres', bottleneck: 'Board approval scheduling'
                    },
                    issues: ['approval-delay','missing-info','system-issues','rework','unclear-process'],
                    steps: [
                        { name: 'CapEx request submitted in ERP', dept: 'Engineering', mins: 30 },
                        { name: 'Cost centre validation', dept: 'Finance', mins: 90 },
                        { name: 'Budget availability check', dept: 'Finance', mins: 60, isDecision: true, branches: [{ label: 'Budget available', target: 'Step 4' }, { label: 'No budget', target: 'Step 14' }] },
                        { name: 'Approval routing', dept: 'Finance', mins: 30, isDecision: true, branches: [{ label: 'Under £50k - auto', target: 'Step 6' }, { label: '£50k+ - manual', target: 'Step 5' }] },
                        { name: 'CFO / Board approval', dept: 'Finance', mins: 15 },
                        { name: 'Procurement sourcing', dept: 'Procurement', mins: 0 },
                        { name: 'Vendor quotes received', dept: 'Procurement', mins: 0 },
                        { name: 'Finance evaluates quotes', dept: 'Finance', mins: 120 },
                        { name: 'Negotiation support', dept: 'Finance', mins: 60 },
                        { name: 'Contract review (finance terms)', dept: 'Finance', mins: 90 },
                        { name: 'PO approved in ERP', dept: 'Finance', mins: 15 },
                        { name: 'Invoice receipt & matching', dept: 'Finance', mins: 120, isDecision: true, branches: [{ label: 'Match OK', target: 'Step 13' }, { label: 'Mismatch', target: 'Step 9' }] },
                        { name: 'Payment batch processing', dept: 'Finance', mins: 30 },
                        { name: 'Budget reallocation request', dept: 'Finance', mins: 180 },
                        { name: 'Asset capitalisation', dept: 'Finance', mins: 60 },
                        { name: 'Month-end reconciliation', dept: 'Finance', mins: 45 }
                    ]
                },
                {
                    name: 'David Mensah',
                    department: 'Engineering',
                    metrics: {
                        elapsedDays: 78, stepsCount: 14, handoffCount: 10, poorHandoffs: 8,
                        totalUserHours: 48, performance: 'Significantly below expectations',
                        biggestDelay: 'Waiting for procurement to process RFQ', bottleneck: 'Procurement bottleneck'
                    },
                    issues: ['approval-delay','slow-response','missing-info','wrong-person','unavailable','rework','unclear-process','escalation'],
                    steps: [
                        { name: 'Write technical requirement', dept: 'Engineering', mins: 240 },
                        { name: 'Submit CapEx form', dept: 'Engineering', mins: 60 },
                        { name: 'Wait for finance approval', dept: 'Finance', mins: 0 },
                        { name: 'Get asked for more info', dept: 'Engineering', mins: 120 },
                        { name: 'Resubmit with corrections', dept: 'Engineering', mins: 90 },
                        { name: 'Wait for procurement', dept: 'Procurement', mins: 0 },
                        { name: 'Review vendor quotes', dept: 'Engineering', mins: 360 },
                        { name: 'Attend vendor demos', dept: 'Engineering', mins: 480 },
                        { name: 'Write technical evaluation report', dept: 'Engineering', mins: 300 },
                        { name: 'Wait for legal/contract', dept: 'Legal', mins: 0 },
                        { name: 'Answer legal queries', dept: 'Engineering', mins: 60 },
                        { name: 'Receive equipment', dept: 'Engineering', mins: 120 },
                        { name: 'Test & commission', dept: 'Engineering', mins: 480, isDecision: true, branches: [{ label: 'Works', target: 'Step 14' }, { label: 'Defective', target: 'Step 12' }] },
                        { name: 'Sign off & handover', dept: 'Engineering', mins: 60 }
                    ]
                },
                {
                    name: 'Amara Williams',
                    department: 'Legal',
                    metrics: {
                        elapsedDays: 55, stepsCount: 10, handoffCount: 8, poorHandoffs: 4,
                        totalUserHours: 24, performance: 'Meets expectations',
                        biggestDelay: 'Vendor T&C negotiation back-and-forth', bottleneck: 'Missing technical specs from Engineering'
                    },
                    issues: ['missing-info','slow-response','external','rework'],
                    steps: [
                        { name: 'Receive contract review request', dept: 'Procurement', mins: 15 },
                        { name: 'Risk assessment', dept: 'Legal', mins: 120, isDecision: true, branches: [{ label: 'Low risk', target: 'Step 4' }, { label: 'High risk', target: 'Step 3' }] },
                        { name: 'Full legal review', dept: 'Legal', mins: 360 },
                        { name: 'Draft amendments', dept: 'Legal', mins: 180 },
                        { name: 'Send to vendor', dept: 'Procurement', mins: 15 },
                        { name: 'Vendor counter-proposals', dept: 'Legal', mins: 0 },
                        { name: 'Review counter-proposals', dept: 'Legal', mins: 120, isDecision: true, branches: [{ label: 'Accept', target: 'Step 9' }, { label: 'Counter again', target: 'Step 4' }, { label: 'Reject vendor', target: 'Step 10' }] },
                        { name: 'Final legal sign-off', dept: 'Legal', mins: 30 },
                        { name: 'Archive executed contract', dept: 'Legal', mins: 15 },
                        { name: 'Notify procurement — vendor rejected', dept: 'Procurement', mins: 15 }
                    ]
                }
            ];

            return { base, respondents };
        }

        async function loadSampleTeamData() {
            const btn = document.getElementById('sampleBtn');
            btn.disabled = true;
            btn.textContent = 'Creating team session...';
            showState('loading');
            document.querySelector('#loadingState h2').textContent = 'Loading sample team data...';

            try {
                const sample = getTeamSampleResponses();

                // Step 1: Create team session
                document.querySelector('#loadingState h2').textContent = 'Creating team session...';
                const createResp = await fetch('/api/team?action=create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        processName: sample.base.processName,
                        createdBy: sample.base.email,
                        company: sample.base.company
                    })
                });
                const createData = await createResp.json();
                if (!createResp.ok) throw new Error(createData.error || 'Failed to create team');
                const teamCode = createData.teamCode;

                // Step 2: Submit each respondent
                for (let i = 0; i < sample.respondents.length; i++) {
                    const r = sample.respondents[i];
                    document.querySelector('#loadingState h2').textContent = `Submitting ${r.name}'s response (${i + 1}/${sample.respondents.length})...`;

                    const respBody = {
                        teamCode,
                        respondentName: r.name,
                        respondentEmail: sample.base.email,
                        respondentDepartment: r.department,
                        responseData: {
                            processName: sample.base.processName,
                            metrics: r.metrics,
                            issues: r.issues,
                            processData: {
                                steps: r.steps
                            }
                        }
                    };
                    const submitResp = await fetch('/api/team?action=submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(respBody)
                    });
                    if (!submitResp.ok) {
                        const err = await submitResp.json();
                        throw new Error(err.error || `Failed to submit ${r.name}'s response`);
                    }
                }

                // Step 3: Load results
                document.querySelector('#loadingState h2').textContent = 'Aggregating results...';
                document.getElementById('codeInput').value = teamCode;
                history.replaceState(null, '', '/team-results?code=' + teamCode);

                const resultsResp = await fetch('/api/team?action=results&code=' + encodeURIComponent(teamCode));
                const resultsData = await resultsResp.json();
                if (!resultsResp.ok) throw new Error(resultsData.error || 'Failed to load results');

                renderResults(resultsData);

                // Step 4: Trigger AI analysis
                triggerAIAnalysis(resultsData);

            } catch (err) {
                console.error('Sample load error:', err);
                document.getElementById('errorTitle').textContent = 'Sample Load Failed';
                document.getElementById('errorMsg').textContent = err.message;
                showState('error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Load Sample Team Data (Complexity 10)';
            }
        }


        // ═══════════════════════════════════════════════════════════
        // LOAD RESULTS
        // ═══════════════════════════════════════════════════════════
        async function loadResults() {
            const code = document.getElementById('codeInput').value.trim().toUpperCase();
            if (!code) return;
            showState('loading');
            document.querySelector('#loadingState h2').textContent = 'Aggregating team perspectives...';
            history.replaceState(null, '', '/team-results?code=' + code);

            try {
                const resp = await fetch('/api/team?action=results&code=' + encodeURIComponent(code));
                const data = await resp.json();

                if (!resp.ok) {
                    document.getElementById('errorTitle').textContent = 'Not Found';
                    document.getElementById('errorMsg').textContent = data.error || 'Team not found.';
                    showState('error');
                    return;
                }

                if (data.responseCount < 2) {
                    document.getElementById('waitingTitle').textContent = data.responseCount === 0
                        ? 'No Responses Yet'
                        : '1 Response So Far';
                    document.getElementById('waitingMsg').textContent = data.responseCount === 0
                        ? `Share the join link: /diagnostic?team=${code} — results appear after 2+ responses.`
                        : `${data.responses[0].name} has responded. Waiting for more perspectives before comparison.`;
                    document.getElementById('waitingCode').textContent = code;
                    showState('waiting');
                    return;
                }

                renderResults(data);
                triggerAIAnalysis(data);
            } catch (err) {
                console.error(err);
                document.getElementById('errorTitle').textContent = 'Connection Error';
                document.getElementById('errorMsg').textContent = 'Could not reach the server.';
                showState('error');
            }
        }


        // ═══════════════════════════════════════════════════════════
        // AI ANALYSIS
        // ═══════════════════════════════════════════════════════════
        async function triggerAIAnalysis(data) {
            lastResultsData = data;
            const container = document.getElementById('aiAnalysisSection');
            if (!container) return;

            container.innerHTML = `<div class="ai-loading">
                <div class="dot-pulse"><span></span><span></span><span></span></div>
                <p style="margin-top: 12px; color: var(--text-mid); font-size: 0.88rem;">Analysing perception gaps with AI...</p>
            </div>`;

            try {
                const resp = await fetch('/api/team?action=analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        team: data.team,
                        responses: data.responses,
                        aggregation: data.aggregation
                    })
                });
                const result = await resp.json();

                if (!result.success || !result.analysis) {
                    container.innerHTML = '<p style="color: var(--text-light); font-size: 0.85rem; text-align: center;">Analysis unavailable.</p>';
                    return;
                }

                renderAIAnalysis(container, result.analysis, result.analysisType);
            } catch (err) {
                console.error('AI analysis error:', err);
                container.innerHTML = '<p style="color: var(--text-light); font-size: 0.85rem; text-align: center;">Could not load AI analysis.</p>';
            }
        }

        function renderAIAnalysis(container, analysis, type) {
            const badge = type === 'ai-enhanced'
                ? '<span class="ai-badge ai">AI-Enhanced</span>'
                : '<span class="ai-badge rule">Rule-Based</span>';

            let html = '';

            // Executive Summary
            if (analysis.executiveSummary) {
                html += `<div class="ai-summary">${analysis.executiveSummary}</div>`;
            }

            // Root Causes
            if (analysis.rootCauses && analysis.rootCauses.length > 0) {
                html += `<h4 style="font-size: 0.95rem; font-weight: 600; color: var(--primary); margin-bottom: 12px;">Root Causes Identified</h4>`;
                analysis.rootCauses.forEach(rc => {
                    html += `<div class="root-cause ${rc.severity}">
                        <div class="root-cause-header">
                            <span class="root-cause-title">${rc.title}</span>
                            <span class="root-cause-sev ${rc.severity}">${rc.severity}</span>
                        </div>
                        <p>${rc.explanation}</p>
                        ${rc.evidence ? `<p class="evidence">Evidence: ${rc.evidence}</p>` : ''}
                        ${rc.affectedDepartments ? `<p style="font-size:0.78rem;color:var(--text-light);margin-top:4px;">Departments: ${rc.affectedDepartments.join(', ')}</p>` : ''}
                    </div>`;
                });
            }

            // Hidden Inefficiencies
            if (analysis.hiddenInefficiencies && analysis.hiddenInefficiencies.length > 0) {
                html += `<h4 style="font-size: 0.95rem; font-weight: 600; color: var(--amber); margin: 20px 0 12px;">Hidden Inefficiencies</h4>`;
                analysis.hiddenInefficiencies.forEach(hi => {
                    html += `<div class="insight-card"><strong>${hi.title}</strong><p>${hi.insight}</p></div>`;
                });
            }

            // Recommendations
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                html += `<h4 style="font-size: 0.95rem; font-weight: 600; color: var(--primary); margin: 20px 0 12px;">Prioritised Recommendations</h4>
                <ul class="rec-list">`;
                analysis.recommendations.forEach(rec => {
                    const tfClass = rec.timeframe === 'quick-win' ? 'quick-win' : rec.timeframe === '30-day' ? 'thirty' : 'ninety';
                    html += `<li class="rec-item">
                        <div class="rec-num">${rec.priority}</div>
                        <div class="rec-body">
                            <strong>${rec.action}</strong>
                            <p>${rec.impact || ''}</p>
                            <div class="rec-tags">
                                <span class="rec-tag ${tfClass}">${rec.timeframe}</span>
                                ${rec.owner ? `<span class="rec-tag">${rec.owner}</span>` : ''}
                            </div>
                        </div>
                    </li>`;
                });
                html += `</ul>`;
            }

            // Alignment Actions
            if (analysis.alignmentActions && analysis.alignmentActions.length > 0) {
                html += `<h4 style="font-size: 0.95rem; font-weight: 600; color: var(--accent); margin: 20px 0 12px;">Alignment Actions</h4>
                <ul class="alignment-list">`;
                analysis.alignmentActions.forEach(a => {
                    html += `<li>${a}</li>`;
                });
                html += `</ul>`;
            }

            container.innerHTML = html;
        }


        // ═══════════════════════════════════════════════════════════
        // RENDER RESULTS
        // ═══════════════════════════════════════════════════════════
        function sec(title, body, startOpen = false, extra = '') {
            const cls = startOpen ? 'collapsible' : 'collapsible collapsed';
            const icon = startOpen ? '−' : '+';
            return `<div class="${cls}">
                <div class="collapsible-header" onclick="toggleSection(this)">
                    <h3>${title}${extra}</h3>
                    <span class="collapse-btn">${icon}</span>
                </div>
                <div class="collapsible-body">${body}</div>
            </div>`;
        }

        function renderResults(data) {
            lastResultsData = data;
            const { team, responses, aggregation } = data;
            const a = aggregation;

            let html = '';

            // Header (always visible, not collapsible)
            html += `<div style="margin-bottom: 24px;">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; font-weight: 700; color: var(--primary);">${team.processName}</h2>
                <p style="color: var(--text-light); font-size: 0.9rem;">${team.company ? team.company + ' &middot; ' : ''}${data.responseCount} team members responded &middot; Created ${formatDate(team.createdAt)}</p>
            </div>`;

            // 1. Consensus score (always open)
            const csColor = a.consensusScore >= 70 ? 'var(--green)' : a.consensusScore >= 40 ? 'var(--amber)' : 'var(--red)';
            const csLabel = a.consensusScore >= 70 ? 'Strong Alignment' : a.consensusScore >= 40 ? 'Partial Alignment' : 'Significant Disagreement';
            html += sec(`Team Consensus: ${a.consensusScore}% — ${csLabel}`, `
                <div class="consensus-bar">
                    <div class="consensus-track"><div class="consensus-fill" style="width: ${a.consensusScore}%; background: ${csColor};"></div></div>
                    <div class="consensus-label"><span>Disagreement</span><span>Full alignment</span></div>
                </div>`, true);

            // 2. Respondents
            let respHtml = '<div class="respondent-grid">';
            responses.forEach(r => {
                const initials = r.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
                respHtml += `<div class="respondent-chip">
                    <div class="respondent-avatar">${initials}</div>
                    <div class="respondent-info"><strong>${r.name}</strong><span>${r.department || 'No department'}</span></div>
                </div>`;
            });
            respHtml += '</div>';
            html += sec('Respondents', respHtml);

            // 3. Aggregated metrics
            let metHtml = '<div class="metrics-grid">';
            const metrics = [
                { value: a.elapsedDays.avg + ' days', label: 'Avg Cycle Time', color: 'blue', range: `${a.elapsedDays.min}–${a.elapsedDays.max} day range` },
                { value: a.steps.avg, label: 'Avg Steps Seen', color: 'purple', range: `${a.steps.min}–${a.steps.max} step range` },
                { value: a.handoffs.avg, label: 'Avg Handoffs', color: 'amber', range: `${a.handoffs.min}–${a.handoffs.max} range` },
                { value: a.totalHours.avg + 'h', label: 'Avg Time Invested', color: 'green', range: `${a.totalHours.min}–${a.totalHours.max}h range` }
            ];
            metrics.forEach(m => {
                metHtml += `<div class="metric-card">
                    <div class="metric-value ${m.color}">${m.value}</div>
                    <div class="metric-label">${m.label}</div>
                    <div class="metric-range">${m.range}</div>
                </div>`;
            });
            metHtml += '</div>';
            html += sec('Aggregated Metrics', metHtml);

            // 4. Perception gaps
            if (a.perceptionGaps.length > 0) {
                let gapHtml = '<p style="font-size: 0.88rem; color: var(--text-mid); margin-bottom: 16px;">These are areas where team members see the process differently. High gaps often reveal hidden inefficiencies.</p>';
                a.perceptionGaps.forEach(g => {
                    gapHtml += `<div class="gap-card ${g.severity}">
                        <div class="gap-header">
                            <span class="gap-metric">${g.metric}</span>
                            <span class="gap-severity ${g.severity}">${g.severity} gap</span>
                        </div>
                        <div class="gap-detail">${g.detail}</div>
                        <ul class="gap-people">${g.byPerson.map(p => `<li>${p}</li>`).join('')}</ul>
                    </div>`;
                });
                html += sec('Perception Gaps &#9888;', gapHtml);
            }

            // 5. AI Analysis
            html += sec('Deep Analysis', `<div id="aiAnalysisSection" class="ai-analysis">
                <div class="ai-loading">
                    <div class="dot-pulse"><span></span><span></span><span></span></div>
                    <p style="margin-top: 12px; color: var(--text-mid); font-size: 0.88rem;">Analysing perception gaps...</p>
                </div>
            </div>`, false, ' <span class="ai-badge ai" style="vertical-align:middle;">AI-Powered</span>');

            // 6. Issues heatmap
            if (a.issueFrequency.length > 0) {
                let issueHtml = '<p style="font-size: 0.88rem; color: var(--text-mid); margin-bottom: 16px;">How many team members reported each issue type.</p><div class="issue-bar-chart">';
                a.issueFrequency.forEach(issue => {
                    const label = issueLabels[issue.issue] || issue.issue;
                    issueHtml += `<div class="issue-row">
                        <div class="issue-label">${label}</div>
                        <div class="issue-track"><div class="issue-fill" style="width: ${issue.pct}%;"><span>${issue.count}/${data.responseCount}</span></div></div>
                    </div>`;
                });
                issueHtml += '</div>';
                html += sec('Issue Frequency', issueHtml, false);
            }

            // 7. Side-by-side comparison table
            let tableHtml = '<div style="overflow-x: auto;"><table class="comp-table"><thead><tr><th>Metric</th>';
            responses.forEach(r => { tableHtml += `<th>${r.name}<br><span style="font-weight:400;text-transform:none;letter-spacing:0;">${r.department || ''}</span></th>`; });
            tableHtml += '</tr></thead><tbody>';
            const rows = [
                { label: 'Cycle Time', key: 'elapsedDays', suffix: ' days' },
                { label: 'Steps', key: 'stepsCount', suffix: '' },
                { label: 'Handoffs', key: 'handoffCount', suffix: '' },
                { label: 'Poor Handoffs', key: 'poorHandoffs', suffix: '' },
                { label: 'Time Invested', key: 'totalUserHours', suffix: 'h' },
                { label: 'Performance', key: 'performance', suffix: '' },
                { label: 'Biggest Delay', key: 'biggestDelay', suffix: '' }
            ];
            rows.forEach(row => {
                tableHtml += `<tr><td style="font-weight:500;">${row.label}</td>`;
                responses.forEach(r => {
                    const val = r.metrics[row.key];
                    const display = val ? val + row.suffix : '—';
                    tableHtml += `<td>${display}</td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table></div>';
            html += sec('Individual Responses', tableHtml, false);

            // CTA (not collapsible)
            html += `<div class="cta-section">
                <h3>Turn These Insights Into Action</h3>
                <p>Perception gaps are the #1 signal of process improvement opportunity. Let's discuss what your team's results reveal.</p>
                <a href="mailto:hopektettey@gmail.com?subject=Team Diagnostic Discussion — ${encodeURIComponent(team.processName)}" class="cta-button">Book a Call</a>
                <a href="/diagnostic" class="cta-button secondary">Run Full Diagnostic</a>
            </div>`;

            const container = document.getElementById('resultsContent');
            container.innerHTML = html;
            container.style.display = '';
            ['lookupState', 'loadingState', 'errorState', 'waitingState'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        }


        // ═══════════════════════════════════════════════════════════
        // COPY TEAM DATA TO CLIPBOARD
        // ═══════════════════════════════════════════════════════════
        function copyTeamSampleJSON() {
            const sample = getTeamSampleResponses();
            const json = JSON.stringify(sample, null, 2);
            navigator.clipboard.writeText(json).then(() => {
                alert('Team sample JSON copied to clipboard! (' + json.length + ' chars)');
            }).catch(() => {
                console.log('Team Sample JSON:', json);
                alert('Logged to console (clipboard blocked).');
            });
        }


        // ═══════════════════════════════════════════════════════════
        // INIT
        // ═══════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(location.search);

            // Show dev toolbar on localhost or with ?sample param
            const isLocal = ['localhost', '127.0.0.1', '0.0.0.0'].includes(location.hostname) || location.port;
            const devToolbar = document.getElementById('devToolbar');
            if (devToolbar && (isLocal || params.has('sample'))) {
                devToolbar.style.display = 'block';
            }

            const code = params.get('code');
            if (code) {
                document.getElementById('codeInput').value = code;
                loadResults();
            }
            if (params.has('sample')) {
                loadSampleTeamData();
            }
        });
    </script>
</body>
</html>
